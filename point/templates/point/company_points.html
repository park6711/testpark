{% extends "staff/base.html" %}
{% load humanize %}

{% block title %}업체별 최종 포인트{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>업체별 최종 포인트</h2>
        <a href="{% url 'point:point_list' %}" class="btn btn-secondary">
            <i class="fas fa-list"></i> 포인트 내역으로
        </a>
    </div>

    <!-- 요약 정보 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-muted">총 업체 수</h5>
                    <h2 class="text-primary">{{ total_companies }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-muted">전체 포인트 합계</h5>
                    <h2 class="text-success">{{ total_points|intcomma }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="d-flex gap-2">
                        <input type="text" class="form-control" name="search"
                               placeholder="업체명 검색" value="{{ request.GET.search }}">
                        <select class="form-select" name="sort" onchange="this.form.submit()">
                            <option value="points" {% if request.GET.sort == 'points' or not request.GET.sort %}selected{% endif %}>
                                포인트순
                            </option>
                            <option value="name" {% if request.GET.sort == 'name' %}selected{% endif %}>
                                업체명순
                            </option>
                            <option value="update" {% if request.GET.sort == 'update' %}selected{% endif %}>
                                최근 업데이트순
                            </option>
                        </select>
                        <button type="submit" class="btn btn-primary">검색</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 업체별 포인트 리스트 -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th>순위</th>
                    <th>업체명</th>
                    <th>포인트 No</th>
                    <th class="text-end">현재 포인트</th>
                    <th class="text-end">총 사용 포인트</th>
                    <th class="text-center">거래 횟수</th>
                    <th>최근 거래 유형</th>
                    <th>최종 업데이트</th>
                    <th>최근 메모</th>
                    <th class="text-center">작업</th>
                </tr>
            </thead>
            <tbody>
                {% for data in company_points %}
                <tr class="{% if data.current_points < 0 %}table-danger{% elif data.current_points == 0 %}table-warning{% endif %}">
                    <td>{{ forloop.counter }}</td>
                    <td>
                        <strong>{{ data.company.sName2 }}</strong>
                        <br>
                        <small class="text-muted">{{ data.company.sName1 }}</small>
                    </td>
                    <td>
                        <a href="{% url 'point:point_detail' data.point.no %}" class="text-decoration-none">
                            #{{ data.point.no }}
                        </a>
                    </td>
                    <td class="text-end">
                        <strong class="{% if data.current_points < 0 %}text-danger{% elif data.current_points > 0 %}text-success{% endif %}">
                            {{ data.current_points|intcomma }}
                        </strong>
                    </td>
                    <td class="text-end text-muted">
                        {{ data.total_used|intcomma }}
                    </td>
                    <td class="text-center">
                        <span class="badge bg-secondary">{{ data.total_transactions }}</span>
                    </td>
                    <td>
                        <span class="badge bg-info">{{ data.last_type }}</span>
                    </td>
                    <td>
                        {{ data.last_update|date:"Y-m-d" }}
                        <br>
                        <small>{{ data.last_update|date:"H:i" }}</small>
                    </td>
                    <td>
                        <span title="{{ data.last_memo }}">
                            {{ data.last_memo|truncatechars:30|default:"-" }}
                        </span>
                    </td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="{% url 'point:point_list' %}?company={{ data.company.no }}"
                               class="btn btn-outline-primary" title="내역 보기">
                                <i class="fas fa-history"></i>
                            </a>
                            <a href="{% url 'point:point_create' %}?company={{ data.company.no }}"
                               class="btn btn-outline-success" title="포인트 추가">
                                <i class="fas fa-plus"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>포인트 내역이 있는 업체가 없습니다.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 포인트 분포 차트 (옵션) -->
    <div class="mt-5">
        <h4>포인트 분포</h4>
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-success">양수 포인트 업체</h5>
                        <h3>
                            {% with positive_count=company_points|length %}
                                {% for data in company_points %}
                                    {% if data.current_points > 0 %}
                                        {% if forloop.first %}1{% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                            개
                        </h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-warning">제로 포인트 업체</h5>
                        <h3>
                            {% with zero_count=0 %}
                                {% for data in company_points %}
                                    {% if data.current_points == 0 %}
                                        {% if forloop.first %}1{% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                            개
                        </h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-danger">마이너스 포인트 업체</h5>
                        <h3>
                            {% with negative_count=0 %}
                                {% for data in company_points %}
                                    {% if data.current_points < 0 %}
                                        {% if forloop.first %}1{% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                            개
                        </h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% extends "staff/base.html" %}
{% load humanize %}

{% block title %}포인트 상세 정보{% endblock %}

{% block content %}
<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>포인트 상세 정보</h2>
        <div>
            <a href="{% url 'point:point_update' point.no %}" class="btn btn-warning">
                <i class="fas fa-edit"></i> 수정
            </a>
            <button type="button" class="btn btn-danger"
                    onclick="confirmDelete({{ point.no }}, '{{ point.noCompany.sName2 }}')">
                <i class="fas fa-trash"></i> 삭제
            </button>
            <a href="{% url 'point:point_list' %}" class="btn btn-secondary">
                <i class="fas fa-list"></i> 목록으로
            </a>
        </div>
    </div>

    <div class="row">
        <!-- 기본 정보 -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">포인트 정보</h5>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <th width="30%">포인트 ID</th>
                                <td>#{{ point.no }}</td>
                            </tr>
                            <tr>
                                <th>업체명</th>
                                <td>
                                    <strong>{{ point.noCompany.sName2 }}</strong>
                                    <br>
                                    <small class="text-muted">{{ point.noCompany.sName1 }}</small>
                                </td>
                            </tr>
                            <tr>
                                <th>일시</th>
                                <td>{{ point.time|date:"Y-m-d H:i:s" }}</td>
                            </tr>
                            <tr>
                                <th>구분</th>
                                <td>
                                    <span class="badge" style="background-color: {{ point.get_type_display_with_color.color }}">
                                        {{ point.get_type_display_with_color.type }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th>계약보고</th>
                                <td>
                                    {% if point.noCompanyReport %}
                                        #{{ point.noCompanyReport.no }} - {{ point.noCompanyReport.get_nType_display }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>작업자</th>
                                <td>{{ point.sWorker|default:"-" }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 포인트 변동 정보 -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">포인트 변동</h5>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <th width="30%">이전 포인트</th>
                                <td class="text-end">{{ point.nPrePoint|intcomma }}</td>
                            </tr>
                            <tr>
                                <th>사용 포인트</th>
                                <td class="text-end text-danger">
                                    {% if point.nUsePoint != 0 %}
                                        -{{ point.nUsePoint|intcomma }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>잔액 포인트</th>
                                <td class="text-end">
                                    <strong class="fs-4">{{ point.nRemainPoint|intcomma }}</strong>
                                </td>
                            </tr>
                            <tr>
                                <th>변동량</th>
                                <td class="text-end">
                                    {{ point.get_point_change_display }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 메모 -->
            {% if point.sMemo %}
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">메모</h5>
                </div>
                <div class="card-body">
                    <p class="mb-0" style="white-space: pre-wrap;">{{ point.sMemo }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- 최근 포인트 내역 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">{{ point.noCompany.sName2 }}의 최근 내역</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for recent in recent_points %}
                        <a href="{% url 'point:point_detail' recent.no %}"
                           class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ recent.get_nType_display }}</h6>
                                <small>{{ recent.time|date:"m/d" }}</small>
                            </div>
                            <p class="mb-1">
                                잔액: <strong>{{ recent.nRemainPoint|intcomma }}</strong>
                            </p>
                            <small class="text-muted">
                                {{ recent.get_memo_preview }}
                            </small>
                        </a>
                        {% empty %}
                        <div class="list-group-item">
                            <p class="mb-0 text-center text-muted">다른 내역이 없습니다.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 삭제 확인 모달 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">포인트 삭제 확인</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">삭제</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDelete(pointId, companyName) {
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    document.getElementById('deleteMessage').textContent =
        `정말로 ${companyName}의 포인트 내역 #${pointId}을(를) 삭제하시겠습니까?`;
    document.getElementById('deleteForm').action =
        "{% url 'point:point_delete' 0 %}".replace('0', pointId);
    modal.show();
}
</script>
{% endblock %}
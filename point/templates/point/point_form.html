{% extends 'staff/base.html' %}

{% block title %}{{ title }} - PMIS 2.0{% endblock %}
{% block page_title %}{{ title }}{% endblock %}
{% block page_subtitle %}포인트 내역 관리{% endblock %}

{% block content %}
<!-- 페이지 헤더 -->
<div class="page-header">
    <h1 class="page-title">{{ title }}</h1>
    <p class="page-subtitle">포인트 내역 관리</p>
</div>

<div class="form-container">
    <form method="post" action="" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {{ form.non_field_errors }}
        </div>
        {% endif %}

        <!-- 기본 정보 섹션 -->
        <div class="form-section">
            <h3 class="section-title">기본 정보</h3>

            <div class="form-group">
                <label for="{{ form.noCompany.id_for_label }}" class="required">업체</label>
                <div class="searchable-select-wrapper">
                    <input type="text"
                           id="company-search"
                           class="form-control search-input"
                           placeholder="업체명 입력..."
                           autocomplete="off">
                    {{ form.noCompany }}
                    <div id="company-dropdown" class="search-dropdown"></div>
                </div>
                {% if form.noCompany.errors %}
                <div class="error-message">{{ form.noCompany.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.nType.id_for_label }}">구분</label>
                {{ form.nType }}
                {% if form.nType.errors %}
                <div class="error-message">{{ form.nType.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.noCompanyReport.id_for_label }}">계약보고</label>
                {{ form.noCompanyReport }}
                {% if form.noCompanyReport.errors %}
                <div class="error-message">{{ form.noCompanyReport.errors }}</div>
                {% endif %}
                <p class="help-text">관련 계약보고가 있는 경우 선택하세요.</p>
            </div>
        </div>

        <!-- 포인트 정보 섹션 -->
        <div class="form-section">
            <h3 class="section-title">포인트 정보</h3>

            <div class="form-group">
                <label>현재 잔액포인트</label>
                <input type="text"
                       id="pre-point"
                       class="form-control"
                       value="0"
                       readonly
                       style="background-color: #f8f9fa; font-weight: bold; text-align: right;">
            </div>

            <div class="form-group">
                <label for="{{ form.nUsePoint.id_for_label }}">적용 포인트</label>
                <input type="text"
                       id="id_nUsePoint_display"
                       class="form-control"
                       placeholder="적용 포인트를 입력하세요"
                       style="text-align: right;">
                <input type="hidden"
                       name="nUsePoint"
                       id="id_nUsePoint"
                       value="">
                {% if form.nUsePoint.errors %}
                <div class="error-message">{{ form.nUsePoint.errors }}</div>
                {% endif %}
                <p class="help-text">양수(+): 포인트 증가, 음수(-): 포인트 감소</p>
            </div>

            <div class="form-group">
                <label>적용 후 예상 잔액포인트</label>
                <input type="text"
                       id="remain-point"
                       class="form-control"
                       value="0"
                       readonly
                       style="background-color: #f8f9fa; font-weight: bold; text-align: right; font-size: 1.2em;">
            </div>

            <div class="form-group">
                <label for="{{ form.sWorker.id_for_label }}">작업자</label>
                <input type="text"
                       name="sWorker"
                       id="id_sWorker"
                       class="form-control"
                       value="{{ current_staff.sNick|default:current_staff.sName }}"
                       readonly
                       style="background-color: #f8f9fa;">
                {% if form.sWorker.errors %}
                <div class="error-message">{{ form.sWorker.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.sMemo.id_for_label }}">메모</label>
                {{ form.sMemo }}
                {% if form.sMemo.errors %}
                <div class="error-message">{{ form.sMemo.errors }}</div>
                {% endif %}
                <p class="help-text">포인트 변동 사유를 상세히 기록하세요.</p>
            </div>
        </div>

        <!-- 현재 정보 (수정 시) -->
        {% if point %}
        <div class="form-section info-section">
            <h3 class="section-title">현재 포인트 정보</h3>
            <table class="info-table">
                <tbody>
                    <tr>
                        <th>포인트 ID</th>
                        <td>#{{ point.no }}</td>
                    </tr>
                    <tr>
                        <th>등록일시</th>
                        <td>{{ point.time|date:"Y-m-d H:i:s" }}</td>
                    </tr>
                    <tr>
                        <th>이전 포인트</th>
                        <td class="number-cell">{{ point.nPrePoint|default:0 }}</td>
                    </tr>
                    <tr>
                        <th>현재 잔액</th>
                        <td class="number-cell"><strong>{{ point.nRemainPoint|default:0 }}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- 액션 버튼 -->
        <div class="form-buttons">
            <button type="submit" class="btn btn-primary">{{ button_text }}</button>
            <a href="{% url 'point:point_list' %}" class="btn btn-secondary">취소</a>
        </div>
    </form>
</div>


<style>
/* 페이지 헤더 */
.page-header {
    margin-bottom: 20px;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.page-title {
    font-size: 24px;
    font-weight: bold;
    color: #333;
    margin: 0 0 5px 0;
}

.page-subtitle {
    color: #666;
    font-size: 14px;
    margin: 0;
}

/* 폼 컨테이너 */
.form-container {
    background: white;
    border-radius: 8px;
    padding: 30px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

/* 폼 섹션 */
.form-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e9ecef;
}

.form-section:last-of-type {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.section-title {
    font-size: 18px;
    font-weight: bold;
    color: #333;
    margin: 0 0 20px 0;
    padding-bottom: 10px;
    border-bottom: 2px solid #007bff;
}

/* 폼 그룹 */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #333;
}

.form-group label.required:after {
    content: " *";
    color: #dc3545;
}

.form-group input[type="text"],
.form-group input[type="number"],
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.2s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

/* 도움말 텍스트 */
.help-text {
    margin-top: 5px;
    font-size: 12px;
    color: #666;
}

/* 에러 메시지 */
.error-message {
    margin-top: 5px;
    font-size: 12px;
    color: #dc3545;
}

/* 알림 */
.alert {
    padding: 12px 15px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.alert-danger {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

/* 정보 섹션 */
.info-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 4px;
}

.info-table {
    width: 100%;
    border-collapse: collapse;
}

.info-table th {
    width: 30%;
    padding: 8px 12px;
    text-align: left;
    font-weight: bold;
    color: #333;
    background: white;
    border: 1px solid #dee2e6;
}

.info-table td {
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    background: white;
}

.number-cell {
    text-align: right !important;
    font-family: monospace;
}

/* 폼 버튼 */
.form-buttons {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e9ecef;
    display: flex;
    gap: 10px;
    justify-content: center;
}


/* 버튼 */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    display: inline-block;
    transition: all 0.2s;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background-color: #0056b3;
}

.btn-primary:disabled {
    background-color: #6c757d;
    cursor: not-allowed;
    opacity: 0.5;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #545b62;
}

/* 검색 가능한 드롭다운 스타일 */
.searchable-select-wrapper {
    position: relative;
}

.searchable-select-wrapper select {
    display: none;
}

.search-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.search-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    z-index: 100;
}

.search-dropdown.show {
    display: block;
}

.dropdown-item {
    padding: 10px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
}

.dropdown-item:hover,
.dropdown-item.selected {
    background-color: #f0f0f0;
}

.dropdown-item:last-child {
    border-bottom: none;
}

.dropdown-item .company-name {
    font-weight: bold;
    color: #333;
}

.dropdown-item .company-code {
    font-size: 12px;
    color: #666;
    margin-left: 8px;
}

.no-results {
    padding: 20px;
    text-align: center;
    color: #999;
}

/* 반응형 디자인 */
@media (max-width: 768px) {
    .form-container {
        padding: 20px;
    }

    .form-buttons {
        flex-direction: column;
    }

    .btn {
        width: 100%;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('company-search');
    const companySelect = document.getElementById('id_noCompany');
    const dropdown = document.getElementById('company-dropdown');

    if (!searchInput || !companySelect) return;

    // 모든 옵션 데이터 수집
    const companies = [];
    for (let option of companySelect.options) {
        if (option.value) {
            companies.push({
                value: option.value,
                text: option.text,
                element: option
            });
        }
    }

    // 기존 선택값이 있으면 검색창에 표시
    if (companySelect.value) {
        const selected = companies.find(c => c.value === companySelect.value);
        if (selected) {
            searchInput.value = selected.text;
        }
    }

    // 한글 초성 검색 함수
    function getChosung(str) {
        const cho = ["ㄱ", "ㄲ", "ㄴ", "ㄷ", "ㄸ", "ㄹ", "ㅁ", "ㅂ", "ㅃ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅉ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];
        let result = "";
        for (let i = 0; i < str.length; i++) {
            const code = str.charCodeAt(i) - 44032;
            if (code > -1 && code < 11172) {
                result += cho[Math.floor(code / 588)];
            } else {
                result += str.charAt(i);
            }
        }
        return result;
    }

    // 검색 필터링 함수
    function filterCompanies(searchTerm) {
        if (!searchTerm) return companies;

        searchTerm = searchTerm.toLowerCase();
        const searchChosung = getChosung(searchTerm);

        return companies.filter(company => {
            const companyText = company.text.toLowerCase();
            const companyChosung = getChosung(company.text.toLowerCase());

            // 일반 텍스트 검색 또는 초성 검색
            return companyText.includes(searchTerm) ||
                   companyChosung.includes(searchChosung) ||
                   companyText.startsWith(searchTerm);
        });
    }

    // 드롭다운 표시 함수
    function showDropdown(filtered) {
        dropdown.innerHTML = '';

        if (filtered.length === 0) {
            dropdown.innerHTML = '<div class="no-results">검색 결과가 없습니다</div>';
        } else {
            filtered.forEach(company => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                if (company.value === companySelect.value) {
                    item.classList.add('selected');
                }

                // 업체명에서 코드와 이름 분리 (예: "서울1호 (업체명)")
                const match = company.text.match(/^(.+?)\s*\((.+?)\)$/);
                if (match) {
                    item.innerHTML = `
                        <span class="company-name">${match[1]}</span>
                        <span class="company-code">(${match[2]})</span>
                    `;
                } else {
                    item.innerHTML = `<span class="company-name">${company.text}</span>`;
                }

                item.addEventListener('click', function() {
                    selectCompany(company);
                });

                dropdown.appendChild(item);
            });
        }

        dropdown.classList.add('show');
    }

    // 업체 선택 함수
    function selectCompany(company) {
        searchInput.value = company.text;
        companySelect.value = company.value;
        dropdown.classList.remove('show');

        // 이전 포인트 가져오기
        if (company.value) {
            fetchPreviousPoint(company.value);
        } else {
            updatePoints(0);
        }

        // change 이벤트 트리거
        const event = new Event('change', { bubbles: true });
        companySelect.dispatchEvent(event);

        // 버튼 상태 업데이트
        validateUsePoint();
    }

    // 검색 입력 이벤트
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value;
        const filtered = filterCompanies(searchTerm);

        if (searchTerm.length > 0) {
            showDropdown(filtered.slice(0, 20)); // 최대 20개 표시
        } else {
            dropdown.classList.remove('show');
            // 검색어가 지워지면 업체 선택도 초기화
            companySelect.value = '';
            updatePoints(0);
            validateUsePoint();
        }
    });

    // 포커스 이벤트
    searchInput.addEventListener('focus', function(e) {
        const searchTerm = e.target.value;
        if (searchTerm.length > 0) {
            const filtered = filterCompanies(searchTerm);
            showDropdown(filtered.slice(0, 20));
        } else {
            // 검색어가 없으면 모든 업체 표시
            showDropdown(companies.slice(0, 20));
        }
    });

    // 외부 클릭 시 드롭다운 닫기
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.remove('show');
        }
    });

    // 키보드 네비게이션
    let selectedIndex = -1;
    searchInput.addEventListener('keydown', function(e) {
        const items = dropdown.querySelectorAll('.dropdown-item:not(.no-results)');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, 0);
            updateSelection(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedIndex >= 0 && items[selectedIndex]) {
                items[selectedIndex].click();
            }
        } else if (e.key === 'Escape') {
            dropdown.classList.remove('show');
            selectedIndex = -1;
        }
    });

    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('selected');
            }
        });
    }

    // 이전 포인트 가져오기 함수
    function fetchPreviousPoint(companyId) {
        fetch(`/point/api/previous-point/${companyId}/`)
            .then(response => response.json())
            .then(data => {
                updatePoints(data.previous_point || 0);
            })
            .catch(error => {
                console.error('Error fetching previous point:', error);
                updatePoints(0);
            });
    }

    // 포인트 업데이트 함수
    function updatePoints(previousPoint) {
        const prePointInput = document.getElementById('pre-point');
        const usePointInput = document.getElementById('id_nUsePoint');
        const remainPointInput = document.getElementById('remain-point');

        // 이전 포인트 설정
        prePointInput.value = previousPoint.toLocaleString();
        prePointInput.dataset.value = previousPoint;

        // 잔액 계산
        calculateRemainPoint();
    }

    // 천 단위 콤마 포맷 함수
    function formatNumber(value) {
        // 숫자가 아닌 문자 제거 (음수 기호는 유지)
        value = value.replace(/[^0-9-]/g, '');

        // 음수 기호는 맨 앞에만 허용
        const isNegative = value.startsWith('-');
        value = value.replace(/-/g, '');

        // 숫자를 정수로 변환
        const number = parseInt(value) || 0;

        // 천 단위 콤마 추가
        const formatted = number.toLocaleString('ko-KR');

        return isNegative ? '-' + formatted : formatted;
    }

    // 적용 포인트 입력 처리
    const usePointDisplay = document.getElementById('id_nUsePoint_display');
    const usePointHidden = document.getElementById('id_nUsePoint');

    if (usePointDisplay) {
        // 입력 시 콤마 포맷 적용
        usePointDisplay.addEventListener('input', function(e) {
            const cursorPos = e.target.selectionStart;
            const oldLength = e.target.value.length;

            // 포맷된 값 설정
            const formatted = formatNumber(e.target.value);
            e.target.value = formatted;

            // hidden 필드에 실제 값 설정
            const actualValue = formatted.replace(/,/g, '');
            usePointHidden.value = actualValue;

            // 커서 위치 조정
            const newLength = formatted.length;
            const diff = newLength - oldLength;
            e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);

            // 잔액 계산
            calculateRemainPoint();

            // 0값 체크
            validateUsePoint();
        });

        // 포커스 아웃 시 값 정리
        usePointDisplay.addEventListener('blur', function(e) {
            const formatted = formatNumber(e.target.value);
            e.target.value = formatted;
            const actualValue = formatted.replace(/,/g, '');
            usePointHidden.value = actualValue;

            // 0값 체크
            validateUsePoint();
        });
    }

    // 적용 포인트 유효성 검사
    function validateUsePoint() {
        const usePointHidden = document.getElementById('id_nUsePoint');
        const usePointDisplay = document.getElementById('id_nUsePoint_display');
        const submitBtn = document.querySelector('button[type="submit"]');
        const errorDiv = usePointDisplay.parentElement.querySelector('.error-message') ||
                         document.createElement('div');

        const value = parseInt(usePointHidden.value) || 0;

        if (value === 0) {
            // 에러 메시지 표시
            errorDiv.className = 'error-message';
            errorDiv.textContent = '적용 포인트는 0이 될 수 없습니다.';
            errorDiv.style.display = 'block';

            if (!usePointDisplay.parentElement.querySelector('.error-message')) {
                usePointDisplay.parentElement.appendChild(errorDiv);
            }

            // 제출 버튼 비활성화
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.5';
            }

            // 입력 필드 테두리 빨간색
            usePointDisplay.style.borderColor = '#dc3545';
        } else {
            // 에러 제거
            if (errorDiv.parentElement) {
                errorDiv.style.display = 'none';
            }

            // 업체 선택 여부도 함께 확인
            if (submitBtn) {
                if (companySelect.value) {
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                } else {
                    submitBtn.disabled = true;
                    submitBtn.style.opacity = '0.5';
                }
            }

            // 입력 필드 테두리 정상
            usePointDisplay.style.borderColor = '#ddd';
        }
    }

    // 잔액 포인트 계산 함수 수정
    function calculateRemainPoint() {
        const prePointInput = document.getElementById('pre-point');
        const usePointHidden = document.getElementById('id_nUsePoint');
        const remainPointInput = document.getElementById('remain-point');

        const prePoint = parseInt(prePointInput.dataset.value) || 0;
        const usePoint = parseInt(usePointHidden.value) || 0;
        const remainPoint = prePoint + usePoint;

        remainPointInput.value = remainPoint.toLocaleString();

        // 잔액에 따라 색상 변경
        if (remainPoint < 0) {
            remainPointInput.style.color = '#dc3545'; // 빨간색
        } else if (remainPoint > 0) {
            remainPointInput.style.color = '#007bff'; // 파란색
        } else {
            remainPointInput.style.color = '#333'; // 기본색
        }
    }

    // 폼 제출 시 유효성 검사
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const usePointHidden = document.getElementById('id_nUsePoint');
            const value = parseInt(usePointHidden.value) || 0;

            if (value === 0) {
                e.preventDefault();
                alert('적용 포인트는 0이 될 수 없습니다.');
                const usePointDisplay = document.getElementById('id_nUsePoint_display');
                if (usePointDisplay) {
                    usePointDisplay.focus();
                }
                return false;
            }

            // 업체 선택 확인
            if (!companySelect.value) {
                e.preventDefault();
                alert('업체를 선택해주세요.');
                if (searchInput) {
                    searchInput.focus();
                    searchInput.style.borderColor = '#dc3545';
                    setTimeout(() => {
                        searchInput.style.borderColor = '#ddd';
                    }, 3000);
                }
                return false;
            }
        });
    }

    // 초기 로드 시 선택된 업체가 있으면 이전 포인트 가져오기
    if (companySelect && companySelect.value) {
        fetchPreviousPoint(companySelect.value);
    }

    // 초기 로드 시 버튼 상태 설정
    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn) {
        // 업체가 선택되어 있지 않으면 버튼 비활성화
        if (!companySelect || !companySelect.value) {
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.5';
            submitBtn.title = '업체를 선택해주세요';
        }
    }

    // 초기 로드 시 적용 포인트 검증
    validateUsePoint();
});
</script>

{% endblock %}
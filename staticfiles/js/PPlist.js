// API ÌÜµÌï© PPlist React Component
const { useState, useEffect, useCallback } = React;

// Ïù¥Î™®ÏßÄ ÏïÑÏù¥ÏΩò Ï†ïÏùò
const IconEmoji = {
  Search: () => 'üîç',
  Plus: () => '‚ûï',
  Copy: () => 'üìã',
  FileText: () => 'üìÑ',
  Send: () => 'üì§',
  X: () => '‚úñÔ∏è',
  Edit2: () => '‚úèÔ∏è',
  MessageSquare: () => 'üí¨',
  QuoteIcon: () => 'üìë'
};

// API ÏÑúÎπÑÏä§
const api = {
    // ÏùòÎ¢∞ Î™©Î°ù Ï°∞Ìöå
    getOrders: async (params = {}) => {
        const response = await axios.get('/orders/', { params });
        return response.data;
    },

    // ÏùòÎ¢∞ ÏÉÅÏÑ∏ Ï°∞Ìöå
    getOrder: async (id) => {
        const response = await axios.get(`/orders/${id}/`);
        return response.data;
    },

    // ÌïÑÎìú ÏàòÏ†ï
    updateField: async (id, data) => {
        const response = await axios.post(`/orders/${id}/update_field/`, data);
        return response.data;
    },

    // ÏÉÅÌÉú Î≥ÄÍ≤Ω
    updateStatus: async (id, data) => {
        const response = await axios.post(`/orders/${id}/update_status/`, data);
        return response.data;
    },

    // Î©îÎ™® Ï∂îÍ∞Ä
    addMemo: async (id, data) => {
        const response = await axios.post(`/orders/${id}/add_memo/`, data);
        return response.data;
    },

    // Í≤¨Ï†Å ÎßÅÌÅ¨ Ï∂îÍ∞Ä
    addQuoteLink: async (id, data) => {
        const response = await axios.post(`/orders/${id}/add_quote_link/`, data);
        return response.data;
    },

    // ÏùòÎ¢∞ Î≥µÏÇ¨
    copyOrder: async (id) => {
        const response = await axios.post(`/orders/${id}/copy/`);
        return response.data;
    },

    // ÏÑ†ÌÉù ÏÇ≠Ï†ú
    bulkDelete: async (orderIds) => {
        const response = await axios.post('/orders/bulk_delete/', { order_ids: orderIds });
        return response.data;
    },

    // ÏóÖÏ≤¥ Ìï†Îãπ
    assignCompanies: async (data) => {
        const response = await axios.post('/orders/assign_companies/', data);
        return response.data;
    },

    // ÏóÖÏ≤¥ Î™©Î°ù Ï°∞Ìöå
    getCompanies: async () => {
        const response = await axios.get('/companies/');
        return response.data;
    },

    // Í≥µÎèôÍµ¨Îß§ Î™©Î°ù Ï°∞Ìöå
    getGroupPurchases: async () => {
        const response = await axios.get('/group-purchases/');
        return response.data;
    },

    // Î©îÏãúÏßÄ ÌÖúÌîåÎ¶ø Ï°∞Ìöå
    getMessageTemplates: async () => {
        const response = await axios.get('/message-templates/');
        return response.data;
    },

    // ÎÑ§Ïù¥Î≤Ñ Ïπ¥Ìéò ÏûêÎèô Í≤åÏãú
    postToNaverCafe: async (id, data) => {
        const response = await axios.post(`/orders/${id}/post_to_cafe/`, data);
        return response.data;
    },

    // Í≤åÏãúÍ∏Ä ÎßÅÌÅ¨ ÏóÖÎç∞Ïù¥Ìä∏
    updatePostLink: async (id, link) => {
        const response = await axios.post(`/orders/${id}/update_field/`, {
            field_name: 'post_link',
            field_label: 'ÏùòÎ¢∞Í≤åÏãúÍ∏Ä',
            new_value: link,
            author: 'Í¥ÄÎ¶¨Ïûê'
        });
        return response.data;
    }
};

// \uc5c5\uccb4 \ud560\ub2f9 \ud328\ub110 \ucef4\ud3ec\ub10c\ud2b8
const CompanyAllocationPanel = ({ order, companies, groupPurchases, onAllocation, onClose }) => {
    const [selectedCompanies, setSelectedCompanies] = useState([]);
    const [selectedServices, setSelectedServices] = useState([]);
    const [searchTerm, setSearchTerm] = useState('');

    // \uc5c5\uccb4 \uac80\uc0c9 \ud544\ud130\ub9c1
    const filteredCompanies = companies.filter(company =>
        company.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        company.location.toLowerCase().includes(searchTerm.toLowerCase())
    );

    const handleCompanyToggle = (companyId) => {
        setSelectedCompanies(prev =>
            prev.includes(companyId)
                ? prev.filter(id => id !== companyId)
                : [...prev, companyId]
        );
    };

    const handleServiceToggle = (serviceId) => {
        setSelectedServices(prev =>
            prev.includes(serviceId)
                ? prev.filter(id => id !== serviceId)
                : [...prev, serviceId]
        );
    };

    const handleSubmit = () => {
        if (selectedCompanies.length === 0 && selectedServices.length === 0) {
            alert('\ucd5c\uc18c \ud558\ub098\uc758 \uc5c5\uccb4 \ub610\ub294 \uc11c\ube44\uc2a4\ub97c \uc120\ud0dd\ud574\uc8fc\uc138\uc694.');
            return;
        }
        onAllocation(order.id, selectedCompanies, selectedServices);
    };

    return (
        <div className="bg-blue-50 border-l-4 border-blue-500 p-4 m-2">
            <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold text-lg">\uc5c5\uccb4 \ud560\ub2f9</h3>
                <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                    <span style={{fontSize: '20px'}}>‚úñÔ∏è</span>
                </button>
            </div>

            {/* \uace0\uac1d \uc815\ubcf4 \uc694\uc57d */}
            <div className="bg-white rounded p-3 mb-4">
                <div className="grid grid-cols-2 gap-2 text-sm">
                    <div><span className="font-medium">\uace0\uac1d\uba85:</span> {order.name}</div>
                    <div><span className="font-medium">\uacf5\uc0ac\uc9c0\uc5ed:</span> {order.area}</div>
                    <div><span className="font-medium">\uacf5\uc0ac\uc608\uc815\uc77c:</span> {order.scheduledDate}</div>
                    <div><span className="font-medium">\uc9c0\uc815:</span> {order.designation || '\uc5c6\uc74c'}</div>
                </div>
                <div className="mt-2">
                    <span className="font-medium">\uacf5\uc0ac\ub0b4\uc6a9:</span> {order.workContent}
                </div>
            </div>

            {/* \uc5c5\uccb4 \uc120\ud0dd */}
            <div className="mb-4">
                <h4 className="font-medium mb-2">\uc5c5\uccb4 \uc120\ud0dd</h4>
                <input
                    type="text"
                    placeholder="\uc5c5\uccb4\uba85 \uac80\uc0c9..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="w-full p-2 border rounded mb-2"
                />
                <div className="bg-white rounded border max-h-60 overflow-y-auto">
                    {filteredCompanies.map(company => (
                        <label
                            key={company.id}
                            className="flex items-center p-2 hover:bg-gray-50 cursor-pointer"
                        >
                            <input
                                type="checkbox"
                                checked={selectedCompanies.includes(company.id)}
                                onChange={() => handleCompanyToggle(company.id)}
                                className="mr-2"
                            />
                            <div className="flex-1">
                                <div className="font-medium">{company.name}</div>
                                <div className="text-xs text-gray-600">
                                    {company.location} | \ub4f1\uae09: {company.grade}
                                </div>
                                {company.features && (
                                    <div className="text-xs text-blue-600">{company.features}</div>
                                )}
                            </div>
                        </label>
                    ))}
                </div>
            </div>

            {/* \uacf5\ub3d9\uad6c\ub9e4 \uc11c\ube44\uc2a4 */}
            {groupPurchases.length > 0 && (
                <div className="mb-4">
                    <h4 className="font-medium mb-2">\uacf5\ub3d9\uad6c\ub9e4 \uc11c\ube44\uc2a4</h4>
                    <div className="bg-white rounded border max-h-40 overflow-y-auto">
                        {groupPurchases.map(service => (
                            <label
                                key={service.id}
                                className="flex items-center p-2 hover:bg-gray-50 cursor-pointer"
                            >
                                <input
                                    type="checkbox"
                                    checked={selectedServices.includes(service.id)}
                                    onChange={() => handleServiceToggle(service.id)}
                                    className="mr-2"
                                />
                                <div className="flex-1">
                                    <div className="font-medium">{service.name}</div>
                                    <div className="text-xs text-gray-600">
                                        {service.round}\ucc28 | {service.company}
                                    </div>
                                </div>
                            </label>
                        ))}
                    </div>
                </div>
            )}

            {/* \ud560\ub2f9 \ubc84\ud2bc */}
            <div className="flex justify-end space-x-2">
                <button
                    onClick={onClose}
                    className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
                >
                    \ucde8\uc18c
                </button>
                <button
                    onClick={handleSubmit}
                    className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                >
                    \ud560\ub2f9\ud558\uae30 ({selectedCompanies.length}\uac1c \uc5c5\uccb4)
                </button>
            </div>
        </div>
    );
};

const QuoteManagementSystem = () => {
    const [currentPage, setCurrentPage] = useState('list');
    const [expandedRow, setExpandedRow] = useState(null);
    const [showCafePostModal, setShowCafePostModal] = useState(false);  // ÎÑ§Ïù¥Î≤ÑÏπ¥Ìéò Í≤åÏãú Î™®Îã¨
    const [showMessageModal, setShowMessageModal] = useState(false);
    const [showEditModal, setShowEditModal] = useState(false);
    const [showQuoteModal, setShowQuoteModal] = useState(false);
    const [showMemoModal, setShowMemoModal] = useState(false);
    const [showStatusModal, setShowStatusModal] = useState(false);
    const [selectedQuoteId, setSelectedQuoteId] = useState(null);
    const [selectedQuoteForModal, setSelectedQuoteForModal] = useState(null);
    const [selectedOrderForPost, setSelectedOrderForPost] = useState(null);  // Ïπ¥Ìéò Í≤åÏãúÌï† Ï£ºÎ¨∏
    const [messageTemplate, setMessageTemplate] = useState('ÌÖúÌîåÎ¶ø1');
    const [messageRecipient, setMessageRecipient] = useState('ÏóÖÏ≤¥+Í≥†Í∞ù');
    const [selectedCompanies, setSelectedCompanies] = useState([]);
    const [selectedServices, setSelectedServices] = useState([]);
    const [selectedRows, setSelectedRows] = useState([]);

    // APIÏóêÏÑú Í∞ÄÏ†∏Ïò® Îç∞Ïù¥ÌÑ∞
    const [quoteRequestsData, setQuoteRequestsData] = useState([]);
    const [companies, setCompanies] = useState([]);
    const [groupPurchases, setGroupPurchases] = useState([]);
    const [messageTemplates, setMessageTemplates] = useState({});
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    // ÏÉÅÌÉú Ï†ÑÌôò Í∑úÏπô
    const statusTransitions = {
        'ÎåÄÍ∏∞Ï§ë': ['Ìï†Îãπ', 'ÏóÖÏ≤¥ÎØ∏ÎπÑ', 'Ï§ëÎ≥µÏ†ëÏàò', 'Ïó∞ÎùΩÏ≤òÏò§Î•ò', 'Í∞ÄÎä•Î¨∏Ïùò', 'Í≥†Í∞ùÎ¨∏Ïùò'],
        'Ìï†Îãπ': ['Î∞òÎ†§', 'Ï∑®ÏÜå', 'Ï†úÏô∏', 'Ïó∞ÎùΩÏ≤òÏò§Î•ò', 'Í≥ÑÏïΩ'],
        'Ïó∞ÎùΩÏ≤òÏò§Î•ò': ['ÎåÄÍ∏∞Ï§ë', 'Ìï†Îãπ'],
        'Í∞ÄÎä•Î¨∏Ïùò': ['Ìï†Îãπ', 'Î∂àÍ∞ÄÎä•ÎãµÎ≥Ä(X)'],
        'Î∞òÎ†§': ['ÎåÄÍ∏∞Ï§ë', 'Ìï†Îãπ', 'Í≥ÑÏïΩ'],
        'Í≥†Í∞ùÎ¨∏Ïùò': ['ÎåÄÍ∏∞Ï§ë', 'Ìï†Îãπ'],
        'Ï∑®ÏÜå': ['Í≥ÑÏïΩ'],
        'Ï†úÏô∏': [],
        'ÏóÖÏ≤¥ÎØ∏ÎπÑ': ['ÎåÄÍ∏∞Ï§ë'],
        'Ï§ëÎ≥µÏ†ëÏàò': [],
        'Î∂àÍ∞ÄÎä•ÎãµÎ≥Ä(X)': ['ÎåÄÍ∏∞Ï§ë'],
        'Í≥ÑÏïΩ': []
    };

    const customerInquiryTemplates = {
        'ÎÇ¥Ïö©Î¨∏Ïùò': 'ÌèâÏàòÎßå ÏûàÍ±∞ÎÇò Í≥µÏÇ¨ÎÇ¥Ïö©ÏùÑ Ïïå Ïàò ÏóÜÎäî Í≤ΩÏö∞Ïóê Í≥†Í∞ùÏóêÍ≤å Î¨∏Ïùò',
        'Ï£ºÏÜåÎ¨∏Ïùò': 'Í≥µÏÇ¨ ÏßÄÏó≠Ïù¥ ÎπÑÏñ¥ÏûàÍ±∞ÎÇò, Í±¥Î¨ºÌòïÌÉúÎßå ÏûàÎäî Í≤ΩÏö∞ ÎòêÎäî ÏãúÍµ¨ÎèôÎßå ÏûàÎäî Í≤ΩÏö∞Ïù∏ÏßÄ Í≥†Í∞ùÏóêÍ≤å Î¨∏Ïùò',
        'Ï£ºÏÜåÎÇ¥Ïö©Î¨∏Ïùò': 'ÌèâÏàòÎßå ÏûàÍ±∞ÎÇò Í≥µÏÇ¨ÎÇ¥Ïö©ÏùÑ Ïïå Ïàò ÏóÜÎäî Í≤ΩÏö∞ + Í≥µÏÇ¨ ÏßÄÏó≠Ïù¥ ÎπÑÏñ¥ÏûàÍ±∞ÎÇò, Í±¥Î¨ºÌòïÌÉúÎßå ÏûàÎäî Í≤ΩÏö∞ ÎòêÎäî ÏãúÍµ¨ÎèôÎßå ÏûàÎäî Í≤ΩÏö∞',
        'Í≥µÏÇ¨ÏùºÏ†ïÎ¨∏Ïùò': 'Í≥†Í∞ùÏù¥ Í≥µÏÇ¨ ÏùºÏ†ïÏùÑ Ï†ÅÏßÄ ÏïäÏùÄ Í≤ΩÏö∞, Í≥†Í∞ùÍªò Î¨∏Ïùò ÎòêÎäî ÏïàÎÇ¥',
        'Í≥µÏÇ¨ÏùºÏ†ïÎ®ºÍ≤ΩÏö∞': 'Í≥†Í∞ùÍªò Î¨∏Ïùò ÎòêÎäî ÏïàÎÇ¥',
        'Í≥µÏÇ¨ÏùºÏ†ïÏ¥âÎ∞ï': 'Í≥†Í∞ùÍªò Î¨∏Ïùò ÎòêÎäî ÏïàÎÇ¥'
    };

    // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    useEffect(() => {
        loadInitialData();
    }, []);

    const loadInitialData = async () => {
        setLoading(true);
        try {
            const [ordersData, companiesData, purchasesData, templatesData] = await Promise.all([
                api.getOrders(),
                api.getCompanies(),
                api.getGroupPurchases(),
                api.getMessageTemplates()
            ]);

            // Orders Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôò
            const transformedOrders = ordersData.results ? ordersData.results : ordersData;
            const ordersWithCorrectFormat = transformedOrders.map(order => ({
                id: order.no,
                receiptDate: new Date(order.receipt_date || order.time).toISOString().slice(0, 16).replace('T', ' '),
                designation: order.designation || order.sAppoint || '',
                designationType: order.designation_type || 'ÏßÄÏ†ïÏóÜÏùå',
                nickname: order.sNick || '',
                naverId: order.sNaverID || '',
                name: order.sName || '',
                phone: order.sPhone || '',
                postLink: order.post_link || order.sPost || '',
                area: order.sArea || '',
                scheduledDate: order.dateSchedule || '',
                workContent: order.sConstruction || '',
                assignedCompany: order.assigned_company || '',
                recentStatus: order.recent_status || 'ÎåÄÍ∏∞Ï§ë',
                reRequestCount: order.re_request_count || 0,
                quoteCount: 0,
                memoCount: 0
            }));

            setQuoteRequestsData(ordersWithCorrectFormat);
            setCompanies(companiesData);
            setGroupPurchases(purchasesData);
            setMessageTemplates(templatesData);
        } catch (err) {
            console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', err);
            setError('Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        } finally {
            setLoading(false);
        }
    };

    // ÏÑ†ÌÉù Í¥ÄÎ†® Ìï®Ïàò
    const handleSelectAll = (e) => {
        if (e.target.checked) {
            setSelectedRows(quoteRequestsData.map(item => item.id));
        } else {
            setSelectedRows([]);
        }
    };

    const handleSelectRow = (id) => {
        if (selectedRows.includes(id)) {
            setSelectedRows(selectedRows.filter(rowId => rowId !== id));
        } else {
            setSelectedRows([...selectedRows, id]);
        }
    };

    const handleDeleteSelected = async () => {
        if (selectedRows.length === 0) {
            alert('ÏÇ≠Ï†úÌï† Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
            return;
        }

        const confirmMessage = selectedRows.length === 1
            ? 'ÏÑ†ÌÉùÌïú 1Í∞ú Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?'
            : `ÏÑ†ÌÉùÌïú ${selectedRows.length}Í∞ú Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;

        if (window.confirm(confirmMessage)) {
            try {
                await api.bulkDelete(selectedRows);
                setQuoteRequestsData(prev =>
                    prev.filter(item => !selectedRows.includes(item.id))
                );
                setSelectedRows([]);
                alert('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            } catch (err) {
                console.error('ÏÇ≠Ï†ú Ïã§Ìå®:', err);
                alert('ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }
    };

    // ÌïÑÎìú Ìé∏Ïßë Í¥ÄÎ†®
    const [editField, setEditField] = useState({
        fieldName: '',
        fieldLabel: '',
        currentValue: '',
        newValue: '',
        quoteId: null
    });

    const [statusFormData, setStatusFormData] = useState({
        status: 'ÎåÄÍ∏∞Ï§ë',
        template: '',
        recipient: 'ÏóÖÏ≤¥+Í≥†Í∞ù',
        messageContent: ''
    });

    const fieldLabels = {
        designation: 'ÏßÄÏ†ï',
        nickname: 'Î≥ÑÎ™Ö',
        naverId: 'ÎÑ§Ïù¥Î≤ÑID',
        name: 'Ïù¥Î¶Ñ',
        phone: 'Ï†ÑÌôîÎ≤àÌò∏',
        area: 'Í≥µÏÇ¨ÏßÄÏó≠',
        scheduledDate: 'Í≥µÏÇ¨ÏòàÏ†ïÏùº',
        workContent: 'Í≥µÏÇ¨ÎÇ¥Ïö©'
    };

    const openEditModal = (quoteId, fieldName, currentValue) => {
        setEditField({
            fieldName,
            fieldLabel: fieldLabels[fieldName],
            currentValue,
            newValue: currentValue,
            quoteId
        });
        setShowEditModal(true);
    };

    const saveFieldEdit = async () => {
        if (editField.currentValue !== editField.newValue) {
            try {
                await api.updateField(editField.quoteId, {
                    field_name: editField.fieldName,
                    field_label: editField.fieldLabel,
                    new_value: editField.newValue,
                    author: 'Í¥ÄÎ¶¨Ïûê'
                });

                setQuoteRequestsData(prev =>
                    prev.map(item =>
                        item.id === editField.quoteId
                            ? { ...item, [editField.fieldName]: editField.newValue }
                            : item
                    )
                );

                setShowEditModal(false);
                alert('ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.');
            } catch (err) {
                console.error('ÌïÑÎìú ÏàòÏ†ï Ïã§Ìå®:', err);
                alert('ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        } else {
            setShowEditModal(false);
        }
    };

    // ÏÉÅÌÉú Î≥ÄÍ≤Ω Í¥ÄÎ†®
    const openStatusModal = (quoteId) => {
        const quote = quoteRequestsData.find(q => q.id === quoteId);
        setSelectedQuoteForModal(quoteId);
        setStatusFormData({
            status: quote.recentStatus,
            template: '',
            recipient: 'ÏóÖÏ≤¥+Í≥†Í∞ù',
            messageContent: ''
        });
        setShowStatusModal(true);
    };

    const handleStatusChange = (newStatus) => {
        const quote = quoteRequestsData.find(q => q.id === selectedQuoteForModal);
        const template = messageTemplates[newStatus];
        let messageContent = '';

        if (template && quote) {
            messageContent = template
                .replace('{name}', quote.name)
                .replace('{workContent}', quote.workContent);
        }

        setStatusFormData({
            ...statusFormData,
            status: newStatus,
            template: newStatus,
            messageContent
        });
    };

    const updateStatus = async (sendMessage) => {
        const currentQuote = quoteRequestsData.find(q => q.id === selectedQuoteForModal);

        try {
            await api.updateStatus(selectedQuoteForModal, {
                status: statusFormData.status,
                message_sent: sendMessage,
                message_content: statusFormData.messageContent,
                recipient: statusFormData.recipient,
                author: 'Í¥ÄÎ¶¨Ïûê'
            });

            setQuoteRequestsData(prev =>
                prev.map(item =>
                    item.id === selectedQuoteForModal
                        ? { ...item, recentStatus: statusFormData.status }
                        : item
                )
            );

            setShowStatusModal(false);
            alert('ÏÉÅÌÉúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.');
        } catch (err) {
            console.error('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®:', err);
            alert(err.response?.data?.message || 'ÏÉÅÌÉú Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }
    };

    // Î©îÎ™® Í¥ÄÎ†®
    const openMemoModal = (quoteId) => {
        setSelectedQuoteForModal(quoteId);
        setShowMemoModal(true);
    };

    const addMemo = async (content) => {
        try {
            const result = await api.addMemo(selectedQuoteForModal, {
                content,
                author: 'Í¥ÄÎ¶¨Ïûê'
            });

            // Î©îÎ™® Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            setQuoteRequestsData(prev =>
                prev.map(item =>
                    item.id === selectedQuoteForModal
                        ? { ...item, memoCount: item.memoCount + 1 }
                        : item
                )
            );

            alert('Î©îÎ™®Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
            return result.memo;
        } catch (err) {
            console.error('Î©îÎ™® Ï∂îÍ∞Ä Ïã§Ìå®:', err);
            alert('Î©îÎ™® Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }
    };

    // Í≤¨Ï†ÅÏÑú Í¥ÄÎ†®
    const openQuoteModal = (quoteId) => {
        setSelectedQuoteForModal(quoteId);
        setShowQuoteModal(true);
    };

    const addQuoteLink = async (draftType, link) => {
        try {
            const result = await api.addQuoteLink(selectedQuoteForModal, {
                draft_type: draftType,
                link
            });

            // Í≤¨Ï†ÅÏÑú Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            setQuoteRequestsData(prev =>
                prev.map(item =>
                    item.id === selectedQuoteForModal
                        ? { ...item, quoteCount: item.quoteCount + 1 }
                        : item
                )
            );

            alert('Í≤¨Ï†ÅÏÑú ÎßÅÌÅ¨Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
            return result.draft;
        } catch (err) {
            console.error('Í≤¨Ï†ÅÏÑú Ï∂îÍ∞Ä Ïã§Ìå®:', err);
            alert('Í≤¨Ï†ÅÏÑú Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }
    };

    // ÏùòÎ¢∞ Î≥µÏÇ¨
    const copyQuoteRequest = async (item) => {
        try {
            const newOrder = await api.copyOrder(item.id);

            // ÌòÑÏû¨ ÏãúÍ∞ÑÏúºÎ°ú Ï†ëÏàòÏùºÏãú ÏÑ§Ï†ï
            const now = new Date();
            const formattedDate = now.toISOString().slice(0, 16).replace('T', ' ');

            const newItem = {
                id: newOrder.no,
                receiptDate: formattedDate, // ÌòÑÏû¨ ÏãúÍ∞Ñ ÏÇ¨Ïö©
                designation: newOrder.designation || item.designation || '',
                designationType: newOrder.designation_type || item.designationType || 'ÏßÄÏ†ïÏóÜÏùå',
                nickname: newOrder.sNick || item.nickname || '',
                naverId: newOrder.sNaverID || item.naverId || '',
                name: newOrder.sName || item.name || '',
                phone: newOrder.sPhone || item.phone || '',
                postLink: '', // Í≤åÏãúÍ∏Ä ÎßÅÌÅ¨Îäî ÎπÑÏõåÎë† (ÏÉàÎ°ú Í≤åÏãúÌï¥Ïïº Ìï®)
                area: newOrder.sArea || item.area || '',
                scheduledDate: newOrder.dateSchedule || item.scheduledDate || '',
                workContent: newOrder.sConstruction || item.workContent || '',
                assignedCompany: '', // Ìï†ÎãπÏóÖÏ≤¥ Ï¥àÍ∏∞Ìôî
                recentStatus: 'ÎåÄÍ∏∞Ï§ë', // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                reRequestCount: 0,
                quoteCount: 0,
                memoCount: 0
            };

            // ÏÉà Ìï≠Î™©ÏùÑ Î™©Î°ù Îß® ÏïûÏóê Ï∂îÍ∞Ä (ÏµúÏã†Ïàú)
            setQuoteRequestsData(prev => [newItem, ...prev]);
            alert(`ÏùòÎ¢∞Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.\nÏÉà ÏùòÎ¢∞Î≤àÌò∏: ${newOrder.no}`);
        } catch (err) {
            console.error('Î≥µÏÇ¨ Ïã§Ìå®:', err);
            alert('Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }
    };

    // Ìñâ ÌôïÏû•
    const toggleRowExpansion = (id) => {
        setExpandedRow(expandedRow === id ? null : id);
    };

    const extractPostNumber = (url) => {
        // URLÏóêÏÑú ÎßàÏßÄÎßâ 6ÏûêÎ¶¨ Ïà´Ïûê Ï∂îÏ∂ú
        if (!url) return '';
        const match = url.match(/\/(\d{6,})\/?$/);
        if (match) {
            const numbers = match[1];
            // 6ÏûêÎ¶¨ Ïù¥ÏÉÅÏù¥Î©¥ ÎßàÏßÄÎßâ 6ÏûêÎ¶¨Îßå Î∞òÌôò
            return numbers.slice(-6);
        }
        return '';
    };

    // ÏóÖÏ≤¥ Ìï†Îãπ
    const handleCompanyAllocation = async (quoteId, companyIds, serviceIds) => {
        try {
            await api.assignCompanies({
                order_id: quoteId,
                company_ids: companyIds,
                service_ids: serviceIds
            });

            await loadInitialData();
            alert('ÏóÖÏ≤¥Í∞Ä Ìï†ÎãπÎêòÏóàÏäµÎãàÎã§.');
            setExpandedRow(null);
        } catch (err) {
            console.error('ÏóÖÏ≤¥ Ìï†Îãπ Ïã§Ìå®:', err);
            alert('ÏóÖÏ≤¥ Ìï†ÎãπÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }
    };

    // Î™®Îã¨ Ïª¥Ìè¨ÎÑåÌä∏Îì§
    const EditModal = () => (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white p-6 rounded-lg w-[500px]">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-bold">{editField.fieldLabel} ÏàòÏ†ï</h3>
                    <button
                        onClick={() => setShowEditModal(false)}
                        className="text-gray-500 hover:text-gray-700"
                    >
                        <span style={{fontSize: '20px'}}>‚úñÔ∏è</span>
                    </button>
                </div>

                <div className="mb-4">
                    <label className="block text-sm font-medium mb-2">ÌòÑÏû¨ Í∞í</label>
                    <div className="p-2 bg-gray-100 rounded">{editField.currentValue}</div>
                </div>

                <div className="mb-4">
                    <label className="block text-sm font-medium mb-2">ÏÉàÎ°úÏö¥ Í∞í</label>
                    {editField.fieldName === 'workContent' || editField.fieldName === 'area' ? (
                        <textarea
                            value={editField.newValue}
                            onChange={(e) => setEditField({...editField, newValue: e.target.value})}
                            className="w-full p-2 border rounded h-24"
                        />
                    ) : editField.fieldName === 'scheduledDate' ? (
                        <input
                            type="date"
                            value={editField.newValue}
                            onChange={(e) => setEditField({...editField, newValue: e.target.value})}
                            className="w-full p-2 border rounded"
                        />
                    ) : (
                        <input
                            type="text"
                            value={editField.newValue}
                            onChange={(e) => setEditField({...editField, newValue: e.target.value})}
                            className="w-full p-2 border rounded"
                        />
                    )}
                </div>

                <div className="flex justify-end space-x-2">
                    <button
                        onClick={() => setShowEditModal(false)}
                        className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
                    >
                        Ï∑®ÏÜå
                    </button>
                    <button
                        onClick={saveFieldEdit}
                        className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                    >
                        Ï†ÄÏû•
                    </button>
                </div>
            </div>
        </div>
    );

    const StatusModal = () => {
        const quote = quoteRequestsData.find(q => q.id === selectedQuoteForModal);
        const currentStatus = quote?.recentStatus || 'ÎåÄÍ∏∞Ï§ë';
        const hasAssignedCompany = quote?.assignedCompany && quote.assignedCompany !== '';

        let availableStatuses = statusTransitions[currentStatus] || [];

        if (currentStatus === 'Ïó∞ÎùΩÏ≤òÏò§Î•ò' && !hasAssignedCompany) {
            availableStatuses = availableStatuses.filter(s => s !== 'Ìï†Îãπ');
        }

        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white p-6 rounded-lg w-[600px] max-h-[90vh] overflow-y-auto">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold">Ìï†ÎãπÏÉÅÌÉú Î≥ÄÍ≤Ω</h3>
                        <button
                            onClick={() => setShowStatusModal(false)}
                            className="text-gray-500 hover:text-gray-700"
                        >
                            <X className="w-5 h-5" />
                        </button>
                    </div>

                    <div className="mb-4 p-3 bg-blue-50 rounded">
                        <div className="text-sm">
                            <span className="font-medium">ÌòÑÏû¨ ÏÉÅÌÉú:</span>
                            <span className="ml-2 px-2 py-1 rounded text-xs bg-gray-100 text-gray-700">
                                {currentStatus}
                            </span>
                            {quote?.assignedCompany && (
                                <>
                                    <span className="ml-4 font-medium">Ìï†ÎãπÏóÖÏ≤¥:</span>
                                    <span className="ml-2 text-blue-600">{quote.assignedCompany}</span>
                                </>
                            )}
                        </div>
                    </div>

                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium mb-2">1. ÏÉÅÌÉú ÏÑ†ÌÉù</label>
                            <select
                                value={statusFormData.status}
                                onChange={(e) => handleStatusChange(e.target.value)}
                                className="w-full p-2 border rounded"
                            >
                                <option value={currentStatus}>{currentStatus}</option>
                                {availableStatuses.map(status => (
                                    <option key={status} value={status}>{status}</option>
                                ))}
                            </select>
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-2">2. ÏàòÏã†Ïûê ÏÑ†ÌÉù</label>
                            <select
                                value={statusFormData.recipient}
                                onChange={(e) => setStatusFormData({...statusFormData, recipient: e.target.value})}
                                className="w-full p-2 border rounded"
                            >
                                <option value="ÏóÖÏ≤¥+Í≥†Í∞ù">ÏóÖÏ≤¥+Í≥†Í∞ù</option>
                                <option value="ÏóÖÏ≤¥">ÏóÖÏ≤¥</option>
                                <option value="Í≥†Í∞ù">Í≥†Í∞ù</option>
                            </select>
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-2">3. Ìï†Îãπ Î¨∏Ïûê ÎÇ¥Ïö©</label>
                            <textarea
                                value={statusFormData.messageContent}
                                onChange={(e) => setStatusFormData({...statusFormData, messageContent: e.target.value})}
                                className="w-full p-2 border rounded h-32"
                                placeholder="Î¨∏Ïûê ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                            />
                        </div>

                        <div className="flex justify-end space-x-2">
                            <button
                                onClick={() => setShowStatusModal(false)}
                                className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
                            >
                                Ï∑®ÏÜå
                            </button>
                            <button
                                onClick={() => updateStatus(false)}
                                disabled={availableStatuses.length === 0}
                                className="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600"
                            >
                                Î¨∏Ïûê ÏïàÎ≥¥ÎÇ¥Í≥† ÏÉÅÌÉúÎ≥ÄÍ≤Ω
                            </button>
                            <button
                                onClick={() => updateStatus(true)}
                                disabled={availableStatuses.length === 0}
                                className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                            >
                                Î¨∏Ïûê Î≥¥ÎÇ¥Í≥† ÏÉÅÌÉúÎ≥ÄÍ≤Ω
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const MemoModal = () => {
        const [newMemo, setNewMemo] = useState('');

        const handleAddMemo = async () => {
            if (newMemo.trim()) {
                await addMemo(newMemo);
                setNewMemo('');
            }
        };

        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white p-6 rounded-lg w-[600px] max-h-[80vh] overflow-y-auto">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold">Î©îÎ™® Í¥ÄÎ¶¨</h3>
                        <button
                            onClick={() => setShowMemoModal(false)}
                            className="text-gray-500 hover:text-gray-700"
                        >
                            <X className="w-5 h-5" />
                        </button>
                    </div>

                    <div className="mb-6">
                        <h4 className="font-medium mb-2">Î©îÎ™® ÏûÖÎ†•</h4>
                        <textarea
                            value={newMemo}
                            onChange={(e) => setNewMemo(e.target.value)}
                            className="w-full p-2 border rounded h-24 mb-2"
                            placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                        />
                        <button
                            onClick={handleAddMemo}
                            className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                        >
                            Î©îÎ™® Ï∂îÍ∞Ä
                        </button>
                    </div>

                    <div className="flex justify-end">
                        <button
                            onClick={() => setShowMemoModal(false)}
                            className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
                        >
                            Îã´Í∏∞
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    // ÎÑ§Ïù¥Î≤ÑÏπ¥Ìéò Í≤åÏãú Î™®Îã¨
    const CafePostModal = () => {
        const [postTitle, setPostTitle] = useState('');
        const [postContent, setPostContent] = useState('');
        const [cafeId, setCafeId] = useState('29829680'); // f-e Ïπ¥Ìéò ID
        const [naverToken, setNaverToken] = useState(localStorage.getItem('naver_token') || null);
        const [isLoggedIn, setIsLoggedIn] = useState(!!naverToken);

        useEffect(() => {
            if (selectedOrderForPost) {
                // ÏûêÎèôÏúºÎ°ú Ï†úÎ™©Í≥º ÎÇ¥Ïö© ÏÉùÏÑ±
                const title = `[${selectedOrderForPost.area}] Ïù∏ÌÖåÎ¶¨Ïñ¥ Í≤¨Ï†ÅÎ¨∏Ïùò - ${selectedOrderForPost.name}Îãò`;
                const content = `
ÏïàÎÖïÌïòÏÑ∏Ïöî. Ïù∏ÌÖåÎ¶¨Ïñ¥ Í≤¨Ï†ÅÎ¨∏Ïùò ÎìúÎ¶ΩÎãàÎã§.

‚ñ∂ Í≥†Í∞ùÏ†ïÎ≥¥
- ÏÑ±Ìï®: ${selectedOrderForPost.name}
- Ïó∞ÎùΩÏ≤ò: ${selectedOrderForPost.phone}
- ÏßÄÏó≠: ${selectedOrderForPost.area}

‚ñ∂ Í≥µÏÇ¨ÎÇ¥Ïö©
${selectedOrderForPost.workContent}

‚ñ∂ Í≥µÏÇ¨ÏòàÏ†ïÏùº
${selectedOrderForPost.scheduledDate || 'ÌòëÏùò'}

‚ñ∂ ÏßÄÏ†ïÏóÖÏ≤¥
${selectedOrderForPost.designation || 'ÏóÜÏùå'}

Í≤¨Ï†Å Î∂ÄÌÉÅÎìúÎ¶ΩÎãàÎã§.
                `.trim();

                setPostTitle(title);
                setPostContent(content);
            }
        }, [selectedOrderForPost]);

        const handleNaverLogin = () => {
            // ÎÑ§Ïù¥Î≤Ñ Î°úÍ∑∏Ïù∏ ÌåùÏóÖ Ïó¥Í∏∞
            const width = 500;
            const height = 600;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;

            // CLIENT_IDÎ•º Ïã§Ï†ú Í∞íÏúºÎ°ú ÍµêÏ≤¥ ÌïÑÏöî
            const CLIENT_ID = 'YOUR_CLIENT_ID';
            const REDIRECT_URI = encodeURIComponent(window.location.origin + '/naver/callback');
            const STATE = Math.random().toString(36).substring(2);

            const loginUrl = `https://nid.naver.com/oauth2.0/authorize?response_type=token&client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&state=${STATE}`;

            const popup = window.open(loginUrl, 'naver_login', `width=${width},height=${height},left=${left},top=${top}`);

            // Î©îÏãúÏßÄ Î¶¨Ïä§ÎÑà - ÌåùÏóÖÏóêÏÑú ÌÜ†ÌÅ∞ Î∞õÍ∏∞
            const messageListener = (event) => {
                if (event.data && event.data.type === 'naver_token') {
                    const token = event.data.token;
                    localStorage.setItem('naver_token', token);
                    setNaverToken(token);
                    setIsLoggedIn(true);
                    alert('ÎÑ§Ïù¥Î≤Ñ Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ!');
                    window.removeEventListener('message', messageListener);
                }
            };
            window.addEventListener('message', messageListener);
        };

        const handlePost = async () => {
            if (!postTitle || !postContent) {
                alert('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // ÏÇ¨Ïö©Ïûê ÌÜ†ÌÅ∞Ïù¥ ÏûàÎäî Í≤ΩÏö∞ Ïö∞ÏÑ† ÏÇ¨Ïö©
            const userToken = localStorage.getItem('naver_token');

            try {
                // ÏûêÎèô Í≤åÏãú ÏãúÎèÑ (ÏÇ¨Ïö©Ïûê ÌÜ†ÌÅ∞ Ìè¨Ìï®)
                const response = await api.postToNaverCafe(selectedOrderForPost.id, {
                    title: postTitle,
                    content: postContent,
                    cafe_id: cafeId,
                    auto_post: true,  // ÏûêÎèô Í≤åÏãú Î™®Îìú
                    user_token: userToken  // ÏÇ¨Ïö©Ïûê ÌÜ†ÌÅ∞ Ï†ÑÎã¨
                });

                if (response.status === 'success') {
                    // ÏûêÎèô Í≤åÏãú ÏÑ±Í≥µ
                    const postLink = response.post_link;

                    setQuoteRequestsData(prev =>
                        prev.map(item =>
                            item.id === selectedOrderForPost.id
                                ? { ...item, postLink: postLink }
                                : item
                        )
                    );

                    setShowCafePostModal(false);

                    // ÏÑ±Í≥µ Î©îÏãúÏßÄÏôÄ Ìï®Íªò Í≤åÏãúÍ∏Ä ÎßÅÌÅ¨ ÌëúÏãú
                    alert(`‚úÖ ÎÑ§Ïù¥Î≤Ñ Ïπ¥Ìéò ÏûêÎèô Í≤åÏãú ÏÑ±Í≥µ!\n\n` +
                          `Í≤åÏãúÍ∏ÄÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§.\n` +
                          `Í≤åÏãúÍ∏Ä Î≤àÌò∏: ${response.article_id}\n\n` +
                          `Í≤åÏãúÍ∏Ä Î≥¥Í∏∞:`);

                    // ÏûëÏÑ±Îêú Í≤åÏãúÍ∏Ä ÏÉà Ï∞ΩÏúºÎ°ú Ïó¥Í∏∞
                    window.open(postLink, '_blank');

                } else if (response.status === 'manual') {
                    // ÏûêÎèô Í≤åÏãú Ïã§Ìå® - ÏàòÎèô Î™®ÎìúÎ°ú Ï†ÑÌôò
                    const posting_data = response.posting_data;

                    // ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê ÎÇ¥Ïö© Î≥µÏÇ¨
                    await navigator.clipboard.writeText(`${posting_data.title}\n\n${posting_data.content}`);

                    setShowCafePostModal(false);

                    // ÏóêÎü¨ ÌÉÄÏûÖÏóê Îî∞Î•∏ Î©îÏãúÏßÄ
                    let errorMessage = response.message;
                    if (response.error === 'NO_TOKEN') {
                        errorMessage = '‚ö†Ô∏è ÎÑ§Ïù¥Î≤Ñ Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.\n\n' +
                                     'Í¥ÄÎ¶¨ÏûêÏóêÍ≤å ÌÜ†ÌÅ∞ ÏÑ§Ï†ïÏùÑ ÏöîÏ≤≠ÌïòÍ±∞ÎÇò\n' +
                                     'ÏàòÎèôÏúºÎ°ú Í≤åÏãúÌï¥Ï£ºÏÑ∏Ïöî.';
                    } else if (response.error === 'AUTH_FAILED') {
                        errorMessage = '‚ö†Ô∏è Ïù∏Ï¶ùÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§.\n\n' +
                                     'ÌÜ†ÌÅ∞ÏùÑ Í∞±Ïã†ÌïòÍ±∞ÎÇò ÏàòÎèôÏúºÎ°ú Í≤åÏãúÌï¥Ï£ºÏÑ∏Ïöî.';
                    }

                    alert(errorMessage + '\n\n' +
                          'Í≤åÏãúÍ∏Ä ÎÇ¥Ïö©Ïù¥ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.\n' +
                          'ÎÑ§Ïù¥Î≤Ñ Ïπ¥ÌéòÏóêÏÑú ÏßÅÏ†ë Î∂ôÏó¨ÎÑ£Í∏∞ÌïòÏó¨ Í≤åÏãúÌï¥Ï£ºÏÑ∏Ïöî.');

                    // ÎÑ§Ïù¥Î≤Ñ Ïπ¥Ìéò Í∏ÄÏì∞Í∏∞ ÌéòÏù¥ÏßÄ ÏÉà Ï∞ΩÏúºÎ°ú Ïó¥Í∏∞
                    window.open('https://cafe.naver.com/f-e/cafes/29829680/menus/26/articles/write', '_blank');
                } else {
                    throw new Error(response.message || 'Í≤åÏãú Ïã§Ìå®');
                }
            } catch (err) {
                console.error('Í≤åÏãú Ïã§Ìå®:', err);
                alert('Í≤åÏãú Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\nÏàòÎèôÏúºÎ°ú Í≤åÏãúÌï¥Ï£ºÏÑ∏Ïöî.');
            }
        };

        return selectedOrderForPost ? (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white p-6 rounded-lg w-[700px] max-h-[90vh] overflow-y-auto">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold">ÎÑ§Ïù¥Î≤ÑÏπ¥Ìéò Í≤åÏãúÍ∏Ä ÏûëÏÑ±</h3>
                        <button
                            onClick={() => setShowCafePostModal(false)}
                            className="text-gray-500 hover:text-gray-700"
                        >
                            <X className="w-5 h-5" />
                        </button>
                    </div>

                    <div className="mb-4">
                        <label className="block text-sm font-medium mb-2">ÎÑ§Ïù¥Î≤Ñ Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú</label>
                        {isLoggedIn ? (
                            <div className="flex items-center justify-between p-3 bg-green-50 rounded">
                                <span className="text-green-700">
                                    ‚úì Î°úÍ∑∏Ïù∏Îê® (pcarpenter3)
                                </span>
                                <button
                                    onClick={() => {
                                        localStorage.removeItem('naver_token');
                                        setNaverToken(null);
                                        setIsLoggedIn(false);
                                    }}
                                    className="text-sm text-gray-500 hover:text-gray-700"
                                >
                                    Î°úÍ∑∏ÏïÑÏõÉ
                                </button>
                            </div>
                        ) : (
                            <button
                                onClick={handleNaverLogin}
                                className="w-full p-3 bg-green-500 text-white rounded hover:bg-green-600 flex items-center justify-center"
                            >
                                <img
                                    src="https://static.nid.naver.com/oauth/button_g.png"
                                    alt="Naver"
                                    className="w-5 h-5 mr-2"
                                />
                                ÎÑ§Ïù¥Î≤Ñ ÏïÑÏù¥ÎîîÎ°ú Î°úÍ∑∏Ïù∏
                            </button>
                        )}
                        <p className="text-xs text-gray-500 mt-2">
                            * Î°úÍ∑∏Ïù∏ÌïòÎ©¥ Î≥∏Ïù∏ Í≥ÑÏ†ïÏúºÎ°ú Ïπ¥ÌéòÏóê ÏßÅÏ†ë Í≤åÏãúÎê©ÎãàÎã§
                        </p>
                    </div>

                    <div className="mb-4">
                        <label className="block text-sm font-medium mb-2">Ï†úÎ™©</label>
                        <input
                            type="text"
                            value={postTitle}
                            onChange={(e) => setPostTitle(e.target.value)}
                            className="w-full p-2 border rounded"
                        />
                    </div>

                    <div className="mb-4">
                        <label className="block text-sm font-medium mb-2">ÎÇ¥Ïö©</label>
                        <textarea
                            value={postContent}
                            onChange={(e) => setPostContent(e.target.value)}
                            className="w-full p-2 border rounded h-64"
                        />
                    </div>

                    <div className="bg-yellow-50 p-3 rounded mb-4">
                        <p className="text-sm text-yellow-800">
                            ‚ö†Ô∏è ÎÑ§Ïù¥Î≤ÑÏπ¥Ìéò ÏûêÎèô Í≤åÏãúÎäî ÎÑ§Ïù¥Î≤Ñ API Ïù∏Ï¶ùÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.
                            ÌòÑÏû¨Îäî ÏúÑ ÎÇ¥Ïö©ÏùÑ Î≥µÏÇ¨ÌïòÏó¨ ÏàòÎèôÏúºÎ°ú Í≤åÏãúÌï¥Ï£ºÏÑ∏Ïöî.
                        </p>
                    </div>

                    <div className="flex justify-end space-x-2">
                        <button
                            onClick={() => {
                                navigator.clipboard.writeText(`${postTitle}\n\n${postContent}`);
                                alert('Í≤åÏãúÍ∏Ä ÎÇ¥Ïö©Ïù¥ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.');
                            }}
                            className="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
                        >
                            ÎÇ¥Ïö© Î≥µÏÇ¨
                        </button>
                        <button
                            onClick={() => setShowCafePostModal(false)}
                            className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
                        >
                            Ï∑®ÏÜå
                        </button>
                        <button
                            onClick={handlePost}
                            className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                        >
                            ÎßÅÌÅ¨ ÏóÖÎç∞Ïù¥Ìä∏
                        </button>
                    </div>
                </div>
            </div>
        ) : null;
    };

    const QuoteModal = () => {
        const [draftLink, setDraftLink] = useState('');

        const handleAddQuote = async () => {
            if (draftLink) {
                await addQuoteLink('Ï¥àÏïà', draftLink);
                setDraftLink('');
            }
        };

        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white p-6 rounded-lg w-[600px] max-h-[80vh] overflow-y-auto">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold">Í≤¨Ï†ÅÏÑú Í¥ÄÎ¶¨</h3>
                        <button
                            onClick={() => setShowQuoteModal(false)}
                            className="text-gray-500 hover:text-gray-700"
                        >
                            <X className="w-5 h-5" />
                        </button>
                    </div>

                    <div className="mb-6">
                        <h4 className="font-medium mb-2">Í≤¨Ï†ÅÏÑú ÎßÅÌÅ¨ Ï∂îÍ∞Ä</h4>
                        <div className="flex space-x-2">
                            <input
                                type="url"
                                value={draftLink}
                                onChange={(e) => setDraftLink(e.target.value)}
                                className="flex-1 p-2 border rounded"
                                placeholder="Í≤¨Ï†ÅÏÑú ÎßÅÌÅ¨ ÏûÖÎ†•"
                            />
                            <button
                                onClick={handleAddQuote}
                                className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                            >
                                Ï∂îÍ∞Ä
                            </button>
                        </div>
                    </div>

                    <div className="flex justify-end">
                        <button
                            onClick={() => setShowQuoteModal(false)}
                            className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
                        >
                            Îã´Í∏∞
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    // Î©îÏù∏ Î¶¨Ïä§Ìä∏ ÌéòÏù¥ÏßÄ
    const QuoteListPage = () => (
        <div className="p-6">
            <div className="flex justify-between items-center mb-6">
                <h1 className="text-2xl font-bold">Í≤¨Ï†ÅÏùòÎ¢∞ Í¥ÄÎ¶¨</h1>
                <div className="flex space-x-2">
                    {selectedRows.length > 0 && (
                        <button
                            onClick={handleDeleteSelected}
                            className="bg-red-500 text-white px-4 py-2 rounded flex items-center hover:bg-red-600"
                        >
                            ÏÑ†ÌÉù ÏÇ≠Ï†ú ({selectedRows.length})
                        </button>
                    )}
                    <button
                        onClick={() => window.open('https://docs.google.com/forms/d/e/1FAIpQLSfOnhe1eBTRM5bb-r_XA6epsUkPctmqexzcwJk-MC5KlC3F4g/viewform', '_blank')}
                        className="bg-blue-500 text-white px-4 py-2 rounded flex items-center hover:bg-blue-600"
                    >
                        <span style={{fontSize: '16px', marginRight: '8px'}}>‚ûï</span>
                        Ï∂îÍ∞Ä
                    </button>
                </div>
            </div>

            {error && (
                <div className="mb-4 p-4 bg-red-100 text-red-700 rounded">
                    {error}
                </div>
            )}

            {loading ? (
                <div className="text-center py-8">
                    <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                    <p className="mt-2">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</p>
                </div>
            ) : (
                <div className="overflow-x-auto">
                    <table className="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr className="bg-gray-100">
                                <th className="border p-2 w-10">
                                    <input
                                        type="checkbox"
                                        onChange={handleSelectAll}
                                        checked={selectedRows.length === quoteRequestsData.length && quoteRequestsData.length > 0}
                                    />
                                </th>
                                <th className="border p-2">Ï†ëÏàòÏùºÏãú</th>
                                <th className="border p-2 w-40">ÏßÄÏ†ï</th>
                                <th className="border p-2">Î≥ÑÎ™Ö</th>
                                <th className="border p-2">ÎÑ§Ïù¥Î≤ÑID</th>
                                <th className="border p-2">Ïù¥Î¶Ñ</th>
                                <th className="border p-2">Ï†ÑÌôîÎ≤àÌò∏</th>
                                <th className="border p-2">ÏùòÎ¢∞Í≤åÏãúÍ∏Ä</th>
                                <th className="border p-2 w-32">Í≥µÏÇ¨ÏßÄÏó≠</th>
                                <th className="border p-2">Í≥µÏÇ¨ÏòàÏ†ïÏùº</th>
                                <th className="border p-2">Í≥µÏÇ¨ÎÇ¥Ïö©</th>
                                <th className="border p-2">Ìï†ÎãπÏóÖÏ≤¥Î™Ö</th>
                                <th className="border p-2">ÏµúÍ∑ºÌï†ÎãπÏÉÅÌÉú</th>
                                <th className="border p-2">Ïû¨ÏùòÎ¢∞</th>
                                <th className="border p-2">Í≤¨Ï†Å</th>
                                <th className="border p-2">Î©îÎ™®</th>
                                <th className="border p-2">Ïï°ÏÖò</th>
                            </tr>
                        </thead>
                        <tbody>
                            {quoteRequestsData
                                .sort((a, b) => new Date(b.receiptDate) - new Date(a.receiptDate))
                                .map(item => (
                                <React.Fragment key={item.id}>
                                    <tr className={`hover:bg-gray-50 ${selectedRows.includes(item.id) ? 'bg-blue-50' : ''}`}>
                                        <td className="border p-2 text-center">
                                            <input
                                                type="checkbox"
                                                checked={selectedRows.includes(item.id)}
                                                onChange={() => handleSelectRow(item.id)}
                                            />
                                        </td>
                                        <td className="border p-2 text-sm">{item.receiptDate}</td>
                                        <td
                                            className="border p-2 text-xs max-w-40 cursor-pointer hover:bg-yellow-50"
                                            onDoubleClick={() => openEditModal(item.id, 'designation', item.designation)}
                                        >
                                            <div className="break-words">{item.designation}</div>
                                        </td>
                                        <td
                                            className="border p-2 cursor-pointer hover:bg-yellow-50"
                                            onDoubleClick={() => openEditModal(item.id, 'nickname', item.nickname)}
                                        >
                                            {item.nickname}
                                        </td>
                                        <td
                                            className="border p-2 cursor-pointer hover:bg-yellow-50"
                                            onDoubleClick={() => openEditModal(item.id, 'naverId', item.naverId)}
                                        >
                                            {item.naverId}
                                        </td>
                                        <td
                                            className="border p-2 cursor-pointer hover:bg-yellow-50"
                                            onDoubleClick={() => openEditModal(item.id, 'name', item.name)}
                                        >
                                            {item.name}
                                        </td>
                                        <td
                                            className="border p-2 cursor-pointer hover:bg-yellow-50"
                                            onDoubleClick={() => openEditModal(item.id, 'phone', item.phone)}
                                        >
                                            {item.phone}
                                        </td>
                                        <td
                                            className="border p-2 cursor-pointer hover:bg-yellow-50"
                                            onDoubleClick={() => {
                                                const newLink = prompt('Í≤åÏãúÍ∏Ä ÎßÅÌÅ¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', item.postLink || '');
                                                if (newLink !== null) {
                                                    api.updatePostLink(item.id, newLink).then(() => {
                                                        setQuoteRequestsData(prev =>
                                                            prev.map(q => q.id === item.id ? {...q, postLink: newLink} : q)
                                                        );
                                                        alert('Í≤åÏãúÍ∏Ä ÎßÅÌÅ¨Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.');
                                                    }).catch(err => {
                                                        console.error('ÎßÅÌÅ¨ ÏàòÏ†ï Ïã§Ìå®:', err);
                                                        alert('ÎßÅÌÅ¨ ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                                                    });
                                                }
                                            }}
                                        >
                                            {item.postLink ? (
                                                <div className="flex items-center justify-between">
                                                    <a
                                                        href={item.postLink}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="text-blue-500 hover:underline"
                                                        onClick={(e) => e.stopPropagation()}
                                                    >
                                                        {extractPostNumber(item.postLink) || 'ÎßÅÌÅ¨'}
                                                    </a>
                                                </div>
                                            ) : (
                                                <button
                                                    className="bg-orange-500 text-white px-2 py-1 rounded text-xs hover:bg-orange-600"
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setSelectedOrderForPost(item);
                                                        setShowCafePostModal(true);
                                                    }}
                                                >
                                                    Í≤åÏãúÌïòÍ∏∞
                                                </button>
                                            )}
                                        </td>
                                        <td
                                            className="border p-2 text-sm cursor-pointer hover:bg-yellow-50"
                                            onDoubleClick={() => openEditModal(item.id, 'area', item.area)}
                                        >
                                            {item.area}
                                        </td>
                                        <td
                                            className="border p-2 cursor-pointer hover:bg-yellow-50"
                                            onDoubleClick={() => openEditModal(item.id, 'scheduledDate', item.scheduledDate)}
                                        >
                                            {item.scheduledDate}
                                        </td>
                                        <td
                                            className="border p-2 cursor-pointer hover:bg-yellow-50"
                                            onDoubleClick={() => openEditModal(item.id, 'workContent', item.workContent)}
                                        >
                                            {item.workContent}
                                        </td>
                                        <td
                                            className="border p-2 cursor-pointer hover:bg-blue-100"
                                            onClick={() => toggleRowExpansion(item.id)}
                                        >
                                            {item.assignedCompany ? (
                                                <span className="text-blue-600 underline">{item.assignedCompany}</span>
                                            ) : (
                                                <button className="bg-orange-500 text-white px-2 py-1 rounded text-xs hover:bg-orange-600">
                                                    ÎåÄÍ∏∞Ï§ë
                                                </button>
                                            )}
                                        </td>
                                        <td
                                            className="border p-2 cursor-pointer hover:bg-blue-100"
                                            onClick={() => openStatusModal(item.id)}
                                        >
                                            <span className={`px-2 py-1 rounded text-xs ${
                                                item.recentStatus === 'ÎåÄÍ∏∞Ï§ë' ? 'bg-gray-100 text-gray-700' :
                                                item.recentStatus === 'Ìï†Îãπ' ? 'bg-blue-100 text-blue-700' :
                                                item.recentStatus === 'Î∞òÎ†§' ? 'bg-red-100 text-red-700' :
                                                item.recentStatus === 'Ï∑®ÏÜå' ? 'bg-gray-100 text-gray-700' :
                                                item.recentStatus === 'Ï†úÏô∏' ? 'bg-gray-100 text-gray-700' :
                                                item.recentStatus === 'ÏóÖÏ≤¥ÎØ∏ÎπÑ' ? 'bg-yellow-100 text-yellow-700' :
                                                item.recentStatus === 'Ï§ëÎ≥µÏ†ëÏàò' ? 'bg-purple-100 text-purple-700' :
                                                item.recentStatus === 'Ïó∞ÎùΩÏ≤òÏò§Î•ò' ? 'bg-orange-100 text-orange-700' :
                                                item.recentStatus === 'Í∞ÄÎä•Î¨∏Ïùò' ? 'bg-blue-100 text-blue-700' :
                                                item.recentStatus === 'Î∂àÍ∞ÄÎä•ÎãµÎ≥Ä(X)' ? 'bg-red-100 text-red-700' :
                                                item.recentStatus === 'Í≥†Í∞ùÎ¨∏Ïùò' ? 'bg-green-100 text-green-700' :
                                                item.recentStatus === 'Í≥ÑÏïΩ' ? 'bg-green-100 text-green-700' :
                                                'bg-gray-100 text-gray-700'
                                            }`}>
                                                {item.recentStatus}
                                            </span>
                                        </td>
                                        <td className="border p-2">
                                            <button className="text-blue-500 hover:underline">
                                                {item.reRequestCount}
                                            </button>
                                        </td>
                                        <td className="border p-2">
                                            <button
                                                className="text-blue-500 hover:underline"
                                                onClick={() => openQuoteModal(item.id)}
                                            >
                                                {item.quoteCount}
                                            </button>
                                        </td>
                                        <td className="border p-2">
                                            <button
                                                className="text-blue-500 hover:underline"
                                                onClick={() => openMemoModal(item.id)}
                                            >
                                                {item.memoCount}
                                            </button>
                                        </td>
                                        <td className="border p-2">
                                            <div className="flex space-x-1">
                                                <button
                                                    onClick={() => copyQuoteRequest(item)}
                                                    className="bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600"
                                                >
                                                    <span style={{fontSize: '12px'}}>üìã</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {expandedRow === item.id && (
                                        <tr>
                                            <td colSpan="17" className="border-0 p-0">
                                                <CompanyAllocationPanel
                                                    order={item}
                                                    companies={companies}
                                                    groupPurchases={groupPurchases}
                                                    onAllocation={handleCompanyAllocation}
                                                    onClose={() => setExpandedRow(null)}
                                                />
                                            </td>
                                        </tr>
                                    )}
                                </React.Fragment>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );

    return (
        <div className="min-h-screen bg-gray-100">
            <nav className="bg-white shadow-sm border-b">
                <div className="max-w-7xl mx-auto px-4">
                    <div className="flex justify-between items-center h-16">
                        <h1 className="text-xl font-bold text-gray-900">Í≤¨Ï†ÅÏùòÎ¢∞ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</h1>
                    </div>
                </div>
            </nav>

            <QuoteListPage />

            {showEditModal && <EditModal />}
            {showStatusModal && <StatusModal />}
            {showQuoteModal && <QuoteModal />}
            {showMemoModal && <MemoModal />}
            {showCafePostModal && <CafePostModal />}
        </div>
    );
};

// React Ïª¥Ìè¨ÎÑåÌä∏ Î†åÎçîÎßÅ
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<QuoteManagementSystem />);
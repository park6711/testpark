{% extends 'staff/base.html' %}

{% block title %}공동구매 리스트 - PMIS 2.0{% endblock %}
{% block page_title %}공동구매 리스트{% endblock %}
{% block page_subtitle %}공동구매 관리 및 조회{% endblock %}

{% block content %}
<!-- 페이지 헤더 -->
<div class="page-header">
    <h1 class="page-title">공동구매 리스트</h1>
    <p class="page-subtitle">공동구매 관리 및 조회</p>
</div>

<div class="filter-section">
    <form method="GET" id="filterForm" class="filter-form">
        <div class="filter-row">
            <!-- nStepType 필터 -->
            <div class="filter-group">
                <label>단계구분:</label>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" name="nStepType" value="0" {% if '0' in selected_step_types %}checked{% endif %}>
                        <span class="badge badge-primary">준비중</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="nStepType" value="1" {% if '1' in selected_step_types %}checked{% endif %}>
                        <span class="badge badge-success">진행중</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="nStepType" value="2" {% if '2' in selected_step_types %}checked{% endif %}>
                        <span class="badge badge-warning">일시정지</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="nStepType" value="3" {% if '3' in selected_step_types %}checked{% endif %}>
                        <span class="badge badge-secondary">마감</span>
                    </label>
                </div>
            </div>

            <!-- nType 필터 -->
            <div class="filter-group">
                <label>구분:</label>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" name="nType" value="0" {% if '0' in selected_types %}checked{% endif %}>
                        <span class="badge badge-info">올수리</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="nType" value="1" {% if '1' in selected_types %}checked{% endif %}>
                        <span class="badge badge-dark">부분기타</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="filter-row">
            <!-- 통합 검색 -->
            <div class="search-group">
                <input type="text" name="search" value="{{ search_query }}" placeholder="공구회차, 공구이름, 특징, 업체명, 지역명으로 검색..." class="search-input">
                <button type="submit" class="btn btn-primary">검색</button>
                <a href="{% url 'gonggu:gonggu_list' %}" class="btn btn-secondary">초기화</a>
            </div>

            <!-- 관리 버튼 -->
            {% if current_staff and current_staff.nOrderAuthority >= 2 %}
            <div class="action-group">
                <a href="{% url 'gonggu:gonggu_create' %}" class="btn btn-success">+ 공동구매 생성</a>
                <button id="editGongguBtn" class="btn btn-warning" onclick="editSelectedGonggu(); return false;" disabled>공동구매 수정</button>
            </div>
            {% endif %}
        </div>
    </form>
</div>

<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>번호</th>
                <th>단계구분</th>
                <th>구분</th>
                <th>공구회차</th>
                <th>공구이름</th>
                <th>특징</th>
                <th>참여업체</th>
                <th>가능지역</th>
                <th>댓글수</th>
                <th>게시물</th>
                {% if current_staff and current_staff.nOrderAuthority >= 2 %}
                <th>관리</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for item in gonggu_data %}
            <tr class="data-row" data-id="{{ item.gonggu.no }}">
                <td>{{ item.gonggu.no }}</td>
                <td>
                    {% if item.gonggu.nStepType == 0 %}
                        <span class="badge badge-primary">준비중</span>
                    {% elif item.gonggu.nStepType == 1 %}
                        <span class="badge badge-success">진행중</span>
                    {% elif item.gonggu.nStepType == 2 %}
                        <span class="badge badge-warning">일시정지</span>
                    {% elif item.gonggu.nStepType == 3 %}
                        <span class="badge badge-secondary">마감</span>
                    {% else %}
                        <span class="badge badge-light">{{ item.gonggu.nStepType }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if item.gonggu.nType == 0 %}
                        <span class="badge badge-info">올수리</span>
                    {% elif item.gonggu.nType == 1 %}
                        <span class="badge badge-dark">부분기타</span>
                    {% else %}
                        <span class="badge badge-light">{{ item.gonggu.nType }}</span>
                    {% endif %}
                </td>
                <td>{{ item.gonggu.sNo|default:'-' }}</td>
                <td class="gonggu-name">{{ item.gonggu.sName|default:'-' }}</td>
                <td class="strength-field">
                    {% if item.strength_tooltip and item.strength_tooltip != item.strength %}
                    <span class="strength-text-with-tooltip" title="{{ item.strength_tooltip }}">{{ item.strength }}</span>
                    {% else %}
                    {{ item.strength|default:'-' }}
                    {% endif %}
                </td>
                <td>{{ item.company }}</td>
                <td class="area-assignments">
                    {% if item.areas_tooltip %}
                    <span class="area-text-with-tooltip" title="{{ item.areas_tooltip }}">{{ item.areas }}</span>
                    {% else %}
                    {{ item.areas }}
                    {% endif %}
                </td>
                <td>
                    {% if item.gonggu.nCommentNow > 0 %}
                        <span class="comment-count">{{ item.gonggu.nCommentNow }}</span>
                        {% if item.gonggu.nCommentPre > 0 %}
                            <small class="text-muted">(이전: {{ item.gonggu.nCommentPre }})</small>
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if item.gonggu.sPost and 'http' in item.gonggu.sPost %}
                        <a href="{{ item.gonggu.sPost }}" target="_blank" class="btn btn-sm btn-outline-primary">보기</a>
                    {% elif item.gonggu.sPost %}
                        <span class="text-muted" title="{{ item.gonggu.sPost }}">텍스트</span>
                    {% else %}
                        -
                    {% endif %}
                </td>
                {% if current_staff and current_staff.nOrderAuthority >= 2 %}
                <td>
                    <button onclick="deleteGonggu({{ item.gonggu.no }}, {{ item.gonggu_company_id|default:'null' }})" class="btn btn-sm btn-outline-danger">삭제</button>
                </td>
                {% endif %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="{% if current_staff and current_staff.nOrderAuthority >= 2 %}11{% else %}9{% endif %}" class="text-center">검색 결과가 없습니다.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<style>
/* 필터 섹션 스타일 */
.filter-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.filter-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.filter-row {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.filter-group label {
    font-weight: bold;
    color: #333;
    min-width: 80px;
}

.checkbox-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    margin: 0;
    font-weight: normal;
}

.checkbox-item input[type="checkbox"] {
    margin: 0;
}

.search-group {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
}

.search-input {
    flex: 1;
    max-width: 400px;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.action-group {
    margin-left: auto;
}

/* 테이블 스타일 */
.table-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.data-table th {
    background: #f8f9fa;
    color: #333;
    padding: 12px 8px;
    text-align: center;
    font-weight: bold;
    border-bottom: 2px solid #dee2e6;
}

.data-table td {
    padding: 10px 8px;
    text-align: center;
    border-bottom: 1px solid #dee2e6;
    vertical-align: middle;
}

.data-row {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.data-row:hover {
    background-color: #f8f9fa;
}

.data-row.selected {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
}

.data-row.selected:hover {
    background-color: #bbdefb;
}

.gonggu-name {
    text-align: left;
    font-weight: 500;
    color: #333;
    max-width: 200px;
    word-break: break-word;
}

.area-assignments {
    text-align: left;
    font-size: 12px;
    max-width: 300px;
    word-break: break-word;
    line-height: 1.4;
}

/* 버튼 스타일 */
.btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    text-decoration: none;
    display: inline-block;
    transition: all 0.2s ease;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #545b62;
}

.btn-success {
    background-color: #28a745;
    color: white;
}

.btn-success:hover {
    background-color: #1e7e34;
}

.btn-warning {
    background-color: #ffc107;
    color: #212529;
}

.btn-warning:hover {
    background-color: #e0a800;
}

.btn:disabled {
    background-color: #6c757d;
    color: #fff;
    cursor: not-allowed;
    opacity: 0.65;
}

.btn:disabled:hover {
    background-color: #6c757d;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 11px;
}

.btn-outline-primary {
    background-color: transparent;
    color: #007bff;
    border: 1px solid #007bff;
}

.btn-outline-primary:hover {
    background-color: #007bff;
    color: white;
}

.btn-outline-danger {
    background-color: transparent;
    color: #dc3545;
    border: 1px solid #dc3545;
}

.btn-outline-danger:hover {
    background-color: #dc3545;
    color: white;
}

/* 뱃지 스타일 */
.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
    display: inline-block;
}

.badge-primary { background-color: #007bff; color: white; }
.badge-success { background-color: #28a745; color: white; }
.badge-warning { background-color: #ffc107; color: #212529; }
.badge-secondary { background-color: #6c757d; color: white; }
.badge-info { background-color: #17a2b8; color: white; }
.badge-dark { background-color: #343a40; color: white; }
.badge-light { background-color: #f8f9fa; color: #212529; border: 1px solid #dee2e6; }

.text-center {
    text-align: center;
}

/* 반응형 */
@media (max-width: 768px) {
    .filter-row {
        flex-direction: column;
        align-items: stretch;
    }

    .action-group {
        margin-left: 0;
        margin-top: 10px;
    }

    .search-input {
        max-width: none;
    }

    .data-table {
        font-size: 12px;
    }

    .data-table th,
    .data-table td {
        padding: 8px 4px;
    }
}

/* 지역 툴팁 스타일 */
.area-text-with-tooltip {
    position: relative;
    cursor: help;
    border-bottom: 1px dotted #999;
}

.area-text-with-tooltip:hover::after {
    content: attr(title);
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 1000;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    margin-top: 5px;
}

.area-text-with-tooltip:hover::before {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-bottom-color: #333;
    z-index: 1000;
    margin-top: -5px;
}

/* 특징 필드 및 툴팁 스타일 */
.strength-field {
    text-align: left;
    max-width: 200px;
    word-break: break-word;
}

.strength-text-with-tooltip {
    position: relative;
    cursor: help;
    border-bottom: 1px dotted #999;
}

.strength-text-with-tooltip:hover::after {
    content: attr(title);
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    white-space: pre-wrap;
    max-width: 300px;
    word-break: break-word;
    z-index: 1000;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    margin-top: 5px;
}

.strength-text-with-tooltip:hover::before {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-bottom-color: #333;
    z-index: 1000;
    margin-top: -5px;
}

/* 커스텀 다이얼로그 스타일 */
.custom-dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.custom-dialog-content {
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-width: 400px;
    min-width: 300px;
}

.custom-dialog-content p {
    margin: 0 0 20px 0;
    font-size: 16px;
    color: #333;
}

.custom-dialog-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
}

.btn-danger:hover {
    background-color: #c82333;
}
</style>

<script>
// 폼 자동 제출 (필터 체크박스만)
document.querySelectorAll('.filter-section input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        document.getElementById('filterForm').submit();
    });
});

// 행 선택 기능
let selectedGongguId = null;

// 수정 버튼 상태 업데이트
function updateEditButtonState() {
    const editBtn = document.getElementById('editGongguBtn');
    if (selectedGongguId) {
        editBtn.disabled = false;
        console.log('Button enabled for gonggu:', selectedGongguId);
    } else {
        editBtn.disabled = true;
        console.log('Button disabled');
    }
}

document.querySelectorAll('.data-row').forEach(row => {
    // 단일 클릭으로 행 선택
    row.addEventListener('click', function(e) {
        // 기존 선택 해제
        document.querySelectorAll('.data-row').forEach(r => r.classList.remove('selected'));

        // 현재 행 선택
        this.classList.add('selected');
        selectedGongguId = this.dataset.id;
        console.log('Selected gonggu ID:', selectedGongguId);

        // 버튼 상태 업데이트
        updateEditButtonState();
    });

    // 더블클릭으로 권한에 따라 수정/보기 페이지로 이동
    row.addEventListener('dblclick', function(e) {
        const gongguId = this.dataset.id;
        {% if current_staff and current_staff.nOrderAuthority >= 2 %}
            // 수정 권한이 있으면 수정 모드로
            window.location.href = `/gonggu/${gongguId}/?edit=1`;
        {% else %}
            // 수정 권한이 없으면 보기 모드로
            window.location.href = `/gonggu/${gongguId}/`;
        {% endif %}
    });
});

// 수정 버튼 클릭 함수를 전역으로 정의
function editSelectedGonggu() {
    console.log('editSelectedGonggu called, selectedGongguId:', selectedGongguId);
    if (selectedGongguId) {
        console.log('Navigating to edit page for gonggu:', selectedGongguId);
        window.location.href = `/gonggu/${selectedGongguId}/?edit=1`;
    } else {
        const gongguId = prompt('수정할 공동구매 번호를 입력하세요:');
        if (gongguId && gongguId.trim()) {
            window.location.href = `/gonggu/${gongguId.trim()}/?edit=1`;
        }
    }
    return false; // 기본 동작 방지
}

// 테이블 외부 클릭 시 선택 해제
document.addEventListener('click', function(e) {
    // 테이블 행이나 액션 그룹 버튼이 아닌 곳을 클릭했을 때만
    if (!e.target.closest('.data-row') && !e.target.closest('.action-group')) {
        // 모든 선택 해제
        document.querySelectorAll('.data-row').forEach(r => r.classList.remove('selected'));
        selectedGongguId = null;
        updateEditButtonState();
    }
});


// 커스텀 확인 다이얼로그
function showConfirmDialog(message, onConfirm) {
    const dialog = document.createElement('div');
    dialog.className = 'custom-dialog-overlay';
    dialog.innerHTML = `
        <div class="custom-dialog-content">
            <p>${message}</p>
            <div class="custom-dialog-buttons">
                <button class="btn btn-secondary" onclick="this.closest('.custom-dialog-overlay').remove()">취소</button>
                <button class="btn btn-danger" id="confirmBtn">확인</button>
            </div>
        </div>
    `;

    document.body.appendChild(dialog);
    document.getElementById('confirmBtn').onclick = function() {
        dialog.remove();
        onConfirm();
    };
}

// 공동구매 삭제
function deleteGonggu(gongguId, gongguCompanyId) {
    showConfirmDialog('정말로 이 공동구매를 삭제하시겠습니까?', function() {
        doDeleteGonggu(gongguId, gongguCompanyId);
    });
}

function doDeleteGonggu(gongguId, gongguCompanyId) {
    // gongguCompanyId가 있으면 URL에 쿼리 파라미터로 추가
    let url = `/gonggu/${gongguId}/delete/`;
    if (gongguCompanyId && gongguCompanyId !== null) {
        url += `?gonggu_company_id=${gongguCompanyId}`;
    }

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('공동구매가 삭제되었습니다.', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast(data.error || '삭제 중 오류가 발생했습니다.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('삭제 중 오류가 발생했습니다.', 'error');
    });
}

// 토스트 알림
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;

    const style = toast.style;
    style.position = 'fixed';
    style.top = '20px';
    style.right = '20px';
    style.padding = '12px 24px';
    style.borderRadius = '4px';
    style.color = 'white';
    style.fontSize = '14px';
    style.zIndex = '9999';
    style.opacity = '0';
    style.transition = 'opacity 0.3s ease';

    if (type === 'success') {
        style.backgroundColor = '#28a745';
    } else if (type === 'error') {
        style.backgroundColor = '#dc3545';
    } else {
        style.backgroundColor = '#17a2b8';
    }

    document.body.appendChild(toast);

    setTimeout(() => {
        style.opacity = '1';
    }, 100);

    setTimeout(() => {
        style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

</script>

{% csrf_token %}
{% endblock %}
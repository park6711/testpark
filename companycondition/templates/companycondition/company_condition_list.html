{% extends 'staff/base.html' %}

{% block title %}ì—…ì²´ ìƒíƒœ{% endblock %}

{% block page_title %}<span id="page-title">ì—…ì²´ ìƒíƒœ</span>{% endblock %}
{% block page_subtitle %}ì—…ì²´ì˜ ìƒíƒœ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.{% endblock %}

{% block content %}
{% if not not_logged_in %}
{{ block.super }}
{% endif %}

{% csrf_token %}

{% if not not_logged_in %}
<style>
    .form-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }

    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
    }

    .company-info-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
        margin-top: 20px;
        display: none;
    }

    .info-row {
        display: flex;
        margin-bottom: 15px;
        align-items: center;
    }

    .info-label {
        font-weight: 600;
        color: #333;
        width: 250px;
        font-size: 14px;
    }

    .info-value {
        color: #555;
        font-size: 14px;
        flex: 1;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background-color: #0056b3;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #545b62;
    }

    /* ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    .company-search-container {
        position: relative;
    }

    .company-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .company-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
    }

    .company-item:hover {
        background-color: #f8f9fa;
    }

    .company-item.active {
        background-color: #e7f3ff;
    }

    .company-item:last-child {
        border-bottom: none;
    }

    .company-name {
        font-weight: 500;
        color: #333;
    }

    .company-meta {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
    }

    /* ì„ íƒëœ ì—…ì²´ í‘œì‹œ */
    .selected-company {
        margin-top: 8px;
        padding: 8px 12px;
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 4px;
        display: none;
        font-size: 14px;
    }

    .clear-company {
        background: none;
        border: none;
        float: right;
        color: #666;
        cursor: pointer;
        font-size: 16px;
    }

    .clear-company:hover {
        color: #333;
    }

    /* ì»¤ìŠ¤í…€ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .custom-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .custom-modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        border-radius: 8px;
        width: 400px;
        max-width: 90%;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .custom-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    .custom-modal-title {
        margin: 0;
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }

    .custom-modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #aaa;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .custom-modal-close:hover {
        color: #000;
    }

    .custom-modal-body {
        margin-bottom: 20px;
    }

    .custom-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    /* Badge ìŠ¤íƒ€ì¼ (Company ë¦¬ìŠ¤íŠ¸ì™€ ë™ì¼) */
    .badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        margin: 0 2px;
    }

    .badge-primary {
        background-color: #007bff;
        color: white;
    }

    .badge-warning {
        background-color: #ffc107;  /* ë…¸ë‘ìƒ‰ìœ¼ë¡œ ë³€ê²½ (ìˆœìˆ˜ë‹¨ì¢…) */
        color: black;
    }

    .badge-secondary {
        background-color: #28a745;  /* ë…¹ìƒ‰ìœ¼ë¡œ ë³€ê²½ (ì¼ë°˜í† íƒˆ) */
        color: white;
    }

    .badge-success {
        background-color: #6c757d;  /* íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½ (btocì œíœ´) */
        color: white;
    }

    .badge-info {
        background-color: #ffc0cb;  /* ì—°í•œë¶„í™ìƒ‰ìœ¼ë¡œ ë³€ê²½ (ë¶€ë¶„ë‹¨ì¢…) */
        color: #333;
    }

    .badge-light {
        background-color: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }

    .badge-dark {
        background-color: #343a40;
        color: white;
    }

    .badge-danger {
        background-color: #dc3545;
        color: white;
    }

    /* ì•Œë¦¼ í† ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 20000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 500;
        max-width: 300px;
    }

    .toast-notification.show {
        opacity: 1;
        transform: translateX(0);
    }

    .toast-notification.error {
        background: #dc3545;
    }
</style>

<!-- ì—…ì²´ ì„ íƒ -->
<div class="form-container">
    <div class="form-group">
        <label for="company-search" class="form-label">
            ì—´ë¦°ì—…ì²´ <span style="color: red;">*</span>
        </label>
        <div class="company-search-container">
            <input type="text"
                   id="company-search"
                   class="form-control"
                   placeholder="ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”..."
                   autocomplete="off"
                   style="padding-right: 40px;"
                   readonly>
            <div id="search-icon" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 16px; cursor: pointer;">ğŸ”</div>
            <div id="company-dropdown" class="company-dropdown"></div>
        </div>
        <input type="hidden" id="company-select" value="">
        <div id="selected-company" class="selected-company">
            <span id="selected-company-name"></span>
            <button type="button" id="clear-company" class="clear-company">âœ•</button>
        </div>
    </div>
</div>

<!-- ì—…ì²´ ìƒíƒœ ì •ë³´ -->
<div id="company-info" class="company-info-container">
    <!-- ë“±ê¸‰ ì •ë³´ ì„¹ì…˜ -->
    <div class="info-section">
        <h4 id="grade-section-title" style="margin-bottom: 20px; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px;">ë“±ê¸‰ ì •ë³´</h4>

        <div class="info-row">
            <div class="info-label">í˜„ì¬ ë ˆë²¨:</div>
            <div class="info-value" id="info-level">-</div>
        </div>

        <div class="info-row">
            <div class="info-label">í˜„ì¬ ë“±ê¸‰:</div>
            <div class="info-value" id="info-grade">-</div>
        </div>

        <div class="info-row">
            <div class="info-label">í˜„ì¬ ì ìš©ë“±ê¸‰:</div>
            <div class="info-value">
                <span id="info-apply-grade">-</span>
                {% if current_staff and current_staff.nCompanyAuthority >= 2 %}
                    <button type="button" id="change-grade-btn" class="btn btn-primary" style="margin-left: 15px;">ì ìš©ë“±ê¸‰ ë³€ê²½</button>
                {% else %}
                    <button type="button" class="btn btn-secondary" style="margin-left: 15px; cursor: not-allowed;" disabled title="ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤">ì ìš©ë“±ê¸‰ ë³€ê²½</button>
                {% endif %}
            </div>
        </div>

        <div class="info-row">
            <div class="info-label">ì ìš©ë“±ê¸‰ ë³€ê²½ì‚¬ìœ :</div>
            <div class="info-value" id="info-apply-grade-reason">-</div>
        </div>
    </div>

    <!-- í• ë‹¹ìˆ˜ ì •ë³´ ì„¹ì…˜ -->
    <div class="info-section" style="margin-top: 30px;">
        <h4 id="assign-section-title" style="margin-bottom: 20px; color: #333; border-bottom: 2px solid #28a745; padding-bottom: 10px;">í• ë‹¹ìˆ˜ ì •ë³´</h4>

        <div class="info-row">
            <div class="info-label">ìµœê·¼ 2ì¼ í• ë‹¹ìˆ˜(ì˜¬ìˆ˜ë¦¬):</div>
            <div class="info-value" id="info-assign-all-2">-</div>
        </div>

        <div class="info-row">
            <div class="info-label">ìµœê·¼ 3ì¼ í• ë‹¹ìˆ˜(ë¶€ë¶„ìˆ˜ë¦¬):</div>
            <div class="info-value" id="info-assign-part-2">-</div>
        </div>

        <div class="info-row">
            <div class="info-label">í˜„ì¬ í‰ê°€ê¸°ê°„ í• ë‹¹ìˆ˜(ì˜¬ìˆ˜ë¦¬):</div>
            <div class="info-value" id="info-assign-all-term">-</div>
        </div>

        <div class="info-row">
            <div class="info-label">í˜„ì¬ í‰ê°€ê¸°ê°„ í• ë‹¹ìˆ˜(ë¶€ë¶„ìˆ˜ë¦¬):</div>
            <div class="info-value" id="info-assign-part-term">-</div>
        </div>

        <div class="info-row">
            <div class="info-label">í˜„ì¬ ì ìš©ë“±ê¸‰ì„ ê³ ë ¤í•œ ìµœëŒ€í• ë‹¹ìˆ˜:</div>
            <div class="info-value" id="info-assign-max">-</div>
        </div>

        <div class="info-row">
            <div class="info-label">í˜„ì¬ ì ìš©ë“±ê¸‰ì„ ê³ ë ¤í•œ í• ë‹¹í¼ì„¼íŠ¸:</div>
            <div class="info-value" id="info-assign-percent">-</div>
        </div>

        <div class="info-row">
            <div class="info-label">ê³ ì •ë¹„ì—…ì²´ í• ë‹¹ë¶€ì¡± ê°œìˆ˜:</div>
            <div class="info-value" id="info-assign-lack">-</div>
        </div>
    </div>
</div>

<!-- ì ìš©ë“±ê¸‰ ë³€ê²½ ëª¨ë‹¬ -->
<div id="grade-modal" class="custom-modal">
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <h3 class="custom-modal-title">ì ìš©ë“±ê¸‰ ë³€ê²½</h3>
            <button type="button" class="custom-modal-close" onclick="closeGradeModal()">&times;</button>
        </div>
        <div class="custom-modal-body">
            <div class="form-group">
                <label class="form-label">í˜„ì¬ ë“±ê¸‰:</label>
                <div class="form-control" style="background-color: #f8f9fa; color: #6c757d;" id="modal-current-grade">-</div>
            </div>
            <div class="form-group">
                <label for="modal-apply-grade" class="form-label">í˜„ì¬ ì ìš©ë“±ê¸‰:</label>
                <select id="modal-apply-grade" class="form-control">
                    <!-- 0ë“±ê¸‰ë¶€í„° 100ë“±ê¸‰ê¹Œì§€ ì˜µì…˜ ë™ì  ìƒì„± -->
                </select>
            </div>
            <div class="form-group">
                <label for="modal-apply-grade-reason" class="form-label">ë³€ê²½ ì‚¬ìœ :</label>
                <textarea id="modal-apply-grade-reason" class="form-control" rows="3" placeholder="ë³€ê²½ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”..."></textarea>
            </div>
        </div>
        <div class="custom-modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeGradeModal()">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-primary" onclick="saveApplyGrade()">ì €ì¥</button>
        </div>
    </div>
</div>

<script>
let selectedCompanyId = null;
let searchTimeout = null;

// í˜„ì¬ ìŠ¤í…ì˜ ê¶Œí•œ ì •ë³´
const currentStaffAuthority = {% if current_staff %}{{ current_staff.nCompanyAuthority }}{% else %}0{% endif %};

// nType Badge ìƒì„± í•¨ìˆ˜
function getTypeBadge(nType, typeText) {
    let badgeClass = '';
    switch(nType) {
        case 0: badgeClass = 'badge-secondary'; break; // ì¼ë°˜í† íƒˆ
        case 1: badgeClass = 'badge-primary'; break;   // ê³ ì •ë¹„í† íƒˆ
        case 2: badgeClass = 'badge-info'; break;      // ë¶€ë¶„ë‹¨ì¢…
        case 3: badgeClass = 'badge-warning'; break;   // ìˆœìˆ˜ë‹¨ì¢…
        case 4: badgeClass = 'badge-success'; break;   // btocì œíœ´
        case 5: badgeClass = 'badge-dark'; break;      // btobì œíœ´
        default: badgeClass = 'badge-secondary'; break;
    }
    return `<span class="badge ${badgeClass}">${typeText}</span>`;
}

// nCondition Badge ìƒì„± í•¨ìˆ˜
function getConditionBadge(nCondition, conditionText) {
    let badgeClass = '';
    switch(nCondition) {
        case 0: badgeClass = 'badge-light'; break;   // ì¤€ë¹„ì¤‘
        case 1: badgeClass = 'badge-success'; break; // ì •ìƒ
        case 2: badgeClass = 'badge-warning'; break; // ì¼ì‹œì •ì§€
        case 3: badgeClass = 'badge-danger'; break;  // íƒˆí‡´
        default: badgeClass = 'badge-light'; break;
    }
    return `<span class="badge ${badgeClass}">${conditionText}</span>`;
}

// ê¶Œí•œì— ë”°ë¥¸ Company ë§í¬ ìƒì„± í•¨ìˆ˜
function getCompanyLink(companyId, companyName) {
    if (currentStaffAuthority === 0) {
        // ê¶Œí•œì—†ìŒ: ì ‘ê·¼ ì œí•œ
        return {
            html: `<span style="color: #999; cursor: not-allowed;" title="ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤">${companyName}</span>`,
            clickable: false
        };
    } else if (currentStaffAuthority === 1) {
        // ì½ê¸°ê¶Œí•œ: ë³´ê¸° í™”ë©´
        return {
            html: `<a href="/company/view/${companyId}/" style="color: #333; text-decoration: underline; cursor: pointer;" title="ë³´ê¸° ì „ìš©">${companyName}</a>`,
            clickable: true
        };
    } else if (currentStaffAuthority === 2) {
        // ì“°ê¸°ê¶Œí•œ: ìˆ˜ì • í™”ë©´
        return {
            html: `<a href="/company/update/${companyId}/" style="color: #333; text-decoration: underline; cursor: pointer;" title="ìˆ˜ì • ê°€ëŠ¥">${companyName}</a>`,
            clickable: true
        };
    } else {
        // ê¸°íƒ€ ê¶Œí•œ: ë³´ê¸° í™”ë©´
        return {
            html: `<a href="/company/view/${companyId}/" style="color: #333; text-decoration: underline; cursor: pointer;">${companyName}</a>`,
            clickable: true
        };
    }
}

// DOMì´ ë¡œë“œëœ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
document.addEventListener('DOMContentLoaded', function() {
    // ì—…ì²´ ê²€ìƒ‰ - í´ë¦­ ì‹œ ì „ì²´ ì—…ì²´ í‘œì‹œ
    document.getElementById('company-search').addEventListener('click', function() {
        console.log('Search input clicked, readOnly:', this.readOnly);
        if (this.readOnly) {
            // ì½ê¸° ì „ìš©ì¼ ë•Œ í´ë¦­í•˜ë©´ ê²€ìƒ‰ ëª¨ë“œë¡œ ì „í™˜
            this.readOnly = false;
            this.placeholder = "ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”...";
            this.focus();
            loadAllCompanies();
        } else {
            // ì´ë¯¸ ê²€ìƒ‰ ëª¨ë“œì¼ ë•Œ
            const query = this.value.trim();
            if (query.length >= 1) {
                searchCompanies(query);
            } else {
                loadAllCompanies();
            }
        }
    });

    // ê²€ìƒ‰ ì•„ì´ì½˜ í´ë¦­ ì‹œ ì „ì²´ ì—…ì²´ í‘œì‹œ
    document.getElementById('search-icon').addEventListener('click', function() {
        console.log('Search icon clicked');
        const searchInput = document.getElementById('company-search');
        searchInput.readOnly = false;
        searchInput.placeholder = "ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”...";
        searchInput.focus();
        loadAllCompanies();
    });

    // ì—…ì²´ ê²€ìƒ‰ (ì…ë ¥ ì‹œì—ë§Œ)
    document.getElementById('company-search').addEventListener('input', function() {
        console.log('Input event, readOnly:', this.readOnly, 'value:', this.value);
        if (this.readOnly) return;

        const query = this.value.trim();

        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }

        searchTimeout = setTimeout(() => {
            if (query.length >= 1) {
                searchCompanies(query);
            } else {
                loadAllCompanies();
            }
        }, 300);
    });
});

// í‚¤ë³´ë“œ ì´ë²¤íŠ¸
document.getElementById('company-search').addEventListener('keydown', function(e) {
    const dropdown = document.getElementById('company-dropdown');

    if (dropdown.style.display !== 'block') return;

    const items = dropdown.querySelectorAll('.company-item');
    const active = dropdown.querySelector('.company-item.active');

    if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (active) {
            const next = active.nextElementSibling;
            if (next) {
                setActiveCompanyItem(items, Array.from(items).indexOf(next));
            }
        } else if (items.length > 0) {
            setActiveCompanyItem(items, 0);
        }
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (active) {
            const prev = active.previousElementSibling;
            if (prev) {
                setActiveCompanyItem(items, Array.from(items).indexOf(prev));
            }
        }
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (active) {
            selectCompany(active.dataset.companyId, active.dataset.companyName, active.dataset.companyType, active.dataset.companyCondition);
        }
    } else if (e.key === 'Escape') {
        hideCompanyDropdown();
    }
});

// ì „ì²´ ì—…ì²´ ë¡œë“œ
async function loadAllCompanies() {
    try {
        const response = await fetch('/companycondition/search/?q=');
        const data = await response.json();

        showCompanyDropdown(data.results);
    } catch (error) {
        console.error('ì—…ì²´ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

// ì—…ì²´ ê²€ìƒ‰ í•¨ìˆ˜
async function searchCompanies(query) {
    try {
        const response = await fetch(`/companycondition/search/?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        showCompanyDropdown(data.results);
    } catch (error) {
        console.error('ì—…ì²´ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
    }
}

// ë“œë¡­ë‹¤ìš´ í‘œì‹œ
function showCompanyDropdown(companies) {
    const dropdown = document.getElementById('company-dropdown');
    dropdown.innerHTML = '';
    dropdown.style.display = 'block';

    if (companies.length === 0) {
        const noResult = document.createElement('div');
        noResult.className = 'company-item';
        noResult.innerHTML = '<div style="color: #999; text-align: center;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        dropdown.appendChild(noResult);
        return;
    }

    companies.forEach((company, index) => {
        const item = document.createElement('div');
        item.className = 'company-item';
        item.dataset.companyId = company.id;
        item.dataset.companyName = company.name;
        item.dataset.companyType = company.type;
        item.dataset.companyCondition = company.condition;
        item.dataset.companyTypeValue = company.type_value;
        item.dataset.companyConditionValue = company.condition_value;

        item.innerHTML = `
            <div class="company-name">${company.name}</div>
            <div class="company-meta">${company.type} | ${company.condition}</div>
        `;

        item.addEventListener('click', function() {
            selectCompany(company.id, company.name, company.type, company.condition);
        });

        dropdown.appendChild(item);

        if (index === 0) {
            setActiveCompanyItem(dropdown.querySelectorAll('.company-item'), 0);
        }
    });
}

// ë“œë¡­ë‹¤ìš´ ìˆ¨ê¸°ê¸°
function hideCompanyDropdown() {
    document.getElementById('company-dropdown').style.display = 'none';
}

// í™œì„± ì•„ì´í…œ ì„¤ì •
function setActiveCompanyItem(items, index) {
    items.forEach(item => item.classList.remove('active'));
    if (items[index]) {
        items[index].classList.add('active');
    }
}

// ì—…ì²´ ì„ íƒ
function selectCompany(companyId, companyName, companyType, companyCondition) {
    selectedCompanyId = companyId;

    // í˜ì´ì§€ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸ (ê¶Œí•œì— ë”°ë¥¸ ì—…ì²´ëª… ë§í¬ ìƒì„±)
    const pageTitle = document.getElementById('page-title');
    const companyLink = getCompanyLink(companyId, companyName);

    // ë“œë¡­ë‹¤ìš´ ì•„ì´í…œì—ì„œ type_valueì™€ condition_value ê°€ì ¸ì˜¤ê¸°
    const clickedItem = document.querySelector('.company-item.active') ||
                       document.querySelector(`[data-company-id="${companyId}"]`);

    let typeBadge = companyType;
    let conditionBadge = companyCondition;

    if (clickedItem) {
        const typeValue = parseInt(clickedItem.dataset.companyTypeValue || 0);
        const conditionValue = parseInt(clickedItem.dataset.companyConditionValue || 0);
        typeBadge = getTypeBadge(typeValue, companyType);
        conditionBadge = getConditionBadge(conditionValue, companyCondition);
    }

    pageTitle.innerHTML = `ì—…ì²´ ìƒíƒœ - ${companyLink.html} ${typeBadge} ${conditionBadge}`;

    // ê²€ìƒ‰ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
    const searchInput = document.getElementById('company-search');
    searchInput.value = `${companyName} (${companyType} | ${companyCondition})`;
    searchInput.readOnly = true;
    searchInput.placeholder = "ì—´ë¦°ì—…ì²´ë¥¼ í´ë¦­í•˜ì—¬ ë³€ê²½í•˜ì„¸ìš”";

    document.getElementById('company-select').value = companyId;
    document.getElementById('selected-company-name').innerHTML = `
        <strong>${companyName}</strong><br>
        <small>${companyType} | ${companyCondition}</small>
    `;
    document.getElementById('selected-company').style.display = 'block';
    hideCompanyDropdown();

    // ì—…ì²´ ìƒì„¸ ì •ë³´ ë¡œë“œ
    loadCompanyDetail(companyId);
}

// ì—…ì²´ ì„ íƒ í•´ì œ
document.getElementById('clear-company').addEventListener('click', function() {
    selectedCompanyId = null;

    // í˜ì´ì§€ íƒ€ì´í‹€ ì´ˆê¸°í™”
    const pageTitle = document.getElementById('page-title');
    pageTitle.textContent = 'ì—…ì²´ ìƒíƒœ';

    // ê²€ìƒ‰ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    const searchInput = document.getElementById('company-search');
    searchInput.value = '';
    searchInput.readOnly = true;
    searchInput.placeholder = "ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”...";

    // ì„¹ì…˜ íƒ€ì´í‹€ ì´ˆê¸°í™”
    document.getElementById('grade-section-title').textContent = 'ë“±ê¸‰ ì •ë³´';
    document.getElementById('assign-section-title').textContent = 'í• ë‹¹ìˆ˜ ì •ë³´';

    document.getElementById('company-select').value = '';
    document.getElementById('selected-company').style.display = 'none';
    document.getElementById('company-info').style.display = 'none';
});

// ì—…ì²´ ìƒì„¸ ì •ë³´ ë¡œë“œ
async function loadCompanyDetail(companyId) {
    try {
        const response = await fetch(`/companycondition/detail/${companyId}/`);
        const data = await response.json();

        if (data.error) {
            showToast(data.error, 'error');
            return;
        }

        // ì„¹ì…˜ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸ (ê¶Œí•œì— ë”°ë¥¸ ì—…ì²´ëª… ë§í¬ ìƒì„±)
        const sectionCompanyLink = getCompanyLink(companyId, data.name);
        document.getElementById('grade-section-title').innerHTML = `${sectionCompanyLink.html} ë“±ê¸‰ ì •ë³´`;
        document.getElementById('assign-section-title').innerHTML = `${sectionCompanyLink.html} í• ë‹¹ìˆ˜ ì •ë³´`;

        // ì •ë³´ í‘œì‹œ
        document.getElementById('info-level').textContent = data.level + ' ë ˆë²¨';
        document.getElementById('info-grade').textContent = data.grade + ' ë“±ê¸‰';
        document.getElementById('info-apply-grade').textContent = data.apply_grade + ' ë“±ê¸‰';
        document.getElementById('info-apply-grade-reason').textContent = data.apply_grade_reason || '-';
        document.getElementById('info-assign-all-2').textContent = data.assign_all_2 + ' ê°œ';
        document.getElementById('info-assign-part-2').textContent = data.assign_part_2 + ' ê°œ';
        document.getElementById('info-assign-all-term').textContent = data.assign_all_term + ' ê°œ';
        document.getElementById('info-assign-part-term').textContent = data.assign_part_term + ' ê°œ';
        document.getElementById('info-assign-max').textContent = data.assign_max + ' ê°œ';
        document.getElementById('info-assign-percent').textContent = data.assign_percent + ' %';
        document.getElementById('info-assign-lack').textContent = data.assign_lack + ' ê°œ';

        document.getElementById('company-info').style.display = 'block';

    } catch (error) {
        console.error('ì—…ì²´ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
        showToast('ì—…ì²´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ì ìš©ë“±ê¸‰ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™” (0~100ë“±ê¸‰)
function initializeGradeDropdown() {
    const select = document.getElementById('modal-apply-grade');
    select.innerHTML = ''; // ê¸°ì¡´ ì˜µì…˜ ì œê±°

    for (let i = 0; i <= 100; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i + 'ë“±ê¸‰';
        select.appendChild(option);
    }
}

// ì ìš©ë“±ê¸‰ ë³€ê²½ ëª¨ë‹¬
const changeGradeBtn = document.getElementById('change-grade-btn');
if (changeGradeBtn) {
    changeGradeBtn.addEventListener('click', function() {
        // ê¶Œí•œ ì²´í¬
        if (currentStaffAuthority < 2) {
            showToast('ì ìš©ë“±ê¸‰ ë³€ê²½ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        if (!selectedCompanyId) return;

        // ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
        initializeGradeDropdown();

        // í˜„ì¬ ë“±ê¸‰ê³¼ ì ìš©ë“±ê¸‰ ê°’ì„ ëª¨ë‹¬ì— ì„¤ì •
        const currentGrade = document.getElementById('info-grade').textContent.replace(' ë“±ê¸‰', '');
        const currentApplyGrade = document.getElementById('info-apply-grade').textContent.replace(' ë“±ê¸‰', '');
        const currentReason = document.getElementById('info-apply-grade-reason').textContent;

        document.getElementById('modal-current-grade').textContent = currentGrade + ' ë“±ê¸‰';
        document.getElementById('modal-apply-grade').value = currentApplyGrade;
        document.getElementById('modal-apply-grade-reason').value = currentReason === '-' ? '' : currentReason;

        document.getElementById('grade-modal').style.display = 'block';
    });
}

// ì ìš©ë“±ê¸‰ ì„ íƒ ì‹œ ìë™ ì‚¬ìœ  ì…ë ¥
document.getElementById('modal-apply-grade').addEventListener('change', function() {
    if (!selectedCompanyId) return;

    const newApplyGrade = this.value;
    const currentGrade = document.getElementById('info-grade').textContent.replace(' ë“±ê¸‰', '');
    const currentApplyGrade = document.getElementById('info-apply-grade').textContent.replace(' ë“±ê¸‰', '');

    // ë‚ ì§œ í˜•ì‹: YYMMDD (250921)
    const today = new Date();
    const year = String(today.getFullYear()).slice(-2); // 25
    const month = String(today.getMonth() + 1).padStart(2, '0'); // 09
    const day = String(today.getDate()).padStart(2, '0'); // 21
    const dateStr = year + month + day;

    // Staff.sNick ì •ë³´ ê°€ì ¸ì˜¤ê¸° (í˜„ì¬ ì„¸ì…˜ì—ì„œ)
    const staffNick = '{{ current_staff.sNick|default:request.session.staff_user.name }}';

    // ìë™ ì‚¬ìœ  ìƒì„±: (Staff.sNick) + ë‚ ì§œ + "nGrade=>nApplyGrade"
    const autoReason = `(${staffNick}) ${dateStr} ${currentGrade}=>${newApplyGrade}`;

    // ê¸°ì¡´ ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ë’·ìª½ì— ì¶”ê°€, ì—†ìœ¼ë©´ ìƒˆë¡œ ì„¤ì •
    const reasonTextarea = document.getElementById('modal-apply-grade-reason');
    const currentReasonValue = reasonTextarea.value.trim();

    if (currentReasonValue) {
        // ê¸°ì¡´ ë‚´ìš©ì´ ìˆìœ¼ë©´ ë’·ìª½ì— ì¶”ê°€
        reasonTextarea.value = currentReasonValue + ' ' + autoReason;
    } else {
        // ê¸°ì¡´ ë‚´ìš©ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ì„¤ì •
        reasonTextarea.value = autoReason;
    }
});

// ëª¨ë‹¬ ë‹«ê¸°
function closeGradeModal() {
    document.getElementById('grade-modal').style.display = 'none';
}

// ì ìš©ë“±ê¸‰ ì €ì¥
async function saveApplyGrade() {
    if (!selectedCompanyId) return;

    const applyGrade = document.getElementById('modal-apply-grade').value;
    const applyGradeReason = document.getElementById('modal-apply-grade-reason').value.trim();

    try {
        const response = await fetch(`/companycondition/update/${selectedCompanyId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                apply_grade: parseInt(applyGrade),
                apply_grade_reason: applyGradeReason
            })
        });

        const data = await response.json();

        if (data.success) {
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('info-apply-grade').textContent = data.apply_grade + ' ë“±ê¸‰';
            document.getElementById('info-apply-grade-reason').textContent = data.apply_grade_reason || '-';

            closeGradeModal();
            showToast(data.message, 'success');
        } else {
            showToast(data.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }

    } catch (error) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', error);
        showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
document.getElementById('grade-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeGradeModal();
    }
});

// í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
function showToast(message, type = 'success') {
    // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
    const existingToast = document.querySelector('.toast-notification');
    if (existingToast) {
        existingToast.remove();
    }

    // ìƒˆ í† ìŠ¤íŠ¸ ìƒì„±
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.textContent = message;

    document.body.appendChild(toast);

    // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ í‘œì‹œ
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);

    // 3ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// ì™¸ë¶€ í´ë¦­ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
document.addEventListener('click', function(e) {
    if (!e.target.closest('.company-search-container')) {
        hideCompanyDropdown();
    }
});
</script>

{% endif %}
{% endblock %}
# ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ: Stage 1 - React ë¹Œë“œ
FROM node:18-alpine AS frontend-builder

WORKDIR /frontend

# package.json íŒŒì¼ë“¤ ë³µì‚¬ ë° ì˜ì¡´ì„± ì„¤ì¹˜
COPY frontend/package*.json ./
RUN npm ci || npm install --legacy-peer-deps

# React ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ ë° í”„ë¡œë•ì…˜ ë¹Œë“œ
COPY frontend/ ./
RUN npm run build && echo "âœ… React ë¹Œë“œ ì™„ë£Œ"

# Stage 2 - Python/Django ì• í”Œë¦¬ì¼€ì´ì…˜
FROM python:3.12-slim

# í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    DJANGO_SETTINGS_MODULE=testpark_project.settings \
    NODE_ENV=production

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜ (í”„ë¡œë•ì…˜ì— í•„ìš”í•œ íŒ¨í‚¤ì§€ë§Œ)
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    python3-dev \
    libpq-dev \
    curl \
    nginx \
    supervisor \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# pip ì—…ê·¸ë ˆì´ë“œ ë° í”„ë¡œë•ì…˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN pip install --upgrade pip setuptools wheel

# Python ì˜ì¡´ì„± ì„¤ì¹˜
COPY requirements.txt /app/
RUN pip install --no-cache-dir -r requirements.txt && \
    pip install gunicorn whitenoise

# Django í”„ë¡œì íŠ¸ ì „ì²´ ë³µì‚¬
COPY . /app/

# React ë¹Œë“œ íŒŒì¼ ë³µì‚¬ (frontend/build -> static/react)
COPY --from=frontend-builder /frontend/build /app/static/react

# ì •ì  íŒŒì¼ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
RUN mkdir -p /app/static /app/media /app/staticfiles && \
    chmod -R 755 /app/static /app/media /app/staticfiles

# Django ì •ì  íŒŒì¼ ìˆ˜ì§‘
RUN python manage.py collectstatic --noinput --clear

# ëª¨ë“  Django ì•±ì˜ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±
RUN for app in accounts area company companycondition contract demo evaluation \
               fixfee globalvars gonggu impossibleterm join license member order \
               point product refund sales staff template; do \
        python manage.py makemigrations $app --noinput 2>/dev/null || true; \
    done

# ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ (ëŸ°íƒ€ì„ì— ì‹¤í–‰ë  ìˆ˜ë„ ìˆìŒ)
RUN python manage.py migrate --noinput || echo "ë§ˆì´ê·¸ë ˆì´ì…˜ì€ ëŸ°íƒ€ì„ì— ì‹¤í–‰ë©ë‹ˆë‹¤"

# í¬íŠ¸ ì„¤ì • (Nginxìš© 80, Djangoìš© 8000)
EXPOSE 80 8000

# í”„ë¡œë•ì…˜ ì„œë²„ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
RUN echo '#!/bin/bash\n\
echo "ğŸš€ TestPark í”„ë¡œë•ì…˜ ì„œë²„ ì‹œì‘..."\n\
python manage.py migrate --noinput\n\
python manage.py collectstatic --noinput\n\
echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ë° ì •ì  íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ"\n\
gunicorn testpark_project.wsgi:application \
  --bind 0.0.0.0:8000 \
  --workers 4 \
  --threads 2 \
  --worker-class sync \
  --worker-tmp-dir /dev/shm \
  --access-logfile - \
  --error-logfile - \
  --log-level info' > /app/start.sh && chmod +x /app/start.sh

# í”„ë¡œë•ì…˜ ì„œë²„ ì‹œì‘
CMD ["/app/start.sh"]
{% extends 'staff/base.html' %}

{% block title %}{{ title }} - PMIS 2.0{% endblock %}

{% block page_title %}{{ title }}{% endblock %}
{% block page_subtitle %}
    {% if not stop %}
        ÏÉàÎ°úÏö¥ ÏùºÏãúÏ†ïÏßÄ Í∏∞Í∞Ñ Îì±Î°ù
    {% endif %}
{% endblock %}

{% block content %}
{% if not not_logged_in %}
{{ block.super }}
{% endif %}

{% if not not_logged_in %}
<style>
    .form-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }

    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
    }

    .form-check {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 5px;
    }

    .form-check-input {
        width: auto;
        margin: 0;
    }

    .form-check-label {
        margin: 0;
        cursor: pointer;
        font-weight: normal;
    }

    .radio-group {
        display: flex;
        gap: 20px;
        margin-top: 8px;
    }

    .radio-option {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .radio-option input[type="radio"] {
        margin: 0;
        width: auto;
    }

    .radio-option label {
        margin: 0;
        cursor: pointer;
        font-weight: normal;
        font-size: 14px;
    }

    .help-text {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin-right: 10px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .form-actions {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
        text-align: center;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 4px;
    }

    .current-info {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 0 4px 4px 0;
    }

    .current-info h4 {
        margin: 0 0 10px 0;
        color: #007bff;
        font-size: 16px;
    }

    .current-info p {
        margin: 5px 0;
        font-size: 14px;
        color: #495057;
    }

    /* ÏûêÎèôÏôÑÏÑ± Ïä§ÌÉÄÏùº */
    .company-autocomplete {
        position: relative;
        display: inline-block;
        width: 100%;
    }

    .company-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }

    .company-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
    }

    .suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .suggestion-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

    .suggestion-item:hover,
    .suggestion-item.highlighted {
        background-color: #f8f9fa;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    @media (max-width: 768px) {
        .form-container {
            padding: 20px;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .form-actions {
            text-align: left;
        }

        .btn {
            width: 100%;
            margin-bottom: 10px;
            margin-right: 0;
        }
    }
</style>

<div class="form-container">
    {% if stop %}
    <!-- ÌòÑÏû¨ Ï†ïÎ≥¥ ÌëúÏãú (ÏàòÏ†ï Î™®Îìú) -->
    <div class="current-info">
        <h4>üìã ÌòÑÏû¨ ÏùºÏãúÏ†ïÏßÄ Í∏∞Í∞Ñ</h4>
        <p><strong>Î≤àÌò∏:</strong> #{{ stop.no }}</p>
        <p><strong>Ïó¥Î¶∞ÏóÖÏ≤¥:</strong> {{ stop.get_company_name }}</p>
        <p><strong>ÏùºÏãúÏ†ïÏßÄ Í∏∞Í∞Ñ:</strong> {{ stop.dateStart }} ~ {{ stop.dateEnd }}</p>
        <p><strong>ÏÉÅÌÉú:</strong> {{ stop.get_status_display }}</p>
        <p><strong>Îì±Î°ùÏùº:</strong> {{ stop.time|date:"Y-m-d H:i" }}</p>
    </div>
    {% endif %}

    <form method="post">
        {% csrf_token %}

        <!-- Ïó¥Î¶∞ÏóÖÏ≤¥ ÏÑ†ÌÉù -->
        <div class="form-group">
            <label class="form-label" for="company-input">
                {{ form.noCompany.label }}
                <span style="color: red;">*</span>
            </label>
            <div class="company-autocomplete">
                <input type="text"
                       id="company-input"
                       class="company-input form-control"
                       placeholder="ÏóÖÏ≤¥Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                       autocomplete="off"
                       {% if stop %}value="{{ stop.get_company_name }}"{% endif %}>
                <div class="suggestions" id="suggestions"></div>
                <input type="hidden" name="noCompany" id="noCompany" value="{% if stop %}{{ stop.noCompany }}{% endif %}">
            </div>
            {% if form.noCompany.errors %}
                <div class="error-message">{{ form.noCompany.errors.0 }}</div>
            {% endif %}
        </div>

        <!-- ÏùºÏãúÏ†ïÏßÄ Í∏∞Í∞Ñ -->
        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="{{ form.dateStart.id_for_label }}">
                    {{ form.dateStart.label }}
                    <span style="color: red;">*</span>
                </label>
                {{ form.dateStart }}
                {% if form.dateStart.help_text %}
                    <div class="help-text">{{ form.dateStart.help_text }}</div>
                {% endif %}
                {% if form.dateStart.errors %}
                    <div class="error-message">{{ form.dateStart.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-label" for="{{ form.dateEnd.id_for_label }}">
                    {{ form.dateEnd.label }}
                </label>
                {{ form.dateEnd }}
                {% if form.dateEnd.help_text %}
                    <div class="help-text">{{ form.dateEnd.help_text }}</div>
                {% endif %}
                {% if form.dateEnd.errors %}
                    <div class="error-message">{{ form.dateEnd.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <!-- Ïã§ÏãúÍ∞Ñ ÏÉÅÌÉú ÌëúÏãú -->
        <div class="form-group">
            <div id="status-display" style="margin-top: 10px; padding: 10px; border-radius: 4px; font-weight: bold; text-align: center; font-size: 14px; display: none;">
                <span id="status-text"></span>
            </div>
        </div>

        <!-- ÏùºÏãúÏ†ïÏßÄ ÏÇ¨Ïú† -->
        <div class="form-group">
            <label class="form-label" for="{{ form.sStop.id_for_label }}">
                {{ form.sStop.label }}
                <span style="color: red;">*</span>
            </label>
            {{ form.sStop }}
            {% if form.sStop.errors %}
                <div class="error-message">{{ form.sStop.errors.0 }}</div>
            {% endif %}
        </div>

        <!-- ÏÑ§Ï†ïÏûê Î∞è Í≥µÍ∞úÏó¨Î∂Ä -->
        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="{{ form.sWorker.id_for_label }}">
                    {{ form.sWorker.label }}
                </label>
                {{ form.sWorker }}
                {% if form.sWorker.help_text %}
                    <div class="help-text">{{ form.sWorker.help_text }}</div>
                {% endif %}
                {% if form.sWorker.errors %}
                    <div class="error-message">{{ form.sWorker.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-label">{{ form.bShow.label }}</label>
                <div class="radio-group">
                    {% for choice in form.bShow %}
                        <div class="radio-option">
                            {{ choice.tag }}
                            <label for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                        </div>
                    {% endfor %}
                </div>
                {% if form.bShow.help_text %}
                    <div class="help-text">{{ form.bShow.help_text }}</div>
                {% endif %}
                {% if form.bShow.errors %}
                    <div class="error-message">{{ form.bShow.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <!-- Ï†ÑÏ≤¥ Ìèº Ïò§Î•ò -->
        {% if form.non_field_errors %}
            <div class="form-group">
                <div class="error-message">{{ form.non_field_errors.0 }}</div>
            </div>
        {% endif %}

        <!-- Ïï°ÏÖò Î≤ÑÌäº -->
        <div class="form-actions">
            {% if stop %}
                <button type="submit" class="btn btn-primary">
                    üíæ ÏàòÏ†ï ÏôÑÎ£å
                </button>
                <a href="{% url 'stop:stop_list' %}" class="btn btn-secondary">
                    ‚Ü©Ô∏è Î™©Î°ùÏúºÎ°ú
                </a>
            {% else %}
                <button type="submit" class="btn btn-primary">
                    ‚ûï ÏùºÏãúÏ†ïÏßÄ Ï∂îÍ∞Ä
                </button>
                <a href="{% url 'stop:stop_list' %}" class="btn btn-secondary">
                    ‚Ü©Ô∏è Î™©Î°ùÏúºÎ°ú
                </a>
            {% endif %}
        </div>
    </form>
</div>

<!-- Ïª§Ïä§ÌÖÄ ÏïåÎ¶º Î™®Îã¨ -->
<div id="alertModal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h5 id="alertModalTitle" class="modal-title">ÏïåÎ¶º</h5>
        </div>
        <div class="modal-body">
            <p id="alertModalMessage"></p>
        </div>
        <div class="modal-footer">
            <button type="button" id="alertModalOk" class="btn btn-primary">ÌôïÏù∏</button>
        </div>
    </div>
</div>

<style>
/* Ïª§Ïä§ÌÖÄ Î™®Îã¨ Ïä§ÌÉÄÏùº */
.custom-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    max-width: 400px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 20px 20px 0 20px;
    border-bottom: 1px solid #dee2e6;
}

.modal-title {
    margin: 0 0 15px 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
}

.modal-body {
    padding: 20px;
}

.modal-body p {
    margin: 0;
    color: #666;
    line-height: 1.5;
}

.modal-footer {
    padding: 0 20px 20px 20px;
    text-align: right;
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
}

.modal-footer .btn {
    margin-left: 10px;
}
</style>

<script>
// Ïª§Ïä§ÌÖÄ ÏïåÎ¶º Ìï®Ïàò
function showAlert(title, message) {
    const modal = document.getElementById('alertModal');
    const modalTitle = document.getElementById('alertModalTitle');
    const modalMessage = document.getElementById('alertModalMessage');
    const modalOk = document.getElementById('alertModalOk');

    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modal.style.display = 'flex';

    // ÌôïÏù∏ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Î™®Îã¨ Îã´Í∏∞
    modalOk.onclick = function() {
        modal.style.display = 'none';
    };

    // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
    modal.onclick = function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };
}

// ÏóÖÏ≤¥ Îç∞Ïù¥ÌÑ∞ (ÏÑúÎ≤ÑÏóêÏÑú Ï†ÑÎã¨)
const companies = [
    {% for choice in company_choices %}
        {% if choice.0 %}
            {id: '{{ choice.0 }}', name: '{{ choice.1|escapejs }}'},
        {% endif %}
    {% endfor %}
];

// ÏûêÎèôÏôÑÏÑ± Í∏∞Îä•
document.addEventListener('DOMContentLoaded', function() {
    const companyInput = document.getElementById('company-input');
    const suggestionsDiv = document.getElementById('suggestions');
    const hiddenInput = document.getElementById('noCompany');
    let currentHighlight = -1;

    // ÏûÖÎ†• Ïãú ÏûêÎèôÏôÑÏÑ± Ïã§Ìñâ
    companyInput.addEventListener('input', function() {
        const value = this.value.trim();
        const valueLower = value.toLowerCase();
        suggestionsDiv.innerHTML = '';
        currentHighlight = -1;

        if (value.length === 0) {
            suggestionsDiv.style.display = 'none';
            hiddenInput.value = '';
            return;
        }

        // Ï†ïÌôïÌûà ÏùºÏπòÌïòÎäî ÏóÖÏ≤¥Î™Ö ÌôïÏù∏
        const exactMatch = companies.find(company =>
            company.name.toLowerCase() === valueLower
        );

        if (exactMatch) {
            // Ï†ïÌôïÌûà ÏùºÏπòÌïòÎäî ÏóÖÏ≤¥Í∞Ä ÏûàÏúºÎ©¥ ÏûêÎèôÏúºÎ°ú ÏÑ†ÌÉù
            selectCompany(exactMatch.id, exactMatch.name);
            return;
        }

        // ÏûÖÎ†•Í∞íÍ≥º ÏùºÏπòÌïòÎäî ÏóÖÏ≤¥ Ï∞æÍ∏∞
        const filteredCompanies = companies.filter(company =>
            company.name.toLowerCase().includes(valueLower)
        );

        if (filteredCompanies.length > 0) {
            filteredCompanies.forEach((company, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = company.name;
                item.dataset.id = company.id;
                item.dataset.index = index;

                item.addEventListener('click', function() {
                    selectCompany(company.id, company.name);
                });

                suggestionsDiv.appendChild(item);
            });

            suggestionsDiv.style.display = 'block';

            // Ï≤´ Î≤àÏß∏ Ìï≠Î™©ÏùÑ ÏûêÎèôÏúºÎ°ú ÌïòÏù¥ÎùºÏù¥Ìä∏
            if (filteredCompanies.length > 0) {
                highlightSuggestion(0);
            }
        } else {
            suggestionsDiv.style.display = 'none';
            hiddenInput.value = ''; // ÏùºÏπòÌïòÎäî ÏóÖÏ≤¥Í∞Ä ÏóÜÏúºÎ©¥ Í∞í Ï¥àÍ∏∞Ìôî
        }
    });

    // ÌÇ§Î≥¥Îìú ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
    companyInput.addEventListener('keydown', function(e) {
        const suggestions = suggestionsDiv.querySelectorAll('.suggestion-item');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentHighlight = Math.min(currentHighlight + 1, suggestions.length - 1);
            highlightSuggestion(currentHighlight);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentHighlight = Math.max(currentHighlight - 1, 0);
            highlightSuggestion(currentHighlight);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (currentHighlight >= 0 && suggestions[currentHighlight]) {
                const item = suggestions[currentHighlight];
                selectCompany(item.dataset.id, item.textContent);
            }
        } else if (e.key === 'Escape') {
            suggestionsDiv.style.display = 'none';
            currentHighlight = -1;
        }
    });

    // ÏûÖÎ†• ÌïÑÎìúÏóêÏÑú Î≤óÏñ¥ÎÇ† Îïå ÏûêÎèô Îß§Ïπ≠ ÌôïÏù∏
    companyInput.addEventListener('blur', function() {
        // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ÏùÑ ÎëêÏñ¥ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Í∞Ä Î®ºÏ†Ä Ï≤òÎ¶¨ÎêòÎèÑÎ°ù Ìï®
        setTimeout(() => {
            const value = this.value.trim();
            const valueLower = value.toLowerCase();

            if (value.length > 0 && !hiddenInput.value) {
                // Ï†ïÌôïÌûà ÏùºÏπòÌïòÎäî ÏóÖÏ≤¥Î™Ö ÌôïÏù∏
                const exactMatch = companies.find(company =>
                    company.name.toLowerCase() === valueLower
                );

                if (exactMatch) {
                    selectCompany(exactMatch.id, exactMatch.name);
                } else {
                    // Î∂ÄÎ∂Ñ ÏùºÏπòÌïòÎäî Ï≤´ Î≤àÏß∏ ÏóÖÏ≤¥ ÏûêÎèô ÏÑ†ÌÉù (ÏÑ†ÌÉùÏÇ¨Ìï≠)
                    const partialMatch = companies.find(company =>
                        company.name.toLowerCase().includes(valueLower)
                    );

                    if (partialMatch) {
                        selectCompany(partialMatch.id, partialMatch.name);
                    }
                }
            }
            suggestionsDiv.style.display = 'none';
        }, 200);
    });

    // Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú ÏûêÎèôÏôÑÏÑ± Ïà®Í∏∞Í∏∞
    document.addEventListener('click', function(e) {
        if (!companyInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            suggestionsDiv.style.display = 'none';
        }
    });

    function highlightSuggestion(index) {
        const suggestions = suggestionsDiv.querySelectorAll('.suggestion-item');
        suggestions.forEach((item, i) => {
            if (i === index) {
                item.classList.add('highlighted');
            } else {
                item.classList.remove('highlighted');
            }
        });
    }

    function selectCompany(id, name) {
        companyInput.value = name;
        hiddenInput.value = id;
        suggestionsDiv.style.display = 'none';
        currentHighlight = -1;
    }
});

// Ïò§Îäò ÎÇ†ÏßúÎ•º Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï (Ï∂îÍ∞Ä Î™®ÎìúÏóêÏÑúÎßå)
{% if not stop %}
document.addEventListener('DOMContentLoaded', function() {
    // ÌïúÍµ≠ ÏãúÍ∞Ñ Í∏∞Ï§ÄÏúºÎ°ú Ïò§Îäò ÎÇ†Ïßú Í≥ÑÏÇ∞
    const koreaTime = new Date(new Date().getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const startDate = document.getElementById('{{ form.dateStart.id_for_label }}');
    const endDate = document.getElementById('{{ form.dateEnd.id_for_label }}');

    if (!startDate.value) {
        startDate.value = today;
    }

    // ÏãúÏûëÏùº Î≥ÄÍ≤Ω Ïãú Ï¢ÖÎ£åÏùº ÏûêÎèô Ï°∞Ï†ï
    startDate.addEventListener('change', function() {
        if (startDate.value && endDate.value && endDate.value < startDate.value) {
            endDate.value = startDate.value;
            updateStatus(); // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        }
    });

    // Ï¢ÖÎ£åÏùº Î≥ÄÍ≤Ω Ïãú ÏãúÏûëÏùº ÏûêÎèô Ï°∞Ï†ï
    endDate.addEventListener('change', function() {
        if (endDate.value && startDate.value && startDate.value > endDate.value) {
            startDate.value = endDate.value;
            updateStatus(); // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        }
    });
});
{% endif %}

// Ìèº Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
document.querySelector('form').addEventListener('submit', function(e) {
    const company = document.getElementById('noCompany').value;
    const startDate = document.getElementById('{{ form.dateStart.id_for_label }}').value;
    const endDate = document.getElementById('{{ form.dateEnd.id_for_label }}').value;
    const reason = document.getElementById('{{ form.sStop.id_for_label }}').value.trim();
    if (!company) {
        showAlert('ÏûÖÎ†• ÌôïÏù∏', 'Ïó¥Î¶∞ÏóÖÏ≤¥Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
        e.preventDefault();
        return false;
    }

    if (!startDate) {
        showAlert('ÏûÖÎ†• ÌôïÏù∏', 'ÏãúÏûëÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        e.preventDefault();
        return false;
    }

    if (endDate && startDate > endDate) {
        showAlert('ÏûÖÎ†• ÌôïÏù∏', 'ÏãúÏûëÏùºÏùÄ Ï¢ÖÎ£åÏùºÎ≥¥Îã§ Îπ®ÎùºÏïº Ìï©ÎãàÎã§.');
        e.preventDefault();
        return false;
    }

    if (!reason) {
        showAlert('ÏûÖÎ†• ÌôïÏù∏', 'ÏùºÏãúÏ†ïÏßÄ ÏÇ¨Ïú†Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        e.preventDefault();
        return false;
    }

    return true;
});

// Ïã§ÏãúÍ∞Ñ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
function updateStatus() {
    const startDateInput = document.getElementById('{{ form.dateStart.id_for_label }}');
    const endDateInput = document.getElementById('{{ form.dateEnd.id_for_label }}');
    const statusDisplay = document.getElementById('status-display');
    const statusText = document.getElementById('status-text');

    const startDate = startDateInput.value;
    const endDate = endDateInput.value;

    if (!startDate) {
        statusDisplay.style.display = 'none';
        return;
    }

    // ÌïúÍµ≠ ÏãúÍ∞Ñ Í∏∞Ï§ÄÏúºÎ°ú Ïò§Îäò ÎÇ†Ïßú Í≥ÑÏÇ∞
    const koreaTime = new Date(new Date().getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const start = new Date(startDate);
    const end = endDate ? new Date(endDate) : null;
    const todayDate = new Date(today);

    let status = '';
    let bgColor = '';
    let textColor = '#fff';

    if (start > todayDate) {
        // ÏãúÏûëÏùºÏù¥ Ïò§ÎäòÎ≥¥Îã§ ÎØ∏Îûò = ÏòàÏ†ï
        status = 'üïê ÏòàÏ†ï';
        bgColor = '#ffc107';
        textColor = '#212529';
    } else if (!end || end >= todayDate) {
        // ÏãúÏûëÏùºÏù¥ Ïò§Îäò Ïù¥ÌïòÏù¥Í≥†, Ï¢ÖÎ£åÏùºÏù¥ ÏóÜÍ±∞ÎÇò Ïò§Îäò Ïù¥ÏÉÅ = ÏùºÏãúÏ†ïÏßÄ Ï§ë
        status = '‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ Ï§ë';
        bgColor = '#dc3545';
        textColor = '#fff';
    } else {
        // Ï¢ÖÎ£åÏùºÏù¥ Ïò§ÎäòÎ≥¥Îã§ Í≥ºÍ±∞ = Ìï¥Ï†ú
        status = '‚úÖ Ìï¥Ï†ú';
        bgColor = '#28a745';
        textColor = '#fff';
    }

    statusText.textContent = status;
    statusDisplay.style.backgroundColor = bgColor;
    statusDisplay.style.color = textColor;
    statusDisplay.style.display = 'block';
}

// ÎÇ†Ïßú ÏûÖÎ†• Ïãú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Î∞è ÏûêÎèô Ï°∞Ï†ï (ÏàòÏ†ï Î™®Îìú)
document.addEventListener('DOMContentLoaded', function() {
    const startDateInput = document.getElementById('{{ form.dateStart.id_for_label }}');
    const endDateInput = document.getElementById('{{ form.dateEnd.id_for_label }}');

    // Ï¥àÍ∏∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    updateStatus();

    // ÎÇ†Ïßú Î≥ÄÍ≤Ω Ïãú Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
    startDateInput.addEventListener('change', updateStatus);
    endDateInput.addEventListener('change', updateStatus);
    startDateInput.addEventListener('input', updateStatus);
    endDateInput.addEventListener('input', updateStatus);

    {% if stop %}
    // ÏàòÏ†ï Î™®ÎìúÏóêÏÑúÎèÑ ÎÇ†Ïßú ÏûêÎèô Ï°∞Ï†ï
    startDateInput.addEventListener('change', function() {
        if (startDateInput.value && endDateInput.value && endDateInput.value < startDateInput.value) {
            endDateInput.value = startDateInput.value;
            updateStatus(); // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        }
    });

    endDateInput.addEventListener('change', function() {
        if (endDateInput.value && startDateInput.value && startDateInput.value > endDateInput.value) {
            startDateInput.value = endDateInput.value;
            updateStatus(); // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        }
    });
    {% endif %}
});
</script>

{% endif %}
{% endblock %}
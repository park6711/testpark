{% extends 'staff/base.html' %}

{% block title %}ê³µì‚¬ ê°€ëŠ¥ ì§€ì—­{% endblock %}

{% block page_title %}<span id="dynamic-title">{{ title }}</span>{% endblock %}
{% block page_subtitle %}<span id="dynamic-subtitle">ê³µì‚¬ ê°€ëŠ¥í•œ ì§€ì—­ì„ ì„¤ì •í•©ë‹ˆë‹¤.</span>{% endblock %}

{% block content %}
{% if not not_logged_in %}
{{ block.super }}
{% endif %}

{% csrf_token %}

{% if not not_logged_in %}
<style>
    .form-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }

    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
    }

    .construction-types {
        display: flex;
        gap: 30px;
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .construction-type {
        flex: 1;
    }

    /* construction-checkbox CSS ì œê±°ë¨ (ì²´í¬ë°•ìŠ¤ ê¸°ëŠ¥ ì œê±°) */

    .area-management {
        display: block;
        margin-top: 15px;
    }

    .area-section {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        background: white;
    }

    .area-section-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        font-size: 14px;
    }

    .area-input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .area-input-group select {
        flex: 1;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin: 2px;
        font-size: 12px;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #218838;
    }

    .area-list {
        margin-top: 10px;
    }

    .area-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        margin-bottom: 5px;
        font-size: 13px;
    }

    .area-item-name {
        flex: 1;
    }

    .area-item-delete {
        margin-left: 10px;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #666;
    }

    .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
    }

    .help-text {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
    }

    .company-item:hover {
        background-color: #f8f9fa !important;
    }

    .company-item.active {
        background-color: #f8f9fa !important;
    }

    .company-search-container {
        position: relative;
    }

    #company-search:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
    }

    .area-search:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
    }

    .area-item:hover {
        background-color: #f8f9fa !important;
    }

    .area-item.active {
        background-color: #f8f9fa !important;
    }

    .area-search-container {
        position: relative;
    }

    .dropdown-toggle-btn:hover {
        background-color: #f8f9fa !important;
    }

    .area-dropdown-btn:hover {
        background-color: #f0f0f0 !important;
    }

    .show-all {
        font-weight: 500 !important;
    }

    .show-all:hover {
        background-color: #e8f5e8 !important;
    }

    /* ì»¤ìŠ¤í…€ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .custom-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .custom-modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        border-radius: 8px;
        width: 400px;
        max-width: 90%;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .custom-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    .custom-modal-title {
        margin: 0;
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }

    .custom-modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #aaa;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .custom-modal-close:hover {
        color: #000;
    }

    .custom-modal-body {
        margin-bottom: 20px;
        line-height: 1.5;
        color: #555;
        white-space: pre-line;
    }

    .custom-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .custom-modal-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        min-width: 70px;
    }

    .custom-modal-btn-primary {
        background-color: #007bff;
        color: white;
    }

    .custom-modal-btn-primary:hover {
        background-color: #0056b3;
    }

    .custom-modal-btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .custom-modal-btn-secondary:hover {
        background-color: #545b62;
    }

    /* ìˆ˜ì§ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ìˆ˜ì • */
    .form-container {
        /* ê¸°ë³¸ ìŠ¤í¬ë¡¤ì´ ì‘ë™í•˜ë„ë¡ height ë° overflow ì œì•½ ì œê±° */
        scroll-behavior: smooth;
    }

    .form-container::-webkit-scrollbar {
        width: 8px;
    }

    .form-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .form-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .form-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .construction-type-container {
        scroll-margin-top: 20px;
    }

    .area-section {
        scroll-margin-top: 10px;
    }

    /* ìŠ¤í¬ë¡¤ ì¸ë””ì¼€ì´í„° */
    .scroll-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        cursor: pointer;
        display: none;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }

    .scroll-indicator:hover {
        background: #0056b3;
        transform: scale(1.1);
    }

    .scroll-indicator.show {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 768px) {
        .construction-types {
            flex-direction: column;
            gap: 15px;
        }

        .area-input-group {
            flex-direction: column;
        }

        /* ëª¨ë°”ì¼ì—ì„œ 3ê°€ì§€ ì§€ì—­ íƒ€ì…ì„ ì„¸ë¡œë¡œ ë°°ì¹˜ */
        .construction-type-container div[style*="grid-template-columns"] {
            display: block !important;
        }

        .construction-type-container .area-section {
            margin-bottom: 20px;
        }

        .form-container {
            /* ëª¨ë°”ì¼ì—ì„œë„ ììœ ë¡­ê²Œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ */
            padding-right: 5px;
        }

        .scroll-indicator {
            bottom: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
        }
    }
</style>

<div class="form-container">
    <!-- ì—…ì²´ ì„ íƒ -->
    <div class="form-group">
        <label class="form-label" for="company-search">
            ì—´ë¦°ì—…ì²´ <span style="color: red;">*</span>
        </label>
        <div class="company-search-container" style="position: relative;">
            <input type="text"
                   id="company-search"
                   class="form-control"
                   placeholder="ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”..."
                   autocomplete="off"
                   style="padding-right: 40px;">
            <div id="search-icon" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 16px;">ğŸ”</div>
            <div id="company-dropdown" class="company-dropdown" style="
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #ddd;
                border-top: none;
                border-radius: 0 0 4px 4px;
                max-height: 300px;
                overflow-y: auto;
                z-index: 1000;
                display: none;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            "></div>
        </div>
        <input type="hidden" id="company-select" value="">
        <div id="selected-company" style="
            margin-top: 8px;
            padding: 8px 12px;
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            display: none;
            font-size: 14px;
        ">
            <span id="selected-company-name"></span>
            <button type="button" id="clear-company" style="
                background: none;
                border: none;
                float: right;
                color: #666;
                cursor: pointer;
                font-size: 16px;
            ">âœ•</button>
        </div>
    </div>

    <!-- ê³µì‚¬ì¢…ë¥˜ë³„ ì§€ì—­ ì„¤ì • -->
    <div id="construction-types-container">
    {% for const_type_value, const_type_name in all_construction_types %}
    <div class="construction-type-container" style="margin-bottom: 30px; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; background: #fafafa;">
        <!-- ê³µì‚¬ì¢…ë¥˜ ì†Œì œëª© ë° ê³µì‚¬ ê°€ëŠ¥í•œ ë¶„ì•¼ ì²´í¬ë°•ìŠ¤ -->
        <div class="construction-title" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 18px; font-weight: bold; color: #333; padding: 10px 15px; background: #e9ecef; border-radius: 6px; border-left: 4px solid #007bff;">
            <span>{{ const_type_name }}</span>

            <!-- ê³µì‚¬ ê°€ëŠ¥í•œ ë¶„ì•¼ ì²´í¬ë°•ìŠ¤ (ì¼ë°˜ ì—…ì²´ë§Œ) -->
            <div class="construction-fields" id="fields-{{ const_type_value }}" style="display: none; gap: 15px;">
                {% if const_type_value == 0 %}
                    <!-- ì˜¬ìˆ˜ë¦¬ ê°€ëŠ¥í•œ ì§€ì—­ -->
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; font-weight: normal;">
                        <input type="checkbox" id="bAptAll-display" disabled style="transform: scale(0.9);">
                        ì•„íŒŒíŠ¸ ì˜¬ìˆ˜ë¦¬
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; font-weight: normal;">
                        <input type="checkbox" id="bHouseAll-display" disabled style="transform: scale(0.9);">
                        ì£¼íƒ ì˜¬ìˆ˜ë¦¬
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; font-weight: normal;">
                        <input type="checkbox" id="bCommerceAll-display" disabled style="transform: scale(0.9);">
                        ìƒê°€ ì˜¬ìˆ˜ë¦¬
                    </label>
                {% elif const_type_value == 1 %}
                    <!-- ë¶€ë¶„ìˆ˜ë¦¬ ê°€ëŠ¥í•œ ì§€ì—­ -->
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; font-weight: normal;">
                        <input type="checkbox" id="bAptPart-display" disabled style="transform: scale(0.9);">
                        ì•„íŒŒíŠ¸ ë¶€ë¶„ìˆ˜ë¦¬
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; font-weight: normal;">
                        <input type="checkbox" id="bHousePart-display" disabled style="transform: scale(0.9);">
                        ì£¼íƒ ë¶€ë¶„ìˆ˜ë¦¬
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; font-weight: normal;">
                        <input type="checkbox" id="bCommercePart-display" disabled style="transform: scale(0.9);">
                        ìƒê°€ ë¶€ë¶„ìˆ˜ë¦¬
                    </label>
                {% elif const_type_value == 2 %}
                    <!-- ì‹ ì¶•/ì¦ì¶• ê°€ëŠ¥í•œ ì§€ì—­ -->
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; font-weight: normal;">
                        <input type="checkbox" id="bBuild-display" disabled style="transform: scale(0.9);">
                        ì‹ ì¶•/ì¦ì¶•
                    </label>
                {% endif %}
            </div>
        </div>

        <!-- ì§€ì—­ ê´€ë¦¬ ì„¹ì…˜ (3ê°€ì§€ë¥¼ ê°€ë¡œë¡œ ë°°ì¹˜) -->
        <div class="area-management" id="management-{{ const_type_value }}" style="display: block;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 15px;">

                <!-- ì¶”ê°€ì§€ì—­ (ê´‘ì—­ì§€ì—­ + ì‹œêµ°êµ¬ì§€ì—­) -->
                <div class="area-section">
                    <div class="area-section-title" style="background: #28a745; color: white; padding: 8px 12px; border-radius: 4px; font-weight: bold; text-align: center; margin-bottom: 10px;">
                        ì¶”ê°€ì§€ì—­ <span id="additional-count-{{ const_type_value }}">(0)</span>
                    </div>
                    <div class="area-search-container" style="position: relative; margin-bottom: 8px;">
                        <input type="text"
                               id="additional-area-search-{{ const_type_value }}"
                               class="form-control area-search"
                               placeholder="ì§€ì—­ëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”..."
                               data-area-type="0"
                               data-const-type="{{ const_type_value }}"
                               autocomplete="off"
                               style="padding-right: 40px;">
                        <div class="search-icon" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 14px;">ğŸ”</div>
                        <div id="additional-area-dropdown-{{ const_type_value }}" class="area-dropdown" style="
                            position: absolute;
                            top: 100%;
                            left: 0;
                            right: 0;
                            background: white;
                            border: 1px solid #ddd;
                            border-top: none;
                            border-radius: 0 0 4px 4px;
                            max-height: 200px;
                            overflow-y: auto;
                            z-index: 1000;
                            display: none;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        "></div>
                        <input type="hidden" id="additional-area-{{ const_type_value }}" value="">
                    </div>
                    <button type="button" class="btn btn-success btn-sm" style="width: 100%; margin-bottom: 10px;" onclick="addArea({{ const_type_value }}, 0, 'additional-area-{{ const_type_value }}')">ì¶”ê°€</button>
                    <div class="area-list" id="additional-list-{{ const_type_value }}" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: white;"></div>
                </div>

                <!-- ì—…ì²´ì œì™¸ì§€ì—­ (ì‹œêµ°êµ¬ì§€ì—­ë§Œ) -->
                <div class="area-section">
                    <div class="area-section-title" style="background: #dc3545; color: white; padding: 8px 12px; border-radius: 4px; font-weight: bold; text-align: center; margin-bottom: 10px;">
                        ì—…ì²´ì œì™¸ì§€ì—­ <span id="company-exclude-count-{{ const_type_value }}">(0)</span>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px; text-align: center;">ì‹œêµ°êµ¬ì§€ì—­ë§Œ</div>
                    <div class="area-search-container" style="position: relative; margin-bottom: 8px;">
                        <input type="text"
                               id="company-exclude-area-search-{{ const_type_value }}"
                               class="form-control area-search"
                               placeholder="ì‹œêµ°êµ¬ ì§€ì—­ëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”..."
                               data-area-type="1"
                               data-const-type="{{ const_type_value }}"
                               autocomplete="off"
                               style="padding-right: 40px;">
                        <div class="search-icon" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 14px;">ğŸ”</div>
                        <div id="company-exclude-area-dropdown-{{ const_type_value }}" class="area-dropdown" style="
                            position: absolute;
                            top: 100%;
                            left: 0;
                            right: 0;
                            background: white;
                            border: 1px solid #ddd;
                            border-top: none;
                            border-radius: 0 0 4px 4px;
                            max-height: 200px;
                            overflow-y: auto;
                            z-index: 1000;
                            display: none;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        "></div>
                        <input type="hidden" id="company-exclude-area-{{ const_type_value }}" value="">
                    </div>
                    <button type="button" class="btn btn-success btn-sm" style="width: 100%; margin-bottom: 10px;" onclick="addArea({{ const_type_value }}, 1, 'company-exclude-area-{{ const_type_value }}')">ì¶”ê°€</button>
                    <div class="area-list" id="company-exclude-list-{{ const_type_value }}" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: white;"></div>
                </div>

                <!-- ìŠ¤í…ì œì™¸ì§€ì—­ (ì‹œêµ°êµ¬ì§€ì—­ë§Œ) -->
                <div class="area-section">
                    <div class="area-section-title" style="background: #ffc107; color: #333; padding: 8px 12px; border-radius: 4px; font-weight: bold; text-align: center; margin-bottom: 10px;">
                        ìŠ¤í…ì œì™¸ì§€ì—­ <span id="staff-exclude-count-{{ const_type_value }}">(0)</span>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px; text-align: center;">ì‹œêµ°êµ¬ì§€ì—­ë§Œ</div>
                    <div class="area-search-container" style="position: relative; margin-bottom: 8px;">
                        <input type="text"
                               id="staff-exclude-area-search-{{ const_type_value }}"
                               class="form-control area-search"
                               placeholder="ì‹œêµ°êµ¬ ì…ë ¥ ë˜ëŠ” í™”ì‚´í‘œ í´ë¦­..."
                               data-area-type="2"
                               data-const-type="{{ const_type_value }}"
                               autocomplete="off"
                               style="padding-right: 80px;">
                        <div class="dropdown-controls" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); display: flex; gap: 4px;">
                            <button type="button" class="area-dropdown-btn" data-area-type="2" data-const-type="{{ const_type_value }}" style="
                                background: none;
                                border: none;
                                padding: 4px 8px;
                                cursor: pointer;
                                color: #666;
                                font-size: 12px;
                                border-radius: 3px;
                            " title="ì§€ì—­ ëª©ë¡ ë³´ê¸°">â–¼</button>
                            <div class="search-icon" style="color: #666; font-size: 12px; padding: 4px;">ğŸ”</div>
                        </div>
                        <div id="staff-exclude-area-dropdown-{{ const_type_value }}" class="area-dropdown" style="
                            position: absolute;
                            top: 100%;
                            left: 0;
                            right: 0;
                            background: white;
                            border: 1px solid #ddd;
                            border-top: none;
                            border-radius: 0 0 4px 4px;
                            max-height: 200px;
                            overflow-y: auto;
                            z-index: 1000;
                            display: none;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        "></div>
                        <input type="hidden" id="staff-exclude-area-{{ const_type_value }}" value="">
                    </div>
                    <button type="button" class="btn btn-success btn-sm" style="width: 100%; margin-bottom: 10px;" onclick="addArea({{ const_type_value }}, 2, 'staff-exclude-area-{{ const_type_value }}')">ì¶”ê°€</button>
                    <div class="area-list" id="staff-exclude-list-{{ const_type_value }}" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: white;"></div>
                </div>
            </div>

            <!-- ê³„ì‚°ëœ ì§€ì—­ë“¤ í‘œì‹œ ì„¹ì…˜ (2ê°œë¥¼ ê°€ë¡œë¡œ ë°°ì¹˜) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; border-top: 2px solid #007bff; padding-top: 20px;">

                <!-- ì—…ì²´ìš”ì²­ì§€ì—­ (ê³„ì‚°ê²°ê³¼) -->
                <div class="area-section">
                    <div class="area-section-title" style="background: #17a2b8; color: white; padding: 8px 12px; border-radius: 4px; font-weight: bold; text-align: center; margin-bottom: 10px;">
                        ì—…ì²´ìš”ì²­ì§€ì—­ <span id="company-request-count-{{ const_type_value }}">(0)</span>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px; text-align: center;">ì¶”ê°€ì§€ì—­ - ì—…ì²´ì œì™¸ì§€ì—­</div>
                    <textarea id="company-request-list-{{ const_type_value }}"
                             style="width: 100%; min-height: 120px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa; font-size: 13px; line-height: 1.4; resize: vertical;"
                             readonly
                             placeholder="ê³„ì‚°ëœ ì§€ì—­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                </div>

                <!-- ì‹¤ì œí• ë‹¹ì§€ì—­ (ê³„ì‚°ê²°ê³¼) -->
                <div class="area-section">
                    <div class="area-section-title" style="background: #6f42c1; color: white; padding: 8px 12px; border-radius: 4px; font-weight: bold; text-align: center; margin-bottom: 10px;">
                        ì‹¤ì œí• ë‹¹ì§€ì—­ <span id="actual-assigned-count-{{ const_type_value }}">(0)</span>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px; text-align: center;">ì¶”ê°€ì§€ì—­ - ì—…ì²´ì œì™¸ì§€ì—­ - ìŠ¤í…ì œì™¸ì§€ì—­</div>
                    <textarea id="actual-assigned-list-{{ const_type_value }}"
                             style="width: 100%; min-height: 120px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa; font-size: 13px; line-height: 1.4; resize: vertical;"
                             readonly
                             placeholder="ê³„ì‚°ëœ ì§€ì—­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- btocì œíœ´ ì—…ì²´ ì „ìš© ë¶€ê°€ì„œë¹„ìŠ¤ ì§€ì—­ ê´€ë¦¬ ì„¹ì…˜ -->
    <div id="btoc-additional-services" class="construction-type-container" style="margin-bottom: 30px; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; background: #fafafa; display: none;">

        <!-- ì§€ì—­ ê´€ë¦¬ ì„¹ì…˜ (3ê°€ì§€ë¥¼ ê°€ë¡œë¡œ ë°°ì¹˜) -->
        <div class="area-management" id="management-3" style="display: block;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 15px;">

                <!-- ì¶”ê°€ì§€ì—­ (ê´‘ì—­ì§€ì—­ + ì‹œêµ°êµ¬ì§€ì—­) -->
                <div class="area-section">
                    <div class="area-section-title" style="background: #28a745; color: white; padding: 8px 12px; border-radius: 4px; font-weight: bold; text-align: center; margin-bottom: 10px;">
                        ì¶”ê°€ì§€ì—­ <span id="additional-count-3">(0)</span>
                    </div>
                    <div class="area-search-container" style="position: relative; margin-bottom: 8px;">
                        <input type="text"
                               id="additional-area-search-3"
                               class="form-control area-search"
                               placeholder="ì§€ì—­ëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”..."
                               data-area-type="0"
                               data-const-type="3"
                               autocomplete="off"
                               style="padding-right: 40px;">
                        <div class="search-icon" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 14px;">ğŸ”</div>
                        <div id="additional-area-dropdown-3" class="area-dropdown" style="
                            position: absolute;
                            top: 100%;
                            left: 0;
                            right: 0;
                            background: white;
                            border: 1px solid #ddd;
                            border-top: none;
                            border-radius: 0 0 4px 4px;
                            max-height: 200px;
                            overflow-y: auto;
                            z-index: 1000;
                            display: none;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        "></div>
                        <input type="hidden" id="additional-area-3" value="">
                    </div>
                    <button type="button" class="btn btn-success btn-sm" style="width: 100%; margin-bottom: 10px;" onclick="addArea(3, 0, 'additional-area-3')">ì¶”ê°€</button>
                    <div class="area-list" id="additional-list-3" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: white;"></div>
                </div>

                <!-- ì—…ì²´ì œì™¸ì§€ì—­ (ì‹œêµ°êµ¬ì§€ì—­ë§Œ) -->
                <div class="area-section">
                    <div class="area-section-title" style="background: #dc3545; color: white; padding: 8px 12px; border-radius: 4px; font-weight: bold; text-align: center; margin-bottom: 10px;">
                        ì—…ì²´ì œì™¸ì§€ì—­ <span id="company-exclude-count-3">(0)</span>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px; text-align: center;">ì‹œêµ°êµ¬ì§€ì—­ë§Œ</div>
                    <div class="area-search-container" style="position: relative; margin-bottom: 8px;">
                        <input type="text"
                               id="company-exclude-area-search-3"
                               class="form-control area-search"
                               placeholder="ì§€ì—­ëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”..."
                               data-area-type="1"
                               data-const-type="3"
                               autocomplete="off"
                               style="padding-right: 40px;">
                        <div class="search-icon" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 14px;">ğŸ”</div>
                        <div id="company-exclude-area-dropdown-3" class="area-dropdown" style="
                            position: absolute;
                            top: 100%;
                            left: 0;
                            right: 0;
                            background: white;
                            border: 1px solid #ddd;
                            border-top: none;
                            border-radius: 0 0 4px 4px;
                            max-height: 200px;
                            overflow-y: auto;
                            z-index: 1000;
                            display: none;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        "></div>
                        <input type="hidden" id="company-exclude-area-3" value="">
                    </div>
                    <button type="button" class="btn btn-success btn-sm" style="width: 100%; margin-bottom: 10px;" onclick="addArea(3, 1, 'company-exclude-area-3')">ì¶”ê°€</button>
                    <div class="area-list" id="company-exclude-list-3" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: white;"></div>
                </div>

                <!-- ìŠ¤í…ì œì™¸ì§€ì—­ (ì‹œêµ°êµ¬ì§€ì—­ë§Œ) -->
                <div class="area-section">
                    <div class="area-section-title" style="background: #fd7e14; color: white; padding: 8px 12px; border-radius: 4px; font-weight: bold; text-align: center; margin-bottom: 10px;">
                        ìŠ¤í…ì œì™¸ì§€ì—­ <span id="staff-exclude-count-3">(0)</span>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px; text-align: center;">ì‹œêµ°êµ¬ì§€ì—­ë§Œ</div>
                    <div class="area-search-container" style="position: relative; margin-bottom: 8px;">
                        <input type="text"
                               id="staff-exclude-area-search-3"
                               class="form-control area-search"
                               placeholder="ì§€ì—­ëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”..."
                               data-area-type="2"
                               data-const-type="3"
                               autocomplete="off"
                               style="padding-right: 40px;">
                        <div class="search-icon" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 14px;">ğŸ”</div>
                        <div id="staff-exclude-area-dropdown-3" class="area-dropdown" style="
                            position: absolute;
                            top: 100%;
                            left: 0;
                            right: 0;
                            background: white;
                            border: 1px solid #ddd;
                            border-top: none;
                            border-radius: 0 0 4px 4px;
                            max-height: 200px;
                            overflow-y: auto;
                            z-index: 1000;
                            display: none;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        "></div>
                        <input type="hidden" id="staff-exclude-area-3" value="">
                    </div>
                    <button type="button" class="btn btn-success btn-sm" style="width: 100%; margin-bottom: 10px;" onclick="addArea(3, 2, 'staff-exclude-area-3')">ì¶”ê°€</button>
                    <div class="area-list" id="staff-exclude-list-3" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: white;"></div>
                </div>
            </div>

            <!-- ê³„ì‚°ëœ ì§€ì—­ë“¤ í‘œì‹œ ì„¹ì…˜ (2ê°œë¥¼ ê°€ë¡œë¡œ ë°°ì¹˜) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; border-top: 2px solid #007bff; padding-top: 20px;">

                <!-- ì—…ì²´ìš”ì²­ì§€ì—­ (ê³„ì‚°ê²°ê³¼) -->
                <div class="area-section">
                    <div class="area-section-title" style="background: #17a2b8; color: white; padding: 8px 12px; border-radius: 4px; font-weight: bold; text-align: center; margin-bottom: 10px;">
                        ì—…ì²´ìš”ì²­ì§€ì—­ <span id="company-request-count-3">(0)</span>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px; text-align: center;">ì¶”ê°€ì§€ì—­ - ì—…ì²´ì œì™¸ì§€ì—­</div>
                    <textarea id="company-request-list-3"
                             style="width: 100%; min-height: 120px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa; font-size: 13px; line-height: 1.4; resize: vertical;"
                             readonly
                             placeholder="ê³„ì‚°ëœ ì§€ì—­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                </div>

                <!-- ì‹¤ì œí• ë‹¹ì§€ì—­ (ê³„ì‚°ê²°ê³¼) -->
                <div class="area-section">
                    <div class="area-section-title" style="background: #6f42c1; color: white; padding: 8px 12px; border-radius: 4px; font-weight: bold; text-align: center; margin-bottom: 10px;">
                        ì‹¤ì œí• ë‹¹ì§€ì—­ <span id="actual-assigned-count-3">(0)</span>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px; text-align: center;">ì¶”ê°€ì§€ì—­ - ì—…ì²´ì œì™¸ì§€ì—­ - ìŠ¤í…ì œì™¸ì§€ì—­</div>
                    <textarea id="actual-assigned-list-3"
                             style="width: 100%; min-height: 120px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa; font-size: 13px; line-height: 1.4; resize: vertical;"
                             readonly
                             placeholder="ê³„ì‚°ëœ ì§€ì—­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

{% endif %}

<!-- ìŠ¤í¬ë¡¤ ì¸ë””ì¼€ì´í„° ë²„íŠ¼ -->
<button id="scroll-indicator" class="scroll-indicator" title="ìœ„ë¡œ ìŠ¤í¬ë¡¤">
    â†‘
</button>

<script>
let currentCompanyId = null;
let currentCompanyName = null;
let currentCompanyType = null;
let allCompanies = [];
let filteredCompanies = [];
let allAreas = [];
let cityAreas = [];

// ì—…ì²´ ë°ì´í„° ì´ˆê¸°í™” (deferë¡œ ì „ì²´ ë¡œë“œ ëŒ€ê¸°)
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeAll);
} else {
    initializeAll();
}

function initializeAll() {
    console.log('PMIS 2.0 ì´ˆê¸°í™” ì‹œì‘');
    try {
        initializeCompanySearch();
        initializeAreaData();
        initializeAreaSearch();
        initializeScrollManagement();

        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ìë™ ê²€ìƒ‰
        const searchQuery = '{{ search_query|default:"" }}';
        if (searchQuery) {
            setTimeout(() => {
                autoSearchCompany(searchQuery);
            }, 100);
        }

        console.log('ì´ˆê¸°í™” ì™„ë£Œ');
    } catch (error) {
        console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
    }
}

function initializeAreaData() {
    // ì „ì²´ ì§€ì—­ ë°ì´í„° (3ë‹¨ê³„ ê³„ì¸µ êµ¬ì¡°)
    const rawCityAreas = [];
    {% for area in city_areas %}
    rawCityAreas.push({
        id: {{ area.no }},
        name: '{{ area.get_full_name }}',
        city: '{{ area.sCity }}',
        searchText: '{{ area.get_full_name }} {{ area.sState }} {{ area.sCity }}'.toLowerCase()
    });
    {% endfor %}

    // ì§€ì—­ íƒ€ì… ë¶„ë¥˜ ë° ì•„ì´ì½˜ ì„¤ì •
    const processedCityAreas = rawCityAreas.map(area => {
        const hasParentheses = area.city.includes('(') && area.city.includes(')');
        const areaId = area.id;
        const lastDigit = areaId % 10;
        const secondLastDigit = Math.floor((areaId % 100) / 10);

        if (hasParentheses) {
            // êµ¬ (ì˜ˆ: ë•ì–‘êµ¬, ë¶„ë‹¹êµ¬)
            return {
                ...area,
                type: 'district',
                level: 3,
                icon: 'ğŸ¢',
                description: 'êµ¬'
            };
        } else if (lastDigit === 0 && secondLastDigit >= 1 && secondLastDigit <= 9) {
            // í†µí•©ì‹œ ìƒìœ„ (ì˜ˆ: ê³ ì–‘ì‹œ, ì„±ë‚¨ì‹œ)
            return {
                ...area,
                type: 'integrated_city',
                level: 2,
                icon: 'ğŸ¢',
                description: 'í†µí•©ì‹œ'
            };
        } else {
            // ì¼ë°˜ ì‹œêµ°êµ¬
            return {
                ...area,
                type: 'city',
                level: 2,
                icon: 'ğŸ¢',
                description: 'ì‹œêµ°êµ¬'
            };
        }
    });

    allAreas = [
        {id: 0, name: 'ì „êµ­', type: 'nationwide', level: 0, searchText: 'ì „êµ­', icon: 'ğŸŒ', description: 'ëª¨ë“  ì§€ì—­ í¬í•¨'},
        {% for area in all_areas %}
            {% if area.sCity == "" and area.no != 0 %}
            {id: {{ area.no }}, name: '{{ area.sState }}', type: 'metro', level: 1, searchText: '{{ area.sState }}'.toLowerCase(), icon: 'ğŸ›ï¸'},
            {% endif %}
        {% endfor %}
        ...processedCityAreas
    ];

    // ì‹œêµ°êµ¬ì§€ì—­ë§Œ (í†µí•©ì‹œ ìƒìœ„ + í•˜ìœ„êµ¬ + ì¼ë°˜ ì‹œêµ°êµ¬)
    cityAreas = allAreas.filter(area => area.type === 'city' || area.type === 'integrated_city' || area.type === 'district');
}

function initializeAreaSearch() {
    const areaSearchInputs = document.querySelectorAll('.area-search');

    areaSearchInputs.forEach(input => {
        const areaType = input.dataset.areaType;
        const constType = input.dataset.constType;
        const dropdownId = getAreaDropdownId(areaType, constType);
        const dropdown = document.getElementById(dropdownId);

        if (!dropdown) return;

        // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸
        input.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            if (query.length > 0) {
                filterAndShowAreas(query, areaType, constType);
            } else {
                hideAreaDropdown(dropdownId);
            }
        });

        // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ - ëª¨ë“  ì§€ì—­ í‘œì‹œ
        input.addEventListener('focus', function() {
            const query = this.value.toLowerCase().trim();
            if (query.length > 0) {
                filterAndShowAreas(query, areaType, constType);
            } else {
                // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ëª¨ë“  ì§€ì—­ í‘œì‹œ
                showAllAreas(areaType, constType);
            }
        });

        // í´ë¦­ ì´ë²¤íŠ¸ - ëª¨ë“  ì§€ì—­ í‘œì‹œ
        input.addEventListener('click', function() {
            const query = this.value.toLowerCase().trim();
            if (query.length > 0) {
                filterAndShowAreas(query, areaType, constType);
            } else {
                // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ëª¨ë“  ì§€ì—­ í‘œì‹œ
                showAllAreas(areaType, constType);
            }
        });

        // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
        input.addEventListener('keydown', function(e) {
            const items = dropdown.querySelectorAll('.area-item');
            const active = dropdown.querySelector('.area-item.active');
            let activeIndex = -1;

            if (active) {
                activeIndex = Array.from(items).indexOf(active);
            }

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                const nextIndex = Math.min(activeIndex + 1, items.length - 1);
                setActiveAreaItem(items, nextIndex);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                const prevIndex = Math.max(activeIndex - 1, 0);
                setActiveAreaItem(items, prevIndex);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (active) {
                    selectArea(active.dataset.areaId, active.dataset.areaName, areaType, constType);
                }
            } else if (e.key === 'Escape') {
                hideAreaDropdown(dropdownId);
            }
        });
    });

    // ì§€ì—­ ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.querySelectorAll('.area-dropdown-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const areaType = this.dataset.areaType;
            const constType = this.dataset.constType;
            const dropdownId = getAreaDropdownId(areaType, constType);
            const dropdown = document.getElementById(dropdownId);

            if (dropdown.style.display === 'block') {
                hideAreaDropdown(dropdownId);
            } else {
                showAllAreas(areaType, constType);
            }
        });

        // í˜¸ë²„ íš¨ê³¼
        btn.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f0f0f0';
        });
        btn.addEventListener('mouseleave', function() {
            this.style.backgroundColor = 'transparent';
        });
    });

    // ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.area-search-container')) {
            document.querySelectorAll('.area-dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }
    });
}

function getAreaDropdownId(areaType, constType) {
    const areaTypeMap = {
        '0': 'additional-area-dropdown',
        '1': 'company-exclude-area-dropdown',
        '2': 'staff-exclude-area-dropdown'
    };
    return `${areaTypeMap[areaType]}-${constType}`;
}

function filterAndShowAreas(query, areaType, constType) {
    const areas = areaType === '0' ? allAreas : cityAreas;
    const filteredAreas = areas.filter(area =>
        area.searchText.includes(query)
    );

    // ì •í™•í•œ ë§¤ì¹˜ë¥¼ ìœ„í•´ ì •ë ¬
    filteredAreas.sort((a, b) => {
        const aStartsWith = a.name.toLowerCase().startsWith(query);
        const bStartsWith = b.name.toLowerCase().startsWith(query);

        if (aStartsWith && !bStartsWith) return -1;
        if (!aStartsWith && bStartsWith) return 1;

        return a.name.localeCompare(b.name);
    });

    showAreaDropdown(filteredAreas, query, areaType, constType);
}

function showAllAreas(areaType, constType) {
    const areas = areaType === '0' ? allAreas : cityAreas;
    showAreaDropdown(areas, '', areaType, constType);
}

function showAreaDropdown(areas, query, areaType, constType) {
    const dropdownId = getAreaDropdownId(areaType, constType);
    const dropdown = document.getElementById(dropdownId);

    dropdown.innerHTML = '';
    dropdown.style.display = 'block';

    if (areas.length === 0) {
        const noResult = document.createElement('div');
        noResult.className = 'area-item no-result';
        noResult.style.cssText = 'padding: 12px; color: #666; font-style: italic;';
        noResult.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
        dropdown.appendChild(noResult);
        return;
    }

    // ì „ì²´ ë³´ê¸° ë§í¬ ì¶”ê°€ (ê²€ìƒ‰ëœ ê²°ê³¼ê°€ 15ê°œ ì´ìƒì´ê³  ì „ì²´ ëª©ë¡ì´ ì•„ë‹Œ ê²½ìš°)
    const originalAreas = areaType === '0' ? allAreas : cityAreas;
    const searchInputId = getAreaSearchInputId(areaType, constType);
    const searchValue = document.getElementById(searchInputId).value.trim();

    if (areas.length >= 15 && searchValue && areas.length < originalAreas.length) {
        const showAllItem = document.createElement('div');
        showAllItem.className = 'area-item show-all';
        showAllItem.style.cssText = 'padding: 8px 12px; cursor: pointer; border-bottom: 2px solid #28a745; background: #f8fff8; color: #28a745; font-weight: 500;';
        showAllItem.innerHTML = `ğŸ“‹ ì „ì²´ ${originalAreas.length}ê°œ ì§€ì—­ ë³´ê¸°`;
        showAllItem.addEventListener('click', function() {
            document.getElementById(searchInputId).value = '';
            showAllAreas(areaType, constType);
        });
        dropdown.appendChild(showAllItem);
    }

    areas.forEach((area, index) => {
        const item = document.createElement('div');
        item.className = 'area-item';
        item.dataset.areaId = area.id;
        item.dataset.areaName = area.name;
        item.style.cssText = `
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        `;

    item.innerHTML = `
            <div style="font-weight: 500; color: #333;">
                ${area.icon} ${highlightQuery(area.name, query)}
            </div>
        `;

        // í˜¸ë²„ íš¨ê³¼
        item.addEventListener('mouseenter', function() {
            setActiveAreaItem(dropdown.querySelectorAll('.area-item'), index);
        });

        item.addEventListener('click', function() {
            selectArea(area.id, area.name, areaType, constType);
        });

        dropdown.appendChild(item);
    });

    // ì²« ë²ˆì§¸ í•­ëª©ì„ ê¸°ë³¸ í™œì„±í™”
    if (areas.length > 0) {
        setActiveAreaItem(dropdown.querySelectorAll('.area-item'), 0);
    }
}

function hideAreaDropdown(dropdownId) {
    document.getElementById(dropdownId).style.display = 'none';
}

function setActiveAreaItem(items, index) {
    items.forEach(item => item.classList.remove('active'));
    if (items[index] && !items[index].classList.contains('no-result')) {
        items[index].classList.add('active');
        items[index].style.backgroundColor = '#f8f9fa';
    }

    // ë¹„í™œì„±í™”ëœ í•­ëª©ë“¤ì˜ ë°°ê²½ìƒ‰ ë¦¬ì…‹
    items.forEach((item, i) => {
        if (i !== index) {
            item.style.backgroundColor = 'white';
        }
    });
}

function selectArea(areaId, areaName, areaType, constType) {
    const searchInputId = getAreaSearchInputId(areaType, constType);
    const hiddenInputId = getAreaHiddenInputId(areaType, constType);
    const dropdownId = getAreaDropdownId(areaType, constType);

    // UI ì—…ë°ì´íŠ¸
    document.getElementById(searchInputId).value = areaName;
    document.getElementById(hiddenInputId).value = areaId;

    hideAreaDropdown(dropdownId);
}

function getAreaSearchInputId(areaType, constType) {
    const areaTypeMap = {
        '0': 'additional-area-search',
        '1': 'company-exclude-area-search',
        '2': 'staff-exclude-area-search'
    };
    return `${areaTypeMap[areaType]}-${constType}`;
}

function getAreaHiddenInputId(areaType, constType) {
    const areaTypeMap = {
        '0': 'additional-area',
        '1': 'company-exclude-area',
        '2': 'staff-exclude-area'
    };
    return `${areaTypeMap[areaType]}-${constType}`;
}

function initializeCompanySearch() {
    // ì—…ì²´ ë°ì´í„° ìˆ˜ì§‘
    allCompanies = [
        {% for company in companies %}
        {
            id: {{ company.no }},
            name: '{{ company.sName2|default:company.sName1 }}',
            type: '{{ company.get_nType_display }}',
            searchText: '{{ company.sName2|default:company.sName1 }} {{ company.get_nType_display }}'.toLowerCase(),
            // ê³µì‚¬ ê°€ëŠ¥í•œ ë¶„ì•¼ ì •ë³´
            bAptAll: {% if company.bAptAll %}true{% else %}false{% endif %},
            bHouseAll: {% if company.bHouseAll %}true{% else %}false{% endif %},
            bCommerceAll: {% if company.bCommerceAll %}true{% else %}false{% endif %},
            bAptPart: {% if company.bAptPart %}true{% else %}false{% endif %},
            bHousePart: {% if company.bHousePart %}true{% else %}false{% endif %},
            bCommercePart: {% if company.bCommercePart %}true{% else %}false{% endif %},
            bBuild: {% if company.bBuild %}true{% else %}false{% endif %}
        },
        {% endfor %}
    ];

    const searchInput = document.getElementById('company-search');
    const dropdown = document.getElementById('company-dropdown');
    const selectedDiv = document.getElementById('selected-company');
    const clearBtn = document.getElementById('clear-company');

    // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        if (query.length > 0) {
            filterAndShowCompanies(query);
        } else {
            hideDropdown();
        }
    });

    // í¬ì»¤ìŠ¤/í´ë¦­ ì´ë²¤íŠ¸ - ëª¨ë“  ì—…ì²´ í‘œì‹œ
    searchInput.addEventListener('focus', function() {
        const query = this.value.toLowerCase().trim();
        if (query.length > 0) {
            filterAndShowCompanies(query);
        } else {
            // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ëª¨ë“  ì—…ì²´ í‘œì‹œ
            showAllCompanies();
        }
    });

    // í´ë¦­ ì´ë²¤íŠ¸ - ëª¨ë“  ì—…ì²´ í‘œì‹œ
    searchInput.addEventListener('click', function() {
        const query = this.value.toLowerCase().trim();
        if (query.length > 0) {
            filterAndShowCompanies(query);
        } else {
            // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ëª¨ë“  ì—…ì²´ í‘œì‹œ
            showAllCompanies();
        }
    });

    // ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.company-search-container')) {
            hideDropdown();
        }
    });

    // ì„ íƒ í•´ì œ ë²„íŠ¼
    clearBtn.addEventListener('click', function() {
        clearCompanySelection();
    });

    // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
    searchInput.addEventListener('keydown', function(e) {
        const items = dropdown.querySelectorAll('.company-item');
        const active = dropdown.querySelector('.company-item.active');
        let activeIndex = -1;

        if (active) {
            activeIndex = Array.from(items).indexOf(active);
        }

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            const nextIndex = Math.min(activeIndex + 1, items.length - 1);
            setActiveItem(items, nextIndex);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            const prevIndex = Math.max(activeIndex - 1, 0);
            setActiveItem(items, prevIndex);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (active) {
                selectCompany(active.dataset.companyId, active.dataset.companyName, active.dataset.companyType);
            }
        } else if (e.key === 'Escape') {
            hideDropdown();
        }
    });
}

// ìë™ ì—…ì²´ ê²€ìƒ‰ (URL íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ëœ ê²€ìƒ‰ì–´ ì²˜ë¦¬)
function autoSearchCompany(searchQuery) {
    const searchInput = document.getElementById('company-search');
    if (searchInput && searchQuery) {
        // ê²€ìƒ‰ ì…ë ¥ í•„ë“œì— ê²€ìƒ‰ì–´ ì„¤ì •
        searchInput.value = searchQuery;

        // ê²€ìƒ‰ ì‹¤í–‰
        filterAndShowCompanies(searchQuery.toLowerCase());

        // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì—…ì²´ê°€ ìˆìœ¼ë©´ ìë™ ì„ íƒ
        const exactMatch = allCompanies.find(company =>
            company.name.toLowerCase() === searchQuery.toLowerCase()
        );

        if (exactMatch) {
            setTimeout(() => {
                selectCompany(exactMatch.id, exactMatch.name, exactMatch.type);
                hideDropdown();
            }, 200);
        }
    }
}

function filterAndShowCompanies(query) {
    filteredCompanies = allCompanies.filter(company =>
        company.searchText.includes(query)
    );

    // ì •í™•í•œ ë§¤ì¹˜ë¥¼ ìœ„í•´ ì •ë ¬
    filteredCompanies.sort((a, b) => {
        const aStartsWith = a.name.toLowerCase().startsWith(query);
        const bStartsWith = b.name.toLowerCase().startsWith(query);

        if (aStartsWith && !bStartsWith) return -1;
        if (!aStartsWith && bStartsWith) return 1;

        return a.name.localeCompare(b.name);
    });

    showDropdown();
}

function showAllCompanies() {
    filteredCompanies = [...allCompanies];
    showDropdown();
}

function showDropdown() {
    const dropdown = document.getElementById('company-dropdown');
    dropdown.innerHTML = '';
    dropdown.style.display = 'block';

    if (filteredCompanies.length === 0) {
        const noResult = document.createElement('div');
        noResult.className = 'company-item no-result';
        noResult.style.cssText = 'padding: 12px; color: #666; font-style: italic;';
        noResult.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
        dropdown.appendChild(noResult);
        return;
    }

    filteredCompanies.forEach((company, index) => {
        const item = document.createElement('div');
        item.className = 'company-item';
        item.dataset.companyId = company.id;
        item.dataset.companyName = company.name;
        item.dataset.companyType = company.type;
        item.style.cssText = `
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        `;

        item.innerHTML = `
            <div style="font-weight: 500; color: #333;">${highlightQuery(company.name, document.getElementById('company-search').value)}</div>
            <div style="font-size: 12px; color: #666; margin-top: 2px;">${company.type}</div>
        `;

        // í˜¸ë²„ íš¨ê³¼
        item.addEventListener('mouseenter', function() {
            setActiveItem(dropdown.querySelectorAll('.company-item'), index);
        });

        item.addEventListener('click', function() {
            selectCompany(company.id, company.name, company.type);
        });

        dropdown.appendChild(item);
    });

    // ì²« ë²ˆì§¸ í•­ëª©ì„ ê¸°ë³¸ í™œì„±í™”
    if (filteredCompanies.length > 0) {
        setActiveItem(dropdown.querySelectorAll('.company-item'), 0);
    }
}

function hideDropdown() {
    document.getElementById('company-dropdown').style.display = 'none';
}

function setActiveItem(items, index) {
    items.forEach(item => item.classList.remove('active'));
    if (items[index] && !items[index].classList.contains('no-result')) {
        items[index].classList.add('active');
        items[index].style.backgroundColor = '#f8f9fa';
    }

    // ë¹„í™œì„±í™”ëœ í•­ëª©ë“¤ì˜ ë°°ê²½ìƒ‰ ë¦¬ì…‹
    items.forEach((item, i) => {
        if (i !== index) {
            item.style.backgroundColor = 'white';
        }
    });
}

function highlightQuery(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<strong style="background: #fff3cd;">$1</strong>');
}

function selectCompany(companyId, companyName, companyType) {
    currentCompanyId = companyId;
    currentCompanyName = companyName;
    currentCompanyType = companyType;

    // UI ì—…ë°ì´íŠ¸
    document.getElementById('company-search').value = '';
    document.getElementById('company-select').value = companyId;
    document.getElementById('selected-company-name').innerHTML = `
        <strong>${companyName}</strong> <span style="color: #666;">(${companyType})</span>
    `;
    document.getElementById('selected-company').style.display = 'block';

    // íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
    updatePageTitle(companyName, companyType);

    // ì—…ì²´ íƒ€ì…ì— ë”°ë¼ ê³µì‚¬ì¢…ë¥˜ í•„í„°ë§
    filterConstructionTypesByCompanyType(companyType);

    // ì´ì „ ë°ì´í„° ë¨¼ì € ì§€ìš°ê¸°
    clearAllData();

    hideDropdown();

    // ê³µì‚¬ ê°€ëŠ¥í•œ ë¶„ì•¼ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
    updateConstructionFieldsDisplay(companyId, companyType);

    loadPossiData(companyId).then(() => {
        // íšŒì‚¬ ì„ íƒ í›„ ê³µì‚¬ì¢…ë¥˜ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        setTimeout(() => {
            scrollToSection('construction-types-container');
        }, 300);
    }).catch(error => {
        console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
    });
}

// ê³µì‚¬ ê°€ëŠ¥í•œ ë¶„ì•¼ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
function updateConstructionFieldsDisplay(companyId, companyType) {
    // ì¼ë°˜ ì—…ì²´(nType 0~3)ë§Œ í‘œì‹œ
    if (['ì¼ë°˜í† íƒˆ', 'ê³ ì •ë¹„í† íƒˆ', 'ìˆœìˆ˜ë‹¨ì¢…', 'ë¶€ë¶„ë‹¨ì¢…'].includes(companyType)) {
        // íšŒì‚¬ ì •ë³´ë¥¼ allCompaniesì—ì„œ ì°¾ê¸°
        const company = allCompanies.find(c => c.id == companyId);
        if (!company) {
            console.error('Company not found:', companyId);
            return;
        }

        // ì²´í¬ë°•ìŠ¤ í•„ë“œ í‘œì‹œ
        document.querySelectorAll('.construction-fields').forEach(field => {
            field.style.display = 'flex';
        });

        // ì˜¬ìˆ˜ë¦¬ ê´€ë ¨ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
        const bAptAllCheckbox = document.getElementById('bAptAll-display');
        const bHouseAllCheckbox = document.getElementById('bHouseAll-display');
        const bCommerceAllCheckbox = document.getElementById('bCommerceAll-display');

        if (bAptAllCheckbox) bAptAllCheckbox.checked = company.bAptAll || false;
        if (bHouseAllCheckbox) bHouseAllCheckbox.checked = company.bHouseAll || false;
        if (bCommerceAllCheckbox) bCommerceAllCheckbox.checked = company.bCommerceAll || false;

        // ë¶€ë¶„ìˆ˜ë¦¬ ê´€ë ¨ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
        const bAptPartCheckbox = document.getElementById('bAptPart-display');
        const bHousePartCheckbox = document.getElementById('bHousePart-display');
        const bCommercePartCheckbox = document.getElementById('bCommercePart-display');

        if (bAptPartCheckbox) bAptPartCheckbox.checked = company.bAptPart || false;
        if (bHousePartCheckbox) bHousePartCheckbox.checked = company.bHousePart || false;
        if (bCommercePartCheckbox) bCommercePartCheckbox.checked = company.bCommercePart || false;

        // ì‹ ì¶•/ì¦ì¶• ê´€ë ¨ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
        const bBuildCheckbox = document.getElementById('bBuild-display');
        if (bBuildCheckbox) bBuildCheckbox.checked = company.bBuild || false;

        // ì„¹ì…˜ show/hide ë¡œì§
        // ì˜¬ìˆ˜ë¦¬ ì„¹ì…˜
        const allRepairHasValue = company.bAptAll || company.bHouseAll || company.bCommerceAll;
        const allRepairSection = document.getElementById('management-0');
        if (allRepairSection) {
            allRepairSection.style.display = allRepairHasValue ? 'block' : 'none';
        }

        // ë¶€ë¶„ìˆ˜ë¦¬ ì„¹ì…˜
        const partRepairHasValue = company.bAptPart || company.bHousePart || company.bCommercePart;
        const partRepairSection = document.getElementById('management-1');
        if (partRepairSection) {
            partRepairSection.style.display = partRepairHasValue ? 'block' : 'none';
        }

        // ì‹ ì¶•/ì¦ì¶• ì„¹ì…˜
        const buildSection = document.getElementById('management-2');
        if (buildSection) {
            buildSection.style.display = company.bBuild ? 'block' : 'none';
        }
    } else {
        // btocì œíœ´ë‚˜ btobì œíœ´ ì—…ì²´ëŠ” ì²´í¬ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
        document.querySelectorAll('.construction-fields').forEach(field => {
            field.style.display = 'none';
        });
    }
}

// ì—…ì²´ íƒ€ì…ì— ë”°ë¼ ê³µì‚¬ì¢…ë¥˜ í•„í„°ë§
function filterConstructionTypesByCompanyType(companyType) {
    // ëª¨ë“  ê³µì‚¬ì¢…ë¥˜ ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸° (ë¶€ê°€ì„œë¹„ìŠ¤ ì œì™¸)
    const allContainers = document.querySelectorAll('.construction-type-container:not(#btoc-additional-services)');
    allContainers.forEach(container => {
        container.style.display = 'none';
    });

    // btocì œíœ´ ì „ìš© ë¶€ê°€ì„œë¹„ìŠ¤ ì„¹ì…˜ ê´€ë¦¬
    const btocSection = document.getElementById('btoc-additional-services');

    // ì—…ì²´ íƒ€ì…ë³„ í‘œì‹œí•  ê³µì‚¬ì¢…ë¥˜ ê²°ì •
    let allowedTypes = [];

    if (companyType === 'ì¼ë°˜í† íƒˆ' || companyType === 'ê³ ì •ë¹„í† íƒˆ' ||
        companyType === 'ìˆœìˆ˜ë‹¨ì¢…' || companyType === 'ë¶€ë¶„ë‹¨ì¢…') {
        // nType 0,1,2: ì˜¬ìˆ˜ë¦¬(0), ë¶€ë¶„ìˆ˜ë¦¬(1), ì‹ ì¶•/ì¦ì¶•(2)
        allowedTypes = [0, 1, 2];
        // btocì œíœ´ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        if (btocSection) {
            btocSection.style.display = 'none';
        }
    } else if (companyType === 'btocì œíœ´') {
        // btocì œíœ´ ì—…ì²´ëŠ” ì¼ë°˜ ê³µì‚¬ì¢…ë¥˜ ìˆ¨ê¸°ê³  ì „ìš© ë¶€ê°€ì„œë¹„ìŠ¤ ì„¹ì…˜ë§Œ í‘œì‹œ
        allowedTypes = [];
        if (btocSection) {
            btocSection.style.display = 'block';
        }
    }

    // í•´ë‹¹í•˜ëŠ” ê³µì‚¬ì¢…ë¥˜ë§Œ í‘œì‹œ (btocì œíœ´ê°€ ì•„ë‹Œ ê²½ìš°ë§Œ)
    allowedTypes.forEach(typeValue => {
        // ì²´í¬ë°•ìŠ¤ ëŒ€ì‹  management divë¡œ ì°¾ê¸°
        const managementDiv = document.getElementById(`management-${typeValue}`);
        if (managementDiv) {
            const container = managementDiv.closest('.construction-type-container');
            if (container) {
                container.style.display = 'block';
            }
        }
    });
}

function clearCompanySelection() {
    currentCompanyId = null;
    currentCompanyName = null;
    currentCompanyType = null;
    document.getElementById('company-search').value = '';
    document.getElementById('company-select').value = '';
    document.getElementById('selected-company').style.display = 'none';

    // íƒ€ì´í‹€ ë¦¬ì…‹
    updatePageTitle(null, null);

    // ê³µì‚¬ ê°€ëŠ¥í•œ ë¶„ì•¼ ì²´í¬ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.construction-fields').forEach(field => {
        field.style.display = 'none';
    });

    // ì—…ì²´ ì„ íƒ í•´ì œ ì‹œ ê¸°ë³¸ ê³µì‚¬ì¢…ë¥˜ë“¤ì„ ë‹¤ì‹œ í‘œì‹œ (btoc ì œì™¸)
    const normalContainers = document.querySelectorAll('.construction-type-container:not(#btoc-additional-services)');
    normalContainers.forEach(container => {
        container.style.display = 'block';
    });

    // ëª¨ë“  ê´€ë¦¬ ì„¹ì…˜ ë‹¤ì‹œ í‘œì‹œ
    document.querySelectorAll('.area-management').forEach(section => {
        section.style.display = 'block';
    });

    // btocì œíœ´ ì „ìš© ë¶€ê°€ì„œë¹„ìŠ¤ ì„¹ì…˜ì€ ìˆ¨ê¸°ê¸°
    const btocSection = document.getElementById('btoc-additional-services');
    if (btocSection) {
        btocSection.style.display = 'none';
    }

    // ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
    clearAllData();

    hideDropdown();
}

function updatePageTitle(companyName, companyType) {
    const titleElement = document.getElementById('dynamic-title');
    const subtitleElement = document.getElementById('dynamic-subtitle');

    if (companyName) {
        // í´ë¦­ ê°€ëŠ¥í•œ ì—…ì²´ëª… ë§í¬ ìƒì„±
        const companyLink = `<span class="company-link" onclick="goToCompanyView()" style="color: #007bff; cursor: pointer; text-decoration: underline;">${companyName}</span>`;

        // btocì œíœ´ ì—…ì²´ì¸ ê²½ìš° "ì„œë¹„ìŠ¤ ê°€ëŠ¥ ì§€ì—­"ìœ¼ë¡œ í‘œì‹œ
        if (companyType === 'btocì œíœ´') {
            titleElement.innerHTML = `ì„œë¹„ìŠ¤ ê°€ëŠ¥ ì§€ì—­(${companyLink})`;
            subtitleElement.textContent = 'ì„œë¹„ìŠ¤ ê°€ëŠ¥í•œ ì§€ì—­ì„ ì„¤ì •í•©ë‹ˆë‹¤.';
        } else {
            titleElement.innerHTML = `ê³µì‚¬ ê°€ëŠ¥ ì§€ì—­(${companyLink})`;
            subtitleElement.textContent = 'ê³µì‚¬ ê°€ëŠ¥í•œ ì§€ì—­ì„ ì„¤ì •í•©ë‹ˆë‹¤.';
        }
    } else {
        titleElement.textContent = 'ê³µì‚¬ ê°€ëŠ¥ ì§€ì—­';
        subtitleElement.textContent = 'ê³µì‚¬ ê°€ëŠ¥í•œ ì§€ì—­ì„ ì„¤ì •í•©ë‹ˆë‹¤.';
    }
}

// ì—…ì²´ëª… í´ë¦­ ì‹œ Company ìˆ˜ì •/ë³´ê¸° í™”ë©´ìœ¼ë¡œ ì´ë™
function goToCompanyView() {
    if (currentCompanyId) {
        // Company ìˆ˜ì • í™”ë©´ìœ¼ë¡œ ì´ë™ (company:company_update URL ì‚¬ìš©)
        window.location.href = `/company/update/${currentCompanyId}/`;
    } else {
        alert('ì„ íƒëœ ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
}

// ê³µì‚¬ì¢…ë¥˜ë³„ ì„¹ì…˜ì€ í•­ìƒ í‘œì‹œë¨ (ì²´í¬ë°•ìŠ¤ ì œê±°ë¨)

// ê³µì‚¬ ê°€ëŠ¥ ì§€ì—­ ë°ì´í„° ë¡œë“œ
function loadPossiData(companyId) {
    console.log(`DEBUG: Loading data for companyId=${companyId}`);
    return fetch(`/possiblearea/data/?company_id=${companyId}`)
        .then(response => {
            console.log('DEBUG: Fetch response:', response);
            return response.json();
        })
        .then(data => {
            console.log('DEBUG: Received data:', data);
            if (data.success) {
                console.log('DEBUG: About to call displayPossiData with:', data.data);
                displayPossiData(data.data);
                return data;
            } else {
                console.error('DEBUG: Data load failed:', data.error);
                alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + data.error);
                throw new Error(data.error);
            }
        })
        .catch(error => {
            console.error('DEBUG: Fetch error:', error);
            alert('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            throw error;
        });
}

// ë°ì´í„° í‘œì‹œ
function displayPossiData(data) {
    console.log('DEBUG: displayPossiData called with data:', data);
    console.log('DEBUG: Data keys:', Object.keys(data));

    // ë””ë²„ê¹…: ëª¨ë“  count ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    console.log('DEBUG: Checking all count elements:');
    for (let i = 0; i <= 3; i++) {
        console.log(`additional-count-${i}:`, document.getElementById(`additional-count-${i}`));
        console.log(`company-exclude-count-${i}:`, document.getElementById(`company-exclude-count-${i}`));
        console.log(`staff-exclude-count-${i}:`, document.getElementById(`staff-exclude-count-${i}`));
    }

    // ì²´í¬ë°•ìŠ¤ ì œê±°ë¨ - ëª¨ë“  ì„¹ì…˜ì€ í•­ìƒ í‘œì‹œë¨

    Object.keys(data).forEach(constType => {
        const constData = data[constType];
        console.log(`DEBUG: Processing constType=${constType}, data:`, constData);

        // btocì œíœ´ ì „ìš© ë¶€ê°€ì„œë¹„ìŠ¤(3)ì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
        if (constType === '3') {
            const btocContainer = document.getElementById('btoc-additional-services');
            if (!btocContainer) {
                console.log('DEBUG: btoc-additional-services container not found, skipping');
                return; // ì´ ê²½ìš°ì—ë§Œ ìŠ¤í‚µ
            }
            // btocì œíœ´ ì„¹ì…˜ì€ ì²´í¬ë°•ìŠ¤ê°€ ì—†ìœ¼ë¯€ë¡œ ë°”ë¡œ ë°ì´í„° í‘œì‹œ
            console.log('DEBUG: Processing btoc data, container display:', btocContainer.style.display);
        } else {
            // ì¼ë°˜ ê³µì‚¬ì¢…ë¥˜ ì„¹ì…˜ì€ í•­ìƒ í‘œì‹œë¨ (ì²´í¬ë°•ìŠ¤ ì œê±°ë¨)
            const managementDiv = document.getElementById(`management-${constType}`);
            if (!managementDiv) {
                console.log(`DEBUG: Skipping constType=${constType} - management section not found`);
                return; // ì´ ê²½ìš°ì—ë§Œ ìŠ¤í‚µ
            }
            console.log(`DEBUG: Found management section for constType=${constType}`);
        }

        // í•´ë‹¹ ê³µì‚¬ì¢…ë¥˜ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸ (ê³„ì‚°ëœ ì§€ì—­ í¬í•¨)
        const hasData = (constData.areas.additional?.length > 0) ||
                       (constData.areas.company_exclude?.length > 0) ||
                       (constData.areas.staff_exclude?.length > 0) ||
                       (constData.areas.company_request?.length > 0) ||
                       (constData.areas.actual_assigned?.length > 0);

        // ì²´í¬ë°•ìŠ¤ ì œê±°ë¨ - ëª¨ë“  ì„¹ì…˜ì€ í•­ìƒ í‘œì‹œë¨

        // ì¶”ê°€ì§€ì—­ í‘œì‹œ
        displayAreaList(constType, 'additional', constData.areas.additional || []);

        // ì—…ì²´ì œì™¸ì§€ì—­ í‘œì‹œ
        console.log(`DEBUG: company_exclude data for ${constType}:`, constData.areas.company_exclude);
        displayAreaList(constType, 'company_exclude', constData.areas.company_exclude || []);

        // ìŠ¤í…ì œì™¸ì§€ì—­ í‘œì‹œ
        console.log(`DEBUG: staff_exclude data for ${constType}:`, constData.areas.staff_exclude);
        displayAreaList(constType, 'staff_exclude', constData.areas.staff_exclude || []);

        // ì—…ì²´ìš”ì²­ì§€ì—­ í‘œì‹œ (ê³„ì‚°ê²°ê³¼)
        displayAreaList(constType, 'company_request', constData.areas.company_request || []);

        // ì‹¤ì œí• ë‹¹ì§€ì—­ í‘œì‹œ (ê³„ì‚°ê²°ê³¼)
        displayAreaList(constType, 'actual_assigned', constData.areas.actual_assigned || []);
    });
}

// ì§€ì—­ ëª©ë¡ í‘œì‹œ
function displayAreaList(constType, areaType, areas) {
    console.log(`DEBUG displayAreaList: constType=${constType}, areaType=${areaType}, areas.length=${areas?.length || 0}`);

    const listId = getListId(areaType, constType);
    const listElement = document.getElementById(listId);

    if (!listElement) {
        console.log(`DEBUG displayAreaList: listElement not found for listId=${listId}`);
        return;
    }

    // ê³„ì‚°ëœ ì§€ì—­ë“¤ì€ í…ìŠ¤íŠ¸ ì˜ì—­ì— í‘œì‹œ
    const isCalculatedArea = areaType === 'company_request' || areaType === 'actual_assigned';

    if (isCalculatedArea) {
        // ê³„ì‚°ëœ ì§€ì—­ì„ textareaì— í‘œì‹œ
        const areaNames = areas.map(area => area.display_name || area.area_name);
        listElement.value = areaNames.join('\n');

        // ê°œìˆ˜ ì—…ë°ì´íŠ¸
        const countElement = document.getElementById(areaType.replace(/_/g, '-') + '-count-' + constType);
        if (countElement) {
            countElement.textContent = `(${areas.length})`;
        }
    } else {
        // ê¸°ì¡´ ì…ë ¥ëœ ì§€ì—­ë“¤ì€ ê¸°ì¡´ ë°©ì‹ëŒ€ë¡œ í‘œì‹œ
        listElement.innerHTML = '';

        areas.forEach(area => {
            const areaItem = document.createElement('div');
            areaItem.className = 'area-item';
            areaItem.dataset.areaId = area.area_id;

            // ì…ë ¥ëœ ì§€ì—­: ì‚­ì œ ë²„íŠ¼ê³¼ í•¨ê»˜ í‘œì‹œ
            areaItem.innerHTML = `
                <span class="area-item-name">${area.display_name || area.area_name}</span>
                <button type="button" class="btn btn-danger area-item-delete" onclick="deleteArea(${area.id})">ì‚­ì œ</button>
            `;

            areaItem.dataset.areaId = area.area_id;
            listElement.appendChild(areaItem);
        });

        // ìˆ˜ë™ ì…ë ¥ ì§€ì—­ë“¤ì˜ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        let countDisplay;
        if (areaType === 'additional' || areaType === 'company_exclude' || areaType === 'staff_exclude') {
            // ì¶”ê°€ì§€ì—­, ì—…ì²´ì œì™¸ì§€ì—­, ìŠ¤í…ì œì™¸ì§€ì—­: ë‹¨ìˆœíˆ ë¦¬ìŠ¤íŠ¸ì˜ ì „ì²´ ê°œìˆ˜ë¥¼ í‘œì‹œ
            countDisplay = `(${areas.length})`;
        } else {
            // ê¸°íƒ€ ì§€ì—­ íƒ€ì…: ê¸°ì¡´ ë¡œì§ ìœ ì§€
            countDisplay = `(${countValidAreas(areas)})`;
        }
        const countElementId = areaType.replace(/_/g, '-') + '-count-' + constType;
        const countElement = document.getElementById(countElementId);

        // íŠ¹ë³„ ë””ë²„ê¹…: staff_exclude ë¬¸ì œ í•´ê²°
        if (areaType === 'staff_exclude') {
            console.log(`SPECIAL DEBUG staff_exclude: constType=${constType}, elementId=${countElementId}`);
            console.log(`SPECIAL DEBUG: Looking for element with ID: ${countElementId}`);
            console.log(`SPECIAL DEBUG: Element found:`, countElement);
            console.log(`SPECIAL DEBUG: Areas data:`, areas);
            console.log(`SPECIAL DEBUG: Count display:`, countDisplay);

            // ê°•ì œë¡œ ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ìš”ì†Œ ì°¾ê¸° ì‹œë„
            const alternativeElement = document.querySelector(`#${countElementId}`);
            console.log(`SPECIAL DEBUG: Alternative query result:`, alternativeElement);

            // company_excludeì™€ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ê°•ì œ ì²˜ë¦¬
            if (!countElement && !alternativeElement) {
                // btoc ì„¹ì…˜ì˜ ê²½ìš° DOM êµ¬ì¡°ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì§ì ‘ ì°¾ê¸°
                if (constType === '3') {
                    const btocContainer = document.getElementById('btoc-additional-services');
                    if (btocContainer) {
                        const staffExcludeSection = btocContainer.querySelector('.area-section:nth-child(3)');
                        if (staffExcludeSection) {
                            const titleSpan = staffExcludeSection.querySelector('.area-section-title span');
                            if (titleSpan) {
                                titleSpan.textContent = countDisplay;
                                console.log(`SPECIAL DEBUG: Force updated btoc staff-exclude count to ${countDisplay}`);
                                return;
                            }
                        }
                    }
                }
            }
        }

        console.log(`DEBUG: areaType=${areaType}, constType=${constType}, elementId=${countElementId}, element=`, countElement, `countDisplay=${countDisplay}`);
        if (countElement) {
            countElement.textContent = countDisplay;
            console.log(`DEBUG: Updated element with count ${countDisplay}`);
        } else {
            console.log(`DEBUG: Element not found: ${countElementId}`);
            // ê³µí†µ fallback: ì„¹ì…˜ë³„ë¡œ ì§ì ‘ ì°¾ê¸°
            let foundElement = null;

            // ë°©ë²• 1: btoc ì„¹ì…˜ì—ì„œ ì°¾ê¸° (constType === '3')
            if (constType === '3') {
                const btocContainer = document.getElementById('btoc-additional-services');
                if (btocContainer) {
                    // ì„¹ì…˜ ìˆœì„œ: ì¶”ê°€ì§€ì—­(1ë²ˆì§¸), ì—…ì²´ì œì™¸ì§€ì—­(2ë²ˆì§¸), ìŠ¤í…ì œì™¸ì§€ì—­(3ë²ˆì§¸)
                    let sectionIndex = 1;
                    if (areaType === 'company_exclude') sectionIndex = 2;
                    if (areaType === 'staff_exclude') sectionIndex = 3;

                    const targetSection = btocContainer.querySelector(`.area-section:nth-child(${sectionIndex})`);
                    if (targetSection) {
                        foundElement = targetSection.querySelector('.area-section-title span');
                        console.log(`DEBUG: Found btoc section ${sectionIndex} span:`, foundElement);
                    }
                }
            }

            // ë°©ë²• 2: ì¼ë°˜ ì„¹ì…˜ì—ì„œ ì°¾ê¸° (constType !== '3')
            if (!foundElement && constType !== '3') {
                const managementSection = document.getElementById(`management-${constType}`);
                if (managementSection) {
                    // ì„¹ì…˜ ìˆœì„œ: ì¶”ê°€ì§€ì—­(1ë²ˆì§¸), ì—…ì²´ì œì™¸ì§€ì—­(2ë²ˆì§¸), ìŠ¤í…ì œì™¸ì§€ì—­(3ë²ˆì§¸)
                    let sectionIndex = 1;
                    if (areaType === 'company_exclude') sectionIndex = 2;
                    if (areaType === 'staff_exclude') sectionIndex = 3;

                    const targetSection = managementSection.querySelector(`.area-section:nth-child(${sectionIndex})`);
                    if (targetSection) {
                        foundElement = targetSection.querySelector('.area-section-title span');
                        console.log(`DEBUG: Found regular section ${sectionIndex} span:`, foundElement);
                    }
                }
            }

            // ì°¾ì€ ìš”ì†Œì— ì—…ë°ì´íŠ¸
            if (foundElement) {
                foundElement.textContent = countDisplay;
                console.log(`DEBUG: Force updated area count to ${countDisplay} for ${areaType} in section ${constType}`);
            } else {
                console.log(`DEBUG: Could not find any fallback element for ${areaType} in section ${constType}`);
            }
        }
    }
}

// ê³„ì¸µ ì•„ì´ì½˜ ë°˜í™˜ (3ë‹¨ê³„ ê³„ì¸µ ì§€ì›)
function getHierarchyIcon(areaId) {
    if (areaId == 0) return 'ğŸŒ'; // ì „êµ­
    if (areaId >= 1000 && areaId < 10000 && areaId % 1000 == 0) return 'ğŸ›ï¸'; // ê´‘ì—­ì§€ì—­

    // í†µí•©ì‹œ í•˜ìœ„ êµ¬ í™•ì¸ (ì˜ˆ: 2021, 2121, 2131 ë“±)
    const lastDigit = areaId % 10;
    const secondLastDigit = Math.floor((areaId % 100) / 10);
    if (lastDigit >= 1 && lastDigit <= 9 && secondLastDigit >= 1 && secondLastDigit <= 9) {
        return 'ğŸ¢'; // êµ¬
    }

    // í†µí•©ì‹œ ìƒìœ„ í™•ì¸ (ì˜ˆ: 2020, 2120, 2130 ë“±)
    if (areaId % 10 == 0 && Math.floor((areaId % 100) / 10) >= 1) {
        return 'ğŸ¢'; // í†µí•©ì‹œ
    }

    return 'ğŸ¢'; // ì¼ë°˜ ì‹œêµ°êµ¬
}

// ì§€ì—­ ê³„ì¸µ í™•ì¸ (3ë‹¨ê³„ ê³„ì¸µ ì§€ì›)
function checkAreaHierarchy(areaId, existingAreas) {
    const warnings = [];
    const areaIdNum = parseInt(areaId);

    // ì „êµ­ ì„ íƒ ì‹œ ê²½ê³ 
    if (areaIdNum == 0) {
        warnings.push('âš ï¸ ì „êµ­ì„ ì„ íƒí•˜ë©´ ëª¨ë“  ì§€ì—­ì´ í¬í•¨ë©ë‹ˆë‹¤.');
        if (existingAreas.length > 0) {
            warnings.push(`âš ï¸ ê¸°ì¡´ ë“±ë¡ëœ ëª¨ë“  ì§€ì—­ì´ ì¤‘ë³µë©ë‹ˆë‹¤.`);
        }
        return warnings;
    }

    // ê´‘ì—­ì§€ì—­ ì„ íƒ ì‹œ í•˜ìœ„ ì‹œêµ°êµ¬/êµ¬ ì¤‘ë³µ ì²´í¬ (ì§ì ‘ ì°¨ë‹¨)
    if (areaIdNum >= 1000 && areaIdNum < 10000 && areaIdNum % 1000 == 0) {
        const cityStart = areaIdNum;
        const cityEnd = areaIdNum + 999;
        const conflictAreas = existingAreas.filter(area =>
            area.area_id > cityStart && area.area_id <= cityEnd
        );

        if (conflictAreas.length > 0) {
            // ì§ì ‘ alertë¡œ ì°¨ë‹¨í•˜ê³  í•¨ìˆ˜ ì¢…ë£Œ
            alert(`ê³„ì¸µ êµ¬ì¡° ì¶©ëŒ: ì„ íƒí•œ ê´‘ì—­ì§€ì—­ì´ ì´ë¯¸ ë“±ë¡ëœ í•˜ìœ„ ì§€ì—­ë“¤(${conflictAreas.map(a => a.area_name).join(', ')})ì„ í¬í•¨í•©ë‹ˆë‹¤.`);
            return null; // nullì„ ë°˜í™˜í•˜ì—¬ addAreaì—ì„œ ì¤‘ë‹¨í•˜ë„ë¡ í•¨
        }
    }

    // í†µí•©ì‹œ ì„ íƒ ì‹œ í•˜ìœ„ êµ¬ ì¤‘ë³µ ì²´í¬ (ì§ì ‘ ì°¨ë‹¨)
    const lastDigit = areaIdNum % 10;
    const secondLastDigit = Math.floor((areaIdNum % 100) / 10);
    if (lastDigit == 0 && secondLastDigit >= 1 && secondLastDigit <= 9) {
        // í†µí•©ì‹œ (ì˜ˆ: 2020, 2120, 2130)
        const districtStart = areaIdNum;
        const districtEnd = areaIdNum + 9;
        const conflictDistricts = existingAreas.filter(area =>
            area.area_id > districtStart && area.area_id <= districtEnd
        );

        if (conflictDistricts.length > 0) {
            // ì§ì ‘ alertë¡œ ì°¨ë‹¨í•˜ê³  í•¨ìˆ˜ ì¢…ë£Œ
            alert(`ê³„ì¸µ êµ¬ì¡° ì¶©ëŒ: ì„ íƒí•œ ì§€ì—­ì´ ì´ë¯¸ ë“±ë¡ëœ í•˜ìœ„ êµ¬ë“¤(${conflictDistricts.map(a => a.area_name).join(', ')})ì„ í¬í•¨í•©ë‹ˆë‹¤.`);
            return null; // nullì„ ë°˜í™˜í•˜ì—¬ addAreaì—ì„œ ì¤‘ë‹¨í•˜ë„ë¡ í•¨
        }
    }

    // í•˜ìœ„ êµ¬ ì„ íƒ ì‹œ ìƒìœ„ í†µí•©ì‹œ ì¤‘ë³µ ì²´í¬ (ì§ì ‘ ì°¨ë‹¨)
    if (lastDigit >= 1 && lastDigit <= 9 && secondLastDigit >= 1 && secondLastDigit <= 9) {
        // í•˜ìœ„ êµ¬ (ì˜ˆ: 2021, 2121, 2131)
        const parentCityId = Math.floor(areaIdNum / 10) * 10;
        const conflictParent = existingAreas.find(area => area.area_id === parentCityId);

        if (conflictParent) {
            // ì§ì ‘ alertë¡œ ì°¨ë‹¨í•˜ê³  í•¨ìˆ˜ ì¢…ë£Œ
            alert(`ê³„ì¸µ êµ¬ì¡° ì¶©ëŒ: ì„ íƒí•œ ì§€ì—­ì´ ì´ë¯¸ ë“±ë¡ëœ ${conflictParent.area_name}ì— í¬í•¨ë©ë‹ˆë‹¤.`);
            return null; // nullì„ ë°˜í™˜í•˜ì—¬ addAreaì—ì„œ ì¤‘ë‹¨í•˜ë„ë¡ í•¨
        }
    }

    // ì‹œêµ°êµ¬ì§€ì—­ ì„ íƒ ì‹œ ìƒìœ„ ê´‘ì—­ì§€ì—­ ì¤‘ë³µ ì²´í¬ (ì§ì ‘ ì°¨ë‹¨)
    if (areaIdNum >= 1000 && areaIdNum < 10000) {
        const metroAreaId = Math.floor(areaIdNum / 1000) * 1000;
        const conflictMetro = existingAreas.find(area => area.area_id === metroAreaId);

        if (conflictMetro) {
            // ì§ì ‘ alertë¡œ ì°¨ë‹¨í•˜ê³  í•¨ìˆ˜ ì¢…ë£Œ
            alert(`ê³„ì¸µ êµ¬ì¡° ì¶©ëŒ: ì„ íƒí•œ ì§€ì—­ì´ ì´ë¯¸ ë“±ë¡ëœ ${conflictMetro.area_name}ì— í¬í•¨ë©ë‹ˆë‹¤.`);
            return null; // nullì„ ë°˜í™˜í•˜ì—¬ addAreaì—ì„œ ì¤‘ë‹¨í•˜ë„ë¡ í•¨
        }
    }

    return warnings;
}

// í†µí•©ì‹œ ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜
function isIntegratedCity(areaId) {
    const areaIdNum = parseInt(areaId);
    const lastDigit = areaIdNum % 10;
    const secondLastDigit = Math.floor((areaIdNum % 100) / 10);

    // í†µí•©ì‹œ íŒ¨í„´: ëìë¦¬ê°€ 0ì´ê³  ëì—ì„œ ë‘ë²ˆì§¸ ìë¦¬ê°€ 1-9ì¸ ê²½ìš° (ì˜ˆ: 2020, 2120, 2130)
    return lastDigit === 0 && secondLastDigit >= 1 && secondLastDigit <= 9 && areaIdNum > 1000;
}

// ê´‘ì—­ì§€ì—­ ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜
function isMetroArea(areaId) {
    const areaIdNum = parseInt(areaId);
    // ê´‘ì—­ì§€ì—­ íŒ¨í„´: 1000ì˜ ë°°ìˆ˜ì´ê³  10000 ë¯¸ë§Œ (ì˜ˆ: 1000, 2000, 3000)
    return areaIdNum >= 1000 && areaIdNum < 10000 && areaIdNum % 1000 === 0;
}

// ìœ íš¨ ì§€ì—­ ê°œìˆ˜ ê³„ì‚° (ê´‘ì—­ì§€ì—­ê³¼ í†µí•©ì‹œ ì œì™¸)
function countValidAreas(areas) {
    if (!areas || !Array.isArray(areas)) return 0;

    return areas.filter(area => {
        const areaId = area.area_id;
        return !isMetroArea(areaId) && !isIntegratedCity(areaId);
    }).length;
}

// ì¶”ê°€ì§€ì—­ì„ ëª¨ë‘ í•˜ìœ„ ì§€ì—­ì´ ì—†ëŠ” ì‹œêµ°êµ¬ì§€ì—­ìœ¼ë¡œ ë¶„ê°œí•œ ê°œìˆ˜ ê³„ì‚°
function countExpandedAreas(areas) {
    if (!areas || !Array.isArray(areas)) return 0;

    let expandedCount = 0;

    areas.forEach(area => {
        const areaId = area.area_id;

        if (areaId === 0) {
            // ì „êµ­: ëª¨ë“  í•˜ìœ„ì§€ì—­ì´ ì—†ëŠ” ì‹œêµ°êµ¬ì§€ì—­ ê°œìˆ˜
            // ì‹¤ì œë¡œëŠ” ì „ì²´ cityAreasì—ì„œ í†µí•©ì‹œë¥¼ ì œì™¸í•œ ê°œìˆ˜
            expandedCount += cityAreas.filter(cityArea => !isIntegratedCity(cityArea.id)).length;
        } else if (isMetroArea(areaId)) {
            // ê´‘ì—­ì§€ì—­: í•´ë‹¹ ê´‘ì—­ì˜ í•˜ìœ„ ì‹œêµ°êµ¬ ì¤‘ í†µí•©ì‹œê°€ ì•„ë‹Œ ê²ƒë“¤ + í†µí•©ì‹œì˜ í•˜ìœ„ êµ¬ë“¤
            const metroStart = areaId;
            const metroEnd = areaId + 999;

            cityAreas.forEach(cityArea => {
                if (cityArea.id > metroStart && cityArea.id <= metroEnd) {
                    if (isIntegratedCity(cityArea.id)) {
                        // í†µí•©ì‹œì¸ ê²½ìš° í•˜ìœ„ êµ¬ë“¤ì˜ ê°œìˆ˜ë¥¼ ë”í•¨
                        const integrationStart = cityArea.id;
                        const integrationEnd = cityArea.id + 9;
                        const districtCount = cityAreas.filter(district =>
                            district.id > integrationStart &&
                            district.id <= integrationEnd &&
                            district.type === 'district'
                        ).length;
                        expandedCount += districtCount;
                    } else {
                        // ì¼ë°˜ ì‹œêµ°êµ¬ì¸ ê²½ìš° 1ê°œ
                        expandedCount += 1;
                    }
                }
            });
        } else if (isIntegratedCity(areaId)) {
            // í†µí•©ì‹œ: í•˜ìœ„ êµ¬ë“¤ì˜ ê°œìˆ˜
            const integrationStart = areaId;
            const integrationEnd = areaId + 9;
            const districtCount = cityAreas.filter(district =>
                district.id > integrationStart &&
                district.id <= integrationEnd &&
                district.type === 'district'
            ).length;
            expandedCount += districtCount;
        } else {
            // ì¼ë°˜ ì‹œêµ°êµ¬ë‚˜ êµ¬: 1ê°œ
            expandedCount += 1;
        }
    });

    return expandedCount;
}

// ì§€ì—­ ì¶”ê°€
async function addArea(constructionType, areaType, selectId) {
    // ìƒˆë¡œìš´ ë°©ì‹ìœ¼ë¡œ hidden inputì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
    const hiddenInputId = getAreaHiddenInputId(areaType.toString(), constructionType.toString());
    const areaId = document.getElementById(hiddenInputId).value;
    if (!currentCompanyId) {
        alert('ë¨¼ì € ì—…ì²´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    if (!areaId) {
        alert('ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    // ê²€ìƒ‰ ì…ë ¥ ì´ˆê¸°í™”
    const searchInputId = getAreaSearchInputId(areaType.toString(), constructionType.toString());
    document.getElementById(searchInputId).value = '';
    document.getElementById(hiddenInputId).value = '';

    // ì—…ì²´ì œì™¸ì§€ì—­(1)ê³¼ ìŠ¤í…ì œì™¸ì§€ì—­(2)ì—ì„œ í†µí•©ì‹œ ì„ íƒ ì‹œì—ëŠ” ê³„ì¸µ êµ¬ì¡° ê²€ì‚¬ ê±´ë„ˆë›°ê¸°
    const skipHierarchyCheck = (areaType === 1 || areaType === 2) && isIntegratedCity(areaId);

    if (!skipHierarchyCheck) {
        // ê³„ì¸µ êµ¬ì¡° ê²€ì‚¬
        const listId = getListId(getAreaTypeString(areaType), constructionType);
        const existingAreas = getCurrentAreaList(listId);
        const warnings = checkAreaHierarchy(areaId, existingAreas);

        // checkAreaHierarchyê°€ nullì„ ë°˜í™˜í•˜ë©´ ì´ë¯¸ ì°¨ë‹¨ë˜ì—ˆìœ¼ë¯€ë¡œ ì¤‘ë‹¨
        if (warnings === null) {
            return;
        }

        if (warnings.length > 0) {
            const proceed = await confirm(warnings.join('\n') + '\n\nê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
            if (!proceed) return;
        }
    }

    const data = {
        company_id: currentCompanyId,
        construction_type: constructionType,
        area_type: areaType,
        area_id: areaId
    };

    fetch('/possiblearea/data/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ì„±ê³µ ì‹œ ì…ë ¥ ì´ˆê¸°í™” ë° ë°ì´í„° ì¬ë¡œë“œ (ìë™ í™•ì¥ í¬í•¨í•˜ì—¬ ì¡°ìš©íˆ ì²˜ë¦¬)
            loadPossiData(currentCompanyId).then(() => {
                // ë°ì´í„° ë¡œë“œ ì™„ë£Œ í›„ í•´ë‹¹ ì§€ì—­ ë¦¬ìŠ¤íŠ¸ë¡œ ìŠ¤í¬ë¡¤
                setTimeout(() => {
                    scrollToAreaList(constructionType, getAreaTypeString(areaType));
                }, 300);
            });
        } else {
            alert('ì¶”ê°€ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ì§€ì—­ ì‚­ì œ
function deleteArea(possiId) {

    const data = {
        possi_id: possiId
    };

    fetch('/possiblearea/data/', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ì„±ê³µ ì‹œ ë°ì´í„° ì¬ë¡œë“œ
            loadPossiData(currentCompanyId);
        } else {
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ë¦¬ìŠ¤íŠ¸ ID ë°˜í™˜
function getListId(areaType, constType) {
    const areaTypeMap = {
        'additional': 'additional-list',
        'company_exclude': 'company-exclude-list',
        'staff_exclude': 'staff-exclude-list',
        'company_request': 'company-request-list',
        'actual_assigned': 'actual-assigned-list'
    };
    return `${areaTypeMap[areaType]}-${constType}`;
}

// ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
function clearAllData() {
    document.querySelectorAll('.area-list').forEach(list => {
        list.innerHTML = '';
    });

    // ì²´í¬ë°•ìŠ¤ ì œê±°ë¨ - ëª¨ë“  ì„¹ì…˜ì€ í•­ìƒ í‘œì‹œë¨
}

// í˜„ì¬ ì§€ì—­ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
function getCurrentAreaList(listId) {
    const areas = [];
    const listElement = document.getElementById(listId);
    if (listElement) {
        const items = listElement.querySelectorAll('.area-item');
        items.forEach(item => {
            const deleteBtn = item.querySelector('.area-item-delete');
            if (deleteBtn) {
                const onclick = deleteBtn.getAttribute('onclick');
                const possiId = onclick.match(/deleteArea\((\d+)\)/)?.[1];
                if (possiId) {
                    areas.push({
                        id: possiId,
                        area_name: item.querySelector('.area-item-name').textContent.trim(),
                        area_id: parseInt(item.dataset.areaId || '0')
                    });
                }
            }
        });
    }
    return areas;
}

// ì§€ì—­ íƒ€ì… ë¬¸ìì—´ ë°˜í™˜
function getAreaTypeString(areaType) {
    const typeMap = {
        0: 'additional',
        1: 'company_exclude',
        2: 'staff_exclude'
    };
    return typeMap[areaType] || 'additional';
}

// íŠ¹ì • ê³µì‚¬ì¢…ë¥˜ ë°ì´í„° ì´ˆê¸°í™”
// clearConstructionTypeData í•¨ìˆ˜ ì œê±°ë¨ (ì²´í¬ë°•ìŠ¤ ê¸°ëŠ¥ ì œê±°ë¡œ ì¸í•´ ë¶ˆí•„ìš”)

// ìŠ¤í¬ë¡¤ ê´€ë¦¬ ì´ˆê¸°í™”
function initializeScrollManagement() {
    const formContainer = document.querySelector('.form-container');
    const scrollIndicator = document.getElementById('scroll-indicator');

    if (!formContainer || !scrollIndicator) return;

    // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    formContainer.addEventListener('scroll', function() {
        // ìŠ¤í¬ë¡¤ì´ 100px ì´ìƒ ë‚´ë ¤ê°€ë©´ ìŠ¤í¬ë¡¤ ì¸ë””ì¼€ì´í„° í‘œì‹œ
        if (formContainer.scrollTop > 100) {
            scrollIndicator.classList.add('show');
        } else {
            scrollIndicator.classList.remove('show');
        }
    });

    // ìŠ¤í¬ë¡¤ ì¸ë””ì¼€ì´í„° í´ë¦­ ì´ë²¤íŠ¸
    scrollIndicator.addEventListener('click', function() {
        formContainer.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    console.log('ìŠ¤í¬ë¡¤ ê´€ë¦¬ ì´ˆê¸°í™” ì™„ë£Œ');
}

// íŠ¹ì • ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
function scrollToSection(sectionId) {
    const formContainer = document.querySelector('.form-container');
    const targetSection = document.getElementById(sectionId);

    if (formContainer && targetSection) {
        const containerRect = formContainer.getBoundingClientRect();
        const targetRect = targetSection.getBoundingClientRect();
        const scrollTop = formContainer.scrollTop;

        // ëŒ€ìƒ ì„¹ì…˜ì˜ ìœ„ì¹˜ ê³„ì‚°
        const targetPosition = scrollTop + targetRect.top - containerRect.top - 20;

        formContainer.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
        });
    }
}

// ê³µì‚¬ì¢…ë¥˜ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
function scrollToConstructionType(constructionType) {
    scrollToSection(`management-${constructionType}`);
}

// ì§€ì—­ ì¶”ê°€ í›„ í•´ë‹¹ ë¦¬ìŠ¤íŠ¸ë¡œ ìŠ¤í¬ë¡¤
function scrollToAreaList(constructionType, areaType) {
    const listId = getListId(areaType, constructionType);
    scrollToSection(listId);
}
</script>

<!-- ì»¤ìŠ¤í…€ ëª¨ë‹¬ HTML -->
<div id="custom-alert-modal" class="custom-modal">
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <h3 class="custom-modal-title">ì•Œë¦¼</h3>
            <button class="custom-modal-close" onclick="closeCustomAlert()">&times;</button>
        </div>
        <div class="custom-modal-body" id="custom-alert-message"></div>
        <div class="custom-modal-footer">
            <button class="custom-modal-btn custom-modal-btn-primary" onclick="closeCustomAlert()">í™•ì¸</button>
        </div>
    </div>
</div>

<div id="custom-confirm-modal" class="custom-modal">
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <h3 class="custom-modal-title">í™•ì¸</h3>
            <button class="custom-modal-close" onclick="closeCustomConfirm(false)">&times;</button>
        </div>
        <div class="custom-modal-body" id="custom-confirm-message"></div>
        <div class="custom-modal-footer">
            <button class="custom-modal-btn custom-modal-btn-secondary" onclick="closeCustomConfirm(false)">ì·¨ì†Œ</button>
            <button class="custom-modal-btn custom-modal-btn-primary" onclick="closeCustomConfirm(true)">í™•ì¸</button>
        </div>
    </div>
</div>

<script>
// ì»¤ìŠ¤í…€ ëª¨ë‹¬ í•¨ìˆ˜ë“¤
let customConfirmCallback = null;

function customAlert(message, title = 'ì•Œë¦¼') {
    document.getElementById('custom-alert-message').innerHTML = message;
    document.querySelector('#custom-alert-modal .custom-modal-title').textContent = title;
    document.getElementById('custom-alert-modal').style.display = 'block';
}

function closeCustomAlert() {
    document.getElementById('custom-alert-modal').style.display = 'none';
}

function customConfirm(message, title = 'í™•ì¸') {
    return new Promise((resolve) => {
        document.getElementById('custom-confirm-message').innerHTML = message;
        document.querySelector('#custom-confirm-modal .custom-modal-title').textContent = title;
        document.getElementById('custom-confirm-modal').style.display = 'block';
        customConfirmCallback = resolve;
    });
}

function closeCustomConfirm(result) {
    document.getElementById('custom-confirm-modal').style.display = 'none';
    if (customConfirmCallback) {
        customConfirmCallback(result);
        customConfirmCallback = null;
    }
}

// ê¸°ì¡´ alertì™€ confirm í•¨ìˆ˜ë¥¼ ì˜¤ë²„ë¼ì´ë“œ
window.originalAlert = window.alert;
window.originalConfirm = window.confirm;

window.alert = function(message) {
    customAlert(message);
};

window.confirm = function(message) {
    return customConfirm(message);
};

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('custom-modal')) {
        if (e.target.id === 'custom-alert-modal') {
            closeCustomAlert();
        } else if (e.target.id === 'custom-confirm-modal') {
            closeCustomConfirm(false);
        }
    }
});

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸° ë° ì „ì²´í™”ë©´ ì¢…ë£Œ ë©”ì‹œì§€ ë°©ì§€
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        e.preventDefault(); // ë¸Œë¼ìš°ì € ê¸°ë³¸ ë™ì‘ ë°©ì§€
        e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€

        // ì»¤ìŠ¤í…€ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
        if (document.getElementById('custom-alert-modal').style.display === 'block') {
            closeCustomAlert();
        } else if (document.getElementById('custom-confirm-modal').style.display === 'block') {
            closeCustomConfirm(false);
        }

        return false; // ì¶”ê°€ ë°©ì§€
    }
});

// ì „ì²´í™”ë©´ ê´€ë ¨ ì´ë²¤íŠ¸ ë°©ì§€
document.addEventListener('fullscreenchange', function(e) {
    e.preventDefault();
    e.stopPropagation();
});

document.addEventListener('webkitfullscreenchange', function(e) {
    e.preventDefault();
    e.stopPropagation();
});

document.addEventListener('mozfullscreenchange', function(e) {
    e.preventDefault();
    e.stopPropagation();
});

document.addEventListener('MSFullscreenChange', function(e) {
    e.preventDefault();
    e.stopPropagation();
});

// F11 í‚¤ ë°©ì§€
document.addEventListener('keydown', function(e) {
    if (e.key === 'F11') {
        e.preventDefault();
        e.stopPropagation();
        return false;
    }
});
</script>

<!-- ë“œë¡­ë‹¤ìš´ ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸ -->
<script src="/static/js/dropdown-fix.js"></script>

<!-- ê³„ì¸µì  ì§€ì—­ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="/static/js/area-hierarchy.js"></script>

{% endblock %}
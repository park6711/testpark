{% extends 'staff/base.html' %}

{% block title %}{{ title }} - PMIS 2.0{% endblock %}

{% block page_title %}{{ title }}{% endblock %}
{% block page_subtitle %}
    {% if action == 'view' %}
        íšŒì› ì •ë³´ ìƒì„¸ ì¡°íšŒ
    {% elif action == 'create' %}
        ìƒˆë¡œìš´ íšŒì› ë“±ë¡
    {% else %}
        íšŒì› ì •ë³´ ìˆ˜ì •
    {% endif %}
{% endblock %}

{% block content %}
{% if not not_logged_in %}
{{ block.super }}
{% endif %}

{% if not not_logged_in %}
<style>
    .form-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
        max-width: 800px;
        margin: 0 auto;
    }

    .form-group {
        margin-bottom: 20px;
    }

    label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }

    input[type="text"],
    input[type="email"],
    input[type="number"],
    select,
    textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 14px;
        font-family: inherit;
    }

    input[type="checkbox"] {
        margin-right: 10px;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
    }

    .readonly-field {
        background-color: #f8f9fa !important;
        cursor: not-allowed;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin-right: 10px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .button-group {
        margin-top: 30px;
        text-align: center;
    }

    .form-row {
        display: flex;
        gap: 20px;
    }

    .form-row .form-group {
        flex: 1;
    }

    small {
        color: #666;
        font-size: 12px;
    }
</style>

<div class="form-container">
    {% if read_only %}
    <div class="alert alert-info">
        <strong>ğŸ“– ì½ê¸° ì „ìš© ëª¨ë“œ</strong><br>
        ì´ ì •ë³´ëŠ” ì¡°íšŒë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.
    </div>
    <form>
    {% else %}
    <form method="post">
        {% csrf_token %}
    {% endif %}

        <div class="form-group">
            <label for="sNaverID0">ë„¤ì´ë²„ ì‹ë³„ì</label>
            <input type="text"
                   id="sNaverID0"
                   name="sNaverID0"
                   value="{{ member.sNaverID0|default:'' }}"
                   readonly
                   class="readonly-field">
            <small>ë„¤ì´ë²„ ë¡œê·¸ì¸ ì‹œ ìë™ìœ¼ë¡œ ì„¤ì •ë˜ë©° ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</small>
        </div>

        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox"
                       id="bApproval"
                       name="bApproval"
                       {% if member.bApproval %}checked{% endif %}
                       {% if read_only %}disabled{% endif %}>
                <label for="bApproval">ìŠ¹ì¸ ì—¬ë¶€</label>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="sNaverID">ë„¤ì´ë²„ ID *</label>
                <input type="text"
                       id="sNaverID"
                       name="sNaverID"
                       value="{{ member.sNaverID|default:'' }}"
                       {% if not read_only %}required{% endif %}
                       {% if read_only %}readonly class="readonly-field"{% endif %}>
            </div>

            <div class="form-group">
                <label for="sCompanyName">ì—…ì²´ëª… *</label>
                <input type="text"
                       id="sCompanyName"
                       name="sCompanyName"
                       value="{{ member.sCompanyName|default:initial_scompany_name }}"
                       {% if not read_only %}required{% endif %}
                       {% if read_only %}readonly class="readonly-field"{% endif %}>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="sName2">ì—´ë¦°ì—…ì²´ëª…</label>
                <input type="text"
                       id="sName2"
                       name="sName2"
                       value="{{ member.sName2|default:initial_sname2 }}"
                       {% if read_only %}readonly class="readonly-field"{% endif %}>
            </div>

            <div class="form-group">
                <label for="noCompany">ì†Œì† ì—´ë¦°ì—…ì²´</label>
                {% if read_only %}
                    <input type="text"
                           id="noCompany"
                           name="noCompany"
                           value="{% if member %}{{ member.get_company_name }}{% endif %}"
                           readonly class="readonly-field">
                {% else %}
                    <select id="noCompany" name="noCompany">
                        <option value="">-- ì—…ì²´ ì„ íƒ --</option>
                        {% for company in companies %}
                            <option value="{{ company.no }}"
                                    data-sname2="{{ company.sName2|default:'' }}"
                                    data-sname1="{{ company.sName1|default:'' }}"
                                    {% if member and member.noCompany == company.no %}selected{% elif initial_no_company == company.no|stringformat:"s" %}selected{% endif %}>
                                {{ company.sName2|default:company.sName1 }} ({{ company.no }})
                            </option>
                        {% endfor %}
                    </select>
                    <script>
                        // ë§¤ì¹­ë˜ì§€ ì•ŠëŠ” noCompany ê°’ ì²˜ë¦¬
                        document.addEventListener('DOMContentLoaded', function() {
                            const select = document.getElementById('noCompany');
                            {% if member and member.noCompany %}
                                const memberCompanyId = {{ member.noCompany }};
                                let found = false;

                                // ê¸°ì¡´ ì˜µì…˜ì—ì„œ ì°¾ê¸°
                                for (let option of select.options) {
                                    if (option.value == memberCompanyId) {
                                        found = true;
                                        break;
                                    }
                                }

                                // ë§¤ì¹­ë˜ì§€ ì•ŠëŠ” ê²½ìš° ë¹¨ê°„ìƒ‰ ì˜µì…˜ ì¶”ê°€
                                if (!found && memberCompanyId) {
                                    const option = document.createElement('option');
                                    option.value = memberCompanyId;
                                    option.textContent = `ì—…ì²´ë²ˆí˜¸: ${memberCompanyId} (ë§¤ì¹­ë˜ì§€ ì•ŠìŒ)`;
                                    option.selected = true;
                                    option.style.color = '#dc3545';
                                    select.appendChild(option);
                                }
                            {% endif %}
                        });
                    </script>
                {% endif %}
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="sName">ì„±ëª… *</label>
                <input type="text"
                       id="sName"
                       name="sName"
                       value="{{ member.sName|default:'' }}"
                       {% if not read_only %}required{% endif %}
                       {% if read_only %}readonly class="readonly-field"{% endif %}>
            </div>

            <div class="form-group">
                <label for="sPhone">í•¸ë“œí° ë²ˆí˜¸</label>
                <input type="text"
                       id="sPhone"
                       name="sPhone"
                       value="{{ member.sPhone|default:'' }}"
                       {% if read_only %}readonly class="readonly-field"{% endif %}>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="nCafeGrade">ì¹´í˜ ë“±ê¸‰</label>
                <select id="nCafeGrade" name="nCafeGrade" {% if read_only %}disabled{% endif %}>
                    <option value="0" {% if member.nCafeGrade == 0 %}selected{% endif %}>ì¼ë°˜</option>
                    <option value="1" {% if member.nCafeGrade == 1 %}selected{% endif %}>ê´‘ê³ ì œíœ´</option>
                    <option value="2" {% if member.nCafeGrade == 2 %}selected{% endif %}>ë‹¨ì¢…ì—´ë¦°</option>
                    <option value="3" {% if member.nCafeGrade == 3 %}selected{% endif %}>í† íƒˆì—´ë¦°</option>
                    <option value="4" {% if member.nCafeGrade == 4 %}selected{% endif %}>ì—°í•©íšŒ</option>
                </select>
            </div>

            <div class="form-group">
                <label for="nNick">ì¹´í˜ë‚´ ë³„ëª…</label>
                <input type="text"
                       id="nNick"
                       name="nNick"
                       value="{{ member.nNick|default:'' }}"
                       {% if read_only %}readonly class="readonly-field"{% endif %}>
            </div>
        </div>


        <!-- ê¶Œí•œ ì„¤ì • -->
        <div class="form-row">
            <div class="form-group">
                <label for="nCompanyAuthority">ì—…ì²´ì •ë³´ ê¶Œí•œ</label>
                <select id="nCompanyAuthority" name="nCompanyAuthority" {% if read_only %}disabled{% endif %}>
                    <option value="0" {% if member.nCompanyAuthority == 0 %}selected{% endif %}>ê¶Œí•œì—†ìŒ</option>
                    <option value="1" {% if member.nCompanyAuthority == 1 %}selected{% endif %}>ì½ê¸°ê¶Œí•œ</option>
                    <option value="2" {% if member.nCompanyAuthority == 2 %}selected{% endif %}>ì“°ê¸°ê¶Œí•œ</option>
                </select>
            </div>

            <div class="form-group">
                <label for="nOrderAuthority">ì˜ë¢°í• ë‹¹ ê¶Œí•œ</label>
                <select id="nOrderAuthority" name="nOrderAuthority" {% if read_only %}disabled{% endif %}>
                    <option value="0" {% if member.nOrderAuthority == 0 %}selected{% endif %}>ê¶Œí•œì—†ìŒ</option>
                    <option value="1" {% if member.nOrderAuthority == 1 %}selected{% endif %}>ì½ê¸°ê¶Œí•œ</option>
                    <option value="2" {% if member.nOrderAuthority == 2 %}selected{% endif %}>ì“°ê¸°ê¶Œí•œ</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="nContractAuthority">ê³„ì•½ê´€ë¦¬ ê¶Œí•œ</label>
                <select id="nContractAuthority" name="nContractAuthority" {% if read_only %}disabled{% endif %}>
                    <option value="0" {% if member.nContractAuthority == 0 %}selected{% endif %}>ê¶Œí•œì—†ìŒ</option>
                    <option value="1" {% if member.nContractAuthority == 1 %}selected{% endif %}>ì½ê¸°ê¶Œí•œ</option>
                    <option value="2" {% if member.nContractAuthority == 2 %}selected{% endif %}>ì“°ê¸°ê¶Œí•œ</option>
                </select>
            </div>

            <div class="form-group">
                <label for="nEvaluationAuthority">ì—…ì²´í‰ê°€ ê¶Œí•œ</label>
                <select id="nEvaluationAuthority" name="nEvaluationAuthority" {% if read_only %}disabled{% endif %}>
                    <option value="0" {% if member.nEvaluationAuthority == 0 %}selected{% endif %}>ê¶Œí•œì—†ìŒ</option>
                    <option value="1" {% if member.nEvaluationAuthority == 1 %}selected{% endif %}>ì½ê¸°ê¶Œí•œ</option>
                    <option value="2" {% if member.nEvaluationAuthority == 2 %}selected{% endif %}>ì“°ê¸°ê¶Œí•œ</option>
                </select>
            </div>
        </div>

        <div class="button-group">
            {% if not read_only %}
                <button type="submit" class="btn btn-primary">
                    {% if action == 'create' %}ì¶”ê°€{% else %}ìˆ˜ì •{% endif %}
                </button>
            {% endif %}
            <a href="{% url 'member:member_list' %}" class="btn btn-secondary">
                {% if read_only %}â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°{% else %}ì·¨ì†Œ{% endif %}
            </a>
        </div>

    </form>
</div>

{% if not read_only %}
<script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì„¤ì •
    document.addEventListener('DOMContentLoaded', function() {

        // ì¶”ê°€ í™”ë©´ì—ì„œë§Œ noCompany ì„ íƒ ì‹œ ìë™ í•„ë“œ ì—…ë°ì´íŠ¸
        {% if action == 'create' %}
        console.log('Member create form detected, setting up noCompany change listener');
        const noCompanySelect = document.getElementById('noCompany');
        console.log('noCompany select element:', noCompanySelect);

        if (noCompanySelect) {
            console.log('Adding change listener to noCompany select');
            noCompanySelect.addEventListener('change', function() {
                console.log('noCompany changed, selectedIndex:', this.selectedIndex);
                const selectedOption = this.options[this.selectedIndex];
                console.log('selectedOption:', selectedOption);

                if (selectedOption && selectedOption.value) {
                    const sName2 = selectedOption.getAttribute('data-sname2');
                    const sName1 = selectedOption.getAttribute('data-sname1');

                    console.log('Selected company:', selectedOption.value);
                    console.log('data-sname2:', sName2);
                    console.log('data-sname1:', sName1);

                    // sName2 í•„ë“œ ì—…ë°ì´íŠ¸
                    const sName2Field = document.getElementById('sName2');
                    console.log('sName2 field element:', sName2Field);
                    if (sName2Field) {
                        sName2Field.value = sName2 || '';
                        console.log('Updated sName2 field to:', sName2Field.value);
                    } else {
                        console.log('sName2 field not found!');
                    }

                    // sCompanyName í•„ë“œ ì—…ë°ì´íŠ¸ (sName1 ì‚¬ìš©)
                    const sCompanyNameField = document.getElementById('sCompanyName');
                    console.log('sCompanyName field element:', sCompanyNameField);
                    if (sCompanyNameField) {
                        sCompanyNameField.value = sName1 || '';
                        console.log('Updated sCompanyName field to:', sCompanyNameField.value);
                    } else {
                        console.log('sCompanyName field not found!');
                    }
                } else {
                    console.log('No option selected or empty value');
                    // ì—…ì²´ ì„ íƒ í•´ì œ ì‹œ í•„ë“œ ì´ˆê¸°í™”
                    const sName2Field = document.getElementById('sName2');
                    const sCompanyNameField = document.getElementById('sCompanyName');
                    if (sName2Field) sName2Field.value = '';
                    if (sCompanyNameField) sCompanyNameField.value = '';
                    console.log('Cleared fields');
                }
            });
        } else {
            console.log('noCompany select element not found!');
        }
        {% endif %}
    });
</script>
{% endif %}

{% endif %}

{% endblock %}
{% extends 'staff/base.html' %}

{% block title %}{{ title }} - PMIS 2.0{% endblock %}

{% block page_title %}{{ title }}{% endblock %}
{% block page_subtitle %}
    {% if not impo %}
        ìƒˆë¡œìš´ ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ ë“±ë¡
    {% endif %}
{% endblock %}

{% block content %}
{% if not not_logged_in %}
{{ block.super }}
{% endif %}

{% if not not_logged_in %}
<style>
    .form-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }

    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
    }

    .form-check {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 5px;
    }

    .form-check-input {
        width: auto;
        margin: 0;
    }

    .form-check-label {
        margin: 0;
        cursor: pointer;
        font-weight: normal;
    }

    .radio-group {
        display: flex;
        gap: 20px;
        margin-top: 8px;
    }

    .radio-option {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .radio-option input[type="radio"] {
        margin: 0;
        width: auto;
    }

    .radio-option label {
        margin: 0;
        cursor: pointer;
        font-weight: normal;
        font-size: 14px;
    }

    .help-text {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin-right: 10px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .form-actions {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
        text-align: center;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 4px;
    }

    .current-info {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 0 4px 4px 0;
    }

    .current-info h4 {
        margin: 0 0 10px 0;
        color: #007bff;
        font-size: 16px;
    }

    .current-info p {
        margin: 5px 0;
        font-size: 14px;
        color: #495057;
    }

    /* ìë™ì™„ì„± ìŠ¤íƒ€ì¼ */
    .company-autocomplete {
        position: relative;
        display: inline-block;
        width: 100%;
    }

    .company-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }

    .company-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
    }

    .suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .suggestion-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

    .suggestion-item:hover,
    .suggestion-item.highlighted {
        background-color: #f8f9fa;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    @media (max-width: 768px) {
        .form-container {
            padding: 20px;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .form-actions {
            text-align: left;
        }

        .btn {
            width: 100%;
            margin-bottom: 10px;
            margin-right: 0;
        }
    }
</style>

<div class="form-container">
    {% if impo %}
    <!-- í˜„ì¬ ì •ë³´ í‘œì‹œ (ìˆ˜ì • ëª¨ë“œ) -->
    <div class="current-info">
        <h4>ğŸ“‹ í˜„ì¬ ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„</h4>
        <p><strong>ë²ˆí˜¸:</strong> #{{ impo.no }}</p>
        <p><strong>ì—´ë¦°ì—…ì²´:</strong> {{ impo.get_company_name }}</p>
        <p><strong>ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„:</strong> {{ impo.dateStart }} ~ {{ impo.dateEnd }}</p>
        <p><strong>ë“±ë¡ì¼:</strong> {{ impo.time|date:"Y-m-d H:i" }}</p>
    </div>
    {% endif %}

    <form method="post">
        {% csrf_token %}

        <!-- ì—´ë¦°ì—…ì²´ ì„ íƒ -->
        <div class="form-group">
            <label class="form-label" for="company-input">
                {{ form.noCompany.label }}
                <span style="color: red;">*</span>
            </label>
            <div class="company-autocomplete">
                <input type="text"
                       id="company-input"
                       class="company-input form-control"
                       placeholder="ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."
                       autocomplete="off"
                       {% if impo %}value="{{ impo.get_company_name }}"{% endif %}>
                <div class="suggestions" id="suggestions"></div>
                <input type="hidden" name="noCompany" id="noCompany" value="{% if impo %}{{ impo.noCompany }}{% endif %}">
            </div>
            {% if form.noCompany.errors %}
                <div class="error-message">{{ form.noCompany.errors.0 }}</div>
            {% endif %}
        </div>

        <!-- ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ -->
        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="{{ form.dateStart.id_for_label }}">
                    {{ form.dateStart.label }}
                    <span style="color: red;">*</span>
                </label>
                {{ form.dateStart }}
                {% if form.dateStart.help_text %}
                    <div class="help-text">{{ form.dateStart.help_text }}</div>
                {% endif %}
                {% if form.dateStart.errors %}
                    <div class="error-message">{{ form.dateStart.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-label" for="{{ form.dateEnd.id_for_label }}">
                    {{ form.dateEnd.label }}
                </label>
                {{ form.dateEnd }}
                {% if form.dateEnd.help_text %}
                    <div class="help-text">{{ form.dateEnd.help_text }}</div>
                {% endif %}
                {% if form.dateEnd.errors %}
                    <div class="error-message">{{ form.dateEnd.errors.0 }}</div>
                {% endif %}
            </div>
        </div>



        <!-- ì„¤ì •ì ë° ê³µê°œì—¬ë¶€ -->
        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="{{ form.sWorker.id_for_label }}">
                    {{ form.sWorker.label }}
                </label>
                {{ form.sWorker }}
                {% if form.sWorker.help_text %}
                    <div class="help-text">{{ form.sWorker.help_text }}</div>
                {% endif %}
                {% if form.sWorker.errors %}
                    <div class="error-message">{{ form.sWorker.errors.0 }}</div>
                {% endif %}
            </div>

        </div>

        <!-- ì „ì²´ í¼ ì˜¤ë¥˜ -->
        {% if form.non_field_errors %}
            <div class="form-group">
                <div class="error-message">{{ form.non_field_errors.0 }}</div>
            </div>
        {% endif %}

        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="form-actions">
            {% if impo %}
                <button type="submit" class="btn btn-primary">
                    ğŸ’¾ ìˆ˜ì • ì™„ë£Œ
                </button>
                <a href="{% url 'impossibleterm:impo_list' %}" class="btn btn-secondary">
                    â†©ï¸ ëª©ë¡ìœ¼ë¡œ
                </a>
            {% else %}
                <button type="submit" class="btn btn-primary">
                    â• ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ ì¶”ê°€
                </button>
                <a href="{% url 'impossibleterm:impo_list' %}" class="btn btn-secondary">
                    â†©ï¸ ëª©ë¡ìœ¼ë¡œ
                </a>
            {% endif %}
        </div>
    </form>
</div>

<!-- ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ -->
<div id="alertModal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h5 id="alertModalTitle" class="modal-title">ì•Œë¦¼</h5>
        </div>
        <div class="modal-body">
            <p id="alertModalMessage"></p>
        </div>
        <div class="modal-footer">
            <button type="button" id="alertModalOk" class="btn btn-primary">í™•ì¸</button>
        </div>
    </div>
</div>

<style>
/* ì»¤ìŠ¤í…€ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.custom-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    max-width: 400px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 20px 20px 0 20px;
    border-bottom: 1px solid #dee2e6;
}

.modal-title {
    margin: 0 0 15px 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
}

.modal-body {
    padding: 20px;
}

.modal-body p {
    margin: 0;
    color: #666;
    line-height: 1.5;
}

.modal-footer {
    padding: 0 20px 20px 20px;
    text-align: right;
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
}

.modal-footer .btn {
    margin-left: 10px;
}
</style>

<script>
// ì»¤ìŠ¤í…€ ì•Œë¦¼ í•¨ìˆ˜
function showAlert(title, message) {
    const modal = document.getElementById('alertModal');
    const modalTitle = document.getElementById('alertModalTitle');
    const modalMessage = document.getElementById('alertModalMessage');
    const modalOk = document.getElementById('alertModalOk');

    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modal.style.display = 'flex';

    // í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
    modalOk.onclick = function() {
        modal.style.display = 'none';
    };

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    modal.onclick = function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };
}

// ì—…ì²´ ë°ì´í„° (ì„œë²„ì—ì„œ ì „ë‹¬)
const companies = [
    {% for choice in company_choices %}
        {% if choice.0 %}
            {id: '{{ choice.0 }}', name: '{{ choice.1|escapejs }}'},
        {% endif %}
    {% endfor %}
];

// ìë™ì™„ì„± ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
    const companyInput = document.getElementById('company-input');
    const suggestionsDiv = document.getElementById('suggestions');
    const hiddenInput = document.getElementById('noCompany');
    let currentHighlight = -1;

    // ì…ë ¥ ì‹œ ìë™ì™„ì„± ì‹¤í–‰
    companyInput.addEventListener('input', function() {
        const value = this.value.trim();
        const valueLower = value.toLowerCase();
        suggestionsDiv.innerHTML = '';
        currentHighlight = -1;

        if (value.length === 0) {
            suggestionsDiv.style.display = 'none';
            hiddenInput.value = '';
            return;
        }

        // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì—…ì²´ëª… í™•ì¸
        const exactMatch = companies.find(company =>
            company.name.toLowerCase() === valueLower
        );

        if (exactMatch) {
            // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì—…ì²´ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì„ íƒ
            selectCompany(exactMatch.id, exactMatch.name);
            return;
        }

        // ì…ë ¥ê°’ê³¼ ì¼ì¹˜í•˜ëŠ” ì—…ì²´ ì°¾ê¸°
        const filteredCompanies = companies.filter(company =>
            company.name.toLowerCase().includes(valueLower)
        );

        if (filteredCompanies.length > 0) {
            filteredCompanies.forEach((company, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = company.name;
                item.dataset.id = company.id;
                item.dataset.index = index;

                item.addEventListener('click', function() {
                    selectCompany(company.id, company.name);
                });

                suggestionsDiv.appendChild(item);
            });

            suggestionsDiv.style.display = 'block';

            // ì²« ë²ˆì§¸ í•­ëª©ì„ ìë™ìœ¼ë¡œ í•˜ì´ë¼ì´íŠ¸
            if (filteredCompanies.length > 0) {
                highlightSuggestion(0);
            }
        } else {
            suggestionsDiv.style.display = 'none';
            hiddenInput.value = ''; // ì¼ì¹˜í•˜ëŠ” ì—…ì²´ê°€ ì—†ìœ¼ë©´ ê°’ ì´ˆê¸°í™”
        }
    });

    // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
    companyInput.addEventListener('keydown', function(e) {
        const suggestions = suggestionsDiv.querySelectorAll('.suggestion-item');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentHighlight = Math.min(currentHighlight + 1, suggestions.length - 1);
            highlightSuggestion(currentHighlight);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentHighlight = Math.max(currentHighlight - 1, 0);
            highlightSuggestion(currentHighlight);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (currentHighlight >= 0 && suggestions[currentHighlight]) {
                const item = suggestions[currentHighlight];
                selectCompany(item.dataset.id, item.textContent);
            }
        } else if (e.key === 'Escape') {
            suggestionsDiv.style.display = 'none';
            currentHighlight = -1;
        }
    });

    // ì…ë ¥ í•„ë“œì—ì„œ ë²—ì–´ë‚  ë•Œ ìë™ ë§¤ì¹­ í™•ì¸
    companyInput.addEventListener('blur', function() {
        // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ í´ë¦­ ì´ë²¤íŠ¸ê°€ ë¨¼ì € ì²˜ë¦¬ë˜ë„ë¡ í•¨
        setTimeout(() => {
            const value = this.value.trim();
            const valueLower = value.toLowerCase();

            if (value.length > 0 && !hiddenInput.value) {
                // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì—…ì²´ëª… í™•ì¸
                const exactMatch = companies.find(company =>
                    company.name.toLowerCase() === valueLower
                );

                if (exactMatch) {
                    selectCompany(exactMatch.id, exactMatch.name);
                } else {
                    // ë¶€ë¶„ ì¼ì¹˜í•˜ëŠ” ì²« ë²ˆì§¸ ì—…ì²´ ìë™ ì„ íƒ (ì„ íƒì‚¬í•­)
                    const partialMatch = companies.find(company =>
                        company.name.toLowerCase().includes(valueLower)
                    );

                    if (partialMatch) {
                        selectCompany(partialMatch.id, partialMatch.name);
                    }
                }
            }
            suggestionsDiv.style.display = 'none';
        }, 200);
    });

    // ì™¸ë¶€ í´ë¦­ ì‹œ ìë™ì™„ì„± ìˆ¨ê¸°ê¸°
    document.addEventListener('click', function(e) {
        if (!companyInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            suggestionsDiv.style.display = 'none';
        }
    });

    function highlightSuggestion(index) {
        const suggestions = suggestionsDiv.querySelectorAll('.suggestion-item');
        suggestions.forEach((item, i) => {
            if (i === index) {
                item.classList.add('highlighted');
            } else {
                item.classList.remove('highlighted');
            }
        });
    }

    function selectCompany(id, name) {
        companyInput.value = name;
        hiddenInput.value = id;
        suggestionsDiv.style.display = 'none';
        currentHighlight = -1;
    }
});

// ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì • (ì¶”ê°€ ëª¨ë“œì—ì„œë§Œ)
{% if not impo %}
document.addEventListener('DOMContentLoaded', function() {
    // í•œêµ­ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ëŠ˜ ë‚ ì§œ ê³„ì‚°
    const koreaTime = new Date(new Date().getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    const startDate = document.getElementById('{{ form.dateStart.id_for_label }}');
    const endDate = document.getElementById('{{ form.dateEnd.id_for_label }}');

    if (!startDate.value) {
        startDate.value = today;
    }

    // ì‹œì‘ì¼ ë³€ê²½ ì‹œ ì¢…ë£Œì¼ ìë™ ì¡°ì •
    startDate.addEventListener('change', function() {
        if (startDate.value && endDate.value && endDate.value < startDate.value) {
            endDate.value = startDate.value;
        }
    });

    // ì¢…ë£Œì¼ ë³€ê²½ ì‹œ ì‹œì‘ì¼ ìë™ ì¡°ì •
    endDate.addEventListener('change', function() {
        if (endDate.value && startDate.value && startDate.value > endDate.value) {
            startDate.value = endDate.value;
        }
    });
});
{% endif %}

// í¼ ìœ íš¨ì„± ê²€ì‚¬
document.querySelector('form').addEventListener('submit', function(e) {
    const company = document.getElementById('noCompany').value;
    const startDate = document.getElementById('{{ form.dateStart.id_for_label }}').value;
    const endDate = document.getElementById('{{ form.dateEnd.id_for_label }}').value;
    if (!company) {
        showAlert('ì…ë ¥ í™•ì¸', 'ì—´ë¦°ì—…ì²´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        e.preventDefault();
        return false;
    }

    if (!startDate) {
        showAlert('ì…ë ¥ í™•ì¸', 'ì‹œì‘ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        e.preventDefault();
        return false;
    }

    if (endDate && startDate > endDate) {
        showAlert('ì…ë ¥ í™•ì¸', 'ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ë¹¨ë¼ì•¼ í•©ë‹ˆë‹¤.');
        e.preventDefault();
        return false;
    }


    return true;
});


// ë‚ ì§œ ì…ë ¥ ì‹œ ìë™ ì¡°ì • (ìˆ˜ì • ëª¨ë“œ)
{% if impo %}
document.addEventListener('DOMContentLoaded', function() {
    const startDateInput = document.getElementById('{{ form.dateStart.id_for_label }}');
    const endDateInput = document.getElementById('{{ form.dateEnd.id_for_label }}');

    // ìˆ˜ì • ëª¨ë“œì—ì„œ ë‚ ì§œ ìë™ ì¡°ì •
    startDateInput.addEventListener('change', function() {
        if (startDateInput.value && endDateInput.value && endDateInput.value < startDateInput.value) {
            endDateInput.value = startDateInput.value;
        }
    });

    endDateInput.addEventListener('change', function() {
        if (endDateInput.value && startDateInput.value && startDateInput.value > endDateInput.value) {
            startDateInput.value = endDateInput.value;
        }
    });
});
{% endif %}
</script>

{% endif %}
{% endblock %}
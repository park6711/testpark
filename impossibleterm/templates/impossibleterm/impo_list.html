{% extends 'staff/base.html' %}

{% block title %}ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ - PMIS 2.0{% endblock %}

{% block page_title %}ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„{% endblock %}
{% block page_subtitle %}ê³µì‚¬ë¥¼ í•  ìˆ˜ ì—†ëŠ” ê¸°ê°„ì…ë‹ˆë‹¤. ê³ ê°ë‹˜ì˜ ê³µì‚¬ì˜ˆì •ì¼ì´ "ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„" ì•ˆì— ë“¤ì–´ì˜¤ëŠ” ì˜ë¢°ê±´ì€ ì¹´í˜ ë³¸ë¶€ì—ì„œ í• ë‹¹í•´ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.(ì˜ˆ : ëª‡ë‹¬ ë’¤ì— ì˜ˆì•½ëœ ì—¬ëŸ¬ê±´ì˜ ê³µì‚¬ê±´, ì¥ê¸°í•´ì™¸ì—¬í–‰){% endblock %}

{% block content %}
{% if not not_logged_in %}
{{ block.super }}
{% endif %}

{% csrf_token %}

{% if not not_logged_in %}
<style>
    .stats-section {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .stat-card.active-filter {
        border: 2px solid #007bff;
        background: #f8f9fa;
    }

    .stat-number {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #666;
        font-size: 14px;
    }

    .stat-card.ended .stat-number { color: #28a745; }
    .stat-card.active .stat-number { color: #dc3545; }
    .stat-card.pending .stat-number { color: #ffc107; }

    .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .search-section {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .search-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        width: 300px;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin: 2px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-warning {
        background: #ffc107;
        color: #212529;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .impos-table {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }

    .table th,
    .table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }

    .table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }

    .table tbody tr:hover {
        background: #f8f9fa;
        cursor: pointer;
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-active {
        background: #dc3545;
        color: white;
    }

    .status-pending {
        background: #ffc107;
        color: #212529;
    }

    .status-ended {
        background: #28a745;
        color: white;
    }

    .visibility-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .visibility-public {
        background: #28a745;
        color: white;
    }

    .visibility-private {
        background: #6c757d;
        color: white;
    }

    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        gap: 5px;
    }

    .pagination a,
    .pagination span {
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        color: #007bff;
        text-decoration: none;
        border-radius: 4px;
    }

    .pagination .current {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }

    .pagination a:hover {
        background: #e9ecef;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 4em;
        margin-bottom: 20px;
        color: #dee2e6;
    }

    /* ì»¤ìŠ¤í…€ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .custom-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
    }

    .modal-message {
        margin-bottom: 25px;
        line-height: 1.5;
        color: #666;
    }

    .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    .modal-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .modal-btn-confirm {
        background: #dc3545;
        color: white;
    }

    .modal-btn-confirm:hover {
        background: #c82333;
    }

    .modal-btn-cancel {
        background: #6c757d;
        color: white;
    }

    .modal-btn-cancel:hover {
        background: #545b62;
    }

    @media (max-width: 768px) {
        .stats-section {
            grid-template-columns: 1fr;
        }

        .controls {
            flex-direction: column;
            gap: 15px;
        }

        .search-input {
            width: 100%;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .modal-buttons {
            flex-direction: column;
        }

        .modal-btn {
            width: 100%;
        }
    }
</style>


<!-- ì»¨íŠ¸ë¡¤ ì„¹ì…˜ -->
<div class="controls">
    <div class="search-section">
        <input type="text" class="search-input" placeholder="ì—…ì²´ëª…, ì„¤ì •ìë¡œ ê²€ìƒ‰..." id="searchInput">
        <button class="btn btn-primary" onclick="searchImpos()">ğŸ” ê²€ìƒ‰</button>
    </div>
    <div class="action-section">
        <a href="{% url 'impossibleterm:impo_add' %}" class="btn btn-success">â• ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ ì¶”ê°€</a>
        <button class="btn btn-secondary" onclick="location.reload()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>
</div>

<!-- ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ ëª©ë¡ í…Œì´ë¸” -->
<div class="impos-table">
    {% if impos %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>ë²ˆí˜¸</th>
                    <th>ì—´ë¦°ì—…ì²´</th>
                    <th>ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„</th>
                    <th>ì„¤ì •ì</th>
                    <th>ë“±ë¡ì¼</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>
                {% for impo in impos %}
                <tr data-impo-id="{{ impo.no }}" ondblclick="editImpo({{ impo.no }})">
                    <td><strong>#{{ impo.no }}</strong></td>
                    <td>
                        <strong onclick="editCompany({{ impo.noCompany }}); event.stopPropagation();"
                                style="cursor: pointer; color: #007bff;"
                                title="í´ë¦­í•˜ì—¬ ì—…ì²´ ì •ë³´ ìˆ˜ì •">{{ impo.get_company_name }}</strong>
                    </td>
                    <td>
                        <div>{{ impo.dateStart|date:"Y-m-d" }}</div>
                        <div>{{ impo.dateEnd|date:"Y-m-d" }}</div>
                        <small class="text-muted">
                            (ì´ {{ impo.get_duration_days }}ì¼)
                        </small>
                    </td>
                    <td>{{ impo.sWorker }}</td>
                    <td>{{ impo.time|date:"m/d H:i" }}</td>
                    <td>
                        <a href="{% url 'impossibleterm:impo_edit' impo.no %}" class="btn btn-warning" style="padding: 4px 8px; font-size: 12px;">ìˆ˜ì •</a>
                        <button onclick="deleteImpo({{ impo.no }}, '{{ impo.get_company_name|escapejs }}')" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;">ì‚­ì œ</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <i>ğŸ“‹</i>
        <h4>ë“±ë¡ëœ ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
        <p>ìƒˆë¡œìš´ ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>
        <a href="{% url 'impossibleterm:impo_add' %}" class="btn btn-success">â• ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ ì¶”ê°€</a>
    </div>
    {% endif %}
</div>

<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
{% if is_paginated %}
<div class="pagination">
    {% if page_obj.has_previous %}
        <a href="?page=1">&laquo; ì²«í˜ì´ì§€</a>
        <a href="?page={{ page_obj.previous_page_number }}">ì´ì „</a>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
            <span class="current">{{ num }}</span>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <a href="?page={{ num }}">{{ num }}</a>
        {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}">ë‹¤ìŒ</a>
        <a href="?page={{ page_obj.paginator.num_pages }}">ë§ˆì§€ë§‰ &raquo;</a>
    {% endif %}
</div>
<!-- ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ -->
<div id="confirmModal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-title" id="modalTitle">í™•ì¸</div>
        <div class="modal-message" id="modalMessage"></div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-confirm" id="modalConfirm">í™•ì¸</button>
            <button class="modal-btn modal-btn-cancel" id="modalCancel">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

{% endif %}

<script>
let currentFilter = null;

// ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ í•¨ìˆ˜
function showConfirm(title, message, onConfirm) {
    const modal = document.getElementById('confirmModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const confirmBtn = document.getElementById('modalConfirm');
    const cancelBtn = document.getElementById('modalCancel');

    modalTitle.textContent = title;
    modalMessage.innerHTML = message;
    modal.style.display = 'flex';

    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
    confirmBtn.replaceWith(confirmBtn.cloneNode(true));
    cancelBtn.replaceWith(cancelBtn.cloneNode(true));

    // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    const newConfirmBtn = document.getElementById('modalConfirm');
    const newCancelBtn = document.getElementById('modalCancel');

    newConfirmBtn.addEventListener('click', function() {
        modal.style.display = 'none';
        onConfirm();
    });

    newCancelBtn.addEventListener('click', function() {
        modal.style.display = 'none';
    });

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
}

function searchImpos() {
    const searchInput = document.getElementById('searchInput');
    const searchTerm = searchInput.value.toLowerCase();
    const rows = document.querySelectorAll('.table tbody tr');
    const pagination = document.querySelector('.pagination');
    let visibleCount = 0;

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // ê²€ìƒ‰ ê²°ê³¼ê°€ 10ê°œ ë¯¸ë§Œì´ë©´ í˜ì´ì§€ë„¤ì´ì…˜ ìˆ¨ê¸°ê¸°
    if (pagination) {
        if (searchTerm.length > 0 && visibleCount < 10) {
            pagination.style.display = 'none';
        } else if (searchTerm.length === 0) {
            pagination.style.display = '';
        } else {
            pagination.style.display = '';
        }
    }
}

function filterByStatus(status) {
    const rows = document.querySelectorAll('.table tbody tr');
    const statCards = document.querySelectorAll('.stat-card');
    const pagination = document.querySelector('.pagination');
    const today = new Date('{{ today|date:"Y-m-d" }}');

    // í†µê³„ ì¹´ë“œ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
    statCards.forEach(card => {
        if (card.dataset.filter === status) {
            card.classList.add('active-filter');
        } else {
            card.classList.remove('active-filter');
        }
    });

    // í•„í„°ê°€ ê°™ìœ¼ë©´ í•„í„° í•´ì œ
    if (currentFilter === status) {
        currentFilter = null;
        statCards.forEach(card => card.classList.remove('active-filter'));
        rows.forEach(row => row.style.display = '');
        // í˜ì´ì§€ë„¤ì´ì…˜ ë³µì›
        if (pagination) {
            pagination.style.display = '';
        }
        return;
    }

    currentFilter = status;
    let visibleCount = 0;

    rows.forEach(row => {
        const dateStartText = row.querySelector('td:nth-child(3) div:first-child').textContent;
        const dateEndText = row.querySelector('td:nth-child(3) div:nth-child(2)').textContent;

        const dateStart = new Date(dateStartText);
        const dateEnd = new Date(dateEndText);

        let showRow = false;

        if (status === 'ended') {
            // í•´ì œ: ì¢…ë£Œì¼ì´ ì˜¤ëŠ˜ë³´ë‹¤ ì´ì „
            showRow = dateEnd < today;
        } else if (status === 'active') {
            // ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„: ì‹œì‘ì¼ <= ì˜¤ëŠ˜ <= ì¢…ë£Œì¼
            showRow = dateStart <= today && today <= dateEnd;
        } else if (status === 'pending') {
            // ì˜ˆì •: ì‹œì‘ì¼ì´ ì˜¤ëŠ˜ë³´ë‹¤ ì´í›„
            showRow = dateStart > today;
        }

        if (showRow) {
            visibleCount++;
        }

        row.style.display = showRow ? '' : 'none';
    });

    // í•„í„°ë§ëœ ê²°ê³¼ê°€ 10ê°œ ë¯¸ë§Œì´ë©´ í˜ì´ì§€ë„¤ì´ì…˜ ìˆ¨ê¸°ê¸°
    if (pagination) {
        if (visibleCount < 10) {
            pagination.style.display = 'none';
        } else {
            pagination.style.display = '';
        }
    }
}

// í†µê³„ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
document.addEventListener('DOMContentLoaded', function() {
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach(card => {
        card.addEventListener('click', function() {
            filterByStatus(this.dataset.filter);
        });
    });
});

// ê²€ìƒ‰ ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ ê²€ìƒ‰
document.getElementById('searchInput').addEventListener('input', searchImpos);

// ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ í•´ì œ ê¸°ëŠ¥
function releaseImpo(impoId) {
    showConfirm(
        'ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ í•´ì œ',
        'ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><br><strong>ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì´ ëª¨ë‘ ì–´ì œë¡œ ë³€ê²½ë©ë‹ˆë‹¤.</strong>',
        function() {
            fetch(`/impossibleterm/release/${impoId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.reload();
                } else {
                    alert('í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }
    );
}

// ë”ë¸”í´ë¦­ìœ¼ë¡œ ìˆ˜ì • í™”ë©´ìœ¼ë¡œ ì´ë™
function editImpo(impoId) {
    window.location.href = `/impossibleterm/edit/${impoId}/`;
}

// ì—…ì²´ëª… ë”ë¸”í´ë¦­ìœ¼ë¡œ ì—…ì²´ ìˆ˜ì • í™”ë©´ìœ¼ë¡œ ì´ë™
function editCompany(companyId) {
    window.location.href = `/company/update/${companyId}/`;
}

// ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ ì‚­ì œ ê¸°ëŠ¥
function deleteImpo(impoId, companyName) {
    showConfirm(
        'ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ ì‚­ì œ',
        `ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><br><strong>ì—…ì²´:</strong> ${companyName}<br><strong>ê³µì‚¬ ë¶ˆê°€ëŠ¥ ê¸°ê°„ ID:</strong> #${impoId}<br><br><span style="color: #dc3545;">âš ï¸ ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>`,
        function() {
            fetch(`/impossibleterm/delete/${impoId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }
    );
}
</script>

{% endif %}
{% endblock %}
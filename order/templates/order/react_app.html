{% extends "staff/base.html" %}
{% load static %}

{% block title %}의뢰할당 관리 시스템{% endblock %}

{% block page_title %}의뢰할당 관리{% endblock %}
{% block page_subtitle %}React 기반 통합 관리 시스템{% endblock %}

{% block content %}
<!-- React 앱이 마운트될 루트 엘리먼트 -->
<div id="root" style="min-height: calc(100vh - 100px);"></div>

<!-- 개발/프로덕션 환경에 따른 스크립트 로드 -->
{% if debug %}
  <!-- 개발 환경: webpack-dev-server 사용 -->
  <script>
    // Django 컨텍스트 데이터를 React에 전달
    window.__DJANGO_CONTEXT__ = {
      user: {
        username: "{{ user.username|escapejs }}",
        email: "{{ user.email|escapejs }}",
        isAuthenticated: {{ user.is_authenticated|lower }},
        isStaff: {{ user.is_staff|lower }}
      },
      apiBaseUrl: '',  // API 서비스에서 환경 변수 사용
      csrfToken: "{{ csrf_token }}"
    };
  </script>

  <!-- 개발 서버에서 React 앱 로드 -->
  <script src="http://localhost:3000/static/js/bundle.js"></script>
  <script src="http://localhost:3000/static/js/0.chunk.js"></script>
  <script src="http://localhost:3000/static/js/main.chunk.js"></script>

{% else %}
  <!-- 프로덕션 환경: 빌드된 정적 파일 사용 -->
  <script>
    // Django 컨텍스트 데이터를 React에 전달
    window.__DJANGO_CONTEXT__ = {
      user: {
        username: "{{ user.username|escapejs }}",
        email: "{{ user.email|escapejs }}",
        isAuthenticated: {{ user.is_authenticated|lower }},
        isStaff: {{ user.is_staff|lower }}
      },
      apiBaseUrl: '',  // API 서비스에서 환경 변수 사용
      csrfToken: "{{ csrf_token }}"
    };
  </script>

  <!-- 빌드된 React 앱 로드 -->
  <link href="{% static 'css/main.a874db27.css' %}" rel="stylesheet">
  <script defer src="{% static 'js/main.f7a94119.js' %}"></script>
{% endif %}

<style>
  /* Django 템플릿과 React 앱 간 스타일 충돌 방지 */
  #root {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
      'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
      sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* 기존 Django 스타일 오버라이드 */
  .main-content {
    padding: 0 !important;
    background: transparent !important;
  }

  /* Ant Design 스타일과 호환성 */
  .ant-layout {
    background: #f0f2f5;
  }
</style>

<script>
  // React 앱 로드 에러 처리
  window.addEventListener('error', function(event) {
    if (event.message.includes('ChunkLoadError')) {
      console.error('React 앱 로딩 실패. 페이지를 새로고침합니다.');
      location.reload();
    }
  });

  // Django CSRF 토큰을 axios 기본 헤더에 설정
  document.addEventListener('DOMContentLoaded', function() {
    if (window.axios) {
      window.axios.defaults.headers.common['X-CSRFToken'] = window.__DJANGO_CONTEXT__.csrfToken;
    }
  });
</script>
{% endblock %}
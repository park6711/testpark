{% extends "staff/base.html" %}

{% block title %}
{% if mode == 'edit' %}
ê³ ê°ê³„ì•½ë³´ê³  ìˆ˜ì •
{% else %}
ê³ ê°ê³„ì•½ë³´ê³  ìƒì„¸ë³´ê¸°
{% endif %}
- PMIS 2.0
{% endblock %}

{% block page_title %}
{% if mode == 'edit' %}
ê³ ê°ê³„ì•½ë³´ê³  ìˆ˜ì •
{% else %}
ê³ ê°ê³„ì•½ë³´ê³  ìƒì„¸ë³´ê¸°
{% endif %}
{% endblock %}

{% block page_subtitle %}
ê³ ê°ê³„ì•½ë³´ê³  #{{ report.no }}
{% endblock %}

{% block content %}
<style>
    .detail-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
        margin-top: 20px;
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }

    .main-title {
        font-size: 24px;
        font-weight: bold;
        color: #2d3748;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 3px solid #667eea;
        text-align: center;
    }

    .section-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-col {
        flex: 1;
    }

    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #495057;
        font-size: 14px;
    }

    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.15s ease-in-out;
    }

    .form-control:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .form-control[readonly] {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .form-control-plaintext {
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 14px;
        color: #495057;
    }

    select.form-control {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right .75rem center;
        background-size: 16px 12px;
        padding-right: 2.25rem;
    }

    textarea.form-control {
        resize: vertical;
        min-height: 100px;
    }

    .btn-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
        background: linear-gradient(135deg, #0f9d58 0%, #0a6f3f 100%);
        color: white;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(15, 157, 88, 0.4);
    }

    .btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: #333;
    }

    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
    }

    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
    }

    .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }

    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
    }

    .link-display {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        color: #007bff;
        text-decoration: none;
    }

    .link-display:hover {
        text-decoration: underline;
    }

    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-secondary {
        background: #6c757d;
        color: white;
    }

    .badge-success {
        background: #28a745;
        color: white;
    }

    .badge-warning {
        background: #ffc107;
        color: #333;
    }

    .badge-danger {
        background: #dc3545;
        color: white;
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
        }

        .btn-group {
            flex-wrap: wrap;
        }
    }

    /* ì»¤ìŠ¤í…€ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        animation: fadeIn 0.3s;
    }

    .modal-overlay.active {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s;
    }

    .modal-header {
        margin-bottom: 20px;
    }

    .modal-title {
        font-size: 20px;
        font-weight: bold;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-body {
        color: #666;
        font-size: 16px;
        line-height: 1.5;
        margin-bottom: 25px;
    }

    .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .modal-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .modal-btn-cancel {
        background: #e9ecef;
        color: #495057;
    }

    .modal-btn-cancel:hover {
        background: #dee2e6;
    }

    .modal-btn-danger {
        background: linear-gradient(135deg, #f93b1d 0%, #ea2c62 100%);
        color: white;
    }

    .modal-btn-danger:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(234, 44, 98, 0.4);
    }

    .modal-btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .modal-btn-primary:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>

<div class="detail-container">
    <form method="post" action="">
        {% csrf_token %}

        <!-- ì£¼ íƒ€ì´í‹€ -->
        <div class="main-title">ê³ ê° ê³„ì•½ë³´ê³ </div>

        <!-- ê¸°ë³¸ ì •ë³´ (ì½ê¸° ì „ìš©) -->
        <div class="section-title">ê¸°ë³¸ ì •ë³´</div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">No</label>
                <div class="form-control-plaintext">#{{ report.no }}</div>
            </div>
            <div class="form-col">
                <label class="form-label">ë“±ë¡ì¼ì‹œ</label>
                <div class="form-control-plaintext">
                    {% if report.timeStamp %}
                        {{ report.timeStamp|date:"Y-m-d H:i:s" }}
                    {% elif report.sTimeStamp %}
                        {{ report.sTimeStamp }}
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì—…ì²´ëª…(êµ¬ê¸€)</label>
                <div class="form-control-plaintext">{{ report.sCompanyName|default:"-" }}</div>
            </div>
            <div class="form-col">
                <label class="form-label">ê³ ê°ëª…</label>
                <div class="form-control-plaintext">{{ report.sName|default:"-" }}</div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê³µì‚¬ì§€ì—­</label>
                <div class="form-control-plaintext">{{ report.sArea|default:"-" }}</div>
            </div>
            <div class="form-col">
                <label class="form-label">ê³ ê° í•¸ë“œí°</label>
                <div class="form-control-plaintext">{{ report.sPhone|default:"-" }}</div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê³µì‚¬ê¸ˆì•¡</label>
                <div class="form-control-plaintext">{{ report.sConMoney|default:"-" }}</div>
            </div>
            <div class="form-col">
                <label class="form-label">ê³µì‚¬ê³„ì•½ì¼</label>
                <div class="form-control-plaintext">
                    {% if report.dateContract %}
                        {{ report.dateContract|date:"Y-m-d" }}
                    {% elif report.sDateContract %}
                        {{ report.sDateContract }}
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê³„ì•½ì„œ íŒŒì¼</label>
                <div class="form-control-plaintext">
                    {% if report.sFile %}
                        <a href="{{ report.sFile }}" target="_blank" class="link-display">
                            ğŸ“ ê³„ì•½ì„œ ë³´ê¸°
                        </a>
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
            <div class="form-col">
                <label class="form-label">ê³ ê° ë©”ëª¨</label>
                <div class="form-control-plaintext">{{ report.sClientMemo|default:"-" }}</div>
            </div>
        </div>

        <!-- ìˆ˜ì • ê°€ëŠ¥í•œ ì •ë³´ -->
        <div class="section-title">ê´€ë¦¬ ì •ë³´</div>

        <div class="form-row">
            <div class="form-col">
                <label for="noCompany" class="form-label">ì—…ì²´ ì„ íƒ</label>
                {% if mode == 'edit' %}
                    <select id="noCompany" name="noCompany" class="form-control">
                        <option value="0">ì„ íƒí•˜ì„¸ìš”</option>
                        {% for company in all_companies %}
                            <option value="{{ company.no }}" {% if company.no == report.noCompany %}selected{% endif %}>
                                {{ company.sName2|default:company.sName1 }}
                            </option>
                        {% endfor %}
                    </select>
                {% else %}
                    <div class="form-control-plaintext">
                        {% if report.company %}
                            {{ report.company.sName2|default:report.company.sName1 }}
                        {% else %}
                            ë¯¸ì§€ì •
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            <div class="form-col">
                <label for="sPost" class="form-label">ê²Œì‹œê¸€ ë§í¬</label>
                {% if mode == 'edit' %}
                    <input type="url" id="sPost" name="sPost" class="form-control"
                           value="{% if report.sPost %}{{ report.sPost }}{% else %}https://cafe.naver.com/pcarpenter/{% endif %}" placeholder="https://...">
                {% else %}
                    <div class="form-control-plaintext">
                        {% if report.sPost %}
                            <a href="{{ report.sPost }}" target="_blank" class="link-display" style="word-break: break-all;">
                                {{ report.sPost }}
                            </a>
                        {% else %}
                            -
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label for="noAssign" class="form-label">í• ë‹¹ ID</label>
                {% if mode == 'edit' %}
                    <input type="number" id="noAssign" name="noAssign" class="form-control"
                           value="{{ report.noAssign|default:'' }}">
                {% else %}
                    <div class="form-control-plaintext">{{ report.noAssign|default:"-" }}</div>
                {% endif %}
            </div>
            <div class="form-col">
                <label for="noCompanyReport" class="form-label">ê³„ì•½ë³´ê³  ID</label>
                {% if mode == 'edit' %}
                    <input type="number" id="noCompanyReport" name="noCompanyReport" class="form-control"
                           value="{{ report.noCompanyReport|default:'' }}">
                {% else %}
                    <div class="form-control-plaintext">{{ report.noCompanyReport|default:"-" }}</div>
                {% endif %}
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label for="nCheck" class="form-label">í™•ì¸ ìƒíƒœ</label>
                {% if mode == 'edit' %}
                    <select id="nCheck" name="nCheck" class="form-control">
                        <option value="0" {% if report.nCheck == 0 %}selected{% endif %}>ë¯¸í™•ì¸</option>
                        <option value="1" {% if report.nCheck == 1 %}selected{% endif %}>ë¶ˆí•„ìš”</option>
                        <option value="2" {% if report.nCheck == 2 %}selected{% endif %}>ê³„ì•½O</option>
                        <option value="3" {% if report.nCheck == 3 %}selected{% endif %}>ê³„ì•½X</option>
                    </select>
                {% else %}
                    <div class="form-control-plaintext">
                        {% if report.nCheck == 0 %}
                            <span class="badge badge-secondary">ë¯¸í™•ì¸</span>
                        {% elif report.nCheck == 1 %}
                            <span class="badge badge-warning">ë¶ˆí•„ìš”</span>
                        {% elif report.nCheck == 2 %}
                            <span class="badge badge-success">ê³„ì•½O</span>
                        {% else %}
                            <span class="badge badge-danger">ê³„ì•½X</span>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            <div class="form-col">
                <label for="sMemo" class="form-label">ë©”ëª¨</label>
                {% if mode == 'edit' %}
                    <input type="text" id="sMemo" name="sMemo" class="form-control"
                           value="{{ report.sMemo|default:'' }}" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                {% else %}
                    <div class="form-control-plaintext">{{ report.sMemo|default:"-" }}</div>
                {% endif %}
            </div>
        </div>

        <!-- ì†Œëª… ê´€ë ¨ ì •ë³´ -->
        <div class="section-title">ì†Œëª… ê´€ë ¨</div>

        <div class="form-row">
            <div class="form-col">
                <label for="dateExplain0" class="form-label">ì†Œëª…ìš”ì²­ ì˜ˆì •ì¼</label>
                {% if mode == 'edit' %}
                    <input type="date" id="dateExplain0" name="dateExplain0" class="form-control"
                           value="{{ report.dateExplain0|date:'Y-m-d'|default:'' }}">
                {% else %}
                    <div class="form-control-plaintext">
                        {% if report.dateExplain0 %}
                            {{ report.dateExplain0|date:"Y-m-d" }}
                        {% else %}
                            -
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            <div class="form-col">
                <label for="dateExplain1" class="form-label">ì†Œëª…ìš”ì²­ ì‹¤ì œì¼</label>
                {% if mode == 'edit' %}
                    <input type="date" id="dateExplain1" name="dateExplain1" class="form-control"
                           value="{{ report.dateExplain1|date:'Y-m-d'|default:'' }}">
                {% else %}
                    <div class="form-control-plaintext">
                        {% if report.dateExplain1 %}
                            {{ report.dateExplain1|date:"Y-m-d" }}
                        {% else %}
                            -
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="form-group">
            <label for="sExplain" class="form-label">ì†Œëª… ë‚´ìš©</label>
            {% if mode == 'edit' %}
                <textarea id="sExplain" name="sExplain" class="form-control"
                          rows="3" placeholder="ì†Œëª… ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">{{ report.sExplain|default:'' }}</textarea>
            {% else %}
                <div class="form-control-plaintext">{{ report.sExplain|default:"-"|linebreaks }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="sPunish" class="form-label">ì§•ê³„ ë‚´ìš©</label>
            {% if mode == 'edit' %}
                <textarea id="sPunish" name="sPunish" class="form-control"
                          rows="3" placeholder="ì§•ê³„ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">{{ report.sPunish|default:'' }}</textarea>
            {% else %}
                <div class="form-control-plaintext">{{ report.sPunish|default:"-"|linebreaks }}</div>
            {% endif %}
        </div>

        <!-- ë²„íŠ¼ ì˜ì—­ -->
        <div class="btn-group">
            {% if mode == 'edit' %}
                <button type="submit" class="btn btn-success">
                    ğŸ’¾ ì €ì¥
                </button>
                <a href="{% url 'contract:clientreport_detail' report.no %}" class="btn btn-secondary">
                    âŒ ì·¨ì†Œ
                </a>
            {% else %}
                <a href="{% url 'contract:clientreport_edit' report.no %}" class="btn btn-warning">
                    âœï¸ ìˆ˜ì •
                </a>
                <button type="button" onclick="deleteReport()" class="btn btn-danger">
                    ğŸ—‘ï¸ ì‚­ì œ
                </button>
            {% endif %}
            <a href="{% url 'contract:clientreport_list' %}" class="btn btn-primary">
                ğŸ“‹ ëª©ë¡ìœ¼ë¡œ
            </a>
        </div>
    </form>
</div>

<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                âš ï¸ ì‚­ì œ í™•ì¸
            </h3>
        </div>
        <div class="modal-body">
            ì •ë§ë¡œ ì´ ê³ ê°ê³„ì•½ë³´ê³ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
            ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </div>
        <div class="modal-footer">
            <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
            <button class="modal-btn modal-btn-danger" onclick="confirmDelete()">ì‚­ì œ</button>
        </div>
    </div>
</div>

<!-- ê²°ê³¼ ë©”ì‹œì§€ ëª¨ë‹¬ -->
<div id="messageModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="messageTitle">
                âœ… ì„±ê³µ
            </h3>
        </div>
        <div class="modal-body" id="messageBody">
            ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
        </div>
        <div class="modal-footer">
            <button class="modal-btn modal-btn-primary" onclick="closeMessageModal()">í™•ì¸</button>
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function deleteReport() {
    if (!confirm('ì •ë§ë¡œ ì´ ê³ ê°ê³„ì•½ë³´ê³ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    fetch("{% url 'contract:clientreport_delete' report.no %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = "{% url 'contract:clientreport_list' %}";
        } else {
            alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || ''));
        }
    })
    .catch(error => {
        alert('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        console.error(error);
    });
}
</script>

{% endblock %}
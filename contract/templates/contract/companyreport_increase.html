{% extends "staff/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}ê³µì‚¬ê¸ˆì•¡ ì¦ì•¡ ë³´ê³  - PMIS 2.0{% endblock %}
{% block page_title %}ê³µì‚¬ê¸ˆì•¡ ì¦ì•¡ ë³´ê³ {% endblock %}
{% block page_subtitle %}ê³„ì•½ë³´ê³ ì„œ ê³µì‚¬ê¸ˆì•¡ ì¦ì•¡ ì²˜ë¦¬{% endblock %}

{% block content %}
<style>
    /* detail í™”ë©´ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼ */
    .detail-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
        margin-top: 20px;
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }

    .main-title {
        font-size: 24px;
        font-weight: bold;
        color: #2d3748;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 3px solid #667eea;
        text-align: center;
    }

    .section-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-bottom: 20px;
        margin-top: 30px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }

    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-col {
        flex: 1;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #495057;
        font-size: 14px;
    }

    .required-field::after {
        content: " *";
        color: #f56565;
    }

    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.15s ease-in-out;
    }

    .form-control:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .form-control[readonly] {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .readonly-field {
        background-color: #f7fafc !important;
        cursor: not-allowed;
    }

    select.form-control {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right .75rem center;
        background-size: 16px 12px;
        padding-right: 2.25rem;
    }

    textarea.form-control {
        resize: vertical;
        min-height: 100px;
    }

    .amount-display {
        font-size: 1.1rem;
        font-weight: bold;
        color: #2d3748;
    }

    .amount-positive {
        color: #22543d;
        font-weight: bold;
    }

    .amount-negative {
        color: #742a2a;
        font-weight: bold;
    }

    .btn-calculate {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 5px;
        font-size: 12px;
        cursor: pointer;
        margin-left: 10px;
        white-space: nowrap;
    }

    .btn-calculate:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(72, 187, 120, 0.4);
    }

    .action-buttons {
        margin-top: 30px;
        display: flex;
        gap: 10px;
        justify-content: center;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
    }

    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
    }

    .btn-success {
        background: linear-gradient(135deg, #0f9d58 0%, #0a6f3f 100%);
        color: white;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(15, 157, 88, 0.4);
    }

    .btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: #333;
    }

    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
    }

    .info-text {
        font-size: 0.85rem;
        color: #718096;
        margin-top: 5px;
    }

    .point-info {
        background: #f7fafc;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
        }

        .action-buttons {
            flex-wrap: wrap;
        }

        .detail-container {
            padding: 20px;
        }
    }
</style>

<div class="detail-container">
    <form id="increaseForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- íƒ€ì´í‹€ -->
        <div class="main-title">
            {% if mode == 'edit' %}
                ê³µì‚¬ê¸ˆì•¡ ì¦ì•¡ ë³´ê³  ìˆ˜ì •
            {% else %}
                ê³µì‚¬ê¸ˆì•¡ ì¦ì•¡ ë³´ê³ 
            {% endif %}
        </div>

        <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ê¸°ë³¸ ì •ë³´</div>

        {% if mode == 'edit' %}
        <div class="form-row">
            <div class="form-col">
                <label class="form-label">No</label>
                <input type="text" class="form-control readonly-field" value="{{ report.no }}" readonly>
            </div>
            <div class="form-col">
                <label class="form-label">ì´ì „ë³´ê³  No</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="noPre" name="noPre" class="form-control"
                           value="{{ report.noPre }}"
                           onchange="fetchParentReportData(this.value)" style="flex: 1;">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="goToPreviousReport()"
                            id="goPrevBtn" style="white-space: nowrap;">
                        ë°”ë¡œê°€ê¸°
                    </button>
                </div>
            </div>
            <div class="form-col">
                <label class="form-label">íƒ€ì„ìŠ¤íƒ¬í”„</label>
                <input type="text" class="form-control readonly-field"
                       value="{% if report.timeStamp %}{{ report.timeStamp|date:'Y-m-d H:i:s' }}{% else %}ë¯¸ë“±ë¡{% endif %}" readonly>
            </div>
        </div>
        {% else %}
        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì´ì „ë³´ê³  No</label>
                <input type="text" class="form-control readonly-field" value="{{ report.noPre }}" readonly>
                <input type="hidden" name="noPre" value="{{ report.noPre }}">
            </div>
        </div>
        {% endif %}

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì—…ì²´ëª…(êµ¬ê¸€)</label>
                <input type="text" name="sCompanyName" id="sCompanyName" class="form-control"
                       value="{{ report.sCompanyName }}">
            </div>
            <div class="form-col">
                <label class="form-label">ì—…ì²´ëª…</label>
                <input type="text" id="company_name_display" class="form-control readonly-field" value="{{ company_name }}" readonly>
                <input type="hidden" name="noCompany" id="noCompany" value="{{ report.noCompany }}">
                <!-- noPre ë³€ê²½ ì‹œ ì—…ë°ì´íŠ¸ë˜ëŠ” hidden í•„ë“œë“¤ -->
                <input type="hidden" name="sName" id="sName" value="{{ report.sName }}">
                <input type="hidden" name="sPhone" id="sPhone" value="{{ report.sPhone }}">
                <input type="hidden" name="sPost" id="sPost" value="{{ report.sPost }}">
                <input type="hidden" name="noAssign" id="noAssign" value="{{ report.noAssign }}">
                <input type="hidden" name="sArea" id="sArea" value="{{ report.sArea }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê²Œì‹œê¸€ ë§í¬</label>
                <input type="text" id="sPost_display" class="form-control readonly-field" value="{{ report.sPost }}" readonly>
            </div>
            <div class="form-col">
                <label class="form-label">ì˜ë¢° ID</label>
                <input type="text" class="form-control readonly-field" value="{{ report.noOrder|default:'' }}" readonly>
                <input type="hidden" name="noOrder" value="{{ report.noOrder|default:'' }}">
            </div>
            <div class="form-col">
                <label class="form-label">í• ë‹¹ ID</label>
                <input type="text" id="noAssign_display" class="form-control readonly-field" value="{{ report.noAssign|default:'' }}" readonly>
            </div>
        </div>

        <!-- ê³µì‚¬ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ê³µì‚¬ ì •ë³´</div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ë³´ê³ êµ¬ë¶„</label>
                <input type="text" id="nType_display" class="form-control readonly-field" value="ì¦ì•¡(ì…ê¸ˆX)" readonly>
                <input type="hidden" name="nType" id="nType" value="{{ report.nType|default:2 }}">
            </div>
            <div class="form-col">
                <label class="form-label">ê³µì‚¬ ìœ í˜•</label>
                <select name="nConType" id="nConType" class="form-control readonly-field" disabled>
                    <option value="0" {% if report.nConType == 0 %}selected{% endif %}>[ì¹´í˜ê±´]ì¸í…Œë¦¬ì–´/ë¦¬ëª¨ë¸ë§/ê¸°íƒ€</option>
                    <option value="1" {% if report.nConType == 1 %}selected{% endif %}>[ì¹´í…Œê±´]ì‹ ì¶•/ì¦ì¶•/ê°œì¶•</option>
                    <option value="2" {% if report.nConType == 2 %}selected{% endif %}>[ì†Œê°œê±´]ì¸í…Œë¦¬ì–´/ë¦¬ëª¨ë¸ë§/ê¸°íƒ€</option>
                    <option value="3" {% if report.nConType == 3 %}selected{% endif %}>[ì†Œê°œê±´]ì‹ ì¶•/ì¦ì¶•/ê°œì¶•</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê³ ê° ì´ë¦„</label>
                <input type="text" id="sName_display" class="form-control readonly-field" value="{{ report.sName }}" readonly>
            </div>
            <div class="form-col">
                <label class="form-label">ê³ ê° í•¸ë“œí°</label>
                <input type="text" id="sPhone_display" class="form-control readonly-field" value="{{ report.sPhone }}" readonly>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê³µì‚¬ ì§€ì—­</label>
                <textarea id="sArea_display" class="form-control readonly-field" rows="2" readonly>{{ report.sArea }}</textarea>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label required-field">ì¦ì•¡ê³µì‚¬ ê³„ì•½ì¼</label>
                <input type="date" name="dateContract" id="dateContract" class="form-control" value="{{ report.dateContract|date:'Y-m-d' }}" required>
            </div>
            <div class="form-col">
                <label class="form-label">ê³µì‚¬ ì™„ë£Œì˜ˆì •ì¼</label>
                <input type="date" name="dateSchedule" id="dateSchedule" class="form-control" value="{{ report.dateSchedule|date:'Y-m-d' }}">
            </div>
        </div>

        <!-- ê¸ˆì•¡ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ê¸ˆì•¡ ì •ë³´</div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì´ì „ ë³´ê³  ê³µì‚¬ê¸ˆì•¡</label>
                <div class="amount-display">{{ report.nPreConMoney|intcomma }} ì› (VAT ë³„ë„)</div>
                <input type="hidden" id="nPreConMoney" name="nPreConMoney" value="{{ report.nPreConMoney }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì´ë²ˆ ë³´ê³  ì¦ì•¡ê¸ˆì•¡(êµ¬ê¸€)</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" name="sConMoney" id="sConMoney" class="form-control"
                           value="{{ report.sConMoney|default:'' }}"
                           placeholder="êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë³µì‚¬í•œ ê¸ˆì•¡">
                    <span>ì›</span>
                </div>
            </div>
            <div class="form-col">
                <label class="form-label required-field">ì´ë²ˆ ë³´ê³  ì¦ì•¡ê¸ˆì•¡</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" id="nConMoney_display" class="form-control money-input" value="{% if mode == 'edit' %}{{ report.nConMoney|intcomma|default:0 }}{% else %}0{% endif %}">
                    <input type="hidden" name="nConMoney" id="nConMoney" value="{% if mode == 'edit' %}{{ report.nConMoney|default:0 }}{% else %}0{% endif %}">
                    <span>ì› (VAT ë³„ë„)</span>
                    <button type="button" class="btn-calculate" onclick="convertToVatExcluded()">
                        ë¶€ê°€ì„¸ ë³„ë„ë¡œ ìë™ ë³€í™˜
                    </button>
                </div>
                <div class="info-text">ë°˜ë“œì‹œ VAT ë³„ë„ë¡œ +ê°’ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ìµœì¢… ê³µì‚¬ ê¸ˆì•¡</label>
                <div class="amount-display" id="totalConMoney_display">0 ì› (VAT ë³„ë„)</div>
                <input type="hidden" id="nTotalConMoney" value="0">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ìµœì¢… ê¸°ì¤€ (ì˜ˆìƒ) ìˆ˜ìˆ˜ë£Œ</label>
                <div class="amount-display" id="totalFee_display">0 ì› (VAT í¬í•¨)</div>
                <input type="hidden" id="nTotalFee" value="0">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì´ì „ ë³´ê³  ìˆ˜ìˆ˜ë£Œ</label>
                <div class="amount-display">{{ report.nPreFee|intcomma }} ì› (VAT í¬í•¨)</div>
                <input type="hidden" id="nPreFee" name="nPreFee" value="{{ report.nPreFee }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì´ë²ˆ ë³´ê³  (ì ìš©) ìˆ˜ìˆ˜ë£Œ</label>
                <div class="amount-display" id="nFee_display">0 ì› (VAT í¬í•¨)</div>
                <input type="hidden" name="nFee" id="nFee" value="0">
            </div>
        </div>

        <!-- í¬ì¸íŠ¸ ë° ì²­êµ¬ ì„¹ì…˜ -->
        <div class="section-title">í¬ì¸íŠ¸ ë° ì²­êµ¬</div>

        <div class="point-info">
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">ì”ì•¡ í¬ì¸íŠ¸</label>
                    <div class="amount-display">
                        <span id="remainPoint">0</span> í¬ì¸íŠ¸
                    </div>
                </div>
                <div class="form-col">
                    <div class="checkbox-group" style="margin-top: 25px;">
                        <input type="checkbox" id="useAllPoints" onclick="applyAllPoints()">
                        <label for="useAllPoints">ì „ë¶€ ì‚¬ìš©</label>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">ì ìš© í¬ì¸íŠ¸</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="text" id="nAppPoint_display" class="form-control money-input" value="{% if mode == 'edit' %}{{ report.nAppPoint|intcomma|default:0 }}{% else %}0{% endif %}">
                        <input type="hidden" name="nAppPoint" id="nAppPoint" value="{% if mode == 'edit' %}{{ report.nAppPoint|default:0 }}{% else %}0{% endif %}">
                        <span>í¬ì¸íŠ¸</span>
                        <button type="button" class="btn-calculate" onclick="deductPoint()" id="deductPointBtn" disabled>
                            í¬ì¸íŠ¸ ì°¨ê° ì ìš©
                        </button>
                    </div>
                    <div class="info-text">ì ìš© í¬ì¸íŠ¸ëŠ” ì”ì•¡ í¬ì¸íŠ¸ë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
            <div class="form-col">
                <label class="form-label">(ì ìš©) ì²­êµ¬ì•¡</label>
                <div class="amount-display" id="nDemand_display">0 ì› (VAT í¬í•¨)</div>
                <input type="hidden" name="nDemand" id="nDemand" value="0">
            </div>
            <div class="form-col">
                <div style="margin-top: 25px;">
                    <button type="button" class="btn btn-warning" onclick="sendInvoiceSMS()">
                        ì²­êµ¬ ë¬¸ì ë°œì†¡
                    </button>
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ì„ ìœ„í•œ ì‚¬ì—…ì</label>
                <select name="sTaxCompany" id="sTaxCompany_select" class="form-control">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    {% for tax_company in tax_companies %}
                    <option value="{{ tax_company }}"
                            {% if tax_company == report.sTaxCompany %}selected{% endif %}>
                        {{ tax_company }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- ì…ê¸ˆ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ì…ê¸ˆ ì •ë³´</div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì…ê¸ˆì•¡</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" id="nDeposit_display" class="form-control money-input" value="{% if mode == 'edit' %}{{ report.nDeposit|intcomma|default:0 }}{% else %}0{% endif %}">
                    <input type="hidden" name="nDeposit" id="nDeposit" value="{% if mode == 'edit' %}{{ report.nDeposit|default:0 }}{% else %}0{% endif %}">
                    <span>ì›</span>
                    <button type="button" class="btn-calculate" onclick="copyDemandToDeposit()">
                        ì²­êµ¬ì•¡ìœ¼ë¡œ ì…ê¸ˆì•¡ ì…ë ¥í•˜ê¸°
                    </button>
                </div>
            </div>
            <div class="form-col">
                <label class="form-label">ì…ê¸ˆì¼</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="date" name="dateDeposit" id="dateDeposit" class="form-control" value="{% if mode == 'edit' and report.dateDeposit %}{{ report.dateDeposit|date:'Y-m-d' }}{% endif %}">
                    <button type="button" class="btn-calculate" onclick="setTodayDeposit()">
                        ì…ê¸ˆì¼ ì˜¤ëŠ˜ë¡œ ì…ë ¥
                    </button>
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê³¼/ë¯¸ì…ê¸ˆ</label>
                <div class="amount-display" id="nExcess_display">
                    <span id="nExcess_amount">0</span> ì›
                </div>
                <input type="hidden" name="nExcess" id="nExcess" value="0">
                <div class="info-text">(+ì´ë©´ ê³¼ì…ê¸ˆ, -ì´ë©´ ë¯¸ì…ê¸ˆì…ë‹ˆë‹¤.)</div>
            </div>
            <div class="form-col">
                <div id="excessPointButton" style="margin-top: 25px; display: none;">
                    <button type="button" class="btn btn-success" onclick="accumulateExcessPoint()">
                        ê³¼ì…ê¸ˆ í¬ì¸íŠ¸ ì ë¦½
                    </button>
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê³¼ì…ê¸ˆì‹œ í™˜ë¶ˆë°©ì‹</label>
                <select name="nRefund" id="nRefund" class="form-control">
                    <option value="0" {% if report.nRefund == 0 %}selected{% endif %}>ê³„ì¢Œì´ì²´</option>
                    <option value="1" {% if report.nRefund == 1 %}selected{% endif %}>í¬ì¸íŠ¸ì ë¦½</option>
                </select>
            </div>
            <div class="form-col">
                <label class="form-label">í™˜ë¶ˆê³„ì¢Œ</label>
                <select name="sAccount" id="sAccount" class="form-control">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    {% for account in accounts %}
                    <option value="{{ account }}"
                            {% if account == report.sAccount %}selected{% endif %}>
                        {{ account }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- ì²¨ë¶€íŒŒì¼ ë° ë©”ëª¨ ì„¹ì…˜ -->
        <div class="section-title">ì²¨ë¶€íŒŒì¼ ë° ë©”ëª¨</div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì¦ë¹™ì„œë¥˜(êµ¬ê¸€)</label>
                <input type="text" name="sFile" class="form-control" value="{{ report.sFile|default:'' }}" placeholder="êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë§í¬">
            </div>
            <div class="form-col">
                <label class="form-label">ì¦ë¹™ì„œë¥˜</label>

                <!-- ê¸°ì¡´ ë‹¨ì¼ íŒŒì¼ í‘œì‹œ (í˜¸í™˜ì„±) -->
                {% if mode == 'edit' and report.file %}
                    <div style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                        <strong>ê¸°ì¡´ íŒŒì¼:</strong>
                        <a href="{{ report.file.url }}" target="_blank" style="color: #007bff; text-decoration: underline; margin-left: 10px;">
                            ğŸ“ {{ report.file.name|default:"íŒŒì¼ ë³´ê¸°" }}
                        </a>
                        <div style="color: #6c757d; font-size: 0.9em; margin-top: 5px;">
                            íŒŒì¼ í¬ê¸°: {{ report.file.size|filesizeformat }}
                        </div>
                    </div>
                {% endif %}

                <!-- ë‹¤ì¤‘ íŒŒì¼ ëª©ë¡ í‘œì‹œ -->
                {% if mode == 'edit' and report.pk and report.report_files.all %}
                <div class="uploaded-files mb-3">
                    <h6 class="text-muted">ì—…ë¡œë“œëœ íŒŒì¼:</h6>
                    <div class="file-list">
                        {% for file in report.report_files.all %}
                        <div class="file-item d-flex align-items-center mb-2" data-file-id="{{ file.no }}">
                            <a href="{{ file.file.url }}" target="_blank" class="flex-grow-1" style="color: #007bff;">
                                ğŸ“„ {{ file.original_name }}
                                <small class="text-muted">({{ file.file_size|filesizeformat }})</small>
                            </a>
                            <button type="button" class="btn btn-sm btn-danger ml-2 delete-file-btn"
                                    data-file-id="{{ file.no }}" data-file-name="{{ file.original_name }}">
                                ì‚­ì œ
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- ë‹¤ì¤‘ íŒŒì¼ ì—…ë¡œë“œ ì…ë ¥ -->
                <input type="file" name="files" class="form-control" multiple accept=".pdf,.jpg,.jpeg,.png">
                <small class="form-text text-muted">
                    ì—¬ëŸ¬ íŒŒì¼ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (Ctrl/Cmd + í´ë¦­)
                    {% if mode == 'edit' and report.file %}
                    <br>ìƒˆ íŒŒì¼ ì—…ë¡œë“œ ì‹œ ê¸°ì¡´ ë‹¨ì¼ íŒŒì¼ì€ ìœ ì§€ë©ë‹ˆë‹¤.
                    {% endif %}
                </small>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì—…ì²´ì—ì„œ ë‚¨ê¸´ ë§ì”€</label>
                <textarea name="sCompanyMemo" class="form-control" rows="3">{{ report.sCompanyMemo }}</textarea>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ìŠ¤í… ë©”ëª¨</label>
                <textarea name="sStaffMemo" class="form-control" rows="3">{{ report.sStaffMemo }}</textarea>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ë³´ê³ ì</label>
                <input type="text" class="form-control readonly-field" value="{% if current_staff %}{{ current_staff.sNick }}{% endif %}" readonly>
                <input type="hidden" name="sWorker" value="{% if current_staff %}{{ current_staff.sNick }}{% endif %}">
            </div>
        </div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="action-buttons">
            <button type="submit" class="btn btn-primary">
                {% if mode == 'edit' %}ìˆ˜ì •{% else %}ì œì¶œ{% endif %}
            </button>
            <a href="{% url 'contract:companyreport_list' %}" class="btn btn-secondary">ì·¨ì†Œ</a>
        </div>
    </form>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜
let companyNo = {{ report.noCompany }};
let currentStaffNick = "{% if current_staff %}{{ current_staff.sNick }}{% endif %}";
let nPreConMoney = {{ report.nPreConMoney }};
let nPreFee = {{ report.nPreFee }};
let nConType = {{ report.nConType }};

// TODO(human) - ì‹¤ì‹œê°„ ê³„ì‚° í•¨ìˆ˜ êµ¬í˜„
// ì´ í•¨ìˆ˜ëŠ” ëª¨ë“  ê¸ˆì•¡ í•„ë“œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤
function calculateAll() {
    // 1. ì…ë ¥ ê°’ ê°€ì ¸ì˜¤ê¸°
    const nConMoney = parseInt(document.getElementById('nConMoney').value) || 0;
    const nAppPoint = parseInt(document.getElementById('nAppPoint').value) || 0;
    const nDeposit = parseInt(document.getElementById('nDeposit').value) || 0;

    // 2. ìµœì¢… ê³µì‚¬ ê¸ˆì•¡ ê³„ì‚° (ì´ì „ ë³´ê³  ê³µì‚¬ê¸ˆì•¡ + ì¦ì•¡ê¸ˆì•¡)
    const nTotalConMoney = nPreConMoney + nConMoney;
    document.getElementById('nTotalConMoney').value = nTotalConMoney;
    document.getElementById('totalConMoney_display').textContent = nTotalConMoney.toLocaleString() + ' ì› (VAT ë³„ë„)';

    // 3. ìµœì¢… ê¸°ì¤€ ìˆ˜ìˆ˜ë£Œ ê³„ì‚°
    const nTotalFee = calculateFee(nConType, nTotalConMoney);
    document.getElementById('nTotalFee').value = nTotalFee;
    document.getElementById('totalFee_display').textContent = nTotalFee.toLocaleString() + ' ì› (VAT í¬í•¨)';

    // 4. ì´ë²ˆ ë³´ê³  ìˆ˜ìˆ˜ë£Œ ê³„ì‚° (ìµœì¢… ìˆ˜ìˆ˜ë£Œ - ì´ì „ ìˆ˜ìˆ˜ë£Œ)
    const nFee = nTotalFee - nPreFee;
    document.getElementById('nFee').value = nFee;
    document.getElementById('nFee_display').textContent = nFee.toLocaleString() + ' ì› (VAT í¬í•¨)';

    // 5. ì²­êµ¬ì•¡ ê³„ì‚° (ìˆ˜ìˆ˜ë£Œ - ì ìš© í¬ì¸íŠ¸)
    const nDemand = nFee - nAppPoint;
    document.getElementById('nDemand').value = nDemand;
    document.getElementById('nDemand_display').textContent = nDemand.toLocaleString() + ' ì› (VAT í¬í•¨)';

    // 6. ê³¼/ë¯¸ì…ê¸ˆ ê³„ì‚° (ì…ê¸ˆì•¡ - ì²­êµ¬ì•¡)
    const nExcess = nDeposit - nDemand;
    document.getElementById('nExcess').value = nExcess;
    const excessElement = document.getElementById('nExcess_amount');
    excessElement.textContent = nExcess.toLocaleString();
    excessElement.className = nExcess > 0 ? 'amount-positive' : (nExcess < 0 ? 'amount-negative' : '');

    // 7. ë²„íŠ¼ ì—…ë°ì´íŠ¸
    updateDeductButton();
    updateExcessPointButton();
}

// ê³µì‚¬ìœ í˜•ë³„ ìˆ˜ìˆ˜ë£Œ ê³„ì‚°
function calculateFee(conType, conMoney) {
    let fee = 0;

    switch(conType) {
        case 0: // ì¹´í˜ê±´ ì¸í…Œë¦¬ì–´
            if (conMoney <= 50000000) {
                fee = Math.round(conMoney * 0.055);
            } else {
                fee = Math.round(50000000 * 0.055 + (conMoney - 50000000) * 0.033);
            }
            break;
        case 1: // ì¹´í…Œê±´ ì‹ ì¶•
            fee = Math.round(conMoney * 0.033);
            break;
        case 2: // ì†Œê°œê±´ ì¸í…Œë¦¬ì–´
            fee = Math.round(conMoney * 0.033);
            break;
        case 3: // ì†Œê°œê±´ ì‹ ì¶•
            fee = Math.round(conMoney * 0.022);
            break;
    }

    return fee;
}

// VAT ë³„ë„ ë³€í™˜
function convertToVatExcluded() {
    const displayField = document.getElementById('nConMoney_display');
    const currentValue = parseFloat(displayField.value.replace(/,/g, '')) || 0;
    const converted = Math.round(currentValue / 1.1);

    document.getElementById('nConMoney').value = converted;
    displayField.value = converted.toLocaleString();

    calculateAll();
}

// ì „ë¶€ ì‚¬ìš© ì²´í¬ë°•ìŠ¤
function applyAllPoints() {
    const useAll = document.getElementById('useAllPoints').checked;
    const remainPoint = parseInt(document.getElementById('remainPoint').textContent.replace(/,/g, '')) || 0;
    const nFee = parseInt(document.getElementById('nFee').value) || 0;

    if (useAll) {
        const applyPoint = Math.min(remainPoint, nFee);
        document.getElementById('nAppPoint').value = applyPoint;
        document.getElementById('nAppPoint_display').value = applyPoint.toLocaleString();
    } else {
        document.getElementById('nAppPoint').value = 0;
        document.getElementById('nAppPoint_display').value = '0';
    }

    calculateAll();
}

// ì²­êµ¬ì•¡ìœ¼ë¡œ ì…ê¸ˆì•¡ ì…ë ¥
function copyDemandToDeposit() {
    const nDemand = parseInt(document.getElementById('nDemand').value) || 0;
    document.getElementById('nDeposit').value = nDemand;
    document.getElementById('nDeposit_display').value = nDemand.toLocaleString();

    calculateAll();
}

// ì…ê¸ˆì¼ ì˜¤ëŠ˜ë¡œ ì…ë ¥
function setTodayDeposit() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateDeposit').value = today;
    updateTypeByDeposit();
}

// ì…ê¸ˆì¼ì— ë”°ë¼ nType ì—…ë°ì´íŠ¸
function updateTypeByDeposit() {
    const dateDeposit = document.getElementById('dateDeposit').value;
    const nTypeField = document.getElementById('nType');
    const nTypeDisplay = document.getElementById('nType_display');

    if (dateDeposit && dateDeposit.trim() !== '') {
        nTypeField.value = 3; // ì¦ì•¡(ì…ê¸ˆO)
        nTypeDisplay.value = 'ì¦ì•¡(ì…ê¸ˆO)';
    } else {
        nTypeField.value = 2; // ì¦ì•¡(ì…ê¸ˆX)
        nTypeDisplay.value = 'ì¦ì•¡(ì…ê¸ˆX)';
    }
}

// í¬ì¸íŠ¸ ì°¨ê° ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
function updateDeductButton() {
    const nAppPoint = parseInt(document.getElementById('nAppPoint').value) || 0;
    document.getElementById('deductPointBtn').disabled = nAppPoint <= 0;
}

// ê³¼ì…ê¸ˆ í¬ì¸íŠ¸ ì ë¦½ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì œì–´
function updateExcessPointButton() {
    const nExcess = parseInt(document.getElementById('nExcess').value) || 0;
    const nRefund = parseInt(document.getElementById('nRefund').value) || 0;
    const buttonDiv = document.getElementById('excessPointButton');

    if (buttonDiv) {
        // nRefund=1ì´ê³  nExcess>0ì¸ ê²½ìš°ì—ë§Œ ë²„íŠ¼ í‘œì‹œ
        if (nRefund === 1 && nExcess > 0) {
            buttonDiv.style.display = 'block';
        } else {
            buttonDiv.style.display = 'none';
        }
    }
}

// í¬ì¸íŠ¸ ì°¨ê°
function deductPoint() {
    const nAppPoint = parseInt(document.getElementById('nAppPoint').value) || 0;
    const noPre = parseInt(document.querySelector('input[name="noPre"]').value) || null;

    if (nAppPoint <= 0) {
        alert('ì ìš© í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    if (!confirm(`${nAppPoint.toLocaleString()} í¬ì¸íŠ¸ë¥¼ ì°¨ê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    fetch('/contract/api/point-process/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            company_no: companyNo,
            type: 0, // ìˆ˜ìˆ˜ë£Œ ë‚©ë¶€
            use_point: nAppPoint,
            report_no: noPre, // ë¶€ëª¨ ë³´ê³ ì„œ ë²ˆí˜¸ (noPre)
            worker: currentStaffNick
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('í¬ì¸íŠ¸ê°€ ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤.');
            document.getElementById('remainPoint').textContent = data.remain_point.toLocaleString();
            loadRemainPoint(); // ì”ì•¡ í¬ì¸íŠ¸ ìƒˆë¡œê³ ì¹¨
        } else {
            alert('í¬ì¸íŠ¸ ì°¨ê° ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('í¬ì¸íŠ¸ ì°¨ê° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ê³¼ì…ê¸ˆ í¬ì¸íŠ¸ ì ë¦½
function accumulateExcessPoint() {
    const nExcess = parseInt(document.getElementById('nExcess').value) || 0;
    const noPre = parseInt(document.querySelector('input[name="noPre"]').value) || null;

    if (nExcess <= 0) {
        alert('ê³¼ì…ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    if (!confirm(`${nExcess.toLocaleString()} ì›ì„ í¬ì¸íŠ¸ë¡œ ì ë¦½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    fetch('/contract/api/point-process/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            company_no: companyNo,
            type: 2, // ê³¼/ë¯¸ì…ê¸ˆ
            use_point: nExcess,
            report_no: noPre, // ë¶€ëª¨ ë³´ê³ ì„œ ë²ˆí˜¸ (noPre)
            worker: currentStaffNick
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('ê³¼ì…ê¸ˆì´ í¬ì¸íŠ¸ë¡œ ì ë¦½ë˜ì—ˆìŠµë‹ˆë‹¤.');
            document.getElementById('remainPoint').textContent = data.remain_point.toLocaleString();
            loadRemainPoint(); // ì”ì•¡ í¬ì¸íŠ¸ ìƒˆë¡œê³ ì¹¨
        } else {
            alert('í¬ì¸íŠ¸ ì ë¦½ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('í¬ì¸íŠ¸ ì ë¦½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ì²­êµ¬ ë¬¸ì ë°œì†¡
function sendInvoiceSMS() {
    alert('ì²­êµ¬ ë¬¸ì ë°œì†¡ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
}

// ì”ì•¡ í¬ì¸íŠ¸ ë¡œë“œ
function loadRemainPoint() {
    if (companyNo > 0) {
        fetch(`/point/api/company-points/${companyNo}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('remainPoint').textContent = data.remain_point.toLocaleString();
            })
            .catch(error => {
                console.error('í¬ì¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('remainPoint').textContent = '0';
            });
    }
}

// ê¸ˆì•¡ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
function initMoneyInputs() {
    const moneyInputs = document.querySelectorAll('.money-input');

    moneyInputs.forEach(input => {
        // ì´ˆê¸° ê°’ í¬ë§·íŒ…
        if (input.value) {
            input.value = formatNumber(input.value);
        }

        // ì…ë ¥ ì´ë²¤íŠ¸
        input.addEventListener('input', function(e) {
            const formatted = formatNumber(e.target.value);
            e.target.value = formatted;

            // hidden í•„ë“œ ì—…ë°ì´íŠ¸
            const hiddenFieldId = e.target.id.replace('_display', '');
            const hiddenField = document.getElementById(hiddenFieldId);
            if (hiddenField) {
                hiddenField.value = removeCommas(formatted);
            }

            calculateAll();
        });
    });
}

// ìˆ«ì í¬ë§·íŒ…
function formatNumber(value) {
    value = value.toString().replace(/[^0-9-]/g, '');
    const isNegative = value.startsWith('-');
    value = value.replace(/-/g, '');
    const number = parseInt(value) || 0;
    const formatted = number.toLocaleString();
    return isNegative ? '-' + formatted : formatted;
}

// ì½¤ë§ˆ ì œê±°
function removeCommas(value) {
    if (!value) return '0';
    // ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ê³  ëª¨ë“  ì‰¼í‘œì™€ ê³µë°± ì œê±°, ìˆ«ìì™€ ë§ˆì´ë„ˆìŠ¤ë§Œ ë‚¨ê¹€
    return value.toString().replace(/[^0-9-]/g, '');
}

// í¼ ì œì¶œ í•¸ë“¤ëŸ¬
function handleFormSubmit(event) {
    console.log('[FORM] Submit handler called');

    // ëª¨ë“  money í•„ë“œ ë™ê¸°í™”
    syncAllMoneyFields();

    // ë””ë²„ê¹…: ìµœì¢… ê°’ í™•ì¸
    const formData = new FormData(document.getElementById('increaseForm'));
    console.log('[FORM] Final values:');
    console.log('- nConMoney:', formData.get('nConMoney'));
    console.log('- nAppPoint:', formData.get('nAppPoint'));
    console.log('- nDeposit:', formData.get('nDeposit'));
    console.log('- file:', formData.get('file'));

    // í¼ ì œì¶œ ê³„ì† ì§„í–‰
    return true;
}

// í¼ ì œì¶œ ì „ ëª¨ë“  money í•„ë“œ ë™ê¸°í™”
function syncAllMoneyFields() {
    console.log('[SYNC] Starting sync...');

    // ëª¨ë“  money input í•„ë“œ ì°¾ê¸°
    const moneyFields = [
        { display: 'nConMoney_display', hidden: 'nConMoney' },
        { display: 'nAppPoint_display', hidden: 'nAppPoint' },
        { display: 'nDeposit_display', hidden: 'nDeposit' }
    ];

    moneyFields.forEach(field => {
        const displayEl = document.getElementById(field.display);
        const hiddenEl = document.getElementById(field.hidden);

        if (displayEl && hiddenEl) {
            const displayValue = displayEl.value || '0';
            const cleanValue = removeCommas(displayValue);
            hiddenEl.value = cleanValue;
            console.log(`[SYNC] ${field.hidden}: "${displayValue}" -> "${cleanValue}"`);
        }
    });

    console.log('[SYNC] Sync complete!');
}

// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// íŒŒì¼ ì‚­ì œ í•¨ìˆ˜
function deleteReportFile(fileId) {
    const csrfToken = getCookie('csrftoken');

    fetch(`/contract/api/report-file/${fileId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // íŒŒì¼ í•­ëª© ì œê±°
            const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
            if (fileItem) {
                fileItem.remove();
            }

            // íŒŒì¼ ëª©ë¡ì´ ë¹„ì—ˆìœ¼ë©´ ì „ì²´ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const fileList = document.querySelector('.file-list');
            if (fileList && fileList.children.length === 0) {
                const uploadedFilesSection = document.querySelector('.uploaded-files');
                if (uploadedFilesSection) {
                    uploadedFilesSection.remove();
                }
            }

            alert(data.message);
        } else {
            alert('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ì´ì „ ë³´ê³ ì„œë¡œ ë°”ë¡œê°€ê¸°
function goToPreviousReport() {
    const noPre = document.getElementById('noPre').value;

    if (!noPre) {
        alert('ì´ì „ë³´ê³  Noê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    console.log('ì´ì „ ë³´ê³ ì„œë¡œ ì´ë™:', noPre);

    // API í˜¸ì¶œí•˜ì—¬ ë³´ê³ ì„œ íƒ€ì… í™•ì¸
    fetch(`/contract/api/companyreport/${noPre}/data/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data) {
            const reportData = data.data;

            // nTypeì— ë”°ë¼ ì ì ˆí•œ ìˆ˜ì • í™”ë©´ìœ¼ë¡œ ì´ë™
            if (reportData.nType !== undefined) {
                const nType = reportData.nType;
                let editUrl = '';

                if (nType === 0 || nType === 1) {
                    // ê³„ì•½
                    editUrl = `/contract/companyreport/${noPre}/edit/`;
                } else if (nType === 2 || nType === 3) {
                    // ì¦ì•¡
                    editUrl = `/contract/companyreport/${noPre}/increase/`;
                } else if (nType === 4 || nType === 5) {
                    // ê°ì•¡
                    editUrl = `/contract/companyreport/${noPre}/decrease/`;
                } else if (nType === 6 || nType === 7) {
                    // ì·¨ì†Œ
                    editUrl = `/contract/companyreport/${noPre}/cancel/`;
                } else {
                    // ê¸°íƒ€ - ê¸°ë³¸ í¸ì§‘ í™”ë©´
                    editUrl = `/contract/companyreport/${noPre}/edit/`;
                }

                // ìƒˆ ì°½ì—ì„œ ì—´ê¸° (í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë‚´ìš© ë³´ì¡´)
                window.open(editUrl, '_blank');
            } else {
                // nType ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ìƒì„¸ í™”ë©´ìœ¼ë¡œ
                window.open(`/contract/companyreport/${noPre}/detail/`, '_blank');
            }
        } else {
            alert('ì´ì „ ë³´ê³ ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // ì—ëŸ¬ ë°œìƒì‹œ ê¸°ë³¸ ìƒì„¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        window.open(`/contract/companyreport/${noPre}/detail/`, '_blank');
    });
}

// ì´ì „ ë³´ê³  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
function fetchParentReportData(noPre) {
    console.log('fetchParentReportData called with noPre:', noPre);
    if (!noPre) {
        console.log('No noPre value, returning');
        return;
    }

    // í˜„ì¬ ë³´ê³ ì„œ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸° (ìˆ˜ì • ëª¨ë“œì¼ ë•Œë§Œ ì¡´ì¬)
    {% if mode == 'edit' %}
    const currentNo = {{ report.no }};

    // ìê¸° ìì‹ ì„ ì´ì „ ë³´ê³ ë¡œ ì„¤ì •í•˜ëŠ”ì§€ í™•ì¸
    if (parseInt(noPre) === currentNo) {
        alert('ì´ì „ë³´ê³  NoëŠ” í˜„ì¬ ë³´ê³ ì„œ ë²ˆí˜¸ì™€ ê°™ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        document.getElementById('noPre').value = '';
        return;
    }
    {% endif %}

    const csrfToken = getCookie('csrftoken');
    console.log('CSRF Token:', csrfToken);

    const apiUrl = `/contract/api/companyreport/${noPre}/data/`;
    console.log('Fetching from URL:', apiUrl);

    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'  // ì„¸ì…˜ ì¿ í‚¤ë¥¼ í¬í•¨í•˜ë„ë¡ ì„¤ì •
    })
    .then(response => {
        console.log('API Response received');
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        console.log('Response headers:', response.headers);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        return response.json();
    })
    .then(data => {
        console.log('JSON parsed successfully');
        console.log('API Response data:', data);
        if (data.success) {
            const reportData = data.data;

            // noNextê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸ (ë‹¤ë¥¸ ë³´ê³ ì„œì— ì´ë¯¸ ì—°ê²°ë¨)
            // ë‹¨, noNextê°€ í˜„ì¬ ë³´ê³ ì„œ ë²ˆí˜¸ì™€ ê°™ë‹¤ë©´ ê¸°ì¡´ ì—°ê²°ì´ë¯€ë¡œ í—ˆìš©
            {% if mode == 'edit' %}
            if (reportData.noNext && reportData.noNext !== currentNo) {
                alert(`ì´ì „ë³´ê³  #${noPre}ëŠ” ì´ë¯¸ ë‹¤ë¥¸ ë³´ê³ ì„œ(#${reportData.noNext})ì— ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
                document.getElementById('noPre').value = '';
                return;
            }
            {% else %}
            // ì‹ ê·œ ìƒì„± ëª¨ë“œì—ì„œëŠ” noNextê°€ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ì°¨ë‹¨
            if (reportData.noNext) {
                alert(`ì´ì „ë³´ê³  #${noPre}ëŠ” ì´ë¯¸ ë‹¤ë¥¸ ë³´ê³ ì„œ(#${reportData.noNext})ì— ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
                document.getElementById('noPre').value = '';
                return;
            }
            {% endif %}

            // nType ê²€ì¦ - ì¦ì•¡ì€ ê³„ì•½(0 ë˜ëŠ” 1) íƒ€ì…ì˜ ë³´ê³ ì„œë§Œ ì´ì „ë³´ê³ ë¡œ ì„ íƒ ê°€ëŠ¥
            if (reportData.nType !== undefined && reportData.nType !== 0 && reportData.nType !== 1) {
                const typeLabels = {
                    2: 'ì¦ì•¡(ì…ê¸ˆX)', 3: 'ì¦ì•¡(ì…ê¸ˆO)',
                    4: 'ê°ì•¡(í™˜ë¶ˆX)', 5: 'ê°ì•¡(í™˜ë¶ˆO)',
                    6: 'ì·¨ì†Œ(í™˜ë¶ˆX)', 7: 'ì·¨ì†Œ(í™˜ë¶ˆO)'
                };
                const typeLabel = typeLabels[reportData.nType] || `íƒ€ì… ${reportData.nType}`;
                alert(`ì´ì „ë³´ê³  #${noPre}ëŠ” ${typeLabel} ë³´ê³ ì„œì…ë‹ˆë‹¤.\nì¦ì•¡ ë³´ê³ ì˜ ì´ì „ë³´ê³ ëŠ” ê³„ì•½ íƒ€ì…(ê³„ì•½(ì…ê¸ˆX) ë˜ëŠ” ê³„ì•½(ì…ê¸ˆO))ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                document.getElementById('noPre').value = '';
                return;
            }

            // í•„ë“œ ì—…ë°ì´íŠ¸ - ê° í•„ë“œë¥¼ ì•ˆì „í•˜ê²Œ ì—…ë°ì´íŠ¸
            const updateField = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value || '';
                    // Hidden í•„ë“œì¸ì§€ í™•ì¸
                    const fieldType = element.type === 'hidden' ? '(hidden)' : '';
                    console.log(`Updated ${id} ${fieldType} with value:`, value);
                } else {
                    console.warn(`Element with ID '${id}' not found`);
                }
            };

            // noCompany í•„ë“œ ì—…ë°ì´íŠ¸
            updateField('noCompany', reportData.noCompany);

            // ì—…ì²´ëª… í‘œì‹œ í•„ë“œ ì—…ë°ì´íŠ¸ (readonly)
            const companyNameDisplay = document.getElementById('company_name_display');
            if (companyNameDisplay && reportData.companyName) {
                companyNameDisplay.value = reportData.companyName;
                console.log('Updated company_name_display with:', reportData.companyName);
            }

            // sCompanyNameì€ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ìê°€ ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ ìœ ì§€)
            console.log('sCompanyName í•„ë“œëŠ” ê¸°ì¡´ ê°’ ìœ ì§€ (ì‚¬ìš©ì ìˆ˜ì • ê°€ëŠ¥)');

            // ë‚˜ë¨¸ì§€ í•„ë“œë“¤ë„ ì•ˆì „í•˜ê²Œ ì—…ë°ì´íŠ¸
            // Hidden í•„ë“œ ì—…ë°ì´íŠ¸
            updateField('sName', reportData.sName);
            updateField('sPhone', reportData.sPhone);
            updateField('sPost', reportData.sPost);
            updateField('noAssign', reportData.noAssign);
            updateField('noOrder', reportData.noOrder);
            updateField('sArea', reportData.sArea);

            // nConType select í•„ë“œ ì—…ë°ì´íŠ¸ (ê³µì‚¬ ìœ í˜• - disabled)
            const nConTypeSelect = document.getElementById('nConType');
            if (nConTypeSelect) {
                // disabled ìƒíƒœì—¬ë„ valueëŠ” ë³€ê²½ ê°€ëŠ¥
                nConTypeSelect.value = String(reportData.nConType || 0);
                console.log('Updated nConType select (disabled) with value:', reportData.nConType);
            }

            // nRefund select í•„ë“œ ì—…ë°ì´íŠ¸ (í™˜ë¶ˆë°©ì‹)
            const nRefundSelect = document.getElementById('nRefund');
            if (nRefundSelect) {
                // ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ (ì˜µì…˜ valueê°€ 0, 1ì´ë¯€ë¡œ)
                nRefundSelect.value = String(reportData.nRefund || 0);
                console.log('Updated nRefund select with value:', reportData.nRefund);
            }

            // sTaxCompany ë“œë¡­ë‹¤ìš´ ì˜µì…˜ì„ License ì •ë³´ë¡œ ì—…ë°ì´íŠ¸
            const sTaxCompanySelect = document.getElementById('sTaxCompany_select');
            if (sTaxCompanySelect && reportData.licenses) {
                // ê¸°ì¡´ ì˜µì…˜ ëª¨ë‘ ì œê±° (ì²« ë²ˆì§¸ 'ì„ íƒí•˜ì„¸ìš”' ì œì™¸)
                while (sTaxCompanySelect.options.length > 1) {
                    sTaxCompanySelect.remove(1);
                }

                // License ì •ë³´ë¡œ ìƒˆ ì˜µì…˜ ì¶”ê°€
                const addedCompanies = new Set(); // ì¤‘ë³µ ë°©ì§€
                reportData.licenses.forEach(license => {
                    if (license.sCompanyName && !addedCompanies.has(license.sCompanyName)) {
                        const option = document.createElement('option');
                        option.value = license.sCompanyName;
                        option.textContent = license.sCompanyName;
                        sTaxCompanySelect.appendChild(option);
                        addedCompanies.add(license.sCompanyName);
                    }
                });

                // ì´ì „ì— ì„ íƒëœ ê°’ì´ ìˆìœ¼ë©´ ì„ íƒ
                if (reportData.sTaxCompany) {
                    sTaxCompanySelect.value = reportData.sTaxCompany;
                    console.log('Updated sTaxCompany_select with licenses and selected:', reportData.sTaxCompany);
                }
            }

            // Display í•„ë“œë„ ì—…ë°ì´íŠ¸ (í™”ë©´ì— í‘œì‹œë˜ëŠ” readonly í•„ë“œ)
            updateField('sName_display', reportData.sName);
            updateField('sPhone_display', reportData.sPhone);
            updateField('sPost_display', reportData.sPost);
            updateField('noAssign_display', reportData.noAssign);

            // textareaëŠ” ë³„ë„ ì²˜ë¦¬
            const sAreaDisplay = document.getElementById('sArea_display');
            if (sAreaDisplay) {
                sAreaDisplay.value = reportData.sArea || '';
                console.log('Updated sArea_display (textarea) with value:', reportData.sArea);
            }

            // í™˜ë¶ˆê³„ì¢Œ ë“œë¡­ë‹¤ìš´ ì˜µì…˜ì„ License ì •ë³´ë¡œ ì—…ë°ì´íŠ¸
            const sAccountSelect = document.getElementById('sAccount');
            if (sAccountSelect && reportData.licenses) {
                // ê¸°ì¡´ ì˜µì…˜ ëª¨ë‘ ì œê±° (ì²« ë²ˆì§¸ 'ì„ íƒí•˜ì„¸ìš”' ì œì™¸)
                while (sAccountSelect.options.length > 1) {
                    sAccountSelect.remove(1);
                }

                // License ì •ë³´ë¡œ ìƒˆ ì˜µì…˜ ì¶”ê°€
                const addedAccounts = new Set(); // ì¤‘ë³µ ë°©ì§€
                reportData.licenses.forEach(license => {
                    if (license.sAccount && !addedAccounts.has(license.sAccount)) {
                        const option = document.createElement('option');
                        option.value = license.sAccount;
                        option.textContent = license.sAccount;
                        sAccountSelect.appendChild(option);
                        addedAccounts.add(license.sAccount);
                    }
                });

                // ì´ì „ì— ì„ íƒëœ ê°’ì´ ìˆìœ¼ë©´ ì„ íƒ
                if (reportData.sAccount) {
                    sAccountSelect.value = reportData.sAccount;
                    console.log('Updated sAccount with licenses and selected:', reportData.sAccount);
                }
            } else if (!sAccountSelect) {
                console.warn('sAccount select not found');
            }

            // ë‚ ì§œ í•„ë“œëŠ” ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ (ì¦ì•¡ ê³„ì•½ì˜ ë…ë¦½ì ì¸ ë‚ ì§œ ìœ ì§€)
            // updateField('dateContract', reportData.dateContract);
            // updateField('dateSchedule', reportData.dateSchedule);
            console.log('ë‚ ì§œ í•„ë“œ(dateContract, dateSchedule)ëŠ” ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ - í˜„ì¬ ê°’ ìœ ì§€');

            // ì´ì „ ë³´ê³ ì˜ nConMoneyë¥¼ í˜„ì¬ì˜ nPreConMoneyë¡œ ì„¤ì •
            if (reportData.nConMoney !== undefined) {
                const nPreConMoneyInput = document.getElementById('nPreConMoney');

                if (nPreConMoneyInput) {
                    nPreConMoneyInput.value = reportData.nConMoney || 0;
                    // ì „ì—­ ë³€ìˆ˜ë„ ì—…ë°ì´íŠ¸
                    nPreConMoney = reportData.nConMoney || 0;
                    console.log('Updated nPreConMoney with previous report nConMoney:', reportData.nConMoney);

                    // ì´ì „ ë³´ê³  ê³µì‚¬ê¸ˆì•¡ í‘œì‹œ div ì—…ë°ì´íŠ¸
                    const displayDiv = nPreConMoneyInput.previousElementSibling;
                    if (displayDiv && displayDiv.classList.contains('amount-display')) {
                        displayDiv.textContent = (reportData.nConMoney || 0).toLocaleString() + ' ì› (VAT ë³„ë„)';
                        console.log('Updated nPreConMoney display div');
                    }
                }
            }

            // ì´ì „ ë³´ê³ ì˜ nFeeë¥¼ í˜„ì¬ì˜ nPreFeeë¡œ ì„¤ì •
            if (reportData.nFee !== undefined) {
                const nPreFeeInput = document.getElementById('nPreFee');

                if (nPreFeeInput) {
                    nPreFeeInput.value = reportData.nFee || 0;
                    // ì „ì—­ ë³€ìˆ˜ë„ ì—…ë°ì´íŠ¸
                    nPreFee = reportData.nFee || 0;
                    console.log('Updated nPreFee with previous report nFee:', reportData.nFee);

                    // ì´ì „ ë³´ê³  ìˆ˜ìˆ˜ë£Œ í‘œì‹œ div ì—…ë°ì´íŠ¸
                    const displayDiv = nPreFeeInput.previousElementSibling;
                    if (displayDiv && displayDiv.classList.contains('amount-display')) {
                        displayDiv.textContent = (reportData.nFee || 0).toLocaleString() + ' ì› (VAT í¬í•¨)';
                        console.log('Updated nPreFee display div');
                    }
                }
            }

            // ê¸ˆì•¡ì´ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ ì¬ê³„ì‚° ì‹¤í–‰
            if (typeof calculateAll === 'function') {
                calculateAll();
                console.log('Recalculated all amounts after loading previous report data');
            }

            console.log('ì´ì „ ë³´ê³  ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', reportData);
        } else {
            alert('ì´ì „ ë³´ê³  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Fetch Error Details:', error);
        console.error('Error Type:', error.name);
        console.error('Error Message:', error.message);
        console.error('Error Stack:', error.stack);
        alert('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initMoneyInputs();
    loadRemainPoint();

    // ì…ê¸ˆì¼ ë³€ê²½ ê°ì§€
    document.getElementById('dateDeposit').addEventListener('change', updateTypeByDeposit);

    // í™˜ë¶ˆë°©ì‹ ë³€ê²½ ê°ì§€
    document.getElementById('nRefund').addEventListener('change', updateExcessPointButton);

    // ìˆ˜ì • ëª¨ë“œì¼ ë•ŒëŠ” í…œí”Œë¦¿ì—ì„œ ì´ë¯¸ intcommaë¡œ í¬ë§·íŒ…ë¨
    {% if mode == 'edit' %}
    // ì´ë¯¸ í…œí”Œë¦¿ì—ì„œ ì²œ ë‹¨ìœ„ êµ¬ë¶„ì ì ìš©ë¨
    console.log('Edit mode - values already formatted with commas');
    {% endif %}

    // íŒŒì¼ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.querySelectorAll('.delete-file-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const fileId = this.dataset.fileId;
            const fileName = this.dataset.fileName;

            if (confirm(`"${fileName}" íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                deleteReportFile(fileId);
            }
        });
    })

    // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    const form = document.getElementById('increaseForm');
    form.addEventListener('submit', function(event) {
        console.log('=== FORM SUBMIT EVENT ===');

        // ëª¨ë“  display í•„ë“œì˜ ê°’ì„ hidden í•„ë“œë¡œ ë³µì‚¬ (ì‰¼í‘œ ì œê±°)
        const fields = [
            { display: 'nConMoney_display', hidden: 'nConMoney' },
            { display: 'nAppPoint_display', hidden: 'nAppPoint' },
            { display: 'nDeposit_display', hidden: 'nDeposit' }
        ];

        fields.forEach(field => {
            const displayEl = document.getElementById(field.display);
            const hiddenEl = document.getElementById(field.hidden);

            if (displayEl && hiddenEl) {
                // ì‰¼í‘œì™€ ëª¨ë“  ë¹„ìˆ«ì ë¬¸ì ì œê±°
                const cleanValue = (displayEl.value || '0').replace(/[^0-9-]/g, '');
                hiddenEl.value = cleanValue || '0';
                console.log(`${field.hidden}: display="${displayEl.value}" -> hidden="${hiddenEl.value}"`);
            }
        });

        // íŒŒì¼ í™•ì¸
        const fileInput = document.querySelector('input[name="file"]');
        if (fileInput && fileInput.files.length > 0) {
            console.log('File selected:', fileInput.files[0].name);
        } else {
            console.log('No file selected');
        }

        console.log('=== FORM WILL SUBMIT ===');
        // í¼ ì œì¶œ ê³„ì†
        return true;
    });

    // ì´ˆê¸° ê³„ì‚°
    calculateAll();
});
</script>
{% endblock %}

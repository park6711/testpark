{% extends "staff/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{% if mode == 'edit' %}ì·¨ì†Œ ë³´ê³  ìˆ˜ì •{% else %}ê³„ì•½ ì·¨ì†Œ ë³´ê³ {% endif %} - PMIS 2.0{% endblock %}
{% block page_title %}{% if mode == 'edit' %}ì·¨ì†Œ ë³´ê³  ìˆ˜ì •{% else %}ê³„ì•½ ì·¨ì†Œ ë³´ê³ {% endif %}{% endblock %}
{% block page_subtitle %}{% if mode == 'edit' %}ê³„ì•½ë³´ê³ ì„œ #{{ report.no }} ìˆ˜ì •{% else %}ê³„ì•½ ì·¨ì†Œ ì²˜ë¦¬{% endif %}{% endblock %}

{% block content %}
<style>
    .detail-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
        margin-top: 20px;
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }

    .main-title {
        font-size: 24px;
        font-weight: bold;
        color: #2d3748;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 3px solid #dc3545;
        text-align: center;
    }

    .section-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-bottom: 20px;
        margin-top: 30px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }

    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-col {
        flex: 1;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #495057;
        font-size: 14px;
    }

    .required-field::after {
        content: " *";
        color: #f56565;
    }

    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.15s ease-in-out;
    }

    .form-control:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .readonly-field {
        background-color: #f7fafc !important;
        cursor: not-allowed;
    }

    .amount-display {
        padding: 10px 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
        font-size: 16px;
        font-weight: bold;
        color: #dc3545;
    }

    .btn-point {
        padding: 6px 12px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }

    .btn-point:hover {
        background-color: #218838;
    }

    .btn-point:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    .info-text {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
    }

    .btn-submit {
        background-color: #007bff;
        color: white;
        padding: 10px 30px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        margin-right: 10px;
    }

    .btn-submit:hover {
        background-color: #0056b3;
    }

    .btn-cancel {
        background-color: #6c757d;
        color: white;
        padding: 10px 30px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
    }

    .btn-cancel:hover {
        background-color: #5a6268;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 5px;
    }

    .money-input {
        text-align: right;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
    }
</style>

<div class="detail-container">
    <form id="cancelForm" method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="main-title">{% if mode == 'edit' %}ì·¨ì†Œ ë³´ê³  ìˆ˜ì •{% else %}ê³„ì•½ ì·¨ì†Œ ë³´ê³ {% endif %}</div>

        <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ê¸°ë³¸ ì •ë³´</div>

        {% if mode == 'edit' %}
        <div class="form-row">
            <div class="form-col">
                <label class="form-label">No</label>
                <input type="text" class="form-control readonly-field" value="{{ report.no }}" readonly>
            </div>
            <div class="form-col">
                <label class="form-label">ì´ì „ë³´ê³  No</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" class="form-control" id="noPre" name="noPre" value="{{ report.noPre }}"
                           onchange="fetchParentReportData(this.value)" style="flex: 1;">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="goToPreviousReport()"
                            id="goPrevBtn" style="white-space: nowrap;">
                        ë°”ë¡œê°€ê¸°
                    </button>
                </div>
            </div>
            <div class="form-col">
                <label class="form-label">íƒ€ì„ìŠ¤íƒ¬í”„</label>
                <input type="text" class="form-control readonly-field"
                       value="{% if report.timeStamp %}{{ report.timeStamp|date:'Y-m-d H:i:s' }}{% else %}ë¯¸ë“±ë¡{% endif %}" readonly>
            </div>
        </div>
        {% else %}
        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì´ì „ë³´ê³  No</label>
                <input type="text" class="form-control readonly-field" value="{{ report.noPre }}" readonly>
                <input type="hidden" id="noPre" name="noPre" value="{{ report.noPre }}">
            </div>
        </div>
        {% endif %}

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì—…ì²´ëª…(êµ¬ê¸€)</label>
                <input type="text" class="form-control" id="sCompanyName" name="sCompanyName" value="{{ report.sCompanyName }}">
            </div>
            <div class="form-col">
                <label class="form-label">ì—…ì²´ëª…</label>
                <input type="text" class="form-control readonly-field" id="companyName_display" value="{{ company_name }}" readonly>
                <input type="hidden" name="noCompany" id="noCompany" value="{{ report.noCompany }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê²Œì‹œê¸€ ë§í¬</label>
                <input type="text" class="form-control readonly-field" id="sPost" name="sPost" value="{{ report.sPost }}" readonly>
            </div>
            <div class="form-col">
                <label class="form-label">ì˜ë¢° ID</label>
                <input type="text" class="form-control readonly-field" id="noOrder" name="noOrder" value="{{ report.noOrder|default:'' }}" readonly>
            </div>
            <div class="form-col">
                <label class="form-label">í• ë‹¹ ID</label>
                <input type="text" class="form-control readonly-field" id="noAssign" name="noAssign" value="{{ report.noAssign|default:'' }}" readonly>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ë³´ê³ êµ¬ë¶„</label>
                <input type="text" id="nType_display" class="form-control readonly-field" value="ì·¨ì†Œ(í™˜ë¶ˆX)" readonly>
                <input type="hidden" name="nType" id="nType" value="6">
            </div>
            <div class="form-col">
                <label class="form-label">ê³µì‚¬ ìœ í˜•</label>
                <input type="text" class="form-control readonly-field" id="nConType_display" value="{{ report.get_nConType_display }}" readonly>
                <input type="hidden" name="nConType" id="nConType" value="{{ report.nConType }}">
            </div>
        </div>

        <!-- ê³ ê° ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ê³ ê° ì •ë³´</div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê³ ê° ì´ë¦„</label>
                <input type="text" class="form-control readonly-field" id="sName" name="sName" value="{{ report.sName }}" readonly>
            </div>
            <div class="form-col">
                <label class="form-label">ê³ ê° í•¸ë“œí°</label>
                <input type="text" class="form-control readonly-field" id="sPhone" name="sPhone" value="{{ report.sPhone }}" readonly>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê³µì‚¬ ì§€ì—­</label>
                <input type="text" class="form-control readonly-field" id="sArea" name="sArea" value="{{ report.sArea }}" readonly>
            </div>
        </div>

        <!-- ì¼ì • ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ì¼ì • ì •ë³´</div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê³µì‚¬ ê³„ì•½ì¼</label>
                <input type="date" name="dateContract" id="dateContract" class="form-control readonly-field"
                       value="{{ report.dateContract|date:'Y-m-d' }}" readonly>
            </div>
            <div class="form-col">
                <label class="form-label">ê³µì‚¬ ì™„ë£Œì˜ˆì •ì¼</label>
                <input type="date" name="dateSchedule" id="dateSchedule" class="form-control readonly-field"
                       value="{{ report.dateSchedule|date:'Y-m-d' }}" readonly>
            </div>
        </div>

        <!-- ê¸ˆì•¡ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ê¸ˆì•¡ ì •ë³´</div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì´ì „ ë³´ê³  ê³µì‚¬ê¸ˆì•¡</label>
                <div class="amount-display">{{ report.nPreConMoney|intcomma }} ì› (VAT ë³„ë„)</div>
                <input type="hidden" id="nPreConMoney" name="nPreConMoney" value="{{ report.nPreConMoney }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì´ë²ˆ ë³´ê³  ì·¨ì†Œê¸ˆì•¡</label>
                <div class="amount-display">{{ report.nConMoney|intcomma }} ì› (VAT ë³„ë„)</div>
                <input type="hidden" name="nConMoney" id="nConMoney" value="{{ report.nConMoney }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">(ì˜ˆìƒ) í™˜ë¶ˆì•¡</label>
                <div class="amount-display" id="nFee_display">{{ report.nFee|intcomma }} ì› (VAT í¬í•¨)</div>
                <input type="hidden" name="nFee" id="nFee" value="{{ report.nFee }}">
                <input type="hidden" name="nDemand" id="nDemand" value="{{ report.nDemand }}">
                <div class="checkbox-group">
                    <input type="checkbox" id="applyFullRefund" onchange="applyFullRefundAmount()">
                    <label for="applyFullRefund">ì˜ˆìƒ í™˜ë¶ˆì•¡ ì „ë¶€ ì ìš©</label>
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label required-field">(ì ìš©) í™˜ë¶ˆì•¡</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" id="nDeposit_display" class="form-control money-input"
                           value="{% if report.nDeposit %}{{ report.nDeposit|intcomma }}{% else %}0{% endif %}">
                    <input type="hidden" name="nDeposit" id="nDeposit"
                           value="{{ report.nDeposit|default:0 }}">
                    <span>ì› (VAT í¬í•¨)</span>
                    <button type="button" class="btn-point" id="refundPointBtn" onclick="processRefundPoint()" style="display: none;">
                        í™˜ë¶ˆì•¡ í¬ì¸íŠ¸ ì ë¦½
                    </button>
                </div>
                <div class="info-text">ë°˜ë“œì‹œ -ê°’ìœ¼ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.</div>
            </div>
            <div class="form-col">
                <label class="form-label">í™˜ë¶ˆì¼</label>
                <input type="date" name="dateDeposit" id="dateDeposit" class="form-control"
                       value="{% if report.dateDeposit %}{{ report.dateDeposit|date:'Y-m-d' }}{% endif %}"
                       onchange="updateTypeByDeposit()">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">í™˜ë¶ˆë°©ì‹</label>
                <select name="nRefund" id="nRefund" class="form-control">
                    {% for value, text in REFUND_TYPE_CHOICES %}
                    <option value="{{ value }}" {% if report.nRefund == value %}selected{% endif %}>{{ text }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-col">
                <label class="form-label">í™˜ë¶ˆê³„ì¢Œ</label>
                <select name="sAccount" id="sAccount" class="form-control">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    {% for account in accounts %}
                    <option value="{{ account }}"
                            {% if account == report.sAccount %}selected{% endif %}>
                        {{ account }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- ì²¨ë¶€íŒŒì¼ ë° ë©”ëª¨ ì„¹ì…˜ -->
        <div class="section-title">ì²¨ë¶€íŒŒì¼ ë° ë©”ëª¨</div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì¦ë¹™ì„œë¥˜(êµ¬ê¸€)</label>
                <input type="text" name="sFile" class="form-control" value="{{ report.sFile|default:'' }}" placeholder="êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë§í¬">
            </div>
            <div class="form-col">
                <label class="form-label">ì¦ë¹™ì„œë¥˜</label>

                <!-- ê¸°ì¡´ ë‹¨ì¼ íŒŒì¼ í‘œì‹œ (í˜¸í™˜ì„±) -->
                {% if report.file %}
                <div class="mb-2">
                    <a href="{{ report.file.url }}" target="_blank" class="btn btn-sm btn-secondary">
                        ğŸ“ ê¸°ì¡´ íŒŒì¼ ë³´ê¸°
                    </a>
                </div>
                {% endif %}

                <!-- ë‹¤ì¤‘ íŒŒì¼ ëª©ë¡ í‘œì‹œ -->
                {% if report.pk and report.report_files.all %}
                <div class="uploaded-files mb-3">
                    <h6 class="text-muted">ì—…ë¡œë“œëœ íŒŒì¼:</h6>
                    <div class="file-list">
                        {% for file in report.report_files.all %}
                        <div class="file-item d-flex align-items-center mb-2" data-file-id="{{ file.no }}">
                            <a href="{{ file.file.url }}" target="_blank" class="flex-grow-1">
                                ğŸ“„ {{ file.original_name }}
                                <small class="text-muted">({{ file.file_size|filesizeformat }})</small>
                            </a>
                            <button type="button" class="btn btn-sm btn-danger ml-2 delete-file-btn"
                                    data-file-id="{{ file.no }}" data-file-name="{{ file.original_name }}">
                                ì‚­ì œ
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- ë‹¤ì¤‘ íŒŒì¼ ì—…ë¡œë“œ ì…ë ¥ -->
                <input type="file" name="files" class="form-control" multiple>
                <small class="form-text text-muted">ì—¬ëŸ¬ íŒŒì¼ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (Ctrl/Cmd + í´ë¦­)</small>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì—…ì²´ì—ì„œ ë‚¨ê¸´ ë§ì”€</label>
                <textarea name="sCompanyMemo" class="form-control" rows="3">{{ report.sCompanyMemo|default:'' }}</textarea>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ìŠ¤í… ë©”ëª¨</label>
                <textarea name="sStaffMemo" class="form-control" rows="3">{{ report.sStaffMemo|default:'' }}</textarea>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ë³´ê³ ì</label>
                <input type="text" class="form-control readonly-field" value="{{ current_staff.sNick }}" readonly>
                <input type="hidden" name="sWorker" value="{{ current_staff.sNick }}">
            </div>
        </div>

        <!-- ë²„íŠ¼ ì„¹ì…˜ -->
        <div style="text-align: center; margin-top: 30px;">
            <button type="submit" class="btn-submit">{% if mode == 'edit' %}ìˆ˜ì •{% else %}ì œì¶œ{% endif %}</button>
            <button type="button" class="btn-cancel" onclick="window.location.href='{% url 'contract:companyreport_list' %}'">ì·¨ì†Œ</button>
        </div>
    </form>
</div>

<script>
// ê¸€ë¡œë²Œ ë³€ìˆ˜
let currentCompanyNo = '{{ report.noCompany }}';
let currentWorker = '{{ current_staff.sNick }}';
const nPreFee = {{ report.nPreFee|default:0 }};

// ìˆ«ìì— ì²œë‹¨ìœ„ ì½¤ë§ˆ ì¶”ê°€
function formatNumberWithCommas(num) {
    const number = parseInt(num.toString().replace(/[^-0-9]/g, '')) || 0;
    const isNegative = number < 0;
    const absNumber = Math.abs(number);
    const formatted = absNumber.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    return isNegative ? '-' + formatted : formatted;
}

// ì½¤ë§ˆ ì œê±°
function removeCommas(str) {
    return str.toString().replace(/[^-0-9]/g, '');
}

// ê¸ˆì•¡ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
function initMoneyInputs() {
    const moneyInputs = document.querySelectorAll('.money-input');

    moneyInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            const hiddenFieldId = e.target.id.replace('_display', '');
            const hiddenField = document.getElementById(hiddenFieldId);

            const cleanValue = removeCommas(e.target.value);

            // ì‚¬ìš©ìê°€ '-'ë§Œ ì…ë ¥í•œ ê²½ìš° ê·¸ëŒ€ë¡œ ìœ ì§€
            if (cleanValue === '-') {
                e.target.value = '-';
                if (hiddenField) {
                    hiddenField.value = '0';
                }
                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ë§Œ í•˜ê³  ê³„ì‚°ì€ ê±´ë„ˆëœ€
                if (hiddenFieldId === 'nDeposit') {
                    updateRefundButton();
                }
                return;
            }

            // ë¹ˆ ë¬¸ìì—´ ì²˜ë¦¬
            if (cleanValue === '') {
                e.target.value = '';
                if (hiddenField) {
                    hiddenField.value = '0';
                }
                updateRefundButton();
                return;
            }

            const formattedValue = formatNumberWithCommas(cleanValue);

            e.target.value = formattedValue;
            if (hiddenField) {
                hiddenField.value = cleanValue;
            }

            // nDeposit í•„ë“œì¸ ê²½ìš° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (hiddenFieldId === 'nDeposit') {
                updateRefundButton();
                updateTypeByDeposit();
            }
        });
    });
}

// ì˜ˆìƒ í™˜ë¶ˆì•¡ ì „ë¶€ ì ìš©
function applyFullRefundAmount() {
    const checkbox = document.getElementById('applyFullRefund');
    if (checkbox.checked) {
        const refundAmount = document.getElementById('nFee').value;
        document.getElementById('nDeposit_display').value = formatNumberWithCommas(refundAmount);
        document.getElementById('nDeposit').value = refundAmount;

        // nDeposit ê°’ì´ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ ë²„íŠ¼ ìƒíƒœì™€ íƒ€ì… ì—…ë°ì´íŠ¸
        updateRefundButton();
        updateTypeByDeposit();
    }
}

// í™˜ë¶ˆì¼ì— ë”°ë¥¸ nType ì—…ë°ì´íŠ¸
function updateTypeByDeposit() {
    const dateDeposit = document.getElementById('dateDeposit').value;
    const nDeposit = parseInt(document.getElementById('nDeposit').value) || 0;
    const nTypeDisplay = document.getElementById('nType_display');
    const nType = document.getElementById('nType');

    if (dateDeposit || nDeposit < 0) {
        nType.value = '7'; // ì·¨ì†Œ(í™˜ë¶ˆO)
        nTypeDisplay.value = 'ì·¨ì†Œ(í™˜ë¶ˆO)';
    } else {
        nType.value = '6'; // ì·¨ì†Œ(í™˜ë¶ˆX)
        nTypeDisplay.value = 'ì·¨ì†Œ(í™˜ë¶ˆX)';
    }
}

// í™˜ë¶ˆ í¬ì¸íŠ¸ ë²„íŠ¼ í‘œì‹œ ì œì–´
function updateRefundButton() {
    const nRefund = document.getElementById('nRefund').value;
    const nDeposit = parseInt(document.getElementById('nDeposit').value) || 0;
    const refundBtn = document.getElementById('refundPointBtn');

    // nRefundê°€ 1(í¬ì¸íŠ¸)ì´ê³  nDepositì´ ìŒìˆ˜ì¸ ê²½ìš°ì—ë§Œ ë²„íŠ¼ í‘œì‹œ
    if (nRefund === '1' && nDeposit < 0) {
        refundBtn.style.display = 'inline-block';
        // ì´ë¯¸ ì ë¦½ ì™„ë£Œëœ ê²½ìš°ê°€ ì•„ë‹ˆë©´ í™œì„±í™”
        if (refundBtn.textContent !== 'í¬ì¸íŠ¸ ì ë¦½ ì™„ë£Œ') {
            refundBtn.disabled = false;
        }
    } else {
        refundBtn.style.display = 'none';
    }
}

// í™˜ë¶ˆì•¡ í¬ì¸íŠ¸ ì ë¦½
function processRefundPoint() {
    const nRefund = document.getElementById('nRefund').value;
    if (nRefund !== '1') {
        alert('í¬ì¸íŠ¸ í™˜ë¶ˆ ë°©ì‹ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
    }

    const nDeposit = document.getElementById('nDeposit').value;
    if (parseInt(nDeposit) >= 0) {
        alert('í™˜ë¶ˆì•¡ì€ ìŒìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }

    if (!confirm('í™˜ë¶ˆì•¡ì„ í¬ì¸íŠ¸ë¡œ ì ë¦½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì ë¦½ í›„ì—ëŠ” ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }

    const csrfToken = getCookie('csrftoken');

    // API í˜¸ì¶œí•˜ì—¬ ì¦‰ì‹œ í¬ì¸íŠ¸ ìƒì„±
    fetch('/contract/api/create-refund-point/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            company_no: currentCompanyNo,
            refund_amount: parseInt(nDeposit),
            pre_report_no: {{ report.noPre }}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ì˜¤ëŠ˜ ë‚ ì§œë¡œ í™˜ë¶ˆì¼ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateDeposit').value = today;
            updateTypeByDeposit();

            // ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById('refundPointBtn').disabled = true;
            document.getElementById('refundPointBtn').textContent = 'í¬ì¸íŠ¸ ì ë¦½ ì™„ë£Œ';

            alert(data.message + '\nì”ì•¡: ' + formatNumberWithCommas(data.remain_point) + ' í¬ì¸íŠ¸');
        } else {
            alert('í¬ì¸íŠ¸ ì ë¦½ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('í¬ì¸íŠ¸ ì ë¦½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// íŒŒì¼ ì‚­ì œ
function deleteReportFile(fileId) {
    const csrfToken = getCookie('csrftoken');

    fetch(`/contract/api/report-file/${fileId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
            if (fileItem) {
                fileItem.remove();
            }

            const fileList = document.querySelector('.file-list');
            if (fileList && fileList.children.length === 0) {
                const uploadedFilesSection = document.querySelector('.uploaded-files');
                if (uploadedFilesSection) {
                    uploadedFilesSection.remove();
                }
            }

            alert(data.message);
        } else {
            alert('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ì´ì „ ë³´ê³ ì„œë¡œ ë°”ë¡œê°€ê¸°
function goToPreviousReport() {
    const noPre = document.getElementById('noPre').value;

    if (!noPre) {
        alert('ì´ì „ë³´ê³  Noê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    console.log('ì´ì „ ë³´ê³ ì„œë¡œ ì´ë™:', noPre);

    // API í˜¸ì¶œí•˜ì—¬ ë³´ê³ ì„œ íƒ€ì… í™•ì¸
    fetch(`/contract/api/companyreport/${noPre}/data/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data) {
            const reportData = data.data;

            // nTypeì— ë”°ë¼ ì ì ˆí•œ ìˆ˜ì • í™”ë©´ìœ¼ë¡œ ì´ë™
            // APIì—ì„œ nTypeì„ ë°˜í™˜í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ ìƒì„¸ í™”ë©´ìœ¼ë¡œ ì´ë™
            if (reportData.nType !== undefined) {
                const nType = reportData.nType;
                let editUrl = '';

                if (nType === 0 || nType === 1) {
                    // ê³„ì•½
                    editUrl = `/contract/companyreport/${noPre}/edit/`;
                } else if (nType === 2 || nType === 3) {
                    // ì¦ì•¡
                    editUrl = `/contract/companyreport/${noPre}/increase/`;
                } else if (nType === 4 || nType === 5) {
                    // ê°ì•¡
                    editUrl = `/contract/companyreport/${noPre}/decrease/`;
                } else if (nType === 6 || nType === 7) {
                    // ì·¨ì†Œ
                    editUrl = `/contract/companyreport/${noPre}/cancel/`;
                } else {
                    // ê¸°íƒ€ - ê¸°ë³¸ í¸ì§‘ í™”ë©´
                    editUrl = `/contract/companyreport/${noPre}/edit/`;
                }

                // ìƒˆ ì°½ì—ì„œ ì—´ê¸° (í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë‚´ìš© ë³´ì¡´)
                window.open(editUrl, '_blank');
            } else {
                // nType ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ìƒì„¸ í™”ë©´ìœ¼ë¡œ
                window.open(`/contract/companyreport/${noPre}/detail/`, '_blank');
            }
        } else {
            alert('ì´ì „ ë³´ê³ ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // ì—ëŸ¬ ë°œìƒì‹œ ê¸°ë³¸ ìƒì„¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        window.open(`/contract/companyreport/${noPre}/detail/`, '_blank');
    });
}

// ì´ì „ ë³´ê³ ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
function fetchParentReportData(noPre) {
    if (!noPre) {
        console.log('noPre ê°’ì´ ì—†ìŠµë‹ˆë‹¤');
        return;
    }

    // í˜„ì¬ ë³´ê³ ì„œ ë²ˆí˜¸ì™€ ë™ì¼í•œì§€ í™•ì¸
    const currentNo = {{ report.no|default:0 }};
    if (parseInt(noPre) === currentNo) {
        alert('ì´ì „ë³´ê³  NoëŠ” í˜„ì¬ ë³´ê³ ì„œ ë²ˆí˜¸ì™€ ê°™ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        // ì´ì „ ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
        document.getElementById('noPre').value = '';
        return;
    }

    console.log('ì´ì „ ë³´ê³ ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°:', noPre);

    // API í˜¸ì¶œ
    fetch(`/contract/api/companyreport/${noPre}/data/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('ì´ì „ ë³´ê³ ì„œ ë°ì´í„°:', data.data);
            const reportData = data.data;

            // ì„ íƒí•œ ì´ì „ ë³´ê³ ì„œê°€ ì´ë¯¸ ë‹¤ë¥¸ ë³´ê³ ì„œì— ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (noNextê°€ ìˆëŠ”ì§€)
            // ë‹¨, noNextê°€ í˜„ì¬ ë³´ê³ ì„œ ë²ˆí˜¸ì™€ ê°™ë‹¤ë©´ ê¸°ì¡´ ì—°ê²°ì´ë¯€ë¡œ í—ˆìš©
            if (reportData.noNext && reportData.noNext !== currentNo) {
                alert(`ì´ì „ë³´ê³  #${noPre}ëŠ” ì´ë¯¸ ë‹¤ë¥¸ ë³´ê³ ì„œ(#${reportData.noNext})ì— ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\nì´ë¯¸ ì—°ê²°ëœ ë³´ê³ ì„œëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                // ì´ì „ ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
                document.getElementById('noPre').value = '';
                return;
            }

            // nType ê²€ì¦ - ì·¨ì†ŒëŠ” ê³„ì•½(0 ë˜ëŠ” 1) íƒ€ì…ì˜ ë³´ê³ ì„œë§Œ ì´ì „ë³´ê³ ë¡œ ì„ íƒ ê°€ëŠ¥
            if (reportData.nType !== undefined && reportData.nType !== 0 && reportData.nType !== 1) {
                const typeLabels = {
                    2: 'ì¦ì•¡(ì…ê¸ˆX)', 3: 'ì¦ì•¡(ì…ê¸ˆO)',
                    4: 'ê°ì•¡(í™˜ë¶ˆX)', 5: 'ê°ì•¡(í™˜ë¶ˆO)',
                    6: 'ì·¨ì†Œ(í™˜ë¶ˆX)', 7: 'ì·¨ì†Œ(í™˜ë¶ˆO)'
                };
                const typeLabel = typeLabels[reportData.nType] || `íƒ€ì… ${reportData.nType}`;
                alert(`ì´ì „ë³´ê³  #${noPre}ëŠ” ${typeLabel} ë³´ê³ ì„œì…ë‹ˆë‹¤.\nì·¨ì†Œ ë³´ê³ ì˜ ì´ì „ë³´ê³ ëŠ” ê³„ì•½ íƒ€ì…(ê³„ì•½(ì…ê¸ˆX) ë˜ëŠ” ê³„ì•½(ì…ê¸ˆO))ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                document.getElementById('noPre').value = '';
                return;
            }

            // í•„ë“œ ì—…ë°ì´íŠ¸ í—¬í¼ í•¨ìˆ˜
            function updateField(fieldId, value) {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = value || '';
                    console.log(`Updated ${fieldId}:`, value);
                } else {
                    console.warn(`Field ${fieldId} not found`);
                }
            }

            // readonly í•„ë“œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateReadonlyField(fieldId, value) {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = value || '';
                    console.log(`Updated readonly ${fieldId}:`, value);
                }
            }

            // ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸ (sCompanyNameì€ ì œì™¸)
            updateField('noCompany', reportData.noCompany);
            updateReadonlyField('companyName_display', reportData.companyName);

            // ê³ ê° ì •ë³´ ì—…ë°ì´íŠ¸
            updateReadonlyField('sName', reportData.sName);
            updateReadonlyField('sPhone', reportData.sPhone);
            updateReadonlyField('sArea', reportData.sArea);

            // ê²Œì‹œê¸€/ì˜ë¢°/í• ë‹¹ ì •ë³´
            updateReadonlyField('sPost', reportData.sPost);
            updateReadonlyField('noOrder', reportData.noOrder);
            updateReadonlyField('noAssign', reportData.noAssign);

            // ê³µì‚¬ ìœ í˜• ì—…ë°ì´íŠ¸
            console.log('ê³µì‚¬ ìœ í˜• ì—…ë°ì´íŠ¸ ì‹œì‘, nConType:', reportData.nConType);

            // hidden í•„ë“œ ì—…ë°ì´íŠ¸
            const nConTypeHidden = document.getElementById('nConType');
            if (nConTypeHidden) {
                nConTypeHidden.value = reportData.nConType || 0;
                console.log('Updated hidden nConType to:', nConTypeHidden.value);
            } else {
                console.warn('Hidden nConType field not found');
            }

            // ê³µì‚¬ ìœ í˜• í‘œì‹œ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (readonly í•„ë“œ)
            const conTypeDisplay = document.getElementById('nConType_display');
            if (conTypeDisplay) {
                const conTypeTexts = {
                    0: '[ì¹´í˜ê±´]ì¸í…Œë¦¬ì–´/ë¦¬ëª¨ë¸ë§/ê¸°íƒ€',
                    1: '[ì¹´í…Œê±´]ì‹ ì¶•/ì¦ì¶•/ê°œì¶•',
                    2: '[ì†Œê°œê±´]ì¸í…Œë¦¬ì–´/ë¦¬ëª¨ë¸ë§/ê¸°íƒ€',
                    3: '[ì†Œê°œê±´]ì‹ ì¶•/ì¦ì¶•/ê°œì¶•'
                };
                const displayText = conTypeTexts[reportData.nConType] || '[ì¹´í˜ê±´]ì¸í…Œë¦¬ì–´/ë¦¬ëª¨ë¸ë§/ê¸°íƒ€';
                conTypeDisplay.value = displayText;
                console.log('Updated nConType_display to:', displayText);
            } else {
                console.warn('nConType_display field not found');
            }

            // í™˜ë¶ˆ ë°©ì‹
            const nRefundSelect = document.getElementById('nRefund');
            if (nRefundSelect && reportData.nRefund !== undefined) {
                nRefundSelect.value = reportData.nRefund;
                console.log('Updated nRefund:', reportData.nRefund);
                updateRefundButton(); // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            }

            // í™˜ë¶ˆê³„ì¢Œ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
            const sAccountSelect = document.getElementById('sAccount');
            if (sAccountSelect && reportData.licenses) {
                // ê¸°ì¡´ ì˜µì…˜ ëª¨ë‘ ì œê±° (ì²« ë²ˆì§¸ 'ì„ íƒí•˜ì„¸ìš”' ì œì™¸)
                while (sAccountSelect.options.length > 1) {
                    sAccountSelect.remove(1);
                }

                // License ì •ë³´ë¡œ ìƒˆ ì˜µì…˜ ì¶”ê°€
                const addedAccounts = new Set(); // ì¤‘ë³µ ë°©ì§€
                reportData.licenses.forEach(license => {
                    if (license.sAccount && !addedAccounts.has(license.sAccount)) {
                        const option = document.createElement('option');
                        option.value = license.sAccount;
                        option.textContent = license.sAccount;
                        sAccountSelect.appendChild(option);
                        addedAccounts.add(license.sAccount);
                    }
                });

                // ì´ì „ì— ì„ íƒëœ ê°’ì´ ìˆìœ¼ë©´ ì„ íƒ
                if (reportData.sAccount) {
                    sAccountSelect.value = reportData.sAccount;
                    console.log('Updated sAccount with licenses and selected:', reportData.sAccount);
                }
            } else if (!sAccountSelect) {
                console.warn('sAccount select not found');
            }

            // ë‚ ì§œ í•„ë“œë„ ì—…ë°ì´íŠ¸
            updateField('dateContract', reportData.dateContract);
            updateField('dateSchedule', reportData.dateSchedule);
            console.log('ë‚ ì§œ í•„ë“œ(dateContract, dateSchedule) ì—…ë°ì´íŠ¸ ì™„ë£Œ');

            // ì´ì „ ë³´ê³ ì˜ nConMoneyë¥¼ í˜„ì¬ì˜ nPreConMoneyë¡œ ì„¤ì •
            if (reportData.nConMoney !== undefined) {
                const nPreConMoneyInput = document.getElementById('nPreConMoney');

                if (nPreConMoneyInput) {
                    nPreConMoneyInput.value = reportData.nConMoney || 0;
                    console.log('Updated nPreConMoney with previous report nConMoney:', reportData.nConMoney);

                    // ì´ì „ ë³´ê³  ê³µì‚¬ê¸ˆì•¡ í‘œì‹œ div ì—…ë°ì´íŠ¸
                    const displayDiv = nPreConMoneyInput.previousElementSibling;
                    if (displayDiv && displayDiv.classList.contains('amount-display')) {
                        displayDiv.textContent = (reportData.nConMoney || 0).toLocaleString() + ' ì› (VAT ë³„ë„)';
                        console.log('Updated nPreConMoney display div');
                    }
                }
            }

            // ì·¨ì†Œê¸ˆì•¡ì€ ì´ì „ ë³´ê³ ì˜ ì „ì²´ ê¸ˆì•¡
            if (reportData.nConMoney !== undefined) {
                const nConMoneyInput = document.getElementById('nConMoney');

                if (nConMoneyInput) {
                    nConMoneyInput.value = -Math.abs(reportData.nConMoney || 0); // ìŒìˆ˜ë¡œ ì„¤ì •
                    console.log('Updated nConMoney (cancel amount):', -Math.abs(reportData.nConMoney));

                    // ì·¨ì†Œê¸ˆì•¡ í‘œì‹œ div ì—…ë°ì´íŠ¸
                    const displayDiv = nConMoneyInput.previousElementSibling;
                    if (displayDiv && displayDiv.classList.contains('amount-display')) {
                        displayDiv.textContent = (-Math.abs(reportData.nConMoney || 0)).toLocaleString() + ' ì› (VAT ë³„ë„)';
                        console.log('Updated nConMoney display div');
                    }
                }

                // í™˜ë¶ˆì•¡ ê³„ì‚° (ì·¨ì†ŒëŠ” ì´ì „ ë³´ê³ ì˜ ìˆ˜ìˆ˜ë£Œ í™˜ë¶ˆ)
                // ì´ì „ ë³´ê³ ì˜ nFeeë¥¼ ìŒìˆ˜ë¡œ ë³€í™˜í•˜ì—¬ í™˜ë¶ˆì•¡ìœ¼ë¡œ ì„¤ì •
                const refundAmount = reportData.nFee ? -Math.abs(reportData.nFee) : 0;

                const nFeeInput = document.getElementById('nFee');
                const nFeeDisplay = document.getElementById('nFee_display');

                if (nFeeInput) {
                    nFeeInput.value = refundAmount;
                    console.log('Updated nFee (refund amount) based on previous report nFee:', refundAmount);
                    console.log('  - ì´ì „ ë³´ê³  nFee:', reportData.nFee);
                    console.log('  - í™˜ë¶ˆì•¡:', refundAmount);
                }

                if (nFeeDisplay) {
                    nFeeDisplay.textContent = refundAmount.toLocaleString() + ' ì› (VAT í¬í•¨)';
                    console.log('Updated nFee display');
                }
            }

        } else {
            console.error('ì´ì „ ë³´ê³ ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', data);
            alert('ì´ì „ ë³´ê³ ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error fetching parent report data:', error);
        alert('ì´ì „ ë³´ê³ ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initMoneyInputs();
    updateRefundButton();
    updateTypeByDeposit();

    // nRefund ë³€ê²½ ê°ì§€ - ì‹¤ì‹œê°„ìœ¼ë¡œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    const nRefundSelect = document.getElementById('nRefund');
    if (nRefundSelect) {
        nRefundSelect.addEventListener('change', function() {
            updateRefundButton();
        });
    }

    // íŒŒì¼ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.querySelectorAll('.delete-file-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const fileId = this.dataset.fileId;
            const fileName = this.dataset.fileName;

            if (confirm(`"${fileName}" íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                deleteReportFile(fileId);
            }
        });
    });

    // í¼ ì œì¶œ ì‹œ ê°’ ë™ê¸°í™”
    document.getElementById('cancelForm').addEventListener('submit', function(e) {
        // ëª¨ë“  display í•„ë“œì˜ ê°’ì„ hidden í•„ë“œë¡œ ë³µì‚¬
        const fields = [
            { display: 'nDeposit_display', hidden: 'nDeposit' }
        ];

        fields.forEach(field => {
            const displayEl = document.getElementById(field.display);
            const hiddenEl = document.getElementById(field.hidden);

            if (displayEl && hiddenEl) {
                const cleanValue = removeCommas(displayEl.value);
                hiddenEl.value = cleanValue || '0';
            }
        });
    });
});
</script>
{% endblock %}
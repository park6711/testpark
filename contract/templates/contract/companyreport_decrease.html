{% extends "staff/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{% if mode == 'edit' %}ê°ì•¡ ë³´ê³  ìˆ˜ì •{% else %}ê³µì‚¬ê¸ˆì•¡ ê°ì•¡ ë³´ê³ {% endif %} - PMIS 2.0{% endblock %}
{% block page_title %}{% if mode == 'edit' %}ê°ì•¡ ë³´ê³  ìˆ˜ì •{% else %}ê³µì‚¬ê¸ˆì•¡ ê°ì•¡ ë³´ê³ {% endif %}{% endblock %}
{% block page_subtitle %}{% if mode == 'edit' %}ê³„ì•½ë³´ê³ ì„œ #{{ report.no }} ìˆ˜ì •{% else %}ê³„ì•½ë³´ê³ ì„œ ê³µì‚¬ê¸ˆì•¡ ê°ì•¡ ì²˜ë¦¬{% endif %}{% endblock %}

{% block content %}
<style>
    .detail-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
        margin-top: 20px;
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }

    .main-title {
        font-size: 24px;
        font-weight: bold;
        color: #2d3748;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 3px solid #dc3545;
        text-align: center;
    }

    .section-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-bottom: 20px;
        margin-top: 30px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }

    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-col {
        flex: 1;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #495057;
        font-size: 14px;
    }

    .required-field::after {
        content: " *";
        color: #f56565;
    }

    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.15s ease-in-out;
    }

    .form-control:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .readonly-field {
        background-color: #f7fafc !important;
        cursor: not-allowed;
    }

    .amount-display {
        padding: 10px 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
        font-size: 16px;
        font-weight: bold;
        color: #dc3545;
    }

    .btn-calculate {
        padding: 6px 12px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }

    .btn-calculate:hover {
        background-color: #5a6268;
    }

    .btn-point {
        padding: 6px 12px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }

    .btn-point:hover {
        background-color: #218838;
    }

    .btn-point:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    .info-text {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
    }

    .btn-submit {
        background-color: #007bff;
        color: white;
        padding: 10px 30px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        margin-right: 10px;
    }

    .btn-submit:hover {
        background-color: #0056b3;
    }

    .btn-cancel {
        background-color: #6c757d;
        color: white;
        padding: 10px 30px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
    }

    .btn-cancel:hover {
        background-color: #5a6268;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 5px;
    }

    .money-input {
        text-align: right;
    }
</style>

<div class="detail-container">
    <form id="decreaseForm" method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="main-title">{% if mode == 'edit' %}ê°ì•¡ ë³´ê³  ìˆ˜ì •{% else %}ê³µì‚¬ê¸ˆì•¡ ê°ì•¡ ë³´ê³ {% endif %}</div>

        <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ê¸°ë³¸ ì •ë³´</div>

        {% if mode == 'edit' %}
        <div class="form-row">
            <div class="form-col">
                <label class="form-label">No</label>
                <input type="text" class="form-control readonly-field" value="{{ report.no }}" readonly>
            </div>
            <div class="form-col">
                <label class="form-label">ì´ì „ë³´ê³  No</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="noPre" name="noPre" class="form-control"
                           value="{{ report.noPre }}"
                           onchange="fetchParentReportData(this.value)" style="flex: 1;">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="goToPreviousReport()"
                            id="goPrevBtn" style="white-space: nowrap;">
                        ë°”ë¡œê°€ê¸°
                    </button>
                </div>
            </div>
            <div class="form-col">
                <label class="form-label">íƒ€ì„ìŠ¤íƒ¬í”„</label>
                <input type="text" class="form-control readonly-field"
                       value="{% if report.timeStamp %}{{ report.timeStamp|date:'Y-m-d H:i:s' }}{% else %}ë¯¸ë“±ë¡{% endif %}" readonly>
            </div>
        </div>
        {% else %}
        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì´ì „ë³´ê³  No</label>
                <input type="text" class="form-control readonly-field" value="{{ report.noPre }}" readonly>
                <input type="hidden" name="noPre" value="{{ report.noPre }}">
            </div>
        </div>
        {% endif %}

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì—…ì²´ëª…(êµ¬ê¸€)</label>
                <input type="text" name="sCompanyName" id="sCompanyName" class="form-control" value="{{ report.sCompanyName }}">
            </div>
            <div class="form-col">
                <label class="form-label">ì—…ì²´ëª…</label>
                <input type="text" id="company_name_display" class="form-control readonly-field" value="{{ company_name }}" readonly>
                <input type="hidden" name="noCompany" id="noCompany" value="{{ report.noCompany }}">
                <!-- noPre ë³€ê²½ ì‹œ ì—…ë°ì´íŠ¸ë˜ëŠ” hidden í•„ë“œë“¤ -->
                <input type="hidden" name="sName" id="sName" value="{{ report.sName }}">
                <input type="hidden" name="sPhone" id="sPhone" value="{{ report.sPhone }}">
                <input type="hidden" name="sPost" id="sPost" value="{{ report.sPost }}">
                <input type="hidden" name="noAssign" id="noAssign" value="{{ report.noAssign }}">
                <input type="hidden" name="sArea" id="sArea" value="{{ report.sArea }}">
                <input type="hidden" name="sTaxCompany" id="sTaxCompany" value="{{ report.sTaxCompany }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê²Œì‹œê¸€ ë§í¬</label>
                <input type="text" id="sPost_display" class="form-control readonly-field" value="{{ report.sPost }}" readonly>
            </div>
            <div class="form-col">
                <label class="form-label">ì˜ë¢° ID</label>
                <input type="text" class="form-control readonly-field" value="{{ report.noOrder|default:'' }}" readonly>
                <input type="hidden" name="noOrder" value="{{ report.noOrder|default:'' }}">
            </div>
            <div class="form-col">
                <label class="form-label">í• ë‹¹ ID</label>
                <input type="text" id="noAssign_display" class="form-control readonly-field" value="{{ report.noAssign|default:'' }}" readonly>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ë³´ê³ êµ¬ë¶„</label>
                <input type="text" id="nType_display" class="form-control readonly-field" value="ê°ì•¡(í™˜ë¶ˆX)" readonly>
                <input type="hidden" name="nType" id="nType" value="4">
            </div>
            <div class="form-col">
                <label class="form-label">ê³µì‚¬ ìœ í˜•</label>
                <input type="text" id="nConType_display" class="form-control readonly-field" value="{{ report.get_nConType_display }}" readonly>
                <input type="hidden" name="nConType" id="nConType" value="{{ report.nConType }}">
            </div>
        </div>

        <!-- ê³ ê° ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ê³ ê° ì •ë³´</div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê³ ê° ì´ë¦„</label>
                <input type="text" id="sName_display" class="form-control readonly-field" value="{{ report.sName }}" readonly>
            </div>
            <div class="form-col">
                <label class="form-label">ê³ ê° í•¸ë“œí°</label>
                <input type="text" id="sPhone_display" class="form-control readonly-field" value="{{ report.sPhone }}" readonly>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê³µì‚¬ ì§€ì—­</label>
                <input type="text" id="sArea_display" class="form-control readonly-field" value="{{ report.sArea }}" readonly>
            </div>
        </div>

        <!-- ì¼ì • ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ì¼ì • ì •ë³´</div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ê°ì•¡ê³µì‚¬ ê³„ì•½ì¼</label>
                <input type="date" name="dateContract" id="dateContract" class="form-control"
                       value="{{ report.dateContract|date:'Y-m-d' }}">
            </div>
            <div class="form-col">
                <label class="form-label">ê³µì‚¬ ì™„ë£Œì˜ˆì •ì¼</label>
                <input type="date" name="dateSchedule" id="dateSchedule" class="form-control"
                       value="{{ report.dateSchedule|date:'Y-m-d' }}">
            </div>
        </div>

        <!-- ê¸ˆì•¡ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ê¸ˆì•¡ ì •ë³´</div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì´ì „ ë³´ê³  ê³µì‚¬ê¸ˆì•¡</label>
                <div class="amount-display">{{ report.nPreConMoney|intcomma }} ì› (VAT ë³„ë„)</div>
                <input type="hidden" id="nPreConMoney" name="nPreConMoney" value="{{ report.nPreConMoney }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì´ë²ˆ ë³´ê³  ê°ì•¡ê¸ˆì•¡(êµ¬ê¸€)</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" name="sConMoney" id="sConMoney" class="form-control"
                           value="{{ report.sConMoney|default:'' }}"
                           placeholder="êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë³µì‚¬í•œ ê¸ˆì•¡">
                    <span>ì›</span>
                </div>
            </div>
            <div class="form-col">
                <label class="form-label required-field">ì´ë²ˆ ë³´ê³  ê°ì•¡ê¸ˆì•¡</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" id="nConMoney_display" class="form-control money-input"
                           value="{% if report.nConMoney %}{{ report.nConMoney|intcomma }}{% else %}0{% endif %}">
                    <input type="hidden" name="nConMoney" id="nConMoney"
                           value="{{ report.nConMoney|default:0 }}">
                    <span>ì› (VAT ë³„ë„)</span>
                    <button type="button" class="btn-calculate" onclick="convertToVatExcluded()">
                        ë¶€ê°€ì„¸ ë³„ë„ë¡œ ìë™ ë³€í™˜
                    </button>
                </div>
                <div class="info-text">ë°˜ë“œì‹œ VAT ë³„ë„ë¡œ -ê°’ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ìµœì¢… ê³µì‚¬ ê¸ˆì•¡</label>
                <div class="amount-display" id="totalConMoney_display">0 ì› (VAT ë³„ë„)</div>
                <input type="hidden" id="nTotalConMoney" value="0">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ìµœì¢… ê¸°ì¤€ (ì˜ˆìƒ) ìˆ˜ìˆ˜ë£Œ</label>
                <div class="amount-display" id="totalFee_display">0 ì› (VAT í¬í•¨)</div>
                <input type="hidden" id="nTotalFee" value="0">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì´ì „ ë³´ê³  ìˆ˜ìˆ˜ë£Œ</label>
                <div class="amount-display">{{ report.nPreFee|intcomma }} ì› (VAT í¬í•¨)</div>
                <input type="hidden" id="nPreFee" name="nPreFee" value="{{ report.nPreFee }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">(ì˜ˆìƒ) í™˜ë¶ˆì•¡</label>
                <div class="amount-display" id="nFee_display">0 ì› (VAT í¬í•¨)</div>
                <input type="hidden" name="nFee" id="nFee" value="0">
                <input type="hidden" name="nDemand" id="nDemand" value="0">
                <div class="checkbox-group">
                    <input type="checkbox" id="applyFullRefund" onchange="applyFullRefundAmount()">
                    <label for="applyFullRefund">ì˜ˆìƒ í™˜ë¶ˆì•¡ ì „ë¶€ ì ìš©</label>
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label required-field">(ì ìš©) í™˜ë¶ˆì•¡</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" id="nDeposit_display" class="form-control money-input"
                           value="{% if report.nDeposit %}{{ report.nDeposit|intcomma }}{% else %}0{% endif %}">
                    <input type="hidden" name="nDeposit" id="nDeposit"
                           value="{{ report.nDeposit|default:0 }}">
                    <span>ì› (VAT í¬í•¨)</span>
                    <button type="button" class="btn-point" id="refundPointBtn" onclick="processRefundPoint()" style="display: none;">
                        í™˜ë¶ˆì•¡ í¬ì¸íŠ¸ ì ë¦½
                    </button>
                </div>
                <div class="info-text">ë°˜ë“œì‹œ -ê°’ìœ¼ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.</div>
            </div>
            <div class="form-col">
                <label class="form-label">í™˜ë¶ˆì¼</label>
                <input type="date" name="dateDeposit" id="dateDeposit" class="form-control"
                       value="{% if report.dateDeposit %}{{ report.dateDeposit|date:'Y-m-d' }}{% endif %}"
                       onchange="updateTypeByDeposit()">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">í™˜ë¶ˆë°©ì‹</label>
                <select name="nRefund" id="nRefund" class="form-control">
                    {% for value, text in REFUND_TYPE_CHOICES %}
                    <option value="{{ value }}" {% if report.nRefund == value %}selected{% endif %}>{{ text }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-col">
                <label class="form-label">í™˜ë¶ˆê³„ì¢Œ</label>
                <select name="sAccount" id="sAccount" class="form-control">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    {% for account in accounts %}
                    <option value="{{ account }}"
                            {% if account == report.sAccount %}selected{% endif %}>
                        {{ account }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- ì²¨ë¶€íŒŒì¼ ë° ë©”ëª¨ ì„¹ì…˜ -->
        <div class="section-title">ì²¨ë¶€íŒŒì¼ ë° ë©”ëª¨</div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì¦ë¹™ì„œë¥˜(êµ¬ê¸€)</label>
                <input type="text" name="sFile" class="form-control" value="{{ report.sFile|default:'' }}" placeholder="êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë§í¬">
            </div>
            <div class="form-col">
                <label class="form-label">ì¦ë¹™ì„œë¥˜</label>

                <!-- ê¸°ì¡´ ë‹¨ì¼ íŒŒì¼ í‘œì‹œ (í˜¸í™˜ì„±) -->
                {% if report.file %}
                <div class="mb-2">
                    <a href="{{ report.file.url }}" target="_blank" class="btn btn-sm btn-secondary">
                        ğŸ“ ê¸°ì¡´ íŒŒì¼ ë³´ê¸°
                    </a>
                </div>
                {% endif %}

                <!-- ë‹¤ì¤‘ íŒŒì¼ ëª©ë¡ í‘œì‹œ -->
                {% if report.pk and report.report_files.all %}
                <div class="uploaded-files mb-3">
                    <h6 class="text-muted">ì—…ë¡œë“œëœ íŒŒì¼:</h6>
                    <div class="file-list">
                        {% for file in report.report_files.all %}
                        <div class="file-item d-flex align-items-center mb-2" data-file-id="{{ file.no }}">
                            <a href="{{ file.file.url }}" target="_blank" class="flex-grow-1">
                                ğŸ“„ {{ file.original_name }}
                                <small class="text-muted">({{ file.file_size|filesizeformat }})</small>
                            </a>
                            <button type="button" class="btn btn-sm btn-danger ml-2 delete-file-btn"
                                    data-file-id="{{ file.no }}" data-file-name="{{ file.original_name }}">
                                ì‚­ì œ
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- ë‹¤ì¤‘ íŒŒì¼ ì—…ë¡œë“œ ì…ë ¥ -->
                <input type="file" name="files" class="form-control" multiple>
                <small class="form-text text-muted">ì—¬ëŸ¬ íŒŒì¼ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (Ctrl/Cmd + í´ë¦­)</small>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ì—…ì²´ì—ì„œ ë‚¨ê¸´ ë§ì”€</label>
                <textarea name="sCompanyMemo" class="form-control" rows="3">{{ report.sCompanyMemo|default:'' }}</textarea>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ìŠ¤í… ë©”ëª¨</label>
                <textarea name="sStaffMemo" class="form-control" rows="3">{{ report.sStaffMemo|default:'' }}</textarea>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label class="form-label">ë³´ê³ ì</label>
                <input type="text" class="form-control readonly-field" value="{{ current_staff.sNick }}" readonly>
                <input type="hidden" name="sWorker" value="{{ current_staff.sNick }}">
            </div>
        </div>

        <!-- ë²„íŠ¼ ì„¹ì…˜ -->
        <div style="text-align: center; margin-top: 30px;">
            <button type="submit" class="btn-submit">{% if mode == 'edit' %}ìˆ˜ì •{% else %}ì œì¶œ{% endif %}</button>
            <button type="button" class="btn-cancel" onclick="window.location.href='{% url 'contract:companyreport_list' %}'">ì·¨ì†Œ</button>
        </div>
    </form>
</div>

<script>
// ê¸€ë¡œë²Œ ë³€ìˆ˜
let currentCompanyNo = '{{ report.noCompany }}';
let currentWorker = '{{ current_staff.sNick }}';

// ìˆ«ìì— ì²œë‹¨ìœ„ ì½¤ë§ˆ ì¶”ê°€
function formatNumberWithCommas(num) {
    const number = parseInt(num.toString().replace(/[^-0-9]/g, '')) || 0;
    const isNegative = number < 0;
    const absNumber = Math.abs(number);
    const formatted = absNumber.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    return isNegative ? '-' + formatted : formatted;
}

// ì½¤ë§ˆ ì œê±°
function removeCommas(str) {
    return str.toString().replace(/[^-0-9]/g, '');
}

// ê¸ˆì•¡ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
function initMoneyInputs() {
    const moneyInputs = document.querySelectorAll('.money-input');

    moneyInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            const hiddenFieldId = e.target.id.replace('_display', '');
            const hiddenField = document.getElementById(hiddenFieldId);

            console.log('=== Input ì´ë²¤íŠ¸ ===');
            console.log('ì…ë ¥ê°’:', e.target.value);

            const cleanValue = removeCommas(e.target.value);
            console.log('ì •ì œ í›„:', cleanValue);

            // ì‚¬ìš©ìê°€ '-'ë§Œ ì…ë ¥í•œ ê²½ìš° ê·¸ëŒ€ë¡œ ìœ ì§€
            if (cleanValue === '-') {
                console.log('ë§ˆì´ë„ˆìŠ¤ë§Œ ì…ë ¥ë¨ - ìœ ì§€');
                e.target.value = '-';
                if (hiddenField) {
                    hiddenField.value = '0';
                }
                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ë§Œ í•˜ê³  ê³„ì‚°ì€ ê±´ë„ˆëœ€
                if (hiddenFieldId === 'nDeposit') {
                    setTimeout(updateRefundButton, 50);
                }
                return;
            }

            // ë¹ˆ ë¬¸ìì—´ ì²˜ë¦¬
            if (cleanValue === '') {
                console.log('ë¹ˆê°’ ì…ë ¥ë¨');
                e.target.value = '';
                if (hiddenField) {
                    hiddenField.value = '0';
                }
                calculateTotalAmounts();
                return;
            }

            const formattedValue = formatNumberWithCommas(cleanValue);
            console.log('í¬ë§· í›„:', formattedValue);

            e.target.value = formattedValue;
            if (hiddenField) {
                hiddenField.value = cleanValue;
            }

            // ì‹¤ì‹œê°„ ê³„ì‚°
            calculateTotalAmounts();

            // nDeposit í•„ë“œì¸ ê²½ìš° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (hiddenFieldId === 'nDeposit') {
                setTimeout(updateRefundButton, 50);
            }
        });
    });
}

// ì´ ê¸ˆì•¡ ê³„ì‚°
function calculateTotalAmounts() {
    const nPreConMoney = parseInt(document.getElementById('nPreConMoney').value) || 0;
    const nConMoney = parseInt(document.getElementById('nConMoney').value) || 0;

    // ìµœì¢… ê³µì‚¬ ê¸ˆì•¡ = ì´ì „ ê¸ˆì•¡ + ê°ì•¡ ê¸ˆì•¡ (ê°ì•¡ì€ ë§ˆì´ë„ˆìŠ¤)
    const totalConMoney = nPreConMoney + nConMoney;
    document.getElementById('nTotalConMoney').value = totalConMoney;
    document.getElementById('totalConMoney_display').textContent = formatNumberWithCommas(totalConMoney) + ' ì› (VAT ë³„ë„)';

    // ìµœì¢… ìˆ˜ìˆ˜ë£Œ ê³„ì‚°
    calculateTotalFee(totalConMoney);
}

// ìˆ˜ìˆ˜ë£Œ ê³„ì‚°
function calculateTotalFee(totalConMoney) {
    const nConType = parseInt('{{ report.nConType }}');
    let fee = 0;

    // ê³µì‚¬ìœ í˜•ë³„ ìˆ˜ìˆ˜ë£Œ ê³„ì‚° (detail í™”ë©´ê³¼ ë™ì¼í•œ ë¡œì§)
    switch(nConType) {
        case 0: // ì¹´í˜ê±´ ì¸í…Œë¦¬ì–´
            if (totalConMoney <= 50000000) {
                // 5ì²œë§Œì› ì´í•˜: 5.5%
                fee = Math.round(totalConMoney * 0.055);
            } else {
                // 5ì²œë§Œì› ì´ˆê³¼: 5ì²œë§Œì›ê¹Œì§€ 5.5% + ì´ˆê³¼ë¶„ 3.3%
                fee = Math.round(50000000 * 0.055 + (totalConMoney - 50000000) * 0.033);
            }
            break;

        case 1: // ì¹´í˜ê±´ ì‹ ì¶•
            // ì¼ë¥  3.3%
            fee = Math.round(totalConMoney * 0.033);
            break;

        case 2: // ì†Œê°œê±´ ì¸í…Œë¦¬ì–´
            // ì¼ë¥  3.3%
            fee = Math.round(totalConMoney * 0.033);
            break;

        case 3: // ì†Œê°œê±´ ì‹ ì¶•
            // ì¼ë¥  2.2%
            fee = Math.round(totalConMoney * 0.022);
            break;

        case 4: // ëŒ€ì¶œê±´
            // ì¼ë¥  1.1%
            fee = Math.round(totalConMoney * 0.011);
            break;

        default:
            // ê¸°ë³¸ê°’: 3.3%
            fee = Math.round(totalConMoney * 0.033);
            break;
    }

    // ìˆ˜ìˆ˜ë£ŒëŠ” ì´ë¯¸ VAT í¬í•¨ëœ ê¸ˆì•¡
    document.getElementById('nTotalFee').value = fee;
    document.getElementById('totalFee_display').textContent = formatNumberWithCommas(fee) + ' ì› (VAT í¬í•¨)';

    // í™˜ë¶ˆì•¡ ê³„ì‚°
    calculateRefundAmount(fee);
}

// í™˜ë¶ˆì•¡ ê³„ì‚°
function calculateRefundAmount(totalFee) {
    const nPreFee = parseInt(document.getElementById('nPreFee').value) || 0;
    const refundAmount = totalFee - nPreFee; // ìŒìˆ˜ê°€ ë  ê²ƒì„

    document.getElementById('nFee').value = refundAmount;
    document.getElementById('nDemand').value = refundAmount;
    document.getElementById('nFee_display').textContent = formatNumberWithCommas(refundAmount) + ' ì› (VAT í¬í•¨)';
}

// ë¶€ê°€ì„¸ ë³„ë„ë¡œ ë³€í™˜
function convertToVatExcluded() {
    const displayField = document.getElementById('nConMoney_display');
    const hiddenField = document.getElementById('nConMoney');
    const currentValue = parseInt(removeCommas(displayField.value)) || 0;

    const excludedValue = Math.round(currentValue / 1.1);
    displayField.value = formatNumberWithCommas(excludedValue);
    hiddenField.value = excludedValue;

    calculateTotalAmounts();
}

// ì˜ˆìƒ í™˜ë¶ˆì•¡ ì „ë¶€ ì ìš©
function applyFullRefundAmount() {
    const checkbox = document.getElementById('applyFullRefund');
    if (checkbox.checked) {
        const refundAmount = document.getElementById('nFee').value;
        document.getElementById('nDeposit_display').value = formatNumberWithCommas(refundAmount);
        document.getElementById('nDeposit').value = refundAmount;

        // nDeposit ê°’ì´ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        console.log('ì˜ˆìƒ í™˜ë¶ˆì•¡ ì „ë¶€ ì ìš© - nDeposit ê°’ ë³€ê²½:', refundAmount);
        updateRefundButton();
    }
}

// í™˜ë¶ˆì¼ì— ë”°ë¥¸ nType ì—…ë°ì´íŠ¸
function updateTypeByDeposit() {
    const dateDeposit = document.getElementById('dateDeposit').value;
    const nTypeDisplay = document.getElementById('nType_display');
    const nType = document.getElementById('nType');

    if (dateDeposit) {
        nType.value = '5'; // ê°ì•¡(í™˜ë¶ˆO)
        nTypeDisplay.value = 'ê°ì•¡(í™˜ë¶ˆO)';
    } else {
        nType.value = '4'; // ê°ì•¡(í™˜ë¶ˆX)
        nTypeDisplay.value = 'ê°ì•¡(í™˜ë¶ˆX)';
    }
}

// í™˜ë¶ˆ í¬ì¸íŠ¸ ë²„íŠ¼ í‘œì‹œ ì œì–´
function updateRefundButton() {
    const nRefund = document.getElementById('nRefund').value;
    const nDeposit = parseInt(document.getElementById('nDeposit').value) || 0;
    const refundBtn = document.getElementById('refundPointBtn');

    // ë””ë²„ê¹… ë¡œê·¸
    console.log('=== updateRefundButton í˜¸ì¶œ ===');
    console.log('nRefund ê°’:', nRefund, 'íƒ€ì…:', typeof nRefund);
    console.log('nDeposit ê°’:', nDeposit, 'íƒ€ì…:', typeof nDeposit);
    console.log('nDeposit < 0 ì²´í¬:', nDeposit < 0);
    console.log('ì¡°ê±´ ì²´í¬:', nRefund === '1', '&&', nDeposit < 0);

    // nRefundê°€ 1(í¬ì¸íŠ¸)ì´ê³  nDepositì´ ìŒìˆ˜ì¸ ê²½ìš°ì—ë§Œ ë²„íŠ¼ í‘œì‹œ
    if (nRefund === '1' && nDeposit < 0) {
        console.log('âœ… ë²„íŠ¼ í‘œì‹œ');
        refundBtn.style.display = 'inline-block';
        // ì´ë¯¸ ì ë¦½ ì™„ë£Œëœ ê²½ìš°ê°€ ì•„ë‹ˆë©´ í™œì„±í™”
        if (refundBtn.textContent !== 'í¬ì¸íŠ¸ ì ë¦½ ì™„ë£Œ') {
            refundBtn.disabled = false;
        }
    } else {
        console.log('âŒ ë²„íŠ¼ ìˆ¨ê¹€');
        refundBtn.style.display = 'none';
    }
}

// í™˜ë¶ˆì•¡ í¬ì¸íŠ¸ ì ë¦½
function processRefundPoint() {
    const nRefund = document.getElementById('nRefund').value;
    if (nRefund !== '1') {
        alert('í¬ì¸íŠ¸ í™˜ë¶ˆ ë°©ì‹ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
    }

    const nDeposit = document.getElementById('nDeposit').value;
    if (parseInt(nDeposit) >= 0) {
        alert('í™˜ë¶ˆì•¡ì€ ìŒìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }

    if (!confirm('í™˜ë¶ˆì•¡ì„ í¬ì¸íŠ¸ë¡œ ì ë¦½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì ë¦½ í›„ì—ëŠ” ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }

    const csrfToken = getCookie('csrftoken');

    // API í˜¸ì¶œí•˜ì—¬ ì¦‰ì‹œ í¬ì¸íŠ¸ ìƒì„±
    fetch('/contract/api/create-refund-point/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            company_no: currentCompanyNo,
            refund_amount: parseInt(nDeposit),
            pre_report_no: {{ report.noPre }}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ì˜¤ëŠ˜ ë‚ ì§œë¡œ í™˜ë¶ˆì¼ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateDeposit').value = today;
            updateTypeByDeposit();

            // ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById('refundPointBtn').disabled = true;
            document.getElementById('refundPointBtn').textContent = 'í¬ì¸íŠ¸ ì ë¦½ ì™„ë£Œ';

            alert(data.message + '\nì”ì•¡: ' + formatNumberWithCommas(data.remain_point) + ' í¬ì¸íŠ¸');
        } else {
            alert('í¬ì¸íŠ¸ ì ë¦½ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('í¬ì¸íŠ¸ ì ë¦½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// íŒŒì¼ ì‚­ì œ
function deleteReportFile(fileId) {
    const csrfToken = getCookie('csrftoken');

    fetch(`/contract/api/report-file/${fileId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
            if (fileItem) {
                fileItem.remove();
            }

            const fileList = document.querySelector('.file-list');
            if (fileList && fileList.children.length === 0) {
                const uploadedFilesSection = document.querySelector('.uploaded-files');
                if (uploadedFilesSection) {
                    uploadedFilesSection.remove();
                }
            }

            alert(data.message);
        } else {
            alert('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ì´ì „ ë³´ê³ ì„œë¡œ ë°”ë¡œê°€ê¸°
function goToPreviousReport() {
    const noPre = document.getElementById('noPre').value;

    if (!noPre) {
        alert('ì´ì „ë³´ê³  Noê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    console.log('ì´ì „ ë³´ê³ ì„œë¡œ ì´ë™:', noPre);

    // API í˜¸ì¶œí•˜ì—¬ ë³´ê³ ì„œ íƒ€ì… í™•ì¸
    fetch(`/contract/api/companyreport/${noPre}/data/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data) {
            const reportData = data.data;

            // nTypeì— ë”°ë¼ ì ì ˆí•œ ìˆ˜ì • í™”ë©´ìœ¼ë¡œ ì´ë™
            if (reportData.nType !== undefined) {
                const nType = reportData.nType;
                let editUrl = '';

                if (nType === 0 || nType === 1) {
                    // ê³„ì•½
                    editUrl = `/contract/companyreport/${noPre}/edit/`;
                } else if (nType === 2 || nType === 3) {
                    // ì¦ì•¡
                    editUrl = `/contract/companyreport/${noPre}/increase/`;
                } else if (nType === 4 || nType === 5) {
                    // ê°ì•¡
                    editUrl = `/contract/companyreport/${noPre}/decrease/`;
                } else if (nType === 6 || nType === 7) {
                    // ì·¨ì†Œ
                    editUrl = `/contract/companyreport/${noPre}/cancel/`;
                } else {
                    // ê¸°íƒ€ - ê¸°ë³¸ í¸ì§‘ í™”ë©´
                    editUrl = `/contract/companyreport/${noPre}/edit/`;
                }

                // ìƒˆ ì°½ì—ì„œ ì—´ê¸° (í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë‚´ìš© ë³´ì¡´)
                window.open(editUrl, '_blank');
            } else {
                // nType ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ìƒì„¸ í™”ë©´ìœ¼ë¡œ
                window.open(`/contract/companyreport/${noPre}/detail/`, '_blank');
            }
        } else {
            alert('ì´ì „ ë³´ê³ ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // ì—ëŸ¬ ë°œìƒì‹œ ê¸°ë³¸ ìƒì„¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        window.open(`/contract/companyreport/${noPre}/detail/`, '_blank');
    });
}

// noPre ë³€ê²½ ì‹œ ì´ì „ ë³´ê³ ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
function fetchParentReportData(noPre) {
    console.log('fetchParentReportData called with noPre:', noPre);
    if (!noPre) return;

    // í˜„ì¬ ë³´ê³ ì„œ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸° (ìˆ˜ì • ëª¨ë“œì¼ ë•Œë§Œ ì¡´ì¬)
    {% if mode == 'edit' %}
    const currentNo = {{ report.no }};

    // ìê¸° ìì‹ ì„ ì´ì „ ë³´ê³ ë¡œ ì„¤ì •í•˜ëŠ”ì§€ í™•ì¸
    if (parseInt(noPre) === currentNo) {
        alert('ì´ì „ë³´ê³  NoëŠ” í˜„ì¬ ë³´ê³ ì„œ ë²ˆí˜¸ì™€ ê°™ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        document.getElementById('noPre').value = '';
        return;
    }
    {% endif %}

    const csrfToken = getCookie('csrftoken');
    const apiUrl = `/contract/api/companyreport/${noPre}/data/`;

    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('API Response data:', data);
        if (data.success) {
            const reportData = data.data;

            // noNextê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸ (ë‹¤ë¥¸ ë³´ê³ ì„œì— ì´ë¯¸ ì—°ê²°ë¨)
            // ë‹¨, noNextê°€ í˜„ì¬ ë³´ê³ ì„œ ë²ˆí˜¸ì™€ ê°™ë‹¤ë©´ ê¸°ì¡´ ì—°ê²°ì´ë¯€ë¡œ í—ˆìš©
            {% if mode == 'edit' %}
            if (reportData.noNext && reportData.noNext !== currentNo) {
                alert(`ì´ì „ë³´ê³  #${noPre}ëŠ” ì´ë¯¸ ë‹¤ë¥¸ ë³´ê³ ì„œ(#${reportData.noNext})ì— ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
                document.getElementById('noPre').value = '';
                return;
            }
            {% else %}
            // ì‹ ê·œ ìƒì„± ëª¨ë“œì—ì„œëŠ” noNextê°€ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ì°¨ë‹¨
            if (reportData.noNext) {
                alert(`ì´ì „ë³´ê³  #${noPre}ëŠ” ì´ë¯¸ ë‹¤ë¥¸ ë³´ê³ ì„œ(#${reportData.noNext})ì— ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
                document.getElementById('noPre').value = '';
                return;
            }
            {% endif %}

            // nType ê²€ì¦ - ê°ì•¡ì€ ê³„ì•½(0 ë˜ëŠ” 1) íƒ€ì…ì˜ ë³´ê³ ì„œë§Œ ì´ì „ë³´ê³ ë¡œ ì„ íƒ ê°€ëŠ¥
            if (reportData.nType !== undefined && reportData.nType !== 0 && reportData.nType !== 1) {
                const typeLabels = {
                    2: 'ì¦ì•¡(ì…ê¸ˆX)', 3: 'ì¦ì•¡(ì…ê¸ˆO)',
                    4: 'ê°ì•¡(í™˜ë¶ˆX)', 5: 'ê°ì•¡(í™˜ë¶ˆO)',
                    6: 'ì·¨ì†Œ(í™˜ë¶ˆX)', 7: 'ì·¨ì†Œ(í™˜ë¶ˆO)'
                };
                const typeLabel = typeLabels[reportData.nType] || `íƒ€ì… ${reportData.nType}`;
                alert(`ì´ì „ë³´ê³  #${noPre}ëŠ” ${typeLabel} ë³´ê³ ì„œì…ë‹ˆë‹¤.\nê°ì•¡ ë³´ê³ ì˜ ì´ì „ë³´ê³ ëŠ” ê³„ì•½ íƒ€ì…(ê³„ì•½(ì…ê¸ˆX) ë˜ëŠ” ê³„ì•½(ì…ê¸ˆO))ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                document.getElementById('noPre').value = '';
                return;
            }

            // í•„ë“œ ì—…ë°ì´íŠ¸ - ê° í•„ë“œë¥¼ ì•ˆì „í•˜ê²Œ ì—…ë°ì´íŠ¸
            const updateField = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value || '';
                    // Hidden í•„ë“œì¸ì§€ í™•ì¸
                    const fieldType = element.type === 'hidden' ? '(hidden)' : '';
                    console.log(`Updated ${id} ${fieldType} with value:`, value);
                } else {
                    console.warn(`Element with ID '${id}' not found`);
                }
            };

            // noCompany í•„ë“œ ì—…ë°ì´íŠ¸
            updateField('noCompany', reportData.noCompany);

            // ì—…ì²´ëª… í‘œì‹œ í•„ë“œ ì—…ë°ì´íŠ¸ (readonly)
            const companyNameDisplay = document.getElementById('company_name_display');
            if (companyNameDisplay && reportData.companyName) {
                companyNameDisplay.value = reportData.companyName;
                console.log('Updated company_name_display with:', reportData.companyName);
            }

            // sCompanyNameì€ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ìê°€ ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ ìœ ì§€)
            console.log('sCompanyName í•„ë“œëŠ” ê¸°ì¡´ ê°’ ìœ ì§€ (ì‚¬ìš©ì ìˆ˜ì • ê°€ëŠ¥)');

            // Hidden í•„ë“œ ì—…ë°ì´íŠ¸
            updateField('sName', reportData.sName);
            updateField('sPhone', reportData.sPhone);
            updateField('sPost', reportData.sPost);
            updateField('noAssign', reportData.noAssign);
            updateField('sArea', reportData.sArea);
            updateField('sTaxCompany', reportData.sTaxCompany);

            // Display í•„ë“œë„ ì—…ë°ì´íŠ¸ (í™”ë©´ì— í‘œì‹œë˜ëŠ” readonly í•„ë“œ)
            updateField('sName_display', reportData.sName);
            updateField('sPhone_display', reportData.sPhone);
            updateField('sPost_display', reportData.sPost);
            updateField('noAssign_display', reportData.noAssign);
            updateField('sArea_display', reportData.sArea);

            // nConType í•„ë“œ ì—…ë°ì´íŠ¸ (hiddenê³¼ display ëª¨ë‘)
            const nConTypeHidden = document.getElementById('nConType');
            if (nConTypeHidden) {
                nConTypeHidden.value = String(reportData.nConType || 0);
                console.log('Updated nConType (hidden) with value:', reportData.nConType);

                // display í•„ë“œë„ ì—…ë°ì´íŠ¸ (í•œê¸€ í‘œì‹œ)
                const nConTypeDisplay = document.getElementById('nConType_display');
                if (nConTypeDisplay) {
                    const conTypeLabels = {
                        0: '[ì¹´í˜ê±´]ì¸í…Œë¦¬ì–´/ë¦¬ëª¨ë¸ë§/ê¸°íƒ€',
                        1: '[ì¹´í…Œê±´]ì‹ ì¶•/ì¦ì¶•/ê°œì¶•',
                        2: '[ì†Œê°œê±´]ì¸í…Œë¦¬ì–´/ë¦¬ëª¨ë¸ë§/ê¸°íƒ€',
                        3: '[ì†Œê°œê±´]ì‹ ì¶•/ì¦ì¶•/ê°œì¶•'
                    };
                    nConTypeDisplay.value = conTypeLabels[reportData.nConType] || '';
                    console.log('Updated nConType_display with label:', conTypeLabels[reportData.nConType]);
                }
            }

            // í™˜ë¶ˆê³„ì¢Œ ë“œë¡­ë‹¤ìš´ ì˜µì…˜ì„ License ì •ë³´ë¡œ ì—…ë°ì´íŠ¸
            const sAccountSelect = document.getElementById('sAccount');
            if (sAccountSelect && reportData.licenses) {
                // ê¸°ì¡´ ì˜µì…˜ ëª¨ë‘ ì œê±° (ì²« ë²ˆì§¸ 'ì„ íƒí•˜ì„¸ìš”' ì œì™¸)
                while (sAccountSelect.options.length > 1) {
                    sAccountSelect.remove(1);
                }

                // License ì •ë³´ë¡œ ìƒˆ ì˜µì…˜ ì¶”ê°€
                const addedAccounts = new Set(); // ì¤‘ë³µ ë°©ì§€
                reportData.licenses.forEach(license => {
                    if (license.sAccount && !addedAccounts.has(license.sAccount)) {
                        const option = document.createElement('option');
                        option.value = license.sAccount;
                        option.textContent = license.sAccount;
                        sAccountSelect.appendChild(option);
                        addedAccounts.add(license.sAccount);
                    }
                });

                // ì´ì „ì— ì„ íƒëœ ê°’ì´ ìˆìœ¼ë©´ ì„ íƒ
                if (reportData.sAccount) {
                    sAccountSelect.value = reportData.sAccount;
                    console.log('Updated sAccount with licenses and selected:', reportData.sAccount);
                }
            }

            // nRefund select í•„ë“œ ì—…ë°ì´íŠ¸ (í™˜ë¶ˆë°©ì‹)
            const nRefundSelect = document.getElementById('nRefund');
            if (nRefundSelect) {
                nRefundSelect.value = String(reportData.nRefund || 0);
                console.log('Updated nRefund select with value:', reportData.nRefund);
            }

            // ì´ì „ ë³´ê³ ì˜ nConMoneyë¥¼ í˜„ì¬ì˜ nPreConMoneyë¡œ ì„¤ì •
            const nPreConMoneyInput = document.getElementById('nPreConMoney');
            if (nPreConMoneyInput) {
                nPreConMoneyInput.value = reportData.nConMoney || 0;
                console.log('Updated nPreConMoney with value:', reportData.nConMoney);

                // í‘œì‹œ div ì—…ë°ì´íŠ¸
                const displayDiv = nPreConMoneyInput.previousElementSibling;
                if (displayDiv && displayDiv.classList.contains('amount-display')) {
                    displayDiv.textContent = formatNumberWithCommas(reportData.nConMoney || 0) + ' ì› (VAT ë³„ë„)';
                }
            }

            // ì´ì „ ë³´ê³ ì˜ nFeeë¥¼ í˜„ì¬ì˜ nPreFeeë¡œ ì„¤ì •
            const nPreFeeInput = document.getElementById('nPreFee');
            if (nPreFeeInput) {
                nPreFeeInput.value = reportData.nFee || 0;
                console.log('Updated nPreFee with value:', reportData.nFee);

                // í‘œì‹œ div ì—…ë°ì´íŠ¸
                const displayDiv = nPreFeeInput.previousElementSibling;
                if (displayDiv && displayDiv.classList.contains('amount-display')) {
                    displayDiv.textContent = formatNumberWithCommas(reportData.nFee || 0) + ' ì› (VAT í¬í•¨)';
                }
            }

            // ê¸ˆì•¡ì´ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ ì¬ê³„ì‚° ì‹¤í–‰
            if (typeof calculateTotalAmounts === 'function') {
                calculateTotalAmounts();
                console.log('Recalculated all amounts after loading previous report data');
            }

            console.log('ì´ì „ ë³´ê³  ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', reportData);
        } else {
            alert('ì´ì „ ë³´ê³  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Fetch Error Details:', error);
        alert('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initMoneyInputs();
    calculateTotalAmounts();
    updateRefundButton();
    updateTypeByDeposit(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì…ê¸ˆì¼ì— ë”°ë¼ nType ì„¤ì •

    // nRefund ë³€ê²½ ê°ì§€ - ì‹¤ì‹œê°„ìœ¼ë¡œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    const nRefundSelect = document.getElementById('nRefund');
    if (nRefundSelect) {
        nRefundSelect.addEventListener('change', function() {
            console.log('nRefund ë³€ê²½ë¨:', this.value);
            updateRefundButton();
        });
    }

    // íŒŒì¼ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.querySelectorAll('.delete-file-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const fileId = this.dataset.fileId;
            const fileName = this.dataset.fileName;

            if (confirm(`"${fileName}" íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                deleteReportFile(fileId);
            }
        });
    });

    // í¼ ì œì¶œ ì‹œ ê°’ ë™ê¸°í™”
    document.getElementById('decreaseForm').addEventListener('submit', function(e) {
        // ëª¨ë“  display í•„ë“œì˜ ê°’ì„ hidden í•„ë“œë¡œ ë³µì‚¬
        const fields = [
            { display: 'nConMoney_display', hidden: 'nConMoney' },
            { display: 'nDeposit_display', hidden: 'nDeposit' }
        ];

        fields.forEach(field => {
            const displayEl = document.getElementById(field.display);
            const hiddenEl = document.getElementById(field.hidden);

            if (displayEl && hiddenEl) {
                const cleanValue = removeCommas(displayEl.value);
                hiddenEl.value = cleanValue || '0';
            }
        });

        // ì œì¶œ ì „ ê°’ í™•ì¸ (ë””ë²„ê¹…)
        console.log('=== í¼ ì œì¶œ ì‹œ ê°’ í™•ì¸ ===');
        console.log('nDeposit:', document.getElementById('nDeposit').value);
        console.log('dateDeposit:', document.getElementById('dateDeposit').value);
        console.log('nType:', document.getElementById('nType').value);
    });
});
</script>
{% endblock %}
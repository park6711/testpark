{% extends "staff/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}
    {% if action == 'create' %}ì‹ ê·œ ê³„ì•½ë³´ê³ {% elif action == 'increase' %}ì¦ì•¡ ë³´ê³ {% elif action == 'decrease' %}ê°ì•¡ ë³´ê³ {% elif action == 'cancel' %}ì·¨ì†Œ ë³´ê³ {% else %}ê³„ì•½ë³´ê³  ìƒì„¸{% endif %}
{% endblock %}

{% block page_title %}
{% if mode == 'edit' %}
    {% if action == 'create' %}ì‹ ê·œ ê³„ì•½ë³´ê³ {% elif action == 'increase' %}ì¦ì•¡ ë³´ê³ {% elif action == 'decrease' %}ê°ì•¡ ë³´ê³ {% elif action == 'cancel' %}ì·¨ì†Œ ë³´ê³ {% else %}ê³„ì•½ë³´ê³  ìˆ˜ì •{% endif %}
{% else %}
    ê³„ì•½ë³´ê³  ìƒì„¸ë³´ê¸°
{% endif %}
{% endblock %}

{% block page_subtitle %}
ê³„ì•½ë³´ê³  #{% if report %}{{ report.no }}{% else %}ì‹ ê·œ{% endif %}
{% endblock %}

{% block content %}
<style>
    /* ê³ ê°ê³„ì•½ë³´ê³  ìˆ˜ì • í™”ë©´ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼ ì ìš© */
    .detail-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
        margin-top: 20px;
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }

    .main-title {
        font-size: 24px;
        font-weight: bold;
        color: #2d3748;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 3px solid #667eea;
        text-align: center;
    }

    .section-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-col {
        flex: 1;
    }

    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #495057;
        font-size: 14px;
    }

    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.15s ease-in-out;
    }

    .form-control:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .form-control[readonly] {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .form-control-plaintext {
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 14px;
        color: #495057;
    }

    select.form-control {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right .75rem center;
        background-size: 16px 12px;
        padding-right: 2.25rem;
    }

    textarea.form-control {
        resize: vertical;
        min-height: 100px;
    }

    .btn-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
        background: linear-gradient(135deg, #0f9d58 0%, #0a6f3f 100%);
        color: white;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(15, 157, 88, 0.4);
    }

    .btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: #333;
    }

    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
    }

    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
    }

    .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }

    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
    }

    .btn-calculate {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 5px;
        font-size: 12px;
        cursor: pointer;
        margin-left: 10px;
    }

    .btn-calculate:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(72, 187, 120, 0.4);
    }

    .link-display {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        color: #007bff;
        text-decoration: none;
    }

    .link-display:hover {
        text-decoration: underline;
    }

    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-secondary {
        background: #6c757d;
        color: white;
    }

    .badge-success {
        background: #28a745;
        color: white;
    }

    .badge-warning {
        background: #ffc107;
        color: #333;
    }

    .badge-danger {
        background: #dc3545;
        color: white;
    }

    .amount-display {
        font-size: 1.1rem;
        font-weight: bold;
        color: #2d3748;
    }

    .info-box {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    .file-upload-area {
        border: 2px dashed #cbd5e0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .file-upload-area:hover {
        border-color: #667eea;
        background: #f7fafc;
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
        }

        .btn-group {
            flex-wrap: wrap;
        }

        .detail-container {
            padding: 20px;
        }
    }

    /* ì»¤ìŠ¤í…€ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        animation: fadeIn 0.3s;
    }

    .modal-overlay.active {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s;
    }

    .modal-header {
        margin-bottom: 20px;
    }

    .modal-title {
        font-size: 20px;
        font-weight: bold;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-body {
        color: #666;
        font-size: 16px;
        line-height: 1.5;
        margin-bottom: 25px;
    }

    .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .modal-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .modal-btn-cancel {
        background: #e9ecef;
        color: #495057;
    }

    .modal-btn-cancel:hover {
        background: #dee2e6;
    }

    .modal-btn-danger {
        background: linear-gradient(135deg, #f93b1d 0%, #ea2c62 100%);
        color: white;
    }

    .modal-btn-danger:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(234, 44, 98, 0.4);
    }

    .modal-btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .modal-btn-primary:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .point-info {
        background: #f7fafc;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* sPost ì…ë ¥ í•„ë“œ ë„ˆë¹„ ì¦ê°€ - flexë¥¼ í™œìš©í•œ ë¹„ìœ¨ ì¡°ì • */
    .spost-input-wrapper {
        flex: 1.25; /* ê¸°ë³¸ flex: 1ì—ì„œ 25% ì¦ê°€ */
        min-width: 0; /* flex itemì´ ë‚´ìš©ë³´ë‹¤ ì‘ì•„ì§ˆ ìˆ˜ ìˆë„ë¡ */
    }

    /* sPostì™€ ê°™ì€ í–‰ì— ìˆëŠ” ë‹¤ë¥¸ í•„ë“œëŠ” ê¸°ë³¸ í¬ê¸° ìœ ì§€ */
    .form-row .form-group:not(.spost-input-wrapper) {
        flex: 1;
    }

    .action-buttons {
        margin-top: 30px;
        display: flex;
        gap: 10px;
        justify-content: center;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
    }

    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
    }

    .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }

    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
    }

    .btn-success {
        background: linear-gradient(135deg, #0f9d58 0%, #0a6f3f 100%);
        color: white;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(15, 157, 88, 0.4);
    }

    .btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: #333;
    }

    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .status-contract {
        background: #bee3f8;
        color: #2c5282;
    }

    .status-paid {
        background: #c6f6d5;
        color: #22543d;
    }

    .status-increase {
        background: #fbb6ce;
        color: #702459;
    }

    .status-decrease {
        background: #fed7d7;
        color: #742a2a;
    }

    .status-cancel {
        background: #e2e8f0;
        color: #2d3748;
    }

    .readonly-field {
        background-color: #f7fafc !important;
        cursor: not-allowed;
    }

    .required-field::after {
        content: " *";
        color: #f56565;
    }

    .info-text {
        font-size: 0.85rem;
        color: #718096;
        margin-top: 5px;
    }

    .amount-positive {
        color: #22543d;
        font-weight: bold;
    }

    .amount-negative {
        color: #742a2a;
        font-weight: bold;
    }

    /* ì—…ì²´ ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    .company-search-container {
        position: relative;
        display: inline-block;
        width: 100%;
    }

    .company-search-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        width: 100%;
        background: #fff;
        cursor: pointer;
        box-sizing: border-box;
    }

    .company-search-input:focus {
        outline: none;
        border-color: #4CAF50;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
    }

    .company-dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 9999;
        display: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-top: -1px;
    }

    .company-dropdown-item {
        padding: 10px 12px;
        font-size: 14px;
        cursor: pointer;
        border-bottom: 1px solid #f5f5f5;
        transition: background-color 0.15s;
    }

    .company-dropdown-item:last-child {
        border-bottom: none;
    }

    .company-dropdown-item:hover {
        background: #f0f0f0;
    }

    .company-dropdown-item.highlighted {
        background: #4CAF50;
        color: white;
    }
</style>

<div class="detail-container">
    <form id="reportForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- ì£¼ íƒ€ì´í‹€ -->
        <div class="main-title">ê³„ì•½ ë³´ê³ </div>

        <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ê¸°ë³¸ ì •ë³´</div>

        <div class="form-row">
                <div class="form-col">
                    <label class="form-label">No</label>
                    {% if mode == 'view' %}
                        <div class="form-control-plaintext">#{{ report.no }}</div>
                    {% else %}
                        <input type="text" class="form-control" value="{{ report.no|default:'ì‹ ê·œ' }}" readonly>
                    {% endif %}
                </div>
                <div class="form-col">
                    <label class="form-label">ì´í›„ë³´ê³  No</label>
                    <div class="form-control-plaintext">
                        {% if report.noNext %}
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span>#{{ report.noNext }}</span>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="goToNextReport({{ report.noNext }})"
                                        style="white-space: nowrap;">
                                    ë°”ë¡œê°€ê¸°
                                </button>
                            </div>
                        {% else %}
                            -
                        {% endif %}
                    </div>
                </div>
                <div class="form-col">
                    <label class="form-label">íƒ€ì„ìŠ¤íƒ¬í”„</label>
                    <div class="form-control-plaintext">
                        {% if report.timeStamp %}
                            {{ report.timeStamp|date:"Y-m-d H:i:s" }}
                        {% else %}
                            -
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">ì—…ì²´ëª…(êµ¬ê¸€)</label>
                    {% if mode == 'view' %}
                        <div class="form-control-plaintext">{{ report.sCompanyName|default:"-" }}</div>
                    {% else %}
                        <input type="text" name="sCompanyName" class="form-control"
                               value="{{ report.sCompanyName|default:'' }}"
                               {% if action in 'increase,decrease,cancel' %}readonly{% endif %}>
                    {% endif %}
                </div>
                <div class="form-col">
                    <label class="form-label">ì—…ì²´ ì„ íƒ</label>
                    {% if mode == 'view' %}
                        <div class="form-control-plaintext">
                            {% if report.company %}
                                {{ report.company.sName2 }}
                            {% else %}
                                -
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="company-search-container" data-report-id="{{ report.no }}">
                            <input type="text"
                                   class="company-search-input"
                                   placeholder="ì—…ì²´ëª…ì„ í´ë¦­í•˜ê±°ë‚˜ ì…ë ¥í•˜ì„¸ìš”..."
                                   value="{% if report.company %}{{ report.company.sName2 }}{% endif %}"
                                   data-report-id="{{ report.no }}"
                                   data-current-company-id="{% if report.company %}{{ report.company.no }}{% else %}0{% endif %}"
                                   autocomplete="off">
                            <input type="hidden" name="noCompany" id="noCompany"
                                   value="{{ report.noCompany|default:'' }}">
                            <div class="company-dropdown-list">
                                {% for company in all_companies %}
                                <div class="company-dropdown-item"
                                     data-company-id="{{ company.no }}"
                                     data-company-name="{{ company.sName2 }}">
                                    {{ company.sName2 }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group spost-input-wrapper">
                        <label class="required-field">ê²Œì‹œê¸€ ë§í¬</label>
                        <input type="text" name="sPost" id="sPost" class="form-control"
                               value="{{ report.sPost|default:'' }}"
                               placeholder="ë„¤ì´ë²„ ì¹´í˜ ê²Œì‹œê¸€ URL"
                               {% if mode == 'view' %}readonly{% endif %}>
                    </div>

                    <div class="form-group">
                        <label>ì˜ë¢° ID</label>
                        <input type="text" id="noOrder" name="noOrder" class="form-control readonly-field"
                               value="{{ report.noOrder|default:'' }}" readonly>
                    </div>

                    <div class="form-group">
                        <label>í• ë‹¹ ID</label>
                        <input type="text" id="noAssign" name="noAssign" class="form-control readonly-field"
                               value="{{ report.noAssign|default:'' }}" readonly>
                    </div>
                </div>

        <!-- ê³µì‚¬ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ê³µì‚¬ ì •ë³´</div>

        <div class="form-row">
                    <div class="form-group">
                        <label>ë³´ê³ êµ¬ë¶„</label>
                        <input type="text" class="form-control readonly-field"
                               value="{{ report.get_nType_display }}" readonly>
                        <input type="hidden" name="nType" id="nType" value="{{ report.nType|default:0 }}">
                    </div>

                    <div class="form-group">
                        <label class="required-field">ê³µì‚¬ ìœ í˜•</label>
                        <select name="nConType" id="nConType" class="form-control"
                                {% if mode == 'view' %}disabled{% endif %}>
                            {% for value, label in CONSTRUCTION_TYPE_CHOICES %}
                            <option value="{{ value }}"
                                    {% if value == report.nConType %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="required-field">ê³ ê° ì´ë¦„</label>
                        <input type="text" name="sName" class="form-control"
                               value="{{ report.sName|default:'' }}"
                               {% if mode == 'view' %}readonly{% endif %}>
                    </div>

                    <div class="form-group">
                        <label class="required-field">ê³ ê° í•¸ë“œí°</label>
                        <input type="text" name="sPhone" class="form-control"
                               value="{{ report.sPhone|default:'' }}"
                               placeholder="010-0000-0000"
                               {% if mode == 'view' %}readonly{% endif %}>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label class="required-field">ê³µì‚¬ ì§€ì—­</label>
                        <textarea name="sArea" class="form-control" rows="2"
                                  {% if mode == 'view' %}readonly{% endif %}>{{ report.sArea|default:'' }}</textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="required-field">ê³µì‚¬ ê³„ì•½ì¼</label>
                        <input type="date" name="dateContract" class="form-control"
                               value="{{ report.dateContract|date:'Y-m-d' }}"
                               {% if mode == 'view' %}readonly{% endif %}>
                    </div>

                    <div class="form-group">
                        <label class="required-field">ê³µì‚¬ ì™„ë£Œì˜ˆì •ì¼</label>
                        <input type="date" name="dateSchedule" class="form-control"
                               value="{{ report.dateSchedule|date:'Y-m-d' }}"
                               {% if mode == 'view' %}readonly{% endif %}>
                    </div>
                </div>

        <!-- ê¸ˆì•¡ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ê¸ˆì•¡ ì •ë³´</div>

        {% if action in 'increase,decrease,cancel' and report.nPreConMoney %}
                <div class="form-row">
                    <div class="form-group">
                        <label>ì´ì „ ë³´ê³  ê³µì‚¬ê¸ˆì•¡</label>
                        <div class="amount-display">
                            {{ report.nPreConMoney|intcomma }} ì› (VAT ë³„ë„)
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ì´ì „ ë³´ê³  ìˆ˜ìˆ˜ë£Œ</label>
                        <div class="amount-display">
                            {{ report.nPreFee|intcomma }} ì› (VAT í¬í•¨)
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="form-row">
                    <div class="form-group">
                        <label>ê³µì‚¬ê¸ˆì•¡(êµ¬ê¸€)</label>
                        <input type="text" name="sConMoney" class="form-control"
                               value="{{ report.sConMoney|default:'' }}"
                               placeholder="êµ¬ê¸€ ì‹œíŠ¸ ì›ë³¸ í…ìŠ¤íŠ¸"
                               {% if mode == 'view' %}readonly{% endif %}>
                    </div>

                    <div class="form-group">
                        <label class="required-field">
                            {% if action == 'increase' %}
                                ì´ë²ˆ ë³´ê³  ì¦ì•¡ê¸ˆì•¡
                            {% elif action == 'decrease' %}
                                ì´ë²ˆ ë³´ê³  ê°ì•¡ê¸ˆì•¡
                            {% elif action == 'cancel' %}
                                ì´ë²ˆ ë³´ê³  ì·¨ì†Œê¸ˆì•¡
                            {% else %}
                                ê³µì‚¬ê¸ˆì•¡
                            {% endif %}
                        </label>
                        <div style="display: flex; align-items: center;">
                            <input type="text" id="nConMoney_display" class="form-control money-input"
                                   value="{{ report.nConMoney|default:0|floatformat:0 }}"
                                   {% if mode == 'view' or action == 'cancel' %}readonly{% endif %}>
                            <input type="hidden" name="nConMoney" id="nConMoney" value="{{ report.nConMoney|default:0 }}">
                            <span style="margin-left: 10px;">ì› (VAT ë³„ë„)</span>
                            {% if mode != 'view' and action != 'cancel' %}
                            <button type="button" class="btn-calculate" onclick="convertToVatExcluded()">
                                ë¶€ê°€ì„¸ ë³„ë„ ë³€í™˜
                            </button>
                            {% endif %}
                        </div>
                        <div class="info-text">ë°˜ë“œì‹œ VAT ë³„ë„ ê¸ˆì•¡ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                    </div>
                </div>

                {% if action in 'increase,decrease' %}
                <div class="form-row">
                    <div class="form-group">
                        <label>ìµœì¢… ê³µì‚¬ ê¸ˆì•¡</label>
                        <div class="amount-display" id="totalConMoney">
                            0 ì› (VAT ë³„ë„)
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ìµœì¢… ê¸°ì¤€ (ì˜ˆìƒ) ìˆ˜ìˆ˜ë£Œ</label>
                        <div class="amount-display" id="totalFee">
                            0 ì› (VAT í¬í•¨)
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="form-row">
                    <div class="form-group">
                        <label class="required-field">(ì ìš©) ìˆ˜ìˆ˜ë£Œ</label>
                        <div style="display: flex; align-items: center;">
                            <input type="text" id="nFee_display" class="form-control money-input"
                                   value="{{ report.nFee|default:0|floatformat:0 }}"
                                   {% if mode == 'view' %}readonly{% endif %}>
                            <input type="hidden" name="nFee" id="nFee" value="{{ report.nFee|default:0 }}">
                            <span style="margin-left: 10px;">ì› (VAT í¬í•¨)</span>
                            {% if mode != 'view' %}
                            <button type="button" class="btn-calculate" onclick="calculateFee()">
                                ìˆ˜ìˆ˜ë£Œ ìë™ê³„ì‚°
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

        <!-- í¬ì¸íŠ¸ ë° ì²­êµ¬ ì„¹ì…˜ -->
        <div class="section-title">í¬ì¸íŠ¸ ë° ì²­êµ¬</div>

        <div class="point-info">
            <div class="form-row">
                <div class="form-group">
                    <label>ì”ì•¡ í¬ì¸íŠ¸</label>
                    <div class="amount-display">
                        <span id="remainPoint">{{ remain_point|default:0|intcomma }}</span> í¬ì¸íŠ¸
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group" style="margin-top: 25px;">
                        <input type="checkbox" id="useAllPoints" onclick="applyAllPoints()">
                        <label for="useAllPoints">ì „ë¶€ ì‚¬ìš©</label>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ì ìš© í¬ì¸íŠ¸</label>
                    <div style="display: flex; align-items: center;">
                        <input type="text" id="nAppPoint_display" class="form-control money-input"
                               value="{{ report.nAppPoint|default:0|floatformat:0 }}"
                               {% if mode == 'view' %}readonly{% endif %}>
                        <input type="hidden" name="nAppPoint" id="nAppPoint" value="{{ report.nAppPoint|default:0 }}">
                        <span style="margin-left: 10px;">í¬ì¸íŠ¸</span>
                        {% if mode != 'view' and report.nAppPoint > 0 %}
                        <button type="button" class="btn-calculate" onclick="processPoint(0)">
                            í¬ì¸íŠ¸ ì°¨ê° ì ìš©
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="form-row" style="margin-top: 20px;">
            <div class="form-group">
                <label>(ì ìš©) ì²­êµ¬ì•¡</label>
                <div class="amount-display" id="demandAmount">
                    {{ report.nDemand|default:0|intcomma }} ì› (VAT í¬í•¨)
                </div>
                <input type="hidden" name="nDemand" id="nDemand" value="{{ report.nDemand|default:0 }}">
            </div>

            <div class="form-group">
                <div style="margin-top: 25px;">
                    {% if mode != 'view' %}
                    <button type="button" class="btn btn-warning" onclick="sendInvoiceSMS()">
                        ì²­êµ¬ ë¬¸ì ë°œì†¡
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ì„ ìœ„í•œ ì‚¬ì—…ì</label>
                <select name="sTaxCompany" class="form-control"
                        {% if mode == 'view' %}disabled{% endif %}>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    {% for tax_company in tax_companies %}
                    <option value="{{ tax_company }}"
                            {% if tax_company == report.sTaxCompany %}selected{% endif %}>
                        {{ tax_company }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- ì…ê¸ˆ ì •ë³´ ì„¹ì…˜ -->
        <div class="section-title">ì…ê¸ˆ ì •ë³´</div>

        <div class="form-row">
            <div class="form-group">
                <label>ì…ê¸ˆì•¡</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" id="nDeposit_display" class="form-control money-input"
                           value="{{ report.nDeposit|default:0|floatformat:0 }}"
                           {% if mode == 'view' %}readonly{% endif %}>
                    <input type="hidden" name="nDeposit" id="nDeposit" value="{{ report.nDeposit|default:0 }}">
                    <span>ì›</span>
                    {% if mode != 'view' %}
                    <button type="button" class="btn-calculate" onclick="copyDemandToDeposit()" style="white-space: nowrap;">
                        ì²­êµ¬ì•¡ìœ¼ë¡œ ì…ê¸ˆì•¡ ì…ë ¥í•˜ê¸°
                    </button>
                    {% endif %}
                </div>
            </div>

            <div class="form-group">
                <label>ì…ê¸ˆì¼</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="date" name="dateDeposit" id="dateDeposit" class="form-control"
                           value="{{ report.dateDeposit|date:'Y-m-d' }}"
                           {% if mode == 'view' %}readonly{% endif %}>
                    {% if mode != 'view' %}
                    <button type="button" class="btn-calculate" onclick="completeDeposit()" style="white-space: nowrap;">
                        ì…ê¸ˆì¼ ì˜¤ëŠ˜ë¡œ ì…ë ¥
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>ê³¼/ë¯¸ì…ê¸ˆ</label>
                <div class="amount-display" id="excessAmount">
                    <span class="{% if report.nExcess > 0 %}amount-positive{% elif report.nExcess < 0 %}amount-negative{% endif %}">
                        {{ report.nExcess|default:0|intcomma }} ì›
                    </span>
                </div>
                <input type="hidden" name="nExcess" id="nExcess" value="{{ report.nExcess|default:0 }}">
                <div class="info-text">+ì´ë©´ ê³¼ì…ê¸ˆ, -ì´ë©´ ë¯¸ì…ê¸ˆì…ë‹ˆë‹¤.</div>
            </div>

            <div class="form-group">
                {% if mode != 'view' %}
                <div id="excessPointButton" style="margin-top: 25px; display: none;">
                    <button type="button" class="btn btn-success" onclick="processPoint(2)">
                        ê³¼ì…ê¸ˆ í¬ì¸íŠ¸ ì ë¦½
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>ê³¼ì…ê¸ˆì‹œ í™˜ë¶ˆë°©ì‹</label>
                <select name="nRefund" id="nRefund" class="form-control"
                        {% if mode == 'view' %}disabled{% endif %}>
                    {% for value, label in REFUND_TYPE_CHOICES %}
                    <option value="{{ value }}"
                            {% if value == report.nRefund %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>í™˜ë¶ˆê³„ì¢Œ</label>
                <select name="sAccount" class="form-control"
                        {% if mode == 'view' %}disabled{% endif %}>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    {% for account in accounts %}
                    <option value="{{ account }}"
                            {% if account == report.sAccount %}selected{% endif %}>
                        {{ account }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- ì²¨ë¶€íŒŒì¼ ë° ë©”ëª¨ ì„¹ì…˜ -->
        <div class="section-title">ì²¨ë¶€íŒŒì¼ ë° ë©”ëª¨</div>

        <div class="form-row">
            <div class="form-group">
                <label>ê³„ì•½ì„œ ì‚¬ë³¸(êµ¬ê¸€)</label>
                <input type="text" name="sFile" class="form-control"
                       value="{{ report.sFile|default:'' }}"
                       placeholder="êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë§í¬"
                       {% if mode == 'view' %}readonly{% endif %}>
            </div>

            <div class="form-group">
                <label>ê³„ì•½ì„œ ì‚¬ë³¸</label>

                <!-- ê¸°ì¡´ ë‹¨ì¼ íŒŒì¼ í‘œì‹œ (í˜¸í™˜ì„±) -->
                {% if report.file %}
                <div class="mb-2">
                    <a href="{{ report.file.url }}" target="_blank" class="btn btn-sm btn-secondary">
                        ğŸ“ ê¸°ì¡´ íŒŒì¼ ë³´ê¸°
                    </a>
                </div>
                {% endif %}

                <!-- ë‹¤ì¤‘ íŒŒì¼ ëª©ë¡ í‘œì‹œ -->
                {% if report.pk and report.report_files.all %}
                <div class="uploaded-files mb-3">
                    <h6 class="text-muted">ì—…ë¡œë“œëœ íŒŒì¼:</h6>
                    <div class="file-list">
                        {% for file in report.report_files.all %}
                        <div class="file-item d-flex align-items-center mb-2" data-file-id="{{ file.no }}">
                            <a href="{{ file.file.url }}" target="_blank" class="flex-grow-1">
                                ğŸ“„ {{ file.original_name }}
                                <small class="text-muted">({{ file.file_size|filesizeformat }})</small>
                            </a>
                            {% if mode != 'view' %}
                            <button type="button" class="btn btn-sm btn-danger ml-2 delete-file-btn"
                                    data-file-id="{{ file.no }}" data-file-name="{{ file.original_name }}">
                                ì‚­ì œ
                            </button>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- ë‹¤ì¤‘ íŒŒì¼ ì—…ë¡œë“œ ì…ë ¥ -->
                {% if mode != 'view' %}
                <div class="file-upload-area">
                    <input type="file" name="files" class="form-control" multiple>
                    <small class="form-text text-muted">ì—¬ëŸ¬ íŒŒì¼ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (Ctrl/Cmd + í´ë¦­)</small>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>ì—…ì²´ì—ì„œ ë‚¨ê¸´ ë§ì”€</label>
                <textarea name="sCompanyMemo" class="form-control" rows="3"
                          {% if mode == 'view' %}readonly{% endif %}>{{ report.sCompanyMemo|default:'' }}</textarea>
            </div>

            <div class="form-group">
                <label>ìŠ¤í… ë©”ëª¨</label>
                <textarea name="sStaffMemo" class="form-control" rows="3"
                          {% if mode == 'view' %}readonly{% endif %}>{{ report.sStaffMemo|default:'' }}</textarea>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>ë³´ê³ ì</label>
                <input type="text" class="form-control readonly-field"
                       value="{% if report.sWorker %}{{ report.sWorker }}{% elif current_staff %}{{ current_staff.sNick }}{% endif %}" readonly>
            </div>
        </div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ ì„¹ì…˜ -->
        <div class="action-buttons">
                {% if mode == 'edit' %}
                    <!-- ìˆ˜ì • ëª¨ë“œ: [ì €ì¥][ì‚­ì œ][ë‹«ê¸°] -->
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                    {% if has_write_permission and report.no and 'delete' in available_actions %}
                    <button type="button" class="btn btn-danger" onclick="deleteReport()">ì‚­ì œ</button>
                    {% endif %}
                    <a href="{% url 'contract:companyreport_list' %}" class="btn btn-secondary">ë‹«ê¸°</a>
                {% else %}
                    <!-- ë³´ê¸° ëª¨ë“œ: [ë‹«ê¸°] -->
                    <a href="{% url 'contract:companyreport_list' %}" class="btn btn-secondary">ë‹«ê¸°</a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="deleteModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>ê³„ì•½ë³´ê³  ì‚­ì œ</h3>
        </div>
        <div class="modal-body">
            <p>ìƒê¸° ê³„ì•½ë³´ê³ ë¥¼ ì‚­ì œí•˜ì‹œë©´, ê¸°ì¡´ ê³„ì•½ë³´ê³  ë°ì´í„°ëŠ” ì‚­ì œë©ë‹ˆë‹¤.</p>
            <p><strong>ê³„ì•½ë³´ê³ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</strong></p>
        </div>
        <div class="modal-footer">
            <button onclick="confirmDelete()" class="btn btn-danger">ì˜ˆ(ì‚­ì œ)</button>
            <button onclick="closeDeleteModal()" class="btn btn-secondary">ì•„ë‹ˆì˜¤</button>
        </div>
    </div>
</div>

<!-- ì¸ë¼ì¸ JavaScript ì¶”ê°€ (ë“œë¡­ë°•ìŠ¤ ê¸°ëŠ¥) -->
<script>
// ì „ì—­ ë³€ìˆ˜
let currentReportNo = {{ report.no|default:'null' }};
let currentCompanyNo = {{ report.noCompany|default:'null' }};
let currentWorker = '{% if current_staff %}{{ current_staff.sNick }}{% endif %}';  // í˜„ì¬ ë¡œê·¸ì¸í•œ Staff.sNick

// ì´í›„ ë³´ê³ ì„œë¡œ ë°”ë¡œê°€ê¸°
function goToNextReport(noNext) {
    if (!noNext) {
        alert('ì´í›„ë³´ê³  Noê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    console.log('ì´í›„ ë³´ê³ ì„œë¡œ ì´ë™:', noNext);

    // API í˜¸ì¶œí•˜ì—¬ ë³´ê³ ì„œ íƒ€ì… í™•ì¸
    fetch(`/contract/api/companyreport/${noNext}/data/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data) {
            const reportData = data.data;

            // nTypeì— ë”°ë¼ ì ì ˆí•œ ìˆ˜ì • í™”ë©´ìœ¼ë¡œ ì´ë™
            if (reportData.nType !== undefined) {
                const nType = reportData.nType;
                let editUrl = '';

                if (nType === 0 || nType === 1) {
                    // ê³„ì•½
                    editUrl = `/contract/companyreport/${noNext}/edit/`;
                } else if (nType === 2 || nType === 3) {
                    // ì¦ì•¡
                    editUrl = `/contract/companyreport/${noNext}/increase/`;
                } else if (nType === 4 || nType === 5) {
                    // ê°ì•¡
                    editUrl = `/contract/companyreport/${noNext}/decrease/`;
                } else if (nType === 6 || nType === 7) {
                    // ì·¨ì†Œ
                    editUrl = `/contract/companyreport/${noNext}/cancel/`;
                } else {
                    // ê¸°íƒ€ - ê¸°ë³¸ í¸ì§‘ í™”ë©´
                    editUrl = `/contract/companyreport/${noNext}/edit/`;
                }

                // ìƒˆ ì°½ì—ì„œ ì—´ê¸° (í˜„ì¬ í˜ì´ì§€ ë‚´ìš© ë³´ì¡´)
                window.open(editUrl, '_blank');
            } else {
                // nType ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ìƒì„¸ í™”ë©´ìœ¼ë¡œ
                window.open(`/contract/companyreport/${noNext}/detail/`, '_blank');
            }
        } else {
            alert('ì´í›„ ë³´ê³ ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // ì—ëŸ¬ ë°œìƒì‹œ ê¸°ë³¸ ìƒì„¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        window.open(`/contract/companyreport/${noNext}/detail/`, '_blank');
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    // noCompanyë‚˜ sPost ë³€ê²½ ì‹œ Order/Assign ìë™ ê²€ìƒ‰
    const noCompanyField = document.getElementById('noCompany');
    const sPostField = document.getElementById('sPost');

    if (noCompanyField) {
        noCompanyField.addEventListener('change', searchOrderAndAssign);
    }

    if (sPostField) {
        sPostField.addEventListener('blur', searchOrderAndAssign);
    }

    // ê¸ˆì•¡ í•„ë“œ ë³€ê²½ ì‹œ ìë™ ê³„ì‚°
    const nConMoneyField = document.getElementById('nConMoney');
    if (nConMoneyField) {
        nConMoneyField.addEventListener('change', function() {
            {% if action in 'increase,decrease' %}
            calculateTotalAmounts();
            {% endif %}
        });
    }

    // ì—…ì²´ ê²€ìƒ‰ ë“œë¡­ë°•ìŠ¤ ì´ˆê¸°í™”
    const companyContainer = document.querySelector('.company-search-container');
    if (companyContainer) {
        new CompanySearchDropdown(companyContainer);
    }

    // ì…ê¸ˆì¼ ë³€ê²½ ì‹œ nType ìë™ ì—…ë°ì´íŠ¸
    const dateDepositField = document.getElementById('dateDeposit');
    if (dateDepositField) {
        dateDepositField.addEventListener('change', updateTypeByDeposit);
        dateDepositField.addEventListener('blur', updateTypeByDeposit);
    }

    // í™˜ë¶ˆë°©ì‹(nRefund) ë³€ê²½ ì‹œ ê³¼ì…ê¸ˆ í¬ì¸íŠ¸ ì ë¦½ ë²„íŠ¼ ì—…ë°ì´íŠ¸
    const nRefundField = document.getElementById('nRefund');
    if (nRefundField) {
        nRefundField.addEventListener('change', updateExcessPointButton);
    }

    // ì´ˆê¸° ê³„ì‚° ì‹¤í–‰
    calculateDemand();
    calculateExcess();
    updateTypeByDeposit();  // ì´ˆê¸° ë¡œë“œ ì‹œ nType ì„¤ì •
    updateExcessPointButton();  // ì´ˆê¸° ë¡œë“œ ì‹œ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì„¤ì •
    {% if action in 'increase,decrease' %}
    calculateTotalAmounts();
    {% endif %}
});

// ì—…ì²´ ë°°ì • í•¨ìˆ˜
function assignCompany(reportNo, companyNo) {
    if (!companyNo) {
        return Promise.resolve(false);
    }

    const csrfToken = getCookie('csrftoken');

    return fetch('/contract/assign-company/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({
            report_no: reportNo,
            company_no: companyNo
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('ì—…ì²´ ë°°ì • ì„±ê³µ');
            // ì—…ì²´ ì„ íƒ í›„ hidden í•„ë“œ ì—…ë°ì´íŠ¸
            document.getElementById('noCompany').value = companyNo;
            // Orderì™€ Assign ìë™ ê²€ìƒ‰
            searchOrderAndAssign();
            return true;
        } else {
            console.error('ì—…ì²´ ë°°ì • ì‹¤íŒ¨:', data.error);
            alert(data.error || 'ì—…ì²´ ë°°ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            return false;
        }
    })
    .catch(error => {
        console.error('ì—…ì²´ ë°°ì • ì˜¤ë¥˜:', error);
        alert('ì—…ì²´ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        return false;
    });
}

// Orderì™€ Assign ìë™ ê²€ìƒ‰
function searchOrderAndAssign() {
    const noCompany = document.getElementById('noCompany').value;
    const sPost = document.getElementById('sPost').value;

    if (!sPost) return;

    // Order ê²€ìƒ‰
    fetch('/contract/api/order-search/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            post: sPost,
            company_no: noCompany
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('noOrder').value = data.order_no;

            // Orderë¥¼ ì°¾ì•˜ìœ¼ë©´ Assignë„ ê²€ìƒ‰
            if (noCompany && data.order_no) {
                searchAssign(noCompany, data.order_no);
            }
        }
    });
}

// Assign ê²€ìƒ‰
function searchAssign(companyNo, orderNo) {
    fetch('/contract/api/assign-search/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            company_no: companyNo,
            order_no: orderNo
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('noAssign').value = data.assign_no;
        }
    });
}

// VAT ë³„ë„ ë³€í™˜
function convertToVatExcluded() {
    const nConMoney = document.getElementById('nConMoney');
    const currentValue = parseFloat(nConMoney.value) || 0;
    nConMoney.value = Math.floor(currentValue / 1.1);

    {% if action in 'increase,decrease' %}
    calculateTotalAmounts();
    {% endif %}
}

// ìˆ˜ìˆ˜ë£Œ ìë™ ê³„ì‚°
function calculateFee() {
    const conType = parseInt(document.getElementById('nConType').value);
    const conMoney = parseInt(document.getElementById('nConMoney').value) || 0;

    let fee = 0;

    // ê³µì‚¬ìœ í˜•ë³„ ìˆ˜ìˆ˜ë£Œ ê³„ì‚°
    switch(conType) {
        case 0: // ì¹´í˜ê±´ ì¸í…Œë¦¬ì–´
            if (conMoney <= 50000000) {
                // 5ì²œë§Œì› ì´í•˜: 5.5%
                fee = Math.round(conMoney * 0.055);
            } else {
                // 5ì²œë§Œì› ì´ˆê³¼: 5ì²œë§Œì›ê¹Œì§€ 5.5% + ì´ˆê³¼ë¶„ 3.3%
                fee = Math.round(50000000 * 0.055 + (conMoney - 50000000) * 0.033);
            }
            break;

        case 1: // ì¹´í…Œê±´ ì‹ ì¶•
            // ì¼ë¥  3.3%
            fee = Math.round(conMoney * 0.033);
            break;

        case 2: // ì†Œê°œê±´ ì¸í…Œë¦¬ì–´
            // ì¼ë¥  3.3%
            fee = Math.round(conMoney * 0.033);
            break;

        case 3: // ì†Œê°œê±´ ì‹ ì¶•
            // ì¼ë¥  2.2%
            fee = Math.round(conMoney * 0.022);
            break;

        default:
            // ê¸°ë³¸ê°’ 0
            fee = 0;
    }

    // ê³„ì‚°ëœ ìˆ˜ìˆ˜ë£Œ ì…ë ¥ (hidden í•„ë“œì™€ display í•„ë“œ ëª¨ë‘ ì—…ë°ì´íŠ¸)
    document.getElementById('nFee').value = fee;
    const feeDisplay = document.getElementById('nFee_display');
    if (feeDisplay) {
        feeDisplay.value = formatNumberWithCommas(fee.toString());
    }

    // ì²­êµ¬ì•¡ ì¬ê³„ì‚°
    calculateDemand();
}

// ì „ì²´ í¬ì¸íŠ¸ ì ìš©
function applyAllPoints() {
    const useAll = document.getElementById('useAllPoints').checked;
    if (useAll) {
        const remainPoint = parseInt(document.getElementById('remainPoint').textContent.replace(/,/g, '')) || 0;
        const nFee = parseInt(document.getElementById('nFee').value) || 0;
        const applyPoint = Math.min(remainPoint, nFee);
        document.getElementById('nAppPoint').value = applyPoint;
        const appPointDisplay = document.getElementById('nAppPoint_display');
        if (appPointDisplay) {
            appPointDisplay.value = formatNumberWithCommas(applyPoint.toString());
        }
        calculateDemand();
    } else {
        document.getElementById('nAppPoint').value = 0;
        const appPointDisplay = document.getElementById('nAppPoint_display');
        if (appPointDisplay) {
            appPointDisplay.value = '0';
        }
        calculateDemand();
    }
}

// ì²­êµ¬ì•¡ ê³„ì‚°
function calculateDemand() {
    const nFee = parseInt(document.getElementById('nFee').value) || 0;
    const nAppPoint = parseInt(document.getElementById('nAppPoint').value) || 0;
    const nDemand = nFee - nAppPoint;

    document.getElementById('nDemand').value = nDemand;
    document.getElementById('demandAmount').textContent = nDemand.toLocaleString() + ' ì› (VAT í¬í•¨)';
}

// ê³¼/ë¯¸ì…ê¸ˆ ê³„ì‚°
function calculateExcess() {
    const nDeposit = parseInt(document.getElementById('nDeposit').value) || 0;
    const nDemand = parseInt(document.getElementById('nDemand').value) || 0;
    const nExcess = nDeposit - nDemand;

    document.getElementById('nExcess').value = nExcess;

    const excessSpan = document.getElementById('excessAmount').querySelector('span');
    excessSpan.textContent = nExcess.toLocaleString() + ' ì›';
    excessSpan.className = nExcess > 0 ? 'amount-positive' : (nExcess < 0 ? 'amount-negative' : '');

    // ê³¼ì…ê¸ˆ í¬ì¸íŠ¸ ì ë¦½ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì—…ë°ì´íŠ¸
    updateExcessPointButton();

    // ê³¼/ë¯¸ì…ê¸ˆ ê³„ì‚° í›„ nTypeì€ updateTypeByDeposit í•¨ìˆ˜ë¡œ ì²˜ë¦¬
}

// ê³¼ì…ê¸ˆ í¬ì¸íŠ¸ ì ë¦½ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì œì–´
function updateExcessPointButton() {
    const nExcess = parseInt(document.getElementById('nExcess').value) || 0;
    const nRefund = parseInt(document.getElementById('nRefund').value) || 0;
    const buttonDiv = document.getElementById('excessPointButton');

    if (buttonDiv) {
        // nRefund=1ì´ê³  nExcess>0ì¸ ê²½ìš°ì—ë§Œ ë²„íŠ¼ í‘œì‹œ
        if (nRefund === 1 && nExcess > 0) {
            buttonDiv.style.display = 'block';
        } else {
            buttonDiv.style.display = 'none';
        }
    }
}

// dateDeposit ê°’ì— ë”°ë¼ nType ìë™ ì„¤ì •
function updateTypeByDeposit() {
    const dateDepositField = document.getElementById('dateDeposit');
    const nTypeField = document.getElementById('nType');
    const nTypeDisplay = document.querySelector('input[readonly][value*="ê³„ì•½"]');

    if (dateDepositField && nTypeField) {
        // ì…ê¸ˆì¼ì´ ìˆìœ¼ë©´ ì…ê¸ˆO íƒ€ì…, ì—†ìœ¼ë©´ ì…ê¸ˆX íƒ€ì…
        const hasDeposit = dateDepositField.value && dateDepositField.value.trim() !== '';

        {% if action == 'create' or action == 'edit' %}
        nTypeField.value = hasDeposit ? 1 : 0;  // ê³„ì•½(ì…ê¸ˆO) : ê³„ì•½(ì…ê¸ˆX)
        if (nTypeDisplay) {
            nTypeDisplay.value = hasDeposit ? 'ê³„ì•½(ì…ê¸ˆO)' : 'ê³„ì•½(ì…ê¸ˆX)';
        }
        {% elif action == 'increase' %}
        nTypeField.value = hasDeposit ? 3 : 2;  // ì¦ì•¡(ì…ê¸ˆO) : ì¦ì•¡(ì…ê¸ˆX)
        if (nTypeDisplay) {
            nTypeDisplay.value = hasDeposit ? 'ì¦ì•¡(ì…ê¸ˆO)' : 'ì¦ì•¡(ì…ê¸ˆX)';
        }
        {% elif action == 'decrease' %}
        nTypeField.value = hasDeposit ? 5 : 4;  // ê°ì•¡(í™˜ë¶ˆO) : ê°ì•¡(í™˜ë¶ˆX)
        if (nTypeDisplay) {
            nTypeDisplay.value = hasDeposit ? 'ê°ì•¡(í™˜ë¶ˆO)' : 'ê°ì•¡(í™˜ë¶ˆX)';
        }
        {% elif action == 'cancel' %}
        nTypeField.value = hasDeposit ? 7 : 6;  // ì·¨ì†Œ(í™˜ë¶ˆO) : ì·¨ì†Œ(í™˜ë¶ˆX)
        if (nTypeDisplay) {
            nTypeDisplay.value = hasDeposit ? 'ì·¨ì†Œ(í™˜ë¶ˆO)' : 'ì·¨ì†Œ(í™˜ë¶ˆX)';
        }
        {% endif %}
    }
}

// ì²­êµ¬ì•¡ìœ¼ë¡œ ì…ê¸ˆì•¡ ì…ë ¥í•˜ê¸°
function copyDemandToDeposit() {
    const nDemand = parseInt(document.getElementById('nDemand').value) || 0;
    const nDemandDisplay = document.getElementById('nDemand_display');

    // ì…ê¸ˆì•¡ hidden í•„ë“œì™€ display í•„ë“œ ëª¨ë‘ ì—…ë°ì´íŠ¸
    document.getElementById('nDeposit').value = nDemand;
    const nDepositDisplay = document.getElementById('nDeposit_display');
    if (nDepositDisplay) {
        // ì²­êµ¬ì•¡ display í•„ë“œì—ì„œ í¬ë§·ëœ ê°’ ê°€ì ¸ì˜¤ê¸°
        nDepositDisplay.value = nDemandDisplay ? nDemandDisplay.value : nDemand.toLocaleString('ko-KR');
    }

    // ê³¼/ë¯¸ì…ê¸ˆ ì¬ê³„ì‚°
    calculateExcess();
}

// ì…ê¸ˆì¼ ì˜¤ëŠ˜ë¡œ ì…ë ¥
function completeDeposit() {
    // ì…ê¸ˆì¼ì„ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
    document.getElementById('dateDeposit').value = new Date().toISOString().split('T')[0];
    // nType ìë™ ì—…ë°ì´íŠ¸
    updateTypeByDeposit();
}

// í¬ì¸íŠ¸ ì²˜ë¦¬
function processPoint(type) {
    // ì—…ì²´ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸° - ì „ì—­ ë³€ìˆ˜ ìš°ì„  ì‚¬ìš©
    let companyNo = currentCompanyNo;
    if (!companyNo) {
        const companyNoElement = document.getElementById('noCompany');
        if (companyNoElement) {
            companyNo = companyNoElement.value;
        }
    }

    // ì‘ì—…ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° - ì „ì—­ ë³€ìˆ˜ ìš°ì„  ì‚¬ìš©
    let worker = currentWorker;
    if (!worker) {
        const workerElement = document.getElementById('sWorker');
        if (workerElement) {
            worker = workerElement.value;
        }
    }

    let usePoint = 0;

    if (type === 0) {  // ì‚¬ìš© (í¬ì¸íŠ¸ ì°¨ê°)
        // display í•„ë“œì˜ ê°’ì„ ë¨¼ì € í™•ì¸ (ì‚¬ìš©ìê°€ ìˆ˜ì •í–ˆì„ ìˆ˜ ìˆìŒ)
        const displayValue = document.getElementById('nAppPoint_display');
        if (displayValue) {
            usePoint = parseInt(displayValue.value.replace(/,/g, '')) || 0;
        } else {
            const hiddenValue = document.getElementById('nAppPoint');
            if (hiddenValue) {
                usePoint = parseInt(hiddenValue.value) || 0;
            }
        }
    } else if (type === 2) {  // ê³¼ì…ê¸ˆ ì ë¦½
        const excessElement = document.getElementById('nExcess');
        if (excessElement) {
            usePoint = parseInt(excessElement.value) || 0;
        }
    }

    if (usePoint <= 0) {
        alert('í¬ì¸íŠ¸ ê¸ˆì•¡ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (í˜„ì¬ ê°’: ' + usePoint + ')');
        return;
    }

    if (!companyNo) {
        alert('ì—…ì²´ ë²ˆí˜¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
        return;
    }

    if (!worker) {
        alert('ì‘ì—…ì ì •ë³´ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
        return;
    }

    console.log('í¬ì¸íŠ¸ ì²˜ë¦¬ ìš”ì²­:', {
        company_no: companyNo,
        type: type,
        use_point: usePoint,
        report_no: currentReportNo,
        worker: worker
    });

    fetch('/contract/api/point-process/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            company_no: companyNo,
            type: type,
            use_point: usePoint,
            report_no: currentReportNo,
            worker: worker  // Staff.sNick ì „ë‹¬
        })
    })
    .then(response => {
        console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('ì‘ë‹µ ë°ì´í„°:', data);
        if (data.success) {
            alert('í¬ì¸íŠ¸ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.\në‚¨ì€ í¬ì¸íŠ¸: ' + data.remain_point.toLocaleString() + 'ì›');

            // í¬ì¸íŠ¸ ì”ì•¡ UI ì—…ë°ì´íŠ¸
            const remainPointElement = document.getElementById('remainPoint');
            if (remainPointElement) {
                remainPointElement.textContent = data.remain_point.toLocaleString();
            }

            // í¬ì¸íŠ¸ ì°¨ê° ì™„ë£Œ - ì ìš©í¬ì¸íŠ¸ ê°’ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
            // (ì‚¬ìš©ìê°€ ê³„ì† ì‘ì—…í•  ìˆ˜ ìˆë„ë¡ ì…ë ¥ê°’ ë³´ì¡´)

            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì§€ ì•ŠìŒ - ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ ìœ ì§€
        } else {
            alert('í¬ì¸íŠ¸ ì²˜ë¦¬ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('í¬ì¸íŠ¸ ì²˜ë¦¬ ì—ëŸ¬:', error);
        alert('í¬ì¸íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    });
}

// ì²­êµ¬ ë¬¸ì ë°œì†¡
function sendInvoiceSMS() {
    // TODO: SMS ë°œì†¡ API êµ¬í˜„
    alert('ì²­êµ¬ ë¬¸ì ë°œì†¡ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
}

{% if action in 'increase,decrease' %}
// ì¦ì•¡/ê°ì•¡ ì‹œ ì´ì•¡ ê³„ì‚°
function calculateTotalAmounts() {
    const preConMoney = {{ report.nPreConMoney|default:0 }};
    const conMoney = parseInt(document.getElementById('nConMoney').value) || 0;
    const conType = parseInt(document.getElementById('nConType').value);

    const totalConMoney = preConMoney + conMoney;
    document.getElementById('totalConMoney').textContent = totalConMoney.toLocaleString() + ' ì› (VAT ë³„ë„)';

    // ì´ ìˆ˜ìˆ˜ë£Œ ê³„ì‚°
    fetch('/contract/api/calculate-fee/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            con_type: conType,
            con_money: totalConMoney
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const totalFee = data.fee;
            document.getElementById('totalFee').textContent = totalFee.toLocaleString() + ' ì› (VAT í¬í•¨)';

            // ì´ë²ˆ ë³´ê³  ìˆ˜ìˆ˜ë£Œ ê³„ì‚°
            const preFee = {{ report.nPreFee|default:0 }};
            const thisFee = totalFee - preFee;
            document.getElementById('nFee').value = thisFee;
            calculateDemand();
        }
    });
}
{% endif %}

// ì‚­ì œ ê´€ë ¨ í•¨ìˆ˜ë“¤
function deleteReport() {
    document.getElementById('deleteModal').style.display = 'block';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

function confirmDelete() {
    if (!currentReportNo) return;

    fetch(`/contract/companyreport/${currentReportNo}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '{% url "contract:companyreport_list" %}';
        } else {
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
        }
    });
}

// ì—…ì²´ ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ í´ë˜ìŠ¤
class CompanySearchDropdown {
    constructor(container) {
        this.container = container;
        this.input = container.querySelector('.company-search-input');
        this.dropdown = container.querySelector('.company-dropdown-list');
        this.items = Array.from(container.querySelectorAll('.company-dropdown-item'));
        this.filteredItems = [...this.items];
        this.selectedIndex = -1;
        this.reportId = container.dataset.reportId;

        this.init();
    }

    init() {
        // ì…ë ¥ ì´ë²¤íŠ¸ ë°”ì¸ë”©
        this.input.addEventListener('input', (e) => this.handleInput(e));
        this.input.addEventListener('focus', () => this.showAllItems());
        this.input.addEventListener('click', () => this.showAllItems());  // í´ë¦­ ì‹œì—ë„ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
        this.input.addEventListener('blur', (e) => this.handleBlur(e));
        this.input.addEventListener('keydown', (e) => this.handleKeydown(e));

        // ë“œë¡­ë°•ìŠ¤ ì•„ì´í…œ í´ë¦­ ì´ë²¤íŠ¸
        this.items.forEach(item => {
            item.addEventListener('mousedown', (e) => this.selectItem(item));
        });
    }

    showAllItems() {
        // ëª¨ë“  ì•„ì´í…œ í‘œì‹œ
        this.items.forEach(item => {
            item.style.display = 'block';
        });
        this.filteredItems = [...this.items];
        this.showDropdown();
    }

    handleInput(e) {
        const query = e.target.value.toLowerCase();
        this.filterItems(query);
        this.showDropdown();
        this.selectedIndex = -1;
    }

    filterItems(query) {
        this.filteredItems = this.items.filter(item => {
            const companyName = item.dataset.companyName.toLowerCase();
            const isMatch = companyName.includes(query);
            item.style.display = isMatch ? 'block' : 'none';
            return isMatch;
        });

        // í•˜ì´ë¼ì´íŠ¸ ì œê±°
        this.items.forEach(item => item.classList.remove('highlighted'));
    }

    showDropdown() {
        this.dropdown.style.display = 'block';
    }

    hideDropdown() {
        this.dropdown.style.display = 'none';
        this.selectedIndex = -1;
        this.items.forEach(item => item.classList.remove('highlighted'));
    }

    handleBlur(e) {
        // ë“œë¡­ë°•ìŠ¤ ì•„ì´í…œ í´ë¦­í•˜ëŠ” ê²½ìš° blur ë¬´ì‹œ
        setTimeout(() => {
            this.hideDropdown();
        }, 150);
    }

    handleKeydown(e) {
        if (!this.dropdown.style.display || this.dropdown.style.display === 'none') {
            return;
        }

        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                this.moveSelection(1);
                break;
            case 'ArrowUp':
                e.preventDefault();
                this.moveSelection(-1);
                break;
            case 'Enter':
                e.preventDefault();
                if (this.selectedIndex >= 0 && this.selectedIndex < this.filteredItems.length) {
                    this.selectItem(this.filteredItems[this.selectedIndex]);
                }
                break;
            case 'Escape':
                this.hideDropdown();
                this.input.blur();
                break;
        }
    }

    moveSelection(direction) {
        // ì´ì „ í•˜ì´ë¼ì´íŠ¸ ì œê±°
        if (this.selectedIndex >= 0 && this.selectedIndex < this.filteredItems.length) {
            this.filteredItems[this.selectedIndex].classList.remove('highlighted');
        }

        // ìƒˆ ì¸ë±ìŠ¤ ê³„ì‚°
        this.selectedIndex += direction;

        if (this.selectedIndex < 0) {
            this.selectedIndex = this.filteredItems.length - 1;
        } else if (this.selectedIndex >= this.filteredItems.length) {
            this.selectedIndex = 0;
        }

        // ìƒˆ í•˜ì´ë¼ì´íŠ¸ ì ìš©
        if (this.selectedIndex >= 0 && this.selectedIndex < this.filteredItems.length) {
            this.filteredItems[this.selectedIndex].classList.add('highlighted');
            this.filteredItems[this.selectedIndex].scrollIntoView({
                block: 'nearest'
            });
        }
    }

    selectItem(item) {
        const companyId = item.dataset.companyId;
        const companyName = item.dataset.companyName;

        // ì…ë ¥ê°’ ì„¤ì •
        this.input.value = companyName;

        // ë°ì´í„° ì†ì„± ì—…ë°ì´íŠ¸
        this.input.dataset.currentCompanyId = companyId;

        // hidden input ì—…ë°ì´íŠ¸ (detail í™”ë©´ì—ì„œëŠ” form submitì´ í•„ìš”)
        const hiddenInput = document.getElementById('noCompany');
        if (hiddenInput) {
            hiddenInput.value = companyId;
        }

        // ë“œë¡­ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
        this.hideDropdown();

        // ì‹œê°ì  í”¼ë“œë°± ì¶”ê°€
        this.input.style.borderColor = '#28a745';
        this.input.style.backgroundColor = '#f0fff4';
        setTimeout(() => {
            this.input.style.borderColor = '';
            this.input.style.backgroundColor = '';
        }, 2000);

        // Order/Assign ê²€ìƒ‰ ì‹¤í–‰ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
        if (typeof searchOrderAndAssign === 'function') {
            searchOrderAndAssign();
        }
    }
}

// ì²œ ë‹¨ìœ„ ì½¤ë§ˆ í¬ë§·íŒ… í•¨ìˆ˜
function formatNumberWithCommas(value) {
    // ìˆ«ìê°€ ì•„ë‹Œ ë¬¸ì ì œê±°
    value = value.toString().replace(/[^0-9-]/g, '');

    // ìŒìˆ˜ ê¸°í˜¸ ì²˜ë¦¬
    const isNegative = value.startsWith('-');
    value = value.replace(/-/g, '');

    // ì²œ ë‹¨ìœ„ ì½¤ë§ˆ ì¶”ê°€
    const number = parseInt(value) || 0;
    const formatted = number.toLocaleString('ko-KR');

    return isNegative ? '-' + formatted : formatted;
}

// ì½¤ë§ˆ ì œê±° í•¨ìˆ˜
function removeCommas(value) {
    return value.toString().replace(/,/g, '');
}

// ê¸ˆì•¡ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” í•¨ìˆ˜
function initMoneyInputs() {
    // ëª¨ë“  money-input í´ë˜ìŠ¤ ìš”ì†Œ ì„ íƒ
    const moneyInputs = document.querySelectorAll('.money-input');

    moneyInputs.forEach(input => {
        // ì´ˆê¸° ê°’ í¬ë§·íŒ…
        if (input.value) {
            input.value = formatNumberWithCommas(input.value);
        }

        // ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        input.addEventListener('input', function(e) {
            const cursorPos = e.target.selectionStart;
            const oldLength = e.target.value.length;

            // í¬ë§·ëœ ê°’ ì„¤ì •
            const formatted = formatNumberWithCommas(e.target.value);
            e.target.value = formatted;

            // hidden í•„ë“œ ì—…ë°ì´íŠ¸
            const hiddenFieldId = e.target.id.replace('_display', '');
            const hiddenField = document.getElementById(hiddenFieldId);
            if (hiddenField) {
                hiddenField.value = removeCommas(formatted);

                // ê´€ë ¨ ê³„ì‚° í•¨ìˆ˜ í˜¸ì¶œ
                if (hiddenFieldId === 'nConMoney') {
                    {% if action in 'increase,decrease' %}
                    calculateTotalAmounts();
                    {% endif %}
                } else if (hiddenFieldId === 'nFee') {
                    calculateDemand();
                } else if (hiddenFieldId === 'nAppPoint') {
                    calculateDemand();
                } else if (hiddenFieldId === 'nDeposit') {
                    calculateExcess();
                }
            }

            // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì •
            const newLength = formatted.length;
            const diff = newLength - oldLength;
            e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
        });

        // í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ì •ë¦¬
        input.addEventListener('blur', function(e) {
            const formatted = formatNumberWithCommas(e.target.value);
            e.target.value = formatted;

            // hidden í•„ë“œ ìµœì¢… ì—…ë°ì´íŠ¸
            const hiddenFieldId = e.target.id.replace('_display', '');
            const hiddenField = document.getElementById(hiddenFieldId);
            if (hiddenField) {
                hiddenField.value = removeCommas(formatted);
            }
        });
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì—…ì²´ ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ ë° ê¸ˆì•¡ ì…ë ¥ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    // ê¸ˆì•¡ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    initMoneyInputs();

    // company-search-container ì°¾ê¸°
    const companySearchContainers = document.querySelectorAll('.company-search-container');

    // ê° ì»¨í…Œì´ë„ˆì— ëŒ€í•´ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
    companySearchContainers.forEach(container => {
        new CompanySearchDropdown(container);
        console.log('CompanySearchDropdown initialized for:', container.dataset.reportId);
    });

    // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸
    if (companySearchContainers.length === 0) {
        console.warn('No company-search-container found in the page');
    }

    // íŒŒì¼ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.querySelectorAll('.delete-file-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const fileId = this.dataset.fileId;
            const fileName = this.dataset.fileName;

            if (confirm(`"${fileName}" íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                deleteReportFile(fileId);
            }
        });
    });
});

// íŒŒì¼ ì‚­ì œ í•¨ìˆ˜
function deleteReportFile(fileId) {
    const csrfToken = getCookie('csrftoken');

    fetch(`/contract/api/report-file/${fileId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // íŒŒì¼ í•­ëª© ì œê±°
            const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
            if (fileItem) {
                fileItem.remove();
            }

            // íŒŒì¼ ëª©ë¡ì´ ë¹„ì—ˆìœ¼ë©´ ì „ì²´ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const fileList = document.querySelector('.file-list');
            if (fileList && fileList.children.length === 0) {
                const uploadedFilesSection = document.querySelector('.uploaded-files');
                if (uploadedFilesSection) {
                    uploadedFilesSection.remove();
                }
            }

            alert(data.message);
        } else {
            alert('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}